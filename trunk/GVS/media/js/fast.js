var cjson_parse=(function(){var d,b,a={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},p,n=function(q){throw {name:"SyntaxError",message:q,at:d,text:p}},h=function(q){if(q&&q!==b){n("Expected '"+q+"' instead of '"+b+"'")}b=p.charAt(d);d+=1;return b},g=function(){var r,q="";if(b==="-"){q="-";h("-")}while(b>="0"&&b<="9"){q+=b;h()}if(b==="."){q+=".";while(h()&&b>="0"&&b<="9"){q+=b}}if(b==="e"||b==="E"){q+=b;h();if(b==="-"||b==="+"){q+=b;h()}while(b>="0"&&b<="9"){q+=b;h()}}r=+q;if(isNaN(r)){n("Bad number")}else{return r}},j=function(){if(b==="/"){h();if(b==="/"){while(h()){if(b==="\n"){h();return}}}else{if(b==="*"){while(h()){if(b==="*"){while(b==="*"){h()}if(b==="/"){h();return}}}}}}n("Bad comment")},i=function(){var t,s,r="",q;if(b==='"'){while(h()){if(b==='"'){h();return r}else{if(b==="\\"){h();if(b==="u"){q=0;for(s=0;s<4;s+=1){t=parseInt(h(),16);if(!isFinite(t)){break}q=q*16+t}r+=String.fromCharCode(q)}else{if(typeof a[b]==="string"){r+=a[b]}else{break}}}else{r+=b}}}}n("Bad string")},l=function(){while(b&&(b<=" "||b==="/")){if(b==="/"){j()}else{h()}}},c=function(){switch(b){case"t":h("t");h("r");h("u");h("e");return true;case"f":h("f");h("a");h("l");h("s");h("e");return false;case"n":h("n");h("u");h("l");h("l");return null}n("Unexpected '"+b+"'")},o,k=function(){var q=[];if(b==="["){h("[");l();if(b==="]"){h("]");return q}while(b){q.push(o());l();if(b==="]"){h("]");return q}h(",");l()}}n("Bad array")},f=function(){var r,q={};if(b==="{"){h("{");l();if(b==="}"){h("}");return q}while(b){r=i();l();h(":");if(Object.hasOwnProperty.call(q,r)){n('Duplicate key "'+r+'"')}q[r]=o();l();if(b==="}"){h("}");return q}h(",");l()}}n("Bad object")};o=function(){l();switch(b){case"{":return f();case"[":return k();case'"':return i();case"-":return g();default:return b>="0"&&b<="9"?g():c()}};return function(t,r){var q;p=t;d=0;b=" ";q=o();l();if(b){n("Syntax error")}return typeof r==="function"?(function s(y,x){var w,u,z=y[x];if(z&&typeof z==="object"){for(w in z){if(Object.hasOwnProperty.call(z,w)){u=s(z,w);if(u!==undefined){z[w]=u}else{delete z[w]}}}}return r.call(y,x,z)}({"":q},"")):q}}());var DragHandler=Class.create({initialize:function(a){this._dragSource=a;this._draggedObject=null;this._initialDropZone=null;this._dropZonesInfo=new Array();this._boundedStartDrag=this._startDrag.bind(this);this._boundedUpdate=this._update.bind(this);this._boundedEndDrag=this._endDrag.bind(this)},enableDragNDrop:function(b,a){this._initialDropZone=b;this._initialDropZonePosition=null;a.each(function(c){this._dropZonesInfo.push({dropZone:c,position:null})}.bind(this));Event.observe(this._dragSource.getHandlerNode(),"mousedown",this._boundedStartDrag,true)},_startDrag:function(c){c=c||window.event;this._mouseXStart=0;this._mouseYStart=0;this._x=0;this._y=0;this._offLimitX=0;this._offLimitY=0;if(!BrowserUtils.isLeftButton(c.button)){return false}this._draggedObject=this._dragSource.getDraggableObject();var a=this._draggedObject.getHandlerNode();this._initialArea=a.parentNode;this._dropZonesInfo.each(function(f){var d=f.dropZone.getNode();f.position=Geometry.getClientRectangle(d)}.bind(this));if(this._initialDropZone){var b=this._initialDropZone.getNode();this._initialDropZonePosition=Geometry.getRectangle(b)}this._toggleEventHandlers(true);this._draggedObject.onStart();this._mouseXStart=parseInt(c.screenX);this._mouseYStart=parseInt(c.screenY);this._y=a.offsetTop;this._x=a.offsetLeft;if(this._isChangingZone()){a.addClassName("dragOnChangeLayer")}else{a.addClassName("dragLayer")}return false},_update:function(d){d=d||window.event;var c=parseInt(d.screenX);var b=parseInt(d.screenY);this._updateNodePosition(c,b);this._updateNodeStatus(this._isValidPosition());this._draggedObject.onUpdate(this._x,this._y);var a=this._draggedObject.getHandlerNode()},_endDrag:function(c){c=c||window.event;if(!BrowserUtils.isLeftButton(c.button)){return false}this._toggleEventHandlers(false);var a=this._draggedObject.getHandlerNode();a.removeClassName("dragLayer");a.removeClassName("dragOnChangeLayer");this._updateNodeStatus(true);var f;var b;if(this._isChangingZone()){var d=this._inWhichDropZone();if(d){b=Geometry.adaptDropPosition(d.getNode(),a);this._initialArea.removeChild(a);f=d.drop(this._draggedObject,b)}else{this._initialArea.removeChild(a);f=false}if(!f){this._draggedObject.destroy()}}else{f=true;b={top:a.offsetTop,left:a.offsetLeft}}if(f){this._draggedObject.onFinish(this._isChangingZone(),b)}this._draggedObject=null;return false},_toggleEventHandlers:function(a){if(a){document.oncontextmenu=function(){return false};document.onmousedown=function(){return false};document.onselectstart=function(){return false};Event.stopObserving(this._draggedObject.getHandlerNode(),"mousedown",this._boundedStartDrag,true);Event.observe(document,"mouseup",this._boundedEndDrag,true);Event.observe(document,"mousemove",this._boundedUpdate,true)}else{document.onmousedown=null;document.oncontextmenu=null;document.onselectstart=null;Event.observe(this._dragSource.getHandlerNode(),"mousedown",this._boundedStartDrag,true);Event.stopObserving(document,"mouseup",this._boundedEndDrag,true);Event.stopObserving(document,"mousemove",this._boundedUpdate,true)}},_isChangingZone:function(){return(this._initialDropZone==null)},_isValidPosition:function(){if(this._isChangingZone()){return(this._inWhichDropZone()!=null)}else{return true}},_inWhichDropZone:function(){for(var a=0;a<this._dropZonesInfo.length;a++){if(Geometry.intersects(this._dropZonesInfo[a].position,this._getDraggableNodeRectangle())){return this._dropZonesInfo[a].dropZone}}return null},_getDraggableNodeRectangle:function(){var a=this._draggedObject.getHandlerNode();return{top:a.offsetTop,left:a.offsetLeft,bottom:a.offsetTop+a.offsetHeight,right:a.offsetLeft+a.offsetWidth}},_updateNodePosition:function(a,i){var h=a-this._mouseXStart;var f=i-this._mouseYStart;this._mouseXStart=a;this._mouseYStart=i;var c=this._draggedObject.getHandlerNode();if(!this._isChangingZone()){var b=Geometry.dragRanges(this._initialDropZonePosition,this._getDraggableNodeRectangle());var g=Geometry.updateAxis(b.x,h,this._offLimitX);h=g.delta;this._offLimitX=g.offLimit;var d=Geometry.updateAxis(b.y,f,this._offLimitY);f=d.delta;this._offLimitY=d.offLimit}this._y=this._y+f;this._x=this._x+h;c.style.top=this._y+"px";c.style.left=this._x+"px"},_updateNodeStatus:function(a){if(a){this._draggedObject.getHandlerNode().removeClassName("disabled")}else{this._draggedObject.getHandlerNode().addClassName("disabled")}}});var DragSource=Class.create({initialize:function(){this._dragHandler=new DragHandler(this)},getHandlerNode:function(){throw"Abstract Method invocation: DragSource::_getHandlerNode"},enableDragNDrop:function(b,a){this._dragHandler.enableDragNDrop(b,a)},getDraggableObject:function(){throw"Abstract Method invocation: DragSource::getDraggableObject"},onStart:function(){},onUpdate:function(a,b){},onFinish:function(a){},isValidPosition:function(a,b){return true}});var Area=Class.create({initialize:function(d,c,f,a){var b=Utils.variableOrDefault(a,{});b=Object.extend({style:""},b);this._acceptedElements=c;this._onDropHandler=f;if(b.region!="center"){if(b.minHeight!=null){b.style+="height: "+b.minHeight+"px;"}if(b.minWidth!=null){b.style+="width: "+b.minWidth+"px;"}}this._contentPane=new dijit.layout.ContentPane(b);this._node=new Element("div",{"class":"dropArea "+d});this._contentPane.setContent(this._node)},getNode:function(){return this._node},getWidget:function(){return this._contentPane},drop:function(b,a){var c=this._onDropHandler(this,b,a);return c},accepts:function(){return this._acceptedElements},setLayout:function(){}});var BuildingBlockFactory=Class.create({initialize:function(){},getBuildingBlockType:function(){throw"Abstract method invocation. BuildingBlockFactory::getBuildingBlockType"},getBuildingBlockName:function(){return Constants.BuildingBlockNames[this.getBuildingBlockType()]},getBuildingBlocks:function(){throw"Abstract method invocation. BuildingBlockFactory::getBuildingBlockDescriptions"},getInstance:function(b,a){throw"Abstract method invocation. BuildingBlockFactory::getInstance"}});var ScreenflowFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.SCREENFLOW},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. ScreenflowFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new ScreenflowInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.screens);this.callback()},_updateBuildingBlockDescriptions:function(b){for(var a=0;a<b.length;a++){this._buildingBlockDescriptions.set(b[a].uri,new ScreenflowDescription(b[a]))}}});var ScreenFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.SCREEN},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. ScreenFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new ScreenInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.screens);this.callback()},_updateBuildingBlockDescriptions:function(b){for(var a=0;a<b.length;a++){this._buildingBlockDescriptions.set(b[a].uri,new ScreenDescription(b[a]))}}});var DomainConceptFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super()},getBuildingBlockType:function(){return Constants.BuildingBlock.DOMAIN_CONCEPT},getBuildingBlocks:function(b,c){var a=this._createUrl(b);PersistenceEngine.sendGet(a,{callback:c},this._onSuccess,this._onError)},_createUrl:function(a){if(a.size()>0){var b=a.collect(function(c){return c.label["en-gb"]}).join("+");return URIs.catalogueTagConcepts.replace("<tags>",b)}else{return URIs.catalogueAllConcepts}},_onSuccess:function(c){var b=c.responseText.evalJSON();var a=new Array();$A(b).each(function(d){a.push(new PrePostDescription(d))});this.callback(a)},_onError:function(b,a){Logger.serverError(b,a)}});var FormFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.FORM},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new FormInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.forms);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new FormDescription(a[b]))}}});var OperatorFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.OPERATOR},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new OperatorInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.operators);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new BuildingBlockDescription(a[b]))}}});var ResourceFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.RESOURCE},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},getInstance:function(b,a){return new ResourceInstance(b,a)},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.backendservices);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new BuildingBlockDescription(a[b]))}}});var Catalogue=Class.create();Object.extend(Catalogue,{_factories:{screen:new ScreenFactory(),screenflow:new ScreenflowFactory(),domainConcept:new DomainConceptFactory(),form:new FormFactory(),resource:new ResourceFactory(),operator:new OperatorFactory()}});Object.extend(Catalogue,{getBuildingBlockFactory:function(a){return this._factories[a]},getFacts:function(){var b=function(c){var d=c.responseText.evalJSON();FactFactory.setFacts(d)};var a=function(c,d){console.error(d)};PersistenceEngine.sendGet(URIs.catalogueGetFacts,this,b,a)},getDomainConcepts:function(){var a=function(d){var g=d.responseText.evalJSON();this.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT).updateBuildingBlockDescriptions(g.domainConcepts);var f=GVS.getDocumentController().getCurrentDocument().getPaletteController();var c=f.getPalette(Constants.BuildingBlock.DOMAIN_CONCEPT);c.paintComponents()};var b=function(c,d){console.error(d)};PersistenceEngine.sendGet(URIs.catalogueGetDomainConcepts,this,a,b)},createScreen:function(b){var c=function(g){var f=JSON.parse(g.responseText);if(f.uri==undefined||f.uri==null){console.log("createScreenOnError");alert("Server error in the Screen creation")}else{var h="Screen correctly created!\nLabel: "+f.label["en-GB"]+"\nURI: "+f.uri;alert(h)}};var d=function(g,f){alert(f.message)};var a=PersistenceEngineFactory.getInstance();a.sendPost(URIs.catalogueCreateScreen,null,b,this,c,d)}});var BuildingBlockDescription=Class.create({initialize:function(a){Utils.addProperties(this,a)},addProperties:function(a){Utils.addProperties(this,a)},toJSON:function(){var a={};$H(this).each(function(b){if(!(b.value instanceof Function)){a[b.key]=b.value}});return Object.toJSON(a)},getTitle:function(){return this.label?this.label["en-gb"]:this.name},getId:function(){return this.id},isValid:function(){return true}});var FormDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a)},getPreview:function(){var b=new Element("div",{"class":"preview"});var a=new Element("div",{"class":"error"});b.appendChild(a);var c=new Element("img",{src:this.screenshot,onerror:'this.src = "/fast/images/gui/imageNotFound.png";'});b.appendChild(c);return b},});var ScreenDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a);this._preconditions=new Hash();this._postconditions=new Hash();this._buildingBlocks=new Hash();this._pipes=new Hash();this._triggers=new Hash()},toJSON:function(){var a={preconditions:this.getPreconditions().size()>0?[this.getPreconditions()]:[],postconditions:this.getPostconditions().size()>0?[this.getPostconditions()]:[],definition:{buildingblocks:this._getScreenBuildingBlocks(),pipes:this._getScreenPipes(),triggers:this._getTriggers()}};a=Object.extend(a,{name:this.name,label:this.label,tags:this.tags,version:this.version,id:this.id,creator:this.creator,description:this.description,rights:this.rights,creationDate:this.creationDate,icon:this.icon,screenshot:this.screenshot,homepage:this.homepage,type:"screen"});return a},getPreview:function(){var b=new Element("div",{"class":"preview"});var a=new Element("div",{"class":"error"});b.appendChild(a);var c=new Element("img",{src:this.screenshot,onerror:"this.parentNode.childNodes[0].update('Image not available');this.src='"+URIs.logoFast+"';"});b.appendChild(c);return b},getInfo:function(){var a=new Hash();a.set("Title",this.label["en-gb"]);a.set("Tags",this.tags.collect(function(b){return b.label["en-gb"]}).join(", "));a.set("Version",this.version);return a},addPre:function(b,a){this._preconditions.set(b.getId(),{buildingblock:b,position:a})},addPost:function(b,a){this._postconditions.set(b.getId(),{buildingblock:b,position:a})},updatePrePost:function(b,a){var d;if(b.getType()=="pre"){d=this._preconditions}else{d=this._postconditions}var f=d.get(b.getId());var c=f.position;if(c.top!=a.top||c.left!=a.left){f.position=a;return true}else{return false}},addBuildingBlock:function(b,a,c){this._buildingBlocks.set(b.getId(),{buildingblock:b,position:a,orientation:c})},updateBuildingBlock:function(b,a,f){var c=this._buildingBlocks.get(b.getId());var d=c.position;if(d.top!=a.top||d.left!=a.left||d.orientation!=f){c.position=a;c.orientation=f;return true}return false},addPipe:function(a){this._pipes.set(a.getId(),a)},addTrigger:function(a){if(this._triggers.get(a.getId())){this._triggers.unset(a.getId())}else{this._triggers.set(a.getId(),a)}},getPipes:function(){var a=new Array();this._pipes.values().each(function(b){a.push(b.getJSONforCheck())});return a},getPreconditions:function(){var a=new Array();this._preconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreen(),{position:c.position});a.push(b)}.bind(this));return a},getPostconditions:function(){var a=new Array();this._postconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreen(),{position:c.position});a.push(b)}.bind(this));return a},getCanvasInstances:function(){var a=new Array();this._buildingBlocks.values().each(function(b){a.push(b.buildingblock)});return a},getInstance:function(a){return this._buildingBlocks.get(a).buildingblock},getInstanceByUri:function(a){return this._buildingBlocks.values().detect(function(b){return b.buildingblock.getUri()==a}).buildingblock},getInstancesByUri:function(a){var b=[];this._buildingBlocks.values().each(function(c){if(c.buildingblock.getUri()==a){b.push(c.buildingblock)}}).buildingblock;return b},contains:function(b){var a=this._buildingBlocks.values().detect(function(c){return c.buildingblock.getUri()==b});if(a){return true}else{return false}},getConditionInstances:function(){var a=new Array();this._preconditions.values().each(function(b){a.push(b.buildingblock)});this._postconditions.values().each(function(b){a.push(b.buildingblock)});return a},getPre:function(a){if(this._preconditions.get(a)){return this._preconditions.get(a).buildingblock}else{return null}},getPost:function(a){if(this._postconditions.get(a)){return this._postconditions.get(a).buildingblock}else{return null}},remove:function(a){switch(a.constructor){case PrePostInstance:if(this._preconditions.get(a.getId())){this._preconditions.unset(a.getId())}else{this._postconditions.unset(a.getId())}break;case Pipe:this._pipes.unset(a.getId());break;case Trigger:case ScreenTrigger:this._triggers.unset(a.getId());break;default:this._buildingBlocks.unset(a.getId())}},_getScreenBuildingBlocks:function(){var a=new Array();this._buildingBlocks.values().each(function(b){a.push({id:b.buildingblock.getId(),uri:b.buildingblock.getUri(),position:b.position,orientation:b.buildingblock.getOrientation(),parameter:b.buildingblock.getParams()})});return a},_getScreenPipes:function(){var a=new Array();this._pipes.values().each(function(b){a.push(b.getJSONforScreen())});return a},_getTriggers:function(){var a=new Array();this._triggers.values().each(function(b){a.push(b.toJSON())});return a}});var ScreenflowDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a);this._screens=new Hash();this._preconditions=new Hash();this._postconditions=new Hash()},toJSON:function(){var a={definition:{screens:this._getScreens(),preconditions:this.getPreconditions(),postconditions:this.getPostconditions()}};a=Object.extend(a,{name:this.name,label:this.label,tags:this.tags,version:this.version,id:this.id,creator:this.creator,description:this.description,rights:this.rights,creationDate:this.creationDate,icon:this.icon,screenshot:this.screenshot,homepage:this.homepage,type:"screenflow"});return a},addScreen:function(b,a){this._screens.set(b.getUri(),{buildingblock:b,position:a})},updateScreen:function(d,a){var b=this._screens.get(d);var c=b.position;if(c.top!=a.top||c.left!=a.left){b.position=a;return true}else{return false}},remove:function(a){this._screens.unset(a);this._preconditions.unset(a);this._postconditions.unset(a)},addPrePost:function(b,a){switch(b.getType()){case"pre":this._preconditions.set(b.getUri(),{buildingblock:b,position:a});break;case"post":this._postconditions.set(b.getUri(),{buildingblock:b,position:a});break;default:}},updatePrePost:function(c,a){var d=this._preconditions.get(c);if(!d){d=this._postconditions.get(c)}var b=d.position;if(b.top!=a.top||b.left!=a.left){d.position=a;return true}return false},getInfo:function(){var a=new Hash();a.set("Title",this.getTitle());a.set("Tags",this.tags.collect(function(b){return b.label["en-gb"]}).join(", "));a.set("Version",this.version);return a},getPreconditions:function(){var a=new Array();this._preconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreenflow(),{position:c.position});a.push(b)}.bind(this));return a},getPostconditions:function(){var a=new Array();this._postconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreenflow(),{position:c.position});a.push(b)}.bind(this));return a},getCanvasInstances:function(){var a=new Array();var b=this._screens.values().concat(this._preconditions.values());b=b.concat(this._postconditions.values());b.each(function(c){a.push(c.buildingblock)});return a},contains:function(b){var c=this._screens.values().concat(this._preconditions.values());c=c.concat(this._postconditions.values());var a=c.detect(function(d){return d.buildingblock.getUri()==b});if(a){return true}else{return false}},getConditionInstances:function(){return new Array()},_getScreenUris:function(){return this._screens.keys()},_getScreens:function(){var a=new Array();this._screens.values().each(function(b){a.push({uri:b.buildingblock.getUri(),position:b.position})});return a}});var PrePostDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a)},clone:function(){return new PrePostDescription(JSON.parse(this.toJSON()))},getTitle:function(){if(!this.title){this._updateTitle()}return this.title},_updateTitle:function(){if(this["http://www.w3.org/2000/01/rdf-schema#label"]){this.title=this["http://www.w3.org/2000/01/rdf-schema#label"].replace("@en","")}else{if(this["label"]){var b=$H(this["label"]).keys();if(b.size()==1){this.title=this["label"][b[0]]}else{}}else{var a;if(this.uri){a=this.uri}else{a=Utils.extractURIfromPattern(this.pattern)}this.title=this._createTitle(a)}}},_createTitle:function(c){if(c){var b=c.split("#");var a="";if(b.length>1){a=b[1]}else{b=c.split("/");a=b[b.length-1]}return this._sanitizeTitle(a)}else{return"Unknown Domain Concept"}},_sanitizeTitle:function(c){var a=c.replace("@en","");var b=a.match(/[A-Z][a-z0-9]+|\s+[a-z][a-z0-9]*/g);if(b){b.map(function(d){return d.strip()});a=b.join(" ")}return a}});var InferenceEngine=Class.create({initialize:function(){this._reachabilityData=new Hash();this._listeners=new Hash()},findCheck:function(c,f,b,h,g){var a=this._constructBody(c,f,b,h);var d={callback:g,mine:this};PersistenceEngine.sendPost(this._getUri("findCheck"),null,a,d,this._findCheckOnSuccess,this._onError)},check:function(c,f,b,h,g){var a=this._constructBody(c,f,b,h,"check");var d={callback:g,mine:this};PersistenceEngine.sendPost(this._getUri("check"),null,a,d,this._checkOnSuccess,this._onError)},addReachabilityListener:function(a,b){this._getListenerList(a).push(b);if(this._reachabilityData.get(a)){b.setReachability(this._reachabilityData.get(a))}},removeReachabilityListener:function(b,c){var a=this._getListenerList(b).indexOf(c);if(a>=0){this._listeners.get(b)[a]=null;this._listeners.set(b,this._listeners.get(b).compact())}},getPreconditionReachability:function(d){var b=this._reachabilityData.get(d);var a=new Hash();if(b.preconditions){if(b.preconditions.length>1){console.log("OR precondition support not implemented yet");return null}else{var c=b.preconditions[0];$A(c).each(function(g){var f=Utils.extractURIfromPattern(g.pattern);a.set(f,g.satisfied)})}}else{if(b.actions){$A(b.actions).each(function(f){$A(f.preconditions).each(function(h){var g=Utils.extractURIfromPattern(h.pattern);a.set(g,h.satisfied)})})}else{console.log("unknown reachability data format");return null}}return a},isReachable:function(b){var a=this._reachabilityData.get(b);if(a){return a.reachability}else{return null}},_constructBody:function(b,c,a,d){throw"Abstract Method invocation: InferenceEngine::_constructBody"},_getUri:function(a){throw"Abstract Method invocation: InferenceEngine::_getUri"},_findCheckOnSuccess:function(a){throw"Abstract method invocation: InferenceEngine::_findCheckOnSuccess"},_checkOnSuccess:function(a){throw"Abstract method invocation: InferenceEngine::_CheckOnSuccess"},_onError:function(b,a){Utils.showMessage("Something went wrong",{error:true,hide:true});Logger.serverError(b,a)},_getListenerList:function(a){var b=this._listeners.get(a);if(!b){b=new Array();this._listeners.set(a,b)}return b},_updateReachability:function(a){a.each(function(b){this._reachabilityData.set(b.uri,b);this._notifyReachability(b.uri)}.bind(this))},_notifyReachability:function(a){this._getListenerList(a).each(function(b){b.setReachability(this._reachabilityData.get(a))}.bind(this))}});var ScreenflowInferenceEngine=Class.create(InferenceEngine,{initialize:function($super){$super()},getPlans:function(d,c,f){var b={goal:c,canvas:d};var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.cataloguePlanner,null,a,{handler:f},this._planOnSuccess,this._onError)},_planOnSuccess:function(b){var a=JSON.parse(b.responseText);this.handler(a)},_constructBody:function(c,d,b,g){var f={tags:b.collect(function(h){return h.label["en-gb"]}),user:GVS.getUser().getUserName()};var a={canvas:c,elements:d,domainContext:f,criterion:g};return Object.toJSON(a)},_getUri:function(a){switch(a){case"findCheck":return URIs.catalogueScreenflowFindCheck;break;case"check":return URIs.catalogueScreenflowCheck;break;default:return""}},_findCheckOnSuccess:function(d){var a=JSON.parse(d.responseText);if(a.elements){var c=a.elements}this.mine._updateReachability(c);var b=new Array();$A(c).each(function(f){b.push(f.uri)});this.callback(b)},_checkOnSuccess:function(c){var a=JSON.parse(c.responseText);var b=a.elements.concat(a.canvas).uniq();this.mine._updateReachability(b);this.callback()}});var ScreenInferenceEngine=Class.create(InferenceEngine,{initialize:function($super){$super()},_constructBody:function(d,f,c,i,b){var h=Utils.variableOrDefault(b,"");var g={tags:c.collect(function(j){return j.label["en-gb"]}),user:GVS.getUser().getUserName()};var a={canvas:d,domainContext:g,criterion:i};if(h=="check"){a.search=false}a=Object.extend(a,f);return Object.toJSON(a)},_getUri:function(a){return URIs.catalogueScreenFindCheck},_findCheckOnSuccess:function(b){var a=JSON.parse(b.responseText);if(a.canvas&&a.canvas.length>0){this.mine._updateReachability(a.canvas)}this.callback(a)},_checkOnSuccess:function(c){try{var a=JSON.parse(c.responseText);this.mine._updateReachability(a.canvas);this.callback(a)}catch(b){}}});var BuildingBlockSet=Class.create({initialize:function(b,a){this._tags=b;this._factory=a;this._listener=null;this._uris=new Array()},getBuildingBlocks:function(){return this._factory.getBuildingBlocks(this._uris)},getBuildingBlockType:function(){return this._factory.getBuildingBlockType()},getBuildingBlockName:function(){return this._factory.getBuildingBlockName()},setListener:function(a){this._listener=a},addURIs:function(a){this._requestedUris=a;this._factory.cacheBuildingBlocks(a,this._cachedElements.bind(this))},_cachedElements:function(){this._uris=this._uris.concat(this._requestedUris).uniq();this._listener.setChanged()}});var DomainConceptSet=Class.create(BuildingBlockSet,{initialize:function($super,b,a){$super(b,a);this._domainConcepts=new Array()},startRetrievingData:function(){this._factory.getBuildingBlocks(this._tags,this._onSuccess.bind(this))},getBuildingBlocks:function(){return this._domainConcepts},_onSuccess:function(a){this._domainConcepts=a;this._listener.setChanged()}});var SetListener=Class.create({initialize:function(){},setChanged:function(){throw"Abstract method invocation: SetListener::setChanged"}});var Table=Class.create({initialize:function(a,d,g,f){this._parentNode=a;this._title=d;this._titleNode=new Element("div",{"class":"dijitAccordionTitle "}).update(this._title);this._tableNode=new Element("table",{"class":"propertiesTable"});var c=(g=="left")?"width: 50%":"width: auto";var b=new dijit.layout.ContentPane({region:g,splitter:true,style:c,"class":"tableArea"});if(f){b.attr("minSize",f)}b.domNode.insert(this._titleNode);b.domNode.insert(this._tableNode);this._parentNode.addChild(b)},setTitle:function(a){this._title=a;this._titleNode.update(a)},getTitle:function(){return this._title},getTableNode:function(){return this._tableNode},insertFieldTitles:function(a){var b=new Element("tr",{"class":"tableHeader"});a.each(function(c){var d=new Element("td").update(c);b.insert(d)});this._tableNode.insert(b)},insertDataValues:function(a){a.each(function(b){var c=new Element("tr");b.each(function(d){var g=new Element("td");var f=new Element("div").update(d);if(typeof d==="string"){f.setAttribute("title",d)}g.insert(f);c.insert(g)});this._tableNode.insert(c)}.bind(this))},emptyTable:function(){this._tableNode.update("")}});var PropertiesPane=Class.create({initialize:function(a){this._propertiesTable=new Table(a,"Properties","left");this._propertiesTable.insertFieldTitles(["Property","Value"])},fillTable:function(a){this._clearElement();var b=a.getTitle();this._propertiesTable.insertDataValues(a.getInfo());this._propertiesTable.setTitle((b?"Properties of "+b:"Properties"))},addSection:function(b,a){this._propertiesTable.insertFieldTitles(b);this._propertiesTable.insertDataValues(a)},_clearElement:function(){this._propertiesTable.emptyTable();this._propertiesTable.setTitle("Properties");this._propertiesTable.insertFieldTitles(["Property","Value"])}});var FactPane=Class.create({initialize:function(a){this._factTable=new Table(a,"Facts","center")},fillTable:function(a,b,c){this._factTable.emptyTable();if(a.size()>0){this._factTable.insertFieldTitles(["PRE","Description","Semantics"]);this._factTable.insertDataValues(a)}if(b.size()>0){this._factTable.insertFieldTitles(["POST","Description","Semantics"]);this._factTable.insertDataValues(b)}if(c.size()>0){this._factTable.insertFieldTitles(["Fact","Description","Semantics"]);this._factTable.insertDataValues(c)}}});var Toolbar=Class.create({initialize:function(){this._toolbar=dijit.byId("toolbar");this._models=new Array();this._sections=new Array();this._sections[0]=new Array()},setModel:function(a,c){this._removeModel(a);if(c){var b=c.getToolbarElements();if(b.size()>0){this._models[a]=c;this._initSection(a);b.each(function(d){this._sections[a].push(d.getWidget())}.bind(this))}}this._refreshToolbar()},_removeModel:function(a){if(this._models[a]){this._models[a]=null;this._sections[a].clear()}},_initSection:function(a){if(!this._sections[a]){this._sections[a]=new Array()}if(a!=0&&!this._sections[a][0]){this._sections[a][0]=new dijit.ToolbarSeparator()}},_refreshToolbar:function(){this._toolbar.getDescendants().each(function(a){this._toolbar.removeChild(a)}.bind(this));this._sections.each(function(a){a.each(function(b){this._toolbar.addChild(b)}.bind(this))}.bind(this))}});var ToolbarModel=Class.create({initialize:function(){this._toolbarElements=new Hash();this._toolbarElementOrder=new Array()},getToolbarElements:function(){var a=new Array();this._toolbarElementOrder.each(function(b){a.push(this._toolbarElements.get(b))}.bind(this));return a},_addToolbarElement:function(a,b){this._toolbarElementOrder.push(a);this._toolbarElements.set(a,b)}});var ToolbarButton=Class.create({initialize:function(b,d,c,a){this._widget=new dijit.form.Button({label:b,iconClass:"toolbarIcon "+d+"Icon",onClick:c,showLabel:false,disabled:(a!==undefined)?(!a):false})},getWidget:function(){return this._widget},setEnabled:function(a){this._widget.attr("disabled",!a)}});var ToolbarDropDown=Class.create({initialize:function(b,c,a){this._menu=new dijit.Menu();this._widget=new dijit.form.DropDownButton({label:b,showLabel:true,iconClass:"toolbarIcon "+c+"Icon",dropDown:this._menu,disabled:(a!==undefined)?(!a):false})},addMenuItem:function(a,c,d){var b=new dijit.MenuItem({label:a,showLabel:true,onClick:c});if(d){b.attr("iconClass","dropDownIcon "+d+"Icon")}this._menu.addChild(b)},getWidget:function(){return this._widget},setEnabled:function(a){this._widget.attr("disabled",!a)}});var Menu=Class.create({initialize:function(a){this._menu=dijit.byId("menu");this._models=new Hash();this._registry=a;this._menuElements=new Array()},setModel:function(b,c){this._models.unset(b);if(c){this._models.set(b,c)}var a=this._mergeAllModels(this._models.values());this._createMenu(a)},_mergeAllModels:function(c){var b=new Hash();c.each(function(d){b=this._mergeMenuElements(b,$H(d.getMenuElements()))}.bind(this));var a=b.values().clone();a.sort(function(f,d){var h=f.get("weight")?f.get("weight"):MenuElement.MAXIMUM_WEIGHT;var g=d.get("weight")?d.get("weight"):MenuElement.MAXIMUM_WEIGHT;return h-g});return a},_mergeMenuElements:function(d,b){var a=new Hash();var c=d.keys().concat(b.keys()).uniq();c.each(function(f){if(d.get(f)&&b.get(f)){a.set(f,this._mergeMenuElement($H(d.get(f)),$H(b.get(f))))}else{if(d.get(f)){a.set(f,$H(d.get(f)))}else{if(b.get(f)){a.set(f,$H(b.get(f)))}}}}.bind(this));return a},_mergeMenuElement:function(d,b){var a=new Hash();var c=d.keys().concat(b.keys()).uniq();c.each(function(f){if(d.get(f)&&b.get(f)){if(f=="children"){a.set(f,this._mergeMenuElements($H(d.get(f)),$H(b.get(f))))}else{if(d.get(f)!=b.get(f)){throw"Conflicting menu element property "+f}a.set(f,d.get(f))}}else{if(d.get(f)){a.set(f,d.get(f))}else{if(b.get(f)){a.set(f,b.get(f))}}}}.bind(this));return a},_createMenu:function(a){this._menuElements.each(function(b){b.unregister(this._registry)}.bind(this));this._menuElements.clear();a.each(function(d){var c=d.toObject();switch(c.type.toLowerCase()){case"submenu":var b=new SubMenu(c,true);break;case"action":var b=c.action;break}this._menuElements.push(b);this._menu.addChild(b.getWidget());b.register(this._registry)}.bind(this))}});var MenuElement=Class.create({initialize:function(a){this._widget=null;this._weight=a;if(!this._weight){this._weight=MenuElement.MAXIMUM_WEIGHT}},getWidget:function(){return this._widget},getWeight:function(){return this._weight},register:function(a){throw"Abstract method invocation. MenuElement::register"},unregister:function(a){throw"Abstract method invocation. MenuElement::unregister"}});MenuElement.MAXIMUM_WEIGHT=10000;var MenuAction=Class.create(MenuElement,{initialize:function($super,b,a){$super(b.weight);if(a){this._widget=new dijit.MenuBarItem({label:b.label,onClick:b.handler,showLabel:true})}else{this._widget=new dijit.MenuItem({label:b.label,onClick:b.handler,showLabel:true})}this._handler=b.handler;this._shortcut=(b.shortcut?b.shortcut:null);if(this._shortcut){this._widget.attr("accelKey",this._shortcut)}this._enabled=null;this.setEnabled(b.enabled!==undefined?b.enabled:true);if(b.iconName){this._widget.attr("iconClass","dijitMenuItemIcon menuIcon "+b.iconName+"MenuIcon")}},setEnabled:function(a){this._enabled=a;this._widget.attr("disabled",!a)},register:function(a){if(this._shortcut){a.addHandler(this._shortcut,this._keyPressHandler.bind(this))}},unregister:function(a){if(this._shortcut){a.removeHandler(this._shortcut)}},_keyPressHandler:function(){if(this._enabled){this._handler()}}});var SubMenu=Class.create(MenuElement,{initialize:function($super,b,a){$super(b.weight);var c=new dijit.Menu({});if(a){this._widget=new dijit.PopupMenuBarItem({label:b.label,popup:c})}else{this._widget=new dijit.PopupMenuItem({label:b.label,popup:c})}this._groups=new Array();var d;$H(b.children).each(function(g){var f=$H(g.value).toObject();switch(f.type.toLowerCase()){case"action":d=f.action;break;case"submenu":d=new SubMenu(f);break}this._addChild(f.group,d)}.bind(this));this._createSubMenu(c)},register:function(a){this._groups.each(function(b){b.each(function(c){c.register(a)})})},unregister:function(a){this._groups.each(function(b){b.each(function(c){c.unregister(a)})});this._widget.destroy(false)},_addChild:function(a,b){if(!this._groups[a]){this._groups[a]=new Array()}this._groups[a].push(b);this._groups[a].sort(function(d,c){return d.getWeight()-c.getWeight()})},_createSubMenu:function(b){for(var a=0;a<this._groups.size();a++){if(this._groups[a]){this._groups[a].each(function(c){b.addChild(c.getWidget())});if(a!=this._groups.size()-1){b.addChild(new dijit.MenuSeparator())}}}b.startup()}});var AbstractDocument=Class.create(ToolbarModel,{initialize:function($super,a,c){$super();var b=Utils.variableOrDefault(c,false);this._title=a;this._tabId=UIDGenerator.generate("tab");this._tabContent=new Element("div",{"class":"document"});this._tab=null;if(!b){this._tab=new dijit.layout.ContentPane({title:this._title,id:this._tabId,closable:true,onClose:this._closeDocument.bind(this)},null);this._tab.setContent(this._tabContent)}else{this._tab=this._getWidget()}},getTabId:function(){return this._tabId},getTab:function(){return this._tab},getTitle:function(){return this._title},getNode:function(){return this._tabContent},onKeyPressed:function(a){},getMenuElements:function(){return{}},show:function(){},hide:function(){},_closeDocument:function(){GVS.getDocumentController().closeDocument(this._tabId);return true},_setTitle:function(a){this._title=a;this._tab.attr("title",this._title)}});var ExternalDocument=Class.create(AbstractDocument,{initialize:function($super,b,a){this._url=a;$super(b,true)},_getWidget:function(){var b=new Element("iframe",{id:this._tabId,dojoType:"dijit.layout.ContentPane",src:this._url,title:this._title,style:"display: none; border: 0px; width: 100%; height: 100%"});$("documentContainer").appendChild(b);dojo.parser.parse($("documentContainer"));var a=dijit.byId(this._tabId);a.attr("closable",true);a.connect("onClose",this._closeDocument.bind(this));return a}});var PaletteDocument=Class.create(AbstractDocument,{initialize:function($super,b,c,a){$super(c.name);this._tags=c.tags;this._typeName=b;this._inferenceEngine=a;this._areas=this._getAreas();this._buildingBlockSets=this._getSets();this._paletteController=null;this._canvasCache=null;this._inspectorArea=new dijit.layout.BorderContainer({region:"bottom",design:"horizontal",style:"height: 180px; z-index:21 !important;",minSize:"100",maxSize:"220",persist:false,splitter:true});this._propertiesPane=new PropertiesPane(this._inspectorArea);this._factPane=new FactPane(this._inspectorArea);this._mainBorderContainer=null;this._designContainer=new dijit.layout.BorderContainer({region:"center",design:"sidebar",splitter:true,gutters:false});this._isDirty=false;this._pendingOperation=null;this._renderMainUI();this._areas.values().each(function(g){var f=g.getWidget();this._designContainer.addChild(f);var d=g.getNode();d.observe("click",function(){this._onClick()}.bind(this));d.observe("dblclick",function(){this._onClick()}.bind(this))}.bind(this));this._selectedElement=null;this._description=this._getDescription(c);this._propertiesDialog=new PropertiesDialog(this._typeName,this._description,this._onPropertiesChange.bind(this));if(this._description.getId()){this._canvasCache=this._getCanvasCache(c)}},getSelectedElement:function(){return this._selectedElement},getBuildingBlockDescription:function(){return this._description},elementClicked:function(a){this._setSelectedElement(a)},elementDblClicked:function(a,b){this._setSelectedElement(a)},positionUpdated:function(b,a){this._setDirty(true)},orientationUpdated:function(b,a){this._setDirty(true)},onKeyPressed:function(a){switch(a){case"delete":this._startDeletingSelectedElement();break;case"space":this._previewSelectedElement();break;default:break}},getMenuElements:function(){return{file:{type:"SubMenu",label:"File",weight:1,children:{save:{type:"Action",action:new MenuAction({label:"Save",handler:function(){this._save()}.bind(this),shortcut:"Alt+S"}),weight:1,group:1},saveas:{type:"Action",action:new MenuAction({label:"Save as...",handler:function(){this._saveAs()}.bind(this)}),weight:2,group:1}}}}},_start:function(){this._paletteController=new PaletteController(this._buildingBlockSets,this._areas.values(),this._inferenceEngine);this._renderPaletteArea();this._configureToolbar();Utils.showMessage("Loading building blocks");var b=this._getEmptyPalette();this._inferenceEngine.findCheck([],b,this._tags,"reachability",this._findCheckCallback.bind(this));var a=this._buildingBlockSets.detect(function(c){return c.constructor==DomainConceptSet});if(a){a.startRetrievingData()}if(this._description.getId()==null){this._setDirty(true)}},_setSelectedElement:function(a){if(this._selectedElement!=null){this._selectedElement.getView().setSelected(false)}if(a!=undefined){this._selectedElement=a;this._selectedElement.getView().setSelected(true)}else{this._selectedElement=null}this._updateToolbar(this._selectedElement);if(a){this._refreshReachability()}else{this._updatePanes()}},_startDeletingSelectedElement:function(){if(this._selectedElement!=null){var a=null;if(this._selectedElement.getTitle()){a='the element "'+this._selectedElement.getTitle()+'"'}else{a="the selected element"}confirm("You are about to remove "+a+" from canvas. Are you sure?",function(b){if(b){this._deleteSelectedElement()}}.bind(this))}},_rotateSelectedElement:function(){var b=this._selectedElement;if(b!=null){b.setOrientation((b.getOrientation()+1)%2);var a=b.getOrientation();b.getView().updateOrientation(a);b.onRotate(a);this.orientationUpdated(b,a)}},_renderMainUI:function(){this._mainBorderContainer=new dijit.layout.BorderContainer({design:"sidebar",liveSplitters:"false",splitter:"true"});this._mainBorderContainer.addChild(this._renderCenterContainer());this._tab.setContent(this._mainBorderContainer.domNode)},_setDirty:function(a){this._isDirty=a;this._toolbarElements.get("save").setEnabled(a);if(a){this._setTitle(this._description.name+"*")}else{this._setTitle(this._description.name)}},_renderPaletteArea:function(){this._mainBorderContainer.addChild(this._paletteController.getNode())},_deleteSelectedElement:function(){if(this._selectedElement){this._deleteInstance(this._selectedElement);this._setSelectedElement()}},_previewSelectedElement:function(){if(this._selectedElement){this._selectedElement.showPreviewDialog()}},_onPropertiesChange:function(){this._setTitle(this._description.name);this._setDirty(true)},_getCanvasUris:function(){var a=new Array();this._description.getCanvasInstances().each(function(b){a.push({uri:b.getUri()})});return a},_getAllFacts:function(){var a=new Hash();var b=this._description.getCanvasInstances().concat(this._description.getConditionInstances());b.each(function(c){if(c.constructor!=PrePostInstance){var i=this._inferenceEngine.getPreconditionReachability(c.getUri());var g=c.getPreconditionTable(i);g.each(function(j){if(!a.get(j[2])){a.set(j[2],j)}});var d=this._inferenceEngine.isReachable(c.getUri());var h=c.getPostconditionTable(d);h.each(function(j){if(!a.get(j[2])){a.set(j[2],j)}})}else{var f=c.getConditionTable();if(!a.get(f[2])){a.set(f[2],f)}}}.bind(this));return a.values()},_closeDocument:function(){if(this._isDirty){var b=new Element("div",{style:"text-align:center"}).update("The document has unsaved changes. Do you want to save?");var a=new ConfirmDialog("Warning",ConfirmDialog.SAVE_DISCARD_CANCEL,{callback:this._effectiveCloseDocument.bind(this),contents:b});a.show()}else{this._effectiveCloseDocument(ConfirmDialog.DISCARD)}return false},_effectiveCloseDocument:function(a){switch(a){case ConfirmDialog.SAVE:this._pendingOperation=this._effectiveCloseDocument.bind(this);this._save(false);break;case ConfirmDialog.CANCEL:break;case ConfirmDialog.DISCARD:default:var b=false;if(!this._description.getId()){b=true}this._description.getCanvasInstances().each(function(c){c.destroy(b,true)}.bind(this));this._description.getConditionInstances().each(function(c){c.destroy(b,true)}.bind(this));GVS.getDocumentController().closeDocument(this._tabId)}},_onClick:function(){this._setSelectedElement()},_deleteInstance:function(a){var b=a.getView().getNode();b.parentNode.removeChild(b);this._setSelectedElement();a.destroy(true);this._setDirty(true);this._refreshReachability()},_addToArea:function(g,b,a,d){var c=b.getView();var f=c.getNode();g.getNode().appendChild(f);f.setStyle({left:a.left+"px",top:a.top+"px",position:"absolute"});if(b.constructor==OperatorInstance){c.updateOrientation(d)}},_save:function(a){var c=Utils.variableOrDefault(a,true);if(c){Utils.showMessage("Saving "+this._typeName)}if(this._description.getId()==null){PersistenceEngine.sendPost(this._getSaveUri(),{buildingblock:Object.toJSON(this._description.toJSON())},null,this,this._onSaveSuccess,this._onSaveError)}else{var b=URIs.buildingblock+this._description.getId();PersistenceEngine.sendUpdate(b,{buildingblock:Object.toJSON(this._description.toJSON())},null,this,this._onSaveSuccess,this._onSaveError)}},_saveAs:function(a){if(this._description.getId()){var b=new SaveAsDialog(this._description.name,this._description.version,this._onSaveAsSuccess.bind(this),a);b.show()}else{this._save()}},_onSaveAsSuccess:function(b,a){this._description.name=b;this._description.label["en-gb"]=b;this._description.version=a;this._description.id=null;this._description.creationDate=null;this._setTitle(this._description.name);this._save()},_onSaveSuccess:function(c){this._setDirty(false);Utils.showMessage("Saved",{hide:true});this._updatePanes();if(this._description.getId()==null){var b=JSON.parse(c.responseText);this._description.addProperties({id:b.id,version:b.version,creationDate:b.creationDate})}if(this._pendingOperation){var a=this._pendingOperation;this._pendingOperation=null;a()}},_onSaveError:function(b){if(!this._pendingOperation){Utils.showMessage("Cannot save "+this._typeName,{hide:true,error:true})}else{var a=this._pendingOperation;this._pendingOperation=null;this._setDirty(false);a()}},_createInstances:function(a,c,b){c.each(function(d){var f=this._canvasCache.getIds(d.uri);f.each(function(k){var i=a.getInstance(d,this._inferenceEngine);i.setId(k);i.setParams(this._canvasCache.getParams(k));var h=this._canvasCache.getPosition(k);i.onFinish(true,h);var j=b.getNode();$("main").appendChild(i.getView().getNode());var g=Geometry.adaptInitialPosition(j,i.getView().getNode(),h);$("main").removeChild(i.getView().getNode());this._drop(b,i,g,this._canvasCache.getOrientation(k),true)}.bind(this))}.bind(this))},_getAreas:function(){throw"Abstract method invocation: PaletteDocument::_getAreas"},_getSets:function(){throw"Abstract method invocation: PaletteDocument::_getSets"},_getDescription:function(a){throw"Abstract method invocation: PaletteDocument::_getDescription"},_getCanvasCache:function(a){throw"Abstract method invocation: PaletteDocument::_getCanvasCache"},_renderCenterContainer:function(){throw"Abstract method invocation. PaletteDocument::_renderCenterContainer"},_updateToolbar:function(a){},_updatePanes:function(){},_getSaveUri:function(){throw"Abstract method invocation. PaletteDocument::_getSaveUri"},_getEmptyPalette:function(){throw"Abstract method invocation. PaletteDocument::_getEmptyPalette"}});var WelcomeDocument=Class.create(AbstractDocument,{initialize:function($super){$super("Welcome!");this._populate()},_populate:function(){var i=this.getNode();i.addClassName("welcome");var c=new Element("img",{src:URIs.logoFast});i.appendChild(c);var f=new Element("div",{"class":"documentTitle"}).update("Welcome to the Gadget Visual Storyboard!");i.appendChild(f);var k=new Element("div",{id:"intro"}).update("Choose your desired action:");i.appendChild(k);var g=new dijit.form.Button({label:"Create a Screenflow from Scratch",onClick:function(){GVS.action("newScreenflow")}});var b=new dijit.form.Button({label:"Browse Screenflows...",onClick:function(){GVS.action("browseScreenflows")}});var a=new dijit.form.Button({label:"Create a Screen from Scratch",onClick:function(){GVS.action("newScreen")}});var d=new dijit.form.Button({label:"Browse Screens...",onClick:function(){GVS.action("browseScreens")}});var j=new dijit.form.Button({label:"Wrap existing services",onClick:function(){GVS.action("wrapperService")}});var h=new Element("div");h.appendChild(new Element("div").update("Screenflows"));h.appendChild(g.domNode);h.appendChild(new Element("br"));h.appendChild(b.domNode);h.appendChild(new Element("div").update("Screens"));h.appendChild(a.domNode);h.appendChild(new Element("br"));h.appendChild(d.domNode);if(!GlobalOptions.isPublicDemo){h.appendChild(new Element("div").update("Building blocks"));h.appendChild(j.domNode)}i.appendChild(h)}});var DocumentController=Class.create({initialize:function(){this._documents=new Hash();this._currentDocument=null;this._welcomeDocument=null;this._registry=new KeyPressRegistry();this._toolbar=new Toolbar();this._menu=new Menu(this._registry);this._documentContainer=dijit.byId("documentContainer");dojo.connect(this._documentContainer,"selectChild",function(a){DocumentController.prototype._selectDocument.apply(this,arguments)}.bind(this));this.showWelcomeDocument();this._registry.addHandler("delete",this._onKeyPressed.bind(this));this._registry.addHandler("space",this._onKeyPressed.bind(this))},createScreenflow:function(c,b,a){var d=new ScreenflowDocument({name:c,tags:b,version:a});this.addDocument(d)},loadScreenflow:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this},this._onScreenflowLoadSuccess,this._onLoadError)},cloneScreenflow:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this,cloned:true},this._onScreenflowLoadSuccess,this._onLoadError)},createScreen:function(d,c,a){var b=new ScreenDocument({name:d,tags:c,version:a});this.addDocument(b)},loadScreen:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this},this._onScreenLoadSuccess,this._onLoadError)},cloneScreen:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this,cloned:true},this._onScreenLoadSuccess,this._onLoadError)},openWrapperService:function(){var a=new ExternalDocument("Wrapper Service",URIs.wrapperService);this.addDocument(a)},showWelcomeDocument:function(){if(this._welcomeDocument){this._documentContainer.selectChild(this._welcomeDocument.getTabId());this._selectDocument(this._welcomeDocument.getTabId())}else{this._welcomeDocument=new WelcomeDocument();this.addDocument(this._welcomeDocument)}},addDocument:function(a){this._documents.set(a.getTabId(),a);this._documentContainer.addChild(a.getTab());if(this._documents.keys().size()>1){this._documentContainer.selectChild(a.getTabId())}},getDocument:function(a){return this._documents.get(a)},getCurrentDocument:function(){return this._currentDocument},closeDocument:function(a){this._documentContainer.back();if(this._welcomeDocument&&this._welcomeDocument.getTabId()==a){this._welcomeDocument=null}this._documentContainer.removeChild(dijit.byId(a));dijit.byId(a).destroyRecursive(true);this._documents.unset(a);if($H(this._documents).keys().length==0){this.showWelcomeDocument()}},getToolbar:function(){return this._toolbar},getMenu:function(){return this._menu},getKeyPressRegistry:function(){return this._registry},_selectDocument:function(a){var b;if(a.id){b=a.id}else{b=a}if(this._currentDocument){this._currentDocument.hide()}this._currentDocument=this._documents.get(b);this._currentDocument.show();this._toolbar.setModel(1,this._currentDocument);this._menu.setModel("document",this._currentDocument);$("logout").focus();$("logout").blur()},_onKeyPressed:function(a){this._currentDocument.onKeyPressed(a)},_onScreenflowLoadSuccess:function(c){var a=JSON.parse(c.responseText);a.cloned=this.cloned;a.uri=null;var b=new ScreenflowDocument(a);this.mine.addDocument(b);b.loadInstances()},_onScreenLoadSuccess:function(c){var b=JSON.parse(c.responseText);b.cloned=this.cloned;b.uri=null;var a=new ScreenDocument(b);this.mine.addDocument(a);a.loadInstances()},_onLoadError:function(){Utils.showMessage("Can not open the selected element",{error:true,hide:true})}});var ScreenflowDocument=Class.create(PaletteDocument,{initialize:function($super,a){this._planPanel=new PlanPanel();$super("Screenflow",a,new ScreenflowInferenceEngine());this._planPanel.setDropZone(this._areas.get("screen"));this._planPanel.setInferenceEngine(this._inferenceEngine);this._builder=new Builder();this._start();this._editMenuAction=new MenuAction({label:"Edit screen",weight:1,enabled:false,handler:function(){this._cloneSelectedElement()}.bind(this)})},loadInstances:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN);a.cacheBuildingBlocks(this._canvasCache.getScreenURIs(),this._onScreenLoaded.bind(this))},positionUpdated:function(c,a){var b;switch(c.constructor){case ScreenInstance:b=this._description.updateScreen(c.getUri(),a);break;case PrePostInstance:b=this._description.updatePrePost(c.getUri(),a);break}if(b){this._setDirty(true)}},getMenuElements:function($super){var a=$super();return Object.extend(a,{edit:{type:"SubMenu",weight:2,label:"Edit",children:{clone:{type:"Action",action:this._editMenuAction,group:0}}}})},_getAreas:function(){var b=new Area("screen",$A([Constants.BuildingBlock.SCREEN]),this._drop.bind(this),{splitter:true,region:"center"});var c=new Area("pre",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"left",minWidth:100});var a=new Area("post",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"right",minWidth:100});b.getNode().parentNode.appendChild(this._planPanel.getNode());return $H({screen:b,pre:c,post:a})},_getSets:function(){var b=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN));var a=new DomainConceptSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT));return[b,a]},_getDescription:function(a){var b;if(a.id){b=Object.clone(a)}else{b={label:{"en-gb":a.name},name:a.name,version:a.version,tags:this._tags,creator:GVS.getUser().getUserName(),description:{"en-gb":"Please fill the description..."},rights:"http://creativecommons.org/",creationDate:null,icon:"http://fast.morfeo-project.eu/icon.png",screenshot:"http://fast.morfeo-project.eu/screenshot.png",homepage:"http://fast.morfeo-project.eu/"}}return new ScreenflowDescription(b)},_getCanvasCache:function(a){return new ScreenflowCanvasCache(a)},_getSaveUri:function(){return URIs.screenflow},_getEmptyPalette:function(){return[]},_drop:function(f,b,a,d){var c=Utils.variableOrDefault(d,false);if(this._description.contains(b.getUri())){Utils.showMessage("There is another element like this. Cannot add it",{hide:true,error:true});return false}if(!b.getId()){b.setId(UIDGenerator.generate(b.getTitle()))}else{if(b.constructor!=PrePostInstance){UIDGenerator.setStartId(b.getId())}}if(b.constructor!=PlanInstance){this._addToArea(f,b,a);b.setEventListener(this);b.enableDragNDrop(f,[f])}switch(b.constructor){case ScreenInstance:this._description.addScreen(b,a);if(!c){this._setSelectedElement(b)}break;case PrePostInstance:b.setChangeHandler(this._onPrePostChange.bind({mine:this,position:a,isLoading:c}));if(f.getNode().className.include("pre")){b.setType("pre")}else{if(f.getNode().className.include("post")){b.setType("post")}}break;case PlanInstance:this._planPanel.hide();this._addPlan(b,a);this._refreshReachability();this._setSelectedElement();break}this._setDirty(true);return true},_deleteInstance:function($super,a){this._description.remove(a.getUri());$super(a)},_findCheckCallback:function(a){var b=this._paletteController.getPalette(Constants.BuildingBlock.SCREEN);var c=b.getBuildingBlockSet();c.addURIs(a)},_configureToolbar:function(){this._addToolbarElement("save",new ToolbarButton("Save the current screenflow","save",this._save.bind(this),false));this._addToolbarElement("properties",new ToolbarButton("Edit screenflow properties","properties",this._propertiesDialog.show.bind(this._propertiesDialog),true));this._addToolbarElement("build",new ToolbarButton("Build Gadget","build",this._buildGadget.bind(this),false));this._addToolbarElement("refresh",new ToolbarButton("Refresh the buildingBlocks catalog","refresh",this._refresh.bind(this),true));this._addToolbarElement("previewElement",new ToolbarButton("Preview selected element","preview",this._previewSelectedElement.bind(this),false));this._addToolbarElement("planner",new ToolbarButton("Create a plan for this screen","planner",this._getPlans.bind(this),false));this._addToolbarElement("cloneElement",new ToolbarButton("Clone selected element","clone",this._cloneSelectedElement.bind(this),false));this._addToolbarElement("deleteElement",new ToolbarButton("Delete selected element","delete",this._startDeletingSelectedElement.bind(this),false))},_refresh:function(){var b=this._getCanvasUris();var a=this._paletteController.getComponentUris(Constants.BuildingBlock.SCREEN);this._inferenceEngine.findCheck(b,a,this._tags,"reachability",this._findCheckCallback.bind(this))},_updateToolbar:function(a){this._toolbarElements.get("deleteElement").setEnabled(a!=null);this._toolbarElements.get("previewElement").setEnabled(a!=null);this._toolbarElements.get("planner").setEnabled(a!=null&&a.constructor==ScreenInstance);var b=(a!=null&&a.constructor==ScreenInstance&&a.getBuildingBlockDescription().definition!=null);this._toolbarElements.get("cloneElement").setEnabled(b);this._editMenuAction.setEnabled(b)},_renderCenterContainer:function(){var a=new dijit.layout.BorderContainer({design:"headline",liveSplitters:"false",region:"center"});this._designContainer.domNode.addClassName("canvas");a.addChild(this._designContainer);a.addChild(this._inspectorArea);return a},_createInspectorArea:function(){var a=new dijit.layout.BorderContainer({region:"bottom",design:"horizontal",style:"height: 180px;",minSize:"100",maxSize:"220",persist:"false",splitter:true});return a},_refreshReachability:function(d){var c=Utils.variableOrDefault(d,false);var b=this._getCanvasUris();var a=this._paletteController.getComponentUris(Constants.BuildingBlock.SCREEN);if(c){this._inferenceEngine.findCheck(b,a,this._tags,"reachability",this._updatePanes.bind(this))}else{this._inferenceEngine.check(b,a,this._tags,"reachability",this._updatePanes.bind(this))}this._toolbarElements.get("build").setEnabled(b.size()>0)},_updatePanes:function(){var d=this._getAllFacts();if(!this._selectedElement){this._propertiesPane.fillTable(this._description);this._factPane.fillTable([],[],d)}else{this._propertiesPane.fillTable(this._selectedElement);if(this._selectedElement.constructor==ScreenInstance){var g=this._inferenceEngine.getPreconditionReachability(this._selectedElement.getUri());var c=this._selectedElement.getPreconditionTable(g);var a=this._inferenceEngine.isReachable(this._selectedElement.getUri());var f=this._selectedElement.getPostconditionTable(a);this._factPane.fillTable(c,f,[])}else{if(this._selectedElement.getType()){var b=[this._selectedElement.getConditionTable(this._inferenceEngine.isReachable(this._selectedElement.getUri()))];this._factPane.fillTable([],[],b)}}}},_getAllFacts:function(){var a=new Hash();this._description.getCanvasInstances().each(function(b){if(b.constructor==ScreenInstance){var h=this._inferenceEngine.getPreconditionReachability(b.getUri());var f=b.getPreconditionTable(h);f.each(function(i){if(!a.get(i[2])){a.set(i[2],i)}});var c=this._inferenceEngine.isReachable(b.getUri());var g=b.getPostconditionTable(c);g.each(function(i){if(!a.get(i[2])){a.set(i[2],i)}})}else{var d=b.getConditionTable(this._inferenceEngine.isReachable(b.getUri()));if(!a.get(d[2])){a.set(d[2],d)}}}.bind(this));return a.values()},_buildGadget:function(){if(this._isDirty){this._pendingOperation=this._buildGadget.bind(this);this._save(false)}else{this._builder.buildGadget(this._description)}},_onPrePostChange:function(a){this.mine._description.addPrePost(a,this.position);if(!this.isLoading){this.mine._refreshReachability();this.mine._setSelectedElement(a);this.mine._setDirty(true)}},_getPlans:function(){if(!this._planPanel.isVisible()){var a=this._getCanvasUris();var b=this._selectedElement.getUri();this._inferenceEngine.getPlans(a,b,this._onSuccessGetPlans.bind(this))}else{this._planPanel.hide()}},_onSuccessGetPlans:function(a){if(a.length>0&&a[0].length>0){this._planPanel.showPlans(a)}else{alert("Sorry, but there is not any available plan for the selected screen")}},_addPlan:function(c,a){var b={left:a.left+3,top:a.top+3};c.getPlanElements().each(function(f){if(!this._description.contains(f.uri)){var d=new ScreenInstance(f,this._inferenceEngine);this._description.addScreen(d,b);d.onFinish(true);this._addToArea(this._areas.get("screen"),d,b);b.left+=108;d.setEventListener(this);d.enableDragNDrop(this._areas.get("screen"),[this._areas.get("screen")])}}.bind(this))},_onScreenLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN);var a=b.getBuildingBlocks(this._canvasCache.getScreenURIs());this._createInstances(b,a,this._areas.get("screen"));this._loadConditions()},_createConditions:function(b,a){b.each(function(h){var g=new PrePostDescription(h);var d=new PrePostInstance(g,this._inferenceEngine);d.onFinish(true,h.position);var f=a.getNode();$("main").appendChild(d.getView().getNode());var c=Geometry.adaptInitialPosition(f,d.getView().getNode(),h.position);$("main").removeChild(d.getView().getNode());this._drop(a,d,c,true);this._description.addPrePost(d,c)}.bind(this))},_loadConditions:function(){this._createConditions(this._canvasCache.getPreconditions(),this._areas.get("pre"));this._createConditions(this._canvasCache.getPostconditions(),this._areas.get("post"));this._setDirty(false);this._refreshReachability();if(this._description.cloned){this._saveAs(true)}},_cloneSelectedElement:function(){var a=this._selectedElement.getBuildingBlockDescription();if(a.definition){GVS.getDocumentController().cloneScreen(a.id)}}});var ScreenDocument=Class.create(PaletteDocument,{initialize:function($super,a){this._formInstance=null;this._pipeFactory=new PipeFactory();this._triggerMappingFactory=new TriggerMappingFactory();this._dojoConnections=new Array();this._recommendationManager=new RecommendationManager();this._closed=false;this._repaint=this._repaint.bind(this);$super("Screen",a,new ScreenInferenceEngine());this._start()},show:function(){this._pipeFactory.showPipes()},hide:function(){this._pipeFactory.hidePipes()},loadInstances:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM);a.cacheBuildingBlocks(this._canvasCache.getFormURI(),this._onFormLoaded.bind(this));var c=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR);c.cacheBuildingBlocks(this._canvasCache.getOperatorURIs(),this._onOperatorsLoaded.bind(this));var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE);b.cacheBuildingBlocks(this._canvasCache.getResourceURIs(),this._onResourcesLoaded.bind(this))},modified:function(a){this._updatePanes();this._setDirty(true)},positionUpdated:function(d,a,c){var b;switch(d.constructor){case PrePostInstance:b=this._description.updatePrePost(d,a);break;default:b=this._description.updateBuildingBlock(d,a,c);break}if(b){this._setDirty(true)}},_getAreas:function(){var c=new Area("form",$A([Constants.BuildingBlock.FORM]),this._drop.bind(this),{splitter:true,region:"top",minHeight:150});var d=new Area("operator",$A([Constants.BuildingBlock.OPERATOR]),this._drop.bind(this),{splitter:true,region:"center",minHeight:350,minWidth:200});var b=new Area("resource",$A([Constants.BuildingBlock.RESOURCE]),this._drop.bind(this),{splitter:true,region:"bottom",minHeight:100});var f=new Area("pre",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"left",minWidth:100});var a=new Area("post",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"right",minWidth:100});return $H({form:c,operator:d,resource:b,pre:f,post:a})},_getSets:function(){var b=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM));var c=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR));var d=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE));var a=new DomainConceptSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT));return[b,c,d,a]},_getDescription:function(a){var b;if(a.id){b=Object.clone(a);b.definition=null;b.precondition=null;b.postconditions=null}else{b={label:{"en-gb":a.name},name:a.name,version:a.version,tags:this._tags,creator:GVS.getUser().getUserName(),description:{"en-gb":"Please fill the description..."},rights:"http://creativecommons.org/",creationDate:null,icon:"http://fast.morfeo-project.eu/icon.png",screenshot:"http://fast.morfeo-project.eu/screenshot.png",homepage:"http://fast.morfeo-project.eu/"}}return new ScreenDescription(b)},_getCanvasCache:function(a){return new ScreenCanvasCache(a)},_getSaveUri:function(){return URIs.screen},_getEmptyPalette:function(){return{forms:[],operators:[],backendservices:[],preconditions:[],postconditions:[],pipes:[]}},_effectiveCloseDocument:function($super,a){if(!a||a==ConfirmDialog.DISCARD){this._closed=true}$super(a);if(!a||a==ConfirmDialog.DISCARD){this._dojoConnections.each(function(b){dojo.disconnect(b)}.bind(this));this._dojoConnections=null;this._repaint=null}},_drop:function(b,n,j,c,l){var k=Utils.variableOrDefault(l,false);if(n.constructor!=OperatorInstance&&this._description.contains(n.getUri())){Utils.showMessage("There is another element like this. Cannot add it",{hide:true,error:true});return false}if(n.constructor==FormInstance){if(this._formInstance){Utils.showMessage("Only one form per screen is allowed",{hide:true,error:true});return false}else{this._formInstance=n;this._description.icon=n.getBuildingBlockDescription().icon;this._description.screenshot=n.getBuildingBlockDescription().screenshot}}this._addToArea(b,n,j,c);if(!n.getId()){n.setId(UIDGenerator.generate(n.getTitle()))}else{UIDGenerator.setStartId(n.getId())}var d={onPipeCreationStart:this._onPipeCreationStartHandler.bind(this),onPipeCreationCancel:this._onPipeCreationCancelHandler.bind(this),onPipeCreation:this._onPipeCreationHandler.bind(this),onPipeDeletion:this._onPipeDeletionHandler.bind(this)};if(n.constructor!=PrePostInstance){n.createTerminals(d);this._description.addBuildingBlock(n,j,c)}else{n.setConfigurable(false);if(b.getNode().className.include("pre")){n.setType("pre");n.createTerminal(d);this._description.addPre(n,j);n.getView().setReachability({satisfied:true})}else{if(b.getNode().className.include("post")){n.setType("post");n.createTerminal(d);this._description.addPost(n,j)}}}if(!k){var o=null;switch(n.constructor){case FormInstance:var p=false;var g=n.getBuildingBlockDescription().actions;for(var h=0;h<g.length;h++){if(g[h].name=="init"){p=true;break}}if(p){o="init"}break;case ResourceInstance:var g=n.getBuildingBlockDescription().actions;if(g.length>0){o=g[0].name}break}if(o){var a={from:{instance:ScreenTrigger.INSTANCE_NAME,name:ScreenTrigger.ONLOAD},to:{instance:n,action:o}};var f=this._triggerMappingFactory.createTrigger(a);this._description.addTrigger(f)}this._setSelectedElement(n)}n.setEventListener(this);n.enableDragNDrop(b,[b]);n.getView().addGhost();this._setDirty(true);return true},_onPipeCreationStartHandler:function(c,b){var a=b.getInstance();var d;if(a instanceof FormInstance){d="form_"+a.getId()+(b.getActionId()?"_"+b.getActionId():"")+"_"+b.getConditionId()}else{if(a instanceof PrePostInstance){d=a.getType()+"_"+a.getId()}else{if(a instanceof ResourceInstance){d="service_"+a.getId()+"_"+b.getActionId()+"_"+b.getConditionId()}else{if(a instanceof OperatorInstance){d="operator_"+a.getId()+"_"+b.getActionId()+"_"+b.getConditionId()}}}}if(this._selectedElement!=a){this._setSelectedElement(a)}this._recommendationManager.setStartFact(d)},_onPipeCreationCancelHandler:function(a){this._recommendationManager.setStartFact(null)},_onPipeDeletionHandler:function(b){if(this._closed){return}var a=this._pipeFactory.getPipe(b);if(a){this._pipeFactory.removePipe(a);this._description.remove(a);this._refreshReachability();this._setDirty(true)}},_onPipeCreationHandler:function(b){var a=this._pipeFactory.getPipe(b);if(a){this._description.addPipe(a);this._refreshReachability();this._setDirty(true)}},_setSelectedElement:function($super,a){if(a==null){this._recommendationManager.clear()}$super(a)},_deleteInstance:function($super,a){if(a.constructor==FormInstance){this._formInstance=null}this._description.remove(a);this._pipeFactory.getPipes(a).each(function(b){this._pipeFactory.removePipe(b);this._description.remove(b)}.bind(this));this._triggerMappingFactory.getRelatedTriggers(a).each(function(b){this._triggerMappingFactory.removeTrigger(b);this._description.remove(b)}.bind(this));$super(a)},_findCheckCallback:function(a){$H(a).each(function(c){var b=this._paletteController.getPalette(Constants.CatalogueRelationships[c.key]);if(b){var d=b.getBuildingBlockSet();d.addURIs(c.value)}}.bind(this))},_configureToolbar:function(){this._addToolbarElement("save",new ToolbarButton("Save the current screen","save",this._save.bind(this),false));this._addToolbarElement("properties",new ToolbarButton("Edit screen properties","properties",this._propertiesDialog.show.bind(this._propertiesDialog),true));this._addToolbarElement("share",new ToolbarButton("Share the current screen with the community","share",this._share.bind(this),true));this._addToolbarElement("refresh",new ToolbarButton("Refresh the buildingBlocks catalog","refresh",this._refresh.bind(this),true));this._addToolbarElement("deleteElement",new ToolbarButton("Delete selected element","delete",this._startDeletingSelectedElement.bind(this),false));this._addToolbarElement("rotate",new ToolbarButton("Rotate selected element","rotate",this._rotateSelectedElement.bind(this),false))},_refresh:function(){var a={forms:this._paletteController.getComponentUris(Constants.BuildingBlock.FORM),operators:this._paletteController.getComponentUris(Constants.BuildingBlock.OPERATOR),backendservices:this._paletteController.getComponentUris(Constants.BuildingBlock.RESOURCE),pipes:this._description.getPipes(),preconditions:this._description.getPreconditions(),postconditions:this._description.getPostconditions()};this._inferenceEngine.findCheck([],a,this._tags,"reachability",this._findCheckCallback.bind(this))},_updateToolbar:function(a){this._toolbarElements.get("deleteElement").setEnabled(a!=null);if(a!=null){var b=a.getBuildingBlockDescription();this._toolbarElements.get("rotate").setEnabled(b.type==Constants.BuildingBlock.OPERATOR)}},_renderCenterContainer:function(){var c=new dijit.layout.BorderContainer({design:"headline",liveSplitters:"false",region:"center"});var b=c.getSplitter("left");this._dojoConnections.push(dojo.connect(b,"onmousemove",this._repaint));var d=c.getSplitter("bottom");this._dojoConnections.push(dojo.connect(d,"onmousemove",this._repaint));this._designContainer.domNode.addClassName("canvas");b=this._designContainer.getSplitter("left");this._dojoConnections.push(dojo.connect(b,"onmousemove",this._repaint));d=this._designContainer.getSplitter("bottom");this._dojoConnections.push(dojo.connect(d,"onmousemove",this._repaint));var f=this._designContainer.getSplitter("right");this._dojoConnections.push(dojo.connect(f,"onmousemove",this._repaint));var a=this._designContainer.getSplitter("top");this._dojoConnections.push(dojo.connect(a,"onmousemove",this._repaint));c.addChild(this._designContainer);c.addChild(this._inspectorArea);return c},_repaint:function(){this._description.getCanvasInstances().each(function(a){a.onUpdate()});this._description.getConditionInstances().each(function(a){a.onUpdate()})},_refreshReachability:function(d){var c=Utils.variableOrDefault(d,true);this._recommendationManager.clear();var b=this._getCanvasUris();var a={forms:this._paletteController.getComponentUris(Constants.BuildingBlock.FORM),operators:this._paletteController.getComponentUris(Constants.BuildingBlock.OPERATOR),backendservices:this._paletteController.getComponentUris(Constants.BuildingBlock.RESOURCE),pipes:this._description.getPipes(),preconditions:this._description.getPreconditions(),postconditions:this._description.getPostconditions()};if(this._selectedElement&&this._selectedElement.getUri()){a.selectedItem=this._selectedElement.getUri()}else{if(this._selectedElement){a.selectedItem=this._selectedElement.getId()}}if(c){this._inferenceEngine.findCheck(b,a,this._tags,"reachability",this._onUpdateReachability.bind(this))}else{this._inferenceEngine.check(b,a,this._tags,"reachability",this._onUpdateReachability.bind(this))}},_parseConnectionElement:function(b,h){if(b.buildingblock==null){var d;var j;if(h){d="pre";j=this._description.getPre(b.condition)}else{d="post";j=this._description.getPost(b.condition)}return{instance:j,node:j.getView().getNode(),key:d+"_"+b.condition}}else{var g=this._description.getInstanceByUri(b.buildingblock);if(b.buildingblock.search("/forms/")!=-1){var i="form_"+g.getId()+(b.action?"_"+b.action:"")+"_"+b.condition;return{instance:g,node:g.getView().getConditionNode(b.condition,b.action),key:i}}else{if(b.buildingblock.search("/services/")!=-1){var f=g.getView();var c;if(h){c="postconditions"}else{c=f._icons.keys()[0]}var a=f.getConditionNode(b.condition,c);return{instance:g,node:a,key:"service_"+g.getId()+"_"+c+"_"+b.condition}}else{if(b.buildingblock.search("/operators/")!=-1){return{instance:g,node:g.getView().getConditionNode(b.condition,b.action),key:"operator_"+g.getId()+"_"+b.action+"_"+b.condition}}else{throw"unknowk building block at ScreenDocument::_parseConnectionElement"}}}}},_onUpdateReachability:function(a){if(a.postconditions){a.postconditions.each(function(c){var d=this._description.getPost(c.id);var b=d.getView();if(b){b.setReachability(c)}}.bind(this))}if(a.pipes){a.pipes.each(function(d){var g,b;if(d.from.buildingblock){var c=this._description.getInstancesByUri(d.from.buildingblock);origins=c.map(function(h){return h.getTerminal(d.from.condition,"postconditions")})}else{origins=[this._description.getPre(d.from.condition).getTerminal()]}if(d.to.buildingblock){var f=this._description.getInstancesByUri(d.to.buildingblock);b=f.map(function(h){return h.getTerminal(d.to.condition,d.to.action)})}else{b=[this._description.getPost(d.to.condition).getTerminal()]}origins.each(function(h){b.each(function(j){var i=this._pipeFactory.getPipeFromTerminals(h,j);if(i){i.setReachability(d)}}.bind(this))}.bind(this))}.bind(this))}if(a.connections){a.connections.each(function(b){var h,g,d,c;try{h=this._parseConnectionElement(b.from,true);g=this._parseConnectionElement(b.to,false)}catch(f){return}if(h.instance==this._selectedElement){d=h;c=g}else{if(g.instance==this._selectedElement){d=g;c=h}else{return}}this._recommendationManager.addRecommendation(d,c)}.bind(this));this._recommendationManager.startAnimation()}this._updatePanes()},_updatePanes:function(){if(!this._selectedElement){this._propertiesPane.fillTable(this._description);var f=this._getAllFacts();this._factPane.fillTable([],[],f)}else{this._propertiesPane.fillTable(this._selectedElement);if(this._selectedElement.constructor!=PrePostInstance){var a=this._getInstanceActions();this._propertiesPane.addSection(["Action","Triggers"],a);var h=this._inferenceEngine.getPreconditionReachability(this._selectedElement.getUri());var d=this._selectedElement.getPreconditionTable(h);var b=this._inferenceEngine.isReachable(this._selectedElement.getUri());var g=this._selectedElement.getPostconditionTable(b);this._factPane.fillTable(d,g,[])}else{if(this._selectedElement.getType()){var c=[this._selectedElement.getConditionTable()];this._factPane.fillTable([],[],c)}}}},_getInstanceActions:function(){var b=this._triggerMappingFactory.getTriggerList(this._selectedElement);var a=new Hash();var c=this._selectedElement.getBuildingBlockDescription().actions;c.each(function(d){a.set(d.name,this._buildTriggerList(d.name,b.get(d.name)))}.bind(this));return a},_buildTriggerList:function(b,c){var a=new Element("div");var d="";if(c){c.each(function(g){d+=g.getTriggerName()+", "});d=d.slice(0,-2)}else{d=new Element("span",{"class":"triggerInfo"}).update("No triggers for this action")}a.update(d);var f=new TriggerDialog(b,c,this._description.getCanvasInstances(),this._onTriggerChange.bind(this));a.appendChild(f.getButtonNode());return a},_onTriggerChange:function(c,b,a){b.each(function(h){var i=h.split("#");var d;if(i[0]==ScreenTrigger.INSTANCE_NAME){d=i[0]}else{d=this._description.getInstance(i[0])}var g={from:{instance:d,name:i[1]},to:{instance:this._selectedElement,action:c}};var f=this._triggerMappingFactory.createTrigger(g);this._description.addTrigger(f)}.bind(this));a.each(function(h){var i=h.split("#");var d;if(i[0]==ScreenTrigger.INSTANCE_NAME){d=i[0]}else{d=this._description.getInstance(i[0])}var g={from:{instance:d,name:i[1]},to:{instance:this._selectedElement,action:c}};var f=this._triggerMappingFactory.removeTrigger(g);this._description.remove(f)}.bind(this));this._updatePanes();this._setDirty(true)},_share:function(){if(this._description.isValid()){if(this._isDirty){this._pendingOperation=this._share.bind(this);this._save(false)}else{var b=new Element("div",{style:"text-align:center; width: 30em; margin: 0 auto;"}).update("You are about to share the screen. After that, you will not be able to edit the screen anymore. You can either close the screen or create a clone (Save with another name/version)");var a=new ConfirmDialog("Warning",ConfirmDialog.CUSTOM,{callback:this._onShareDialogEvent.bind(this),contents:b,buttons:{clone:"Share and create a clone",close:"Share and close",cancel:"Cancel"},style:"width: "});a.show()}}else{this._propertiesDialog.show(this._share.bind(this))}},_onShareDialogEvent:function(a){if(a!="cancel"){var b=URIs.share.replace("<id>",this._description.getId());PersistenceEngine.sendPost(b,null,null,{mine:this,status:a},this._onShareSuccess,Utils.onAJAXError)}},_onShareSuccess:function(a){Utils.showMessage("Screen successfully shared",{hide:true});switch(this.status){case"clone":this.mine._saveAs(true);break;case"close":this.mine._effectiveCloseDocument(ConfirmDialog.DISCARD);break}},_onFormLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM);var a=b.getBuildingBlocks(this._canvasCache.getFormURI());this._createInstances(b,a,this._areas.get("form"));this._canvasCache.setLoaded(Constants.BuildingBlock.FORM);this._loadConnections()},_onOperatorsLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR);var a=b.getBuildingBlocks(this._canvasCache.getOperatorURIs());this._createInstances(b,a,this._areas.get("operator"));this._canvasCache.setLoaded(Constants.BuildingBlock.OPERATOR);this._loadConnections()},_onResourcesLoaded:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE);var b=a.getBuildingBlocks(this._canvasCache.getResourceURIs());this._createInstances(a,b,this._areas.get("resource"));this._canvasCache.setLoaded(Constants.BuildingBlock.RESOURCE);this._loadConnections()},_createConditions:function(b,a){b.each(function(h){var g=new PrePostDescription(h);var d=new PrePostInstance(g,this._inferenceEngine,false);d.setId(h.id);d.onFinish(true,h.position);var f=a.getNode();$("main").appendChild(d.getView().getNode());var c=Geometry.adaptInitialPosition(f,d.getView().getNode(),h.position);$("main").removeChild(d.getView().getNode());this._drop(a,d,c,true)}.bind(this))},_createPipes:function(a){a.each(function(f){var c;var g;if(f.from.buildingblock!=""){c=this._description.getInstance(f.from.buildingblock);g=c.getTerminal(f.from.condition)}else{c=this._description.getPre(f.from.condition);if(!c){c=this._description.getPost(f.from.condition)}g=c.getTerminal()}var h;var b;if(f.to.buildingblock!=""){h=this._description.getInstance(f.to.buildingblock);b=h.getTerminal(f.to.condition,f.to.action)}else{h=this._description.getPre(f.to.condition);if(!h){h=this._description.getPost(f.to.condition)}b=h.getTerminal()}var d=this._pipeFactory.getPipe(g,b);this._description.addPipe(d)}.bind(this))},_createTriggers:function(a){a.each(function(g){var c=null;if(g.from.buildingblock!=""){c=this._description.getInstance(g.from.buildingblock)}var f=this._description.getInstance(g.to.buildingblock);var d={from:{instance:c?c:ScreenTrigger.INSTANCE_NAME,name:c?g.from.name:ScreenTrigger.ONLOAD},to:{instance:f,action:g.to.action}};var b=this._triggerMappingFactory.createTrigger(d);this._description.addTrigger(b)}.bind(this))},_loadConnections:function(){if(this._canvasCache.areInstancesLoaded()){this._createConditions(this._canvasCache.getPreconditions(),this._areas.get("pre"));this._createConditions(this._canvasCache.getPostconditions(),this._areas.get("post"));this._createPipes(this._canvasCache.getPipes());this._createTriggers(this._canvasCache.getTriggers());this._setDirty(false);this._refreshReachability();if(this._description.cloned){this._saveAs(true)}}}});var ScreenCanvasCache=Class.create({initialize:function(a){this._buildingblocks=a.definition.buildingblocks;this._pipes=a.definition.pipes;this._triggers=a.definition.triggers;this._preconditions=a.preconditions[0]?a.preconditions[0]:new Array();this._postconditions=a.postconditions[0]?a.postconditions[0]:new Array();this._elementsLoaded=new Array()},getFormURI:function(){var a=this._buildingblocks.detect(function(b){return(b.uri.search(/forms/i)!=-1)});if(a){return[a.uri]}else{return[]}},getOperatorURIs:function(){var b=this._buildingblocks.findAll(function(c){return(c.uri.search(/operators/i)!=-1)});var a=new Array();b.each(function(c){if(a.indexOf(c.uri)==-1){a.push(c.uri)}});return a},getResourceURIs:function(){var b=this._buildingblocks.findAll(function(c){return(c.uri.search(/services/i)!=-1)});var a=new Array();b.each(function(c){if(a.indexOf(c.uri)==-1){a.push(c.uri)}});return a},getPreconditions:function(){return this._preconditions},getPostconditions:function(){return this._postconditions},getPipes:function(){return this._pipes},getTriggers:function(){return this._triggers},getIds:function(a){var b=this._buildingblocks.findAll(function(c){return c.uri==a});if(b){return b.collect(function(c){return c.id})}else{return null}},getParams:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.parameter}else{return null}},getPosition:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.position}else{return null}},getOrientation:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.orientation}else{return null}},setLoaded:function(a){this._elementsLoaded.push(a)},areInstancesLoaded:function(){var a=(this._elementsLoaded.indexOf(Constants.BuildingBlock.RESOURCE)!=-1);a=a&&(this._elementsLoaded.indexOf(Constants.BuildingBlock.OPERATOR)!=-1);a=a&&(this._elementsLoaded.indexOf(Constants.BuildingBlock.FORM)!=-1);return a}});var ScreenflowCanvasCache=Class.create({initialize:function(a){this._screens=a.definition.screens?a.definition.screens:new Array();this._preconditions=a.definition.preconditions?a.definition.preconditions:new Array();this._postconditions=a.definition.postconditions?a.definition.postconditions:new Array();this._elementsLoaded=new Array()},getScreenURIs:function(){var a=new Array();this._screens.each(function(b){a.push(b.uri)});return a},getPreconditions:function(){return this._preconditions},getPostconditions:function(){return this._postconditions},getIds:function(a){var b=this._screens.findAll(function(c){return c.uri==a});if(b){return b.collect(function(c){return c.uri})}else{return null}},getParams:function(a){return""},getPosition:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.position}else{return null}},setLoaded:function(a){this._elementsLoaded.push(a)},areInstancesLoaded:function(){return this._elementsLoaded.indexOf(Constants.BuildingBlock.SCREEN)!=-1}});var Fact=Class.create({initialize:function(c,a,b){this._uri=c;this._shortcut=a;this._description=b},getUri:function(){return this._uri},getShortcut:function(){return this._shortcut},getDescription:function(){return this._description}});var FactFactory=Class.create();Object.extend(FactFactory,{_cachedFacts:new Hash(),_cachedShortcuts:new Array()});Object.extend(FactFactory,{getFactIcon:function(b,c){var a=this._getFact(b);return new FactIcon(a,c)},getFactUri:function(a){var b;if(a.uri){b=a.uri}else{if(a.pattern){b=Utils.extractURIfromPattern(a.pattern)}else{b="http://unknown.uri#?"}}return b},_getFact:function(a){var b=this.getFactUri(a);if(this._cachedFacts.get(b)==null){this._cachedFacts.set(b,new Fact(b,this._extractShortcut(b),this._extractDescription(a)))}return this._cachedFacts.get(b)},_extractShortcut:function(d){var c=d.split("#");var b="";if(c.length>1){b=c[1]}else{c=d.split("/");b=c[c.length-1]}b=b.substr(0,1).toUpperCase()+b.substr(1);var f=b.match(/[A-Z]/g);if(f&&f.length>1){a=f.slice(0,2).join("");if(this._cachedShortcuts.indexOf(a)==-1){this._cachedShortcuts.push(a);return a}}b[1]=b[1].toLowerCase();var a=b.slice(0,2);if(this._cachedShortcuts.indexOf(a)==-1){this._cachedShortcuts.push(a);return a}a=b.slice(0,1);return a},_extractDescription:function(b){if(b.label&&b.label["en-gb"]){return b.label["en-gb"]}var c=b["http://www.w3.org/2000/01/rdf-schema#comment"];if(c){return c.replace("@en","")}var a=b["http://www.w3.org/2000/01/rdf-schema#label"];if(a){return a.replace("@en","")}}});var FactIcon=Class.create({initialize:function(b,c){this._fact=b;this._size=c;this._node=new Element("div",{"class":this._size+"_fact fact",title:this._fact.getDescription()});var a=new Element("div",{"class":"contentLayer"});this._node.appendChild(a);a.update(this._fact.getShortcut());var d=new Element("div",{"class":"recommendationLayer"});this._node.appendChild(d)},getNode:function(){return this._node},getFact:function(){return this._fact}});var ComponentInstance=Class.create(DragSource,{initialize:function($super,b,a){$super();this._buildingBlockDescription=b;this._id=null;this._orientation=0;this._view=this._createView();this._params="{}";this._inferenceEngine=a;this._listener=null;if(this.getUri()){this._inferenceEngine.addReachabilityListener(this.getUri(),this._view)}},getTitle:function(){throw"Abstract method invocation. ComponentInstance::getTitle"},getInfo:function(){var c=new Hash();c.set("Title",this.getTitle());c.set("Description",this._buildingBlockDescription.description["en-gb"]);c.set("Tags",this._buildingBlockDescription.tags.collect(function(i){return i.label["en-gb"]}).join(", "));var d=document.createElement("div");var j=this.getParams();var a=j.strip().length>0;if(a){try{var k=k=cjson_parse(j);a=false;for(var f in k){d.addClassName("json-icon-bg");a=true;break}}catch(g){d.addClassName("text-icon-bg")}}if(!a){var h=document.createElement("span");h.addClassName("triggerInfo");h.appendChild(document.createTextNode("No parameterized"));d.appendChild(h)}var b=new ParamsDialog(this.getTitle(),this.getParams(),this._buildingBlockDescription.parameterTemplate,this.setParams.bind(this));d.appendChild(b.getButtonNode());c.set("Parameters",d);return c},setEventListener:function(a){this._listener=a},getUri:function(){return this._buildingBlockDescription.uri},getHandlerNode:function(){return this._view.getNode()},getDraggableObject:function(){return this},getView:function(){return this._view},getPosition:function(){var c=parseInt(this.getHandlerNode().offsetLeft)-parseInt(this.getHandlerNode().getStyle("margin-left"));var b=parseInt(this.getHandlerNode().offsetTop)-parseInt(this.getHandlerNode().getStyle("margin-top"));var a={left:c,top:b};return a},getOrientation:function(){return this._orientation},setPosition:function(a){this.getHandlerNode().style.left=a.left+"px";this.getHandlerNode().style.top=a.top+"px"},setOrientation:function(a){this._orientation=a},getParams:function(){return this._params},setParams:function(a){this._params=a;if(this._listener&&this._listener.modified){this._listener.modified(this)}},getBuildingBlockDescription:function(){return this._buildingBlockDescription},getBuildingBlockType:function(){return this._buildingBlockType},getId:function(){return this._id},setId:function(a){this._id=a},destroy:function(){this._inferenceEngine.removeReachabilityListener(this._buildingBlockDescription.uri,this._view);this._view.destroy();this._view=null},onUpdate:function(a,b){},onFinish:function(b,a){if(b){this._view.addEventListener(function(c){c.stop()}.bind(this),"click");this._view.addEventListener(function(c){c.stop();this._onDoubleClick(c)}.bind(this),"dblclick")}else{this._onClick();if(this._listener){this._listener.positionUpdated(this,a)}}this.onUpdate()},onScroll:function(){this.onUpdate()},getPreconditionTable:function(a){return new Array()},getPostconditionTable:function(a){return this._getConditionList("postconditions",a)},_createView:function(){throw"Abstract Method invocation: ComponentInstance::_createView"},_onClick:function(){if(this._listener){this._listener.elementClicked(this)}},_onDoubleClick:function(a){if(this._listener){this._listener.elementDblClicked(this,a)}},_getConditionList:function(c,b){if(c!="actions"&&this._buildingBlockDescription[c].length>1){console.log("OR support not implemented yet");return null}else{var a=new Array();if(c!="actions"){var d=this._buildingBlockDescription[c][0];$A(d).each(function(g){a.push(this._getConditionItem(g,b))}.bind(this))}else{var f=this._buildingBlockDescription.actions;$A(f).each(function(g){$A(g.preconditions).each(function(h){a.push(this._getConditionItem(h,b))}.bind(this))}.bind(this))}return a}},_getConditionItem:function(f,b){var d=FactFactory.getFactUri(f);var a=FactFactory.getFactIcon(f,"embedded").getNode();if(b.constructor==Hash){Utils.setSatisfeabilityClass(a,b.get(d))}else{Utils.setSatisfeabilityClass(a,b)}if(f.positive===false){a.addClassName("negative")}var c=f.label["en-gb"];return[a,c,d]}});var ScreenflowInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._dialog=null},getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},getInfo:function(){var a=new Hash();a.set("Title",this._buildingBlockDescription.label["en-gb"]);a.set("Description",this._buildingBlockDescription.description["en-gb"]);a.set("Tags",this._buildingBlockDescription.tags.collect(function(b){return b.label["en-gb"]}).join(", "));return a},showPreviewDialog:function(){if(!this._dialog){this._dialog=new PreviewDialog(this.getTitle(),this._buildingBlockDescription.getPreview())}this._dialog.show()},getPreconditionTable:function(a){return this._getConditionList("preconditions",a)},_createView:function(){return null},_onDoubleClick:function(a){this.showPreviewDialog()}});var ScreenInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._dialog=null},getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},getInfo:function(){var a=new Hash();a.set("Title",this._buildingBlockDescription.label["en-gb"]);a.set("Description",this._buildingBlockDescription.description["en-gb"]);a.set("Tags",this._buildingBlockDescription.tags.collect(function(b){return b.label["en-gb"]}).join(", "));return a},showPreviewDialog:function(){if(!this._dialog){this._dialog=new PreviewDialog(this.getTitle(),this._buildingBlockDescription.getPreview())}this._dialog.show()},getPreconditionTable:function(a){return this._getConditionList("preconditions",a)},_createView:function(){return new ScreenView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()}});var PrePostInstance=Class.create(ComponentInstance,{initialize:function($super,c,b,a){$super(c.clone(),b);if(!this._buildingBlockDescription.pattern){this._buildingBlockDescription.pattern="?x http://www.w3.org/1999/02/22-rdf-syntax-ns#type "+this._buildingBlockDescription.uri}if(!this._buildingBlockDescription.label){this._buildingBlockDescription.label={"en-gb":this._buildingBlockDescription.title}}if(this._buildingBlockDescription.id){this._id=this._buildingBlockDescription.id}this._dialog=null;this._changeHandler=null;this._terminal=null;this._isConfigurable=Utils.variableOrDefault(a,true)},getTitle:function(){return this._buildingBlockDescription.getTitle()},getInfo:function(){var a=new Hash();a.set("Title",this.getTitle());a.set("Uri",this._buildingBlockDescription.uri);a.set("Type",this.getType());if(this._buildingBlockDescription.properties){a.set("EzWeb Binding",this._buildingBlockDescription.properties.ezweb.binding);a.set("Friendcode",this._buildingBlockDescription.properties.ezweb.friendcode);a.set("Variable Name",this._buildingBlockDescription.properties.ezweb.variableName)}return a},getType:function(){return this._buildingBlockDescription.type},toJSONForScreen:function(){return{label:this._buildingBlockDescription.label,pattern:this._buildingBlockDescription.pattern,positive:true,uri:this._buildingBlockDescription.uri,id:this.getId(),type:this._buildingBlockDescription.type}},toJSONForScreenflow:function(){return{conditions:[this._getCondition()],id:this.getId(),catalogueUri:this._buildingBlockDescription.catalogueUri,semantics:this._buildingBlockDescription.uri,binding:this._buildingBlockDescription.properties.ezweb.binding,friendcode:this._buildingBlockDescription.properties.ezweb.friendcode,variableName:this._buildingBlockDescription.properties.ezweb.variableName,label:this.getTitle(),type:this._buildingBlockDescription.type,uri:this._buildingBlockDescription.uri}},getUri:function(){return this._buildingBlockDescription.catalogueUri},setType:function(a){this._buildingBlockDescription.type=a;if(this._isConfigurable){var b={label:this.getTitle()};if(this._buildingBlockDescription.properties){b=Object.extend(b,this._buildingBlockDescription.properties.ezweb)}else{if(this._buildingBlockDescription.binding){b=Object.extend(b,{binding:this._buildingBlockDescription.binding,variableName:this._buildingBlockDescription.variableName,friendcode:this._buildingBlockDescription.friendcode})}else{b=Object.extend(b,{binding:this._buildingBlockDescription.type=="pre"?"slot":"event",variableName:this.getTitle().replace(" ",""),friendcode:this.getTitle().replace(" ","")})}}this._onChange(b)}else{this._onClick()}},setConfigurable:function(a){this._isConfigurable=a},setChangeHandler:function(a){this._changeHandler=a},showPreviewDialog:function(){if(this._isConfigurable){if(!this._dialog){this._dialog=new PrePostDialog(this._onChange.bind(this),this.getTitle(),this._buildingBlockDescription.type)}this._dialog.show()}},getConditionTable:function(b){var a=FactFactory.getFactIcon(this._getCondition(),"embedded").getNode();var c;if(b!==undefined){c=b}else{c=this._view.getNode().hasClassName("satisfeable")}Utils.setSatisfeabilityClass(a,c);return[a,this.getTitle(),this._buildingBlockDescription.uri]},createTerminal:function(a){var b={direction:[],offsetPosition:{},wireConfig:{drawingMethod:"arrows"}};if(this._buildingBlockDescription.type=="pre"){b.alwaysSrc=true;b.direction=[1,0];b.offsetPosition={top:2,left:15};b.ddConfig={type:"output",allowedTypes:["input"]}}else{b.direction=[-1,0];b.offsetPosition={top:2,left:-8};b.ddConfig={type:"input",allowedTypes:["output"]}}this._terminal=new Terminal(this._view.getNode(),b,this,this.getId());if(this._buildingBlockDescription.type=="pre"){this._terminal.onWireHandler(a)}},getTerminal:function(){return this._terminal},destroy:function($super,b){if(this._buildingBlockDescription.catalogueUri&&b){var a=(this._buildingBlockDescription.type=="pre")?URIs.pre:URIs.post;this._removeFromServer(a+this.getId())}if(this._terminal){this._terminal.destroy();this._terminal=null}$super()},onUpdate:function(a,b){if(this._terminal){this._terminal.updatePosition()}},_createView:function(){return new DomainConceptView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()},_getCondition:function(){return{label:{"en-gb":this.getTitle()},pattern:this._buildingBlockDescription.pattern,positive:true,uri:this._buildingBlockDescription.uri}},_toJSONForCatalogue:function(){return{conditions:[this._getCondition()],id:this.getId(),name:this.getTitle()}},_onChange:function(b){this._buildingBlockDescription.title=b.label;if(b.binding){this._buildingBlockDescription.properties={ezweb:{binding:b.binding,variableName:b.variableName,friendcode:b.friendcode}}}if(!this._buildingBlockDescription.catalogueUri){var a=(this._buildingBlockDescription.type=="pre")?URIs.pre:URIs.post;this._id=new Date().valueOf();PersistenceEngine.sendPost(a,null,Object.toJSON(this._toJSONForCatalogue()),this,this._onPostSuccess,Utils.onAJAXError)}else{this._onClick()}},_onPostSuccess:function(b){var a=JSON.parse(b.responseText);this._buildingBlockDescription.catalogueUri=a.uri;this._inferenceEngine.addReachabilityListener(a.uri,this._view);this._changeHandler(this)},_onDeleteSuccess:function(a){console.log("deleted")},_removeFromServer:function(a){PersistenceEngine.sendDelete(a,this,this._onDeleteSuccess,Utils.onAJAXError)}});var ResourceInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._terminals=new Hash()},getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},getUri:function(){return this._buildingBlockDescription.uri},createTerminals:function(b){var c={direction:[0,1],offsetPosition:{top:-6,left:4},wireConfig:{drawingMethod:"arrows"}};var a;this._buildingBlockDescription.actions.each(function(g){a=new Hash();g.preconditions.each(function(j){c.ddConfig={type:"input",allowedTypes:["output"]};var i=this._view.getConditionNode(j.id,g.name);var h=new Terminal(i,c,this,j.id,g.name);h.onWireHandler(b);a.set(j.id,h)}.bind(this));this._terminals.set(g.name,a)}.bind(this));var d;if(this._buildingBlockDescription.postconditions&&this._buildingBlockDescription.postconditions[0] instanceof Array){d=this._buildingBlockDescription.postconditions[0]}else{d=this._buildingBlockDescription.postconditions}var f=new Hash();d.each(function(h){c.alwaysSrc=true;c.ddConfig={type:"output",allowedTypes:["input"]};var i=this._view.getConditionNode(h.id,"postconditions");var g=new Terminal(i,c,this,h.id);g.onWireHandler(b);f.set(h.id,g)}.bind(this));this._terminals.set("postconditions",f)},getTerminal:function(d,a){var c=null;if(a){var b=this._terminals.get(a);if(b){c=b.get(d)}}else{c=this._terminals.get("postconditions").get(d)}return c},destroy:function($super,a){if(this._terminals){this._terminals.values().each(function(b){b.values().each(function(c){c.destroy()})})}$super()},onUpdate:function(a,b){if(this._terminals){this._terminals.values().each(function(c){c.values().each(function(d){d.updatePosition()})})}},getPreconditionTable:function(a){return this._getConditionList("actions",a)},_createView:function(){return new ResourceView(this._buildingBlockDescription)}});var OperatorInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._terminals=new Hash()},getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},getUri:function(){return this._buildingBlockDescription.uri},createTerminals:function(a){var b={direction:[0,1],wireConfig:{drawingMethod:"arrows"}};this._buildingBlockDescription.actions.each(function(g){var f=new Hash();g.preconditions.each(function(j){b.ddConfig={type:"input",allowedTypes:["output"]};b.offsetPosition={top:6,left:0};var i=this._view.getConditionNode(j.id);var h=new Terminal(i,b,this,j.id,g.name);h.onWireHandler(a);f.set(j.id,h)}.bind(this));this._terminals.set(g.name,f)}.bind(this));var c;if(this._buildingBlockDescription.postconditions&&this._buildingBlockDescription.postconditions[0] instanceof Array){c=this._buildingBlockDescription.postconditions[0]}else{c=this._buildingBlockDescription.postconditions}var d=new Hash();c.each(function(g){b.alwaysSrc=true;b.ddConfig={type:"output",allowedTypes:["input"]};b.offsetPosition={top:-10,left:2};var h=this._view.getConditionNode(g.id);var f=new Terminal(h,b,this,g.id);f.onWireHandler(a);d.set(g.id,f)}.bind(this));this._terminals.set("postconditions",d)},getTerminal:function(d,a){var c=null;if(a){var b=this._terminals.get(a);if(b){c=b.get(d)}}else{c=this._terminals.get("postconditions").get(d)}return c},getPreconditionTable:function(a){return this._getConditionList("actions",a)},destroy:function($super,a){if(this._terminals){this._terminals.values().each(function(b){b.values().each(function(c){c.destroy()})});this._terminals=null}$super()},onUpdate:function(a,b){if(this._terminals){this._terminals.values().each(function(c){c.values().each(function(d){d.updatePosition()})})}},onRotate:function(a){if(this._terminals){this._terminals.values().each(function(b){b.values().each(function(c){c.updatePosition()})})}},_createView:function(){return new OperatorView(this._buildingBlockDescription,this._orientation)}});var FormInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._terminals=new Hash();this._dialog=null},getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},showPreviewDialog:function(){if(!this._dialog){this._dialog=new PreviewDialog(this.getTitle(),this._buildingBlockDescription.getPreview())}this._dialog.show()},getUri:function(){return this._buildingBlockDescription.uri},createTerminals:function(a){var b={direction:[0,1],wireConfig:{drawingMethod:"arrows"}};this._buildingBlockDescription.actions.each(function(g){var f=new Hash();g.preconditions.each(function(j){b.ddConfig={type:"input",allowedTypes:["output"]};b.offsetPosition={top:6,left:2};var i=this._view.getConditionNode(j.id,g.name);var h=new Terminal(i,b,this,j.id,g.name);h.onWireHandler(a);f.set(j.id,h)}.bind(this));this._terminals.set(g.name,f)}.bind(this));var c;if(this._buildingBlockDescription.postconditions&&this._buildingBlockDescription.postconditions[0] instanceof Array){c=this._buildingBlockDescription.postconditions[0]}else{c=this._buildingBlockDescription.postconditions}var d=new Hash();c.each(function(g){b.alwaysSrc=true;b.ddConfig={type:"output",allowedTypes:["input"]};b.offsetPosition={top:9,left:2};var h=this._view.getConditionNode(g.id);var f=new Terminal(h,b,this,g.id);f.onWireHandler(a);d.set(g.id,f)}.bind(this));this._terminals.set("postconditions",d)},getTerminal:function(d,a){var c=null;if(a){var b=this._terminals.get(a);if(b){c=b.get(d)}}else{c=this._terminals.get("postconditions").get(d)}return c},destroy:function($super,a){if(this._terminals){this._terminals.values().each(function(b){b.values().each(function(c){c.destroy()})});this._terminals=null}$super()},onUpdate:function(a,b){if(this._terminals){this._terminals.values().each(function(c){c.values().each(function(d){d.updatePosition()})})}},getPreconditionTable:function(a){return this._getConditionList("actions",a)},_createView:function(){return new FormView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()}});var Palette=Class.create(SetListener,{initialize:function(c,a,b){this._inferenceEngine=b;this._set=c;this._dropZones=a;this._components=new Hash();this._node=null;this._contentNode=null;this._renderUI();this._set.setListener(this)},getNode:function(){return this._node},setChanged:function(){this._updateComponents()},getBuildingBlockSet:function(){return this._set},getComponentUris:function(){var a=[];this._set.getBuildingBlocks().each(function(b){a.push({uri:b.uri})});return a},_renderUI:function(){this._node=new dijit.layout.AccordionPane({title:this._set.getBuildingBlockName(),"class":"paletteElement"});this._contentNode=new Element("div",{"class":"paletteContent"});this._searchBox=new PaletteSearchBox();this._searchBox.addEventListener(this._filterComponents.bind(this));this._node.setContent(this._searchBox.getDOMNode());this._searchBox.getDOMNode().insert({after:this._contentNode})},_updateComponents:function(){var f=$A(this._set.getBuildingBlocks());var b=f.sortBy(function(h){return h.getTitle()});var c;var a;for(var d=0,g;g=b[d];d++){c=this._components.get(g.uri);if(!c){c=this._buildComponentFor(g);if(a){a.insert({after:c.getNode()})}else{this._contentNode.appendChild(c.getNode())}c.getNode().insert({after:new Element("div",{"class":"paletteSeparator"})})}a=c.getNode().next()}this._filterComponents();if(this._set.getBuildingBlockType()==Constants.BuildingBlock.SCREEN||this._set.getBuildingBlockType()==Constants.BuildingBlock.FORM){Utils.showMessage("Building blocks loaded",{hide:true})}},_filterComponents:function(){this._components.each(function(b){var a=b.value;var d=a.getBuildingBlockDescription().getTitle().toLowerCase();var c=this._searchBox.getValue().toLowerCase();if(c.blank()||d.match(c)){a.getNode().show()}else{a.getNode().hide()}}.bind(this))},_buildComponentFor:function(b){var a=null;switch(this._set.getBuildingBlockType()){case Constants.BuildingBlock.SCREEN:a=new ScreenComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.DOMAIN_CONCEPT:a=new DomainConceptComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.FORM:a=new FormComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.RESOURCE:a=new ResourceComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.OPERATOR:a=new OperatorComponent(b,this._dropZones,this._inferenceEngine);break;default:throw"Unsupported building block type"}this._components.set(b.uri,a);return a}});var PaletteComponent=Class.create(DragSource,{initialize:function($super,c,a,b){$super();this._dropZones=a;this._buildingBlockDescription=c;this._inferenceEngine=b;this._view=this._createView();this._node=this._createSlot()},getNode:function(){return this._node},getHandlerNode:function(){return this._view.getNode()},getDraggableObject:function(){var a=this._createInstance();var b=a.getHandlerNode();document.body.appendChild(b);b.setStyle({top:this._getContentOffsetTop()+"px",left:this._getContentOffsetLeft()+"px",position:"absolute"});return a},getBuildingBlockDescription:function(){return this._buildingBlockDescription},getView:function(){return this._view},_createSlot:function(){var a=new Element("div",{"class":"slot"});a.appendChild(this._view.getNode());var b=new Element("div",{"class":"slotTitle"}).update(this._getTitle());a.appendChild(b);this.enableDragNDrop(null,this._dropZones);return a},_getTitle:function(){throw"Abstract Method invocation: PaletteComponent::_getTitle"},_createView:function(){throw"Abstract Method invocation: PaletteComponent::_createView"},_createInstance:function(){throw"Abstract Method invocation: PaletteComponent::_createInstance"},_getContentOffsetTop:function(){return this.getView().getNode().cumulativeOffset().top-this.getView().getNode().cumulativeScrollOffset().top},_getContentOffsetLeft:function(){return this.getView().getNode().cumulativeOffset().left-this.getView().getNode().cumulativeScrollOffset().left}});var PaletteController=Class.create({initialize:function(c,a,b){this._palettes=new Hash();this._node=new dijit.layout.AccordionContainer({"class":"palettePane",region:"left",minSize:"170",maxSize:"300",splitter:"true",livesplitters:"false",style:"width:260px;"});$A(c).each(function(g){var d=new Array();a.each(function(h){if(h.accepts().include(g.getBuildingBlockType())){d.push(h)}});var f=new Palette(g,d,b);this._palettes.set(g.getBuildingBlockType(),f);this._node.addChild(f.getNode())}.bind(this))},getPalette:function(a){return this._palettes.get(a)},getNode:function(){return this._node},getComponentUris:function(a){return this._palettes.get(a).getComponentUris()}});var PaletteSearchBox=Class.create({initialize:function(a){this.defaultValue=a||"Search...";this._listeners=[];this._textSearch="";this._inputElement=new Element("input",{type:"text","class":"defaultValue",value:this.defaultValue});this._inputElement.observe("blur",this._lostFocus.bind(this));this._inputElement.observe("focus",this._getFocus.bind(this));new Form.Element.Observer(this._inputElement,1,this._valueChange.bind(this));this._rootNode=new Element("div",{"class":"searchBox"}).insert(this._inputElement)},getValue:function(){if(this._inputElement.hasClassName("defaultValue")){return""}return String.interpret(this._inputElement.value)},setValue:function(a){this._inputElement.value=a},getDOMNode:function(){return this._rootNode},addEventListener:function(a){this._listeners.push(a)},_getFocus:function(){if(this._inputElement.hasClassName("defaultValue")){this._inputElement.value="";this._inputElement.removeClassName("defaultValue")}else{this._inputElement.select()}},_lostFocus:function(){if(!this.getValue()){this._inputElement.value=this.defaultValue;this._inputElement.addClassName("defaultValue")}},_valueChange:function(){this._textSearch=this.getValue();for(var a=0;a<this._listeners.length;a++){this._listeners[a](this,this._textSearch)}}});var ScreenComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b);this._inferenceEngine.addReachabilityListener(this._buildingBlockDescription.uri,this._view)},_createView:function(){return new ScreenView(this._buildingBlockDescription)},_createInstance:function(){return new ScreenInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]}});var DomainConceptComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b)},_createView:function(){return new DomainConceptView(this._buildingBlockDescription)},_createInstance:function(){return new PrePostInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.getTitle()}});var ResourceComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b)},_createView:function(){return new ResourceView(this._buildingBlockDescription)},_createInstance:function(){return new ResourceInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]}});var OperatorComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b)},_createView:function(){return new OperatorView(this._buildingBlockDescription)},_createInstance:function(){return new OperatorInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]}});var FormComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b)},_createView:function(){return new FormSnapshotView(this._buildingBlockDescription)},_createInstance:function(){return new FormInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]}});var BuildingBlockView=Class.create({initialize:function(){this._node=null},getNode:function(){return this._node},setReachability:function(a){throw"Abstract Method invocation. BuildingBlockView :: setReachability"},setSelected:function(a){if(a){this._node.addClassName("selected")}else{this._node.removeClassName("selected")}},destroy:function(){},addEventListener:function(a,b){Element.observe(this._node,b,a)},addGhost:function(){var a=new Element("div",{"class":"ghost ghostLayer"});this._node.appendChild(a)},_setViewReachability:function(d,c,b,f){var a=d.reachability;Utils.setSatisfeabilityClass(f,a);b.each(function(g){Utils.setSatisfeabilityClass(g.getNode(),a)});d.actions.each(function(g){g.preconditions.each(function(h){var i=c.get(h.id).getNode();Utils.setSatisfeabilityClass(i,h.satisfied)}.bind(this))}.bind(this))}});var ScreenView=Class.create(BuildingBlockView,{initialize:function($super,j){$super();this._preIcons=new Array();this._postIcons=new Array();this._tooltip=null;var f=new Element("div",{"class":"title"});f.update(j.label["en-gb"]);var d=new Element("div",{"class":"preArea"});if(j.preconditions.length>1){console.log("OR precondition support not implemented yet")}else{var h=j.preconditions[0]}$A(h).each(function(l){var k=FactFactory.getFactIcon(l,"embedded");this._preIcons.push(k);d.appendChild(k.getNode())}.bind(this));var i=new Element("div",{"class":"postArea"});if(j.postconditions.length>1){console.log("OR postcondition support not implemented yet")}else{var a=j.postconditions[0]}$A(a).each(function(k){if(k){var l=FactFactory.getFactIcon(k,"embedded");this._postIcons.push(l);if(!k.positive){l.getNode().addClassName("negative")}i.appendChild(l.getNode())}}.bind(this));var b=new Element("div",{"class":"prePostSeparator"});if(j.icon){var g=new Element("div",{"class":"image"});var c=new Element("img",{"class":"img",src:j.icon});g.appendChild(c)}this._node=new Element("div",{"class":"view screen"});this._node.appendChild(f);this._node.appendChild(d);this._node.appendChild(b);if(j.icon){this._node.appendChild(g)}this._node.appendChild(i);this._createTooltip(j)},setReachability:function(d){var a=d.reachability;Utils.setSatisfeabilityClass(this.getNode(),a);this._postIcons.each(function(g){Utils.setSatisfeabilityClass(g.getNode(),a)});var c=d.preconditions;if(c.length>1){console.log("OR precondition support not implemented yet");return}else{var b=c[0]}var f=new Hash();$A(b).each(function(g){f.set(FactFactory.getFactUri(g),g.satisfied)});this._preIcons.each(function(h){var g=h.getFact().getUri();Utils.setSatisfeabilityClass(h.getNode(),f.get(g))})},destroy:function(){this._preIcons=null;this._postIcons=null;this._node=null},_createTooltip:function(a){}});var DomainConceptView=Class.create(BuildingBlockView,{initialize:function($super,a){$super();this._factIcon=FactFactory.getFactIcon(a,"standalone").getNode();this._node=new Element("div",{"class":"view domainConcept"});this._node.appendChild(this._factIcon)},destroy:function(){this._node=null},setReachability:function(a){var b=(a.reachability!==undefined)?a.reachability:a.satisfied;Utils.setSatisfeabilityClass(this._factIcon,b)}});var ResourceView=Class.create(BuildingBlockView,{initialize:function($super,h){$super();this._icons=new Hash();var d=new Element("div",{"class":"preArea"});var g=new Element("div",{"class":"postArea"});var f=h.actions;var a;f.each(function(j){a=new Hash();j.preconditions.each(function(l){var k=FactFactory.getFactIcon(l,"embedded");a.set(l.id,k);d.appendChild(k.getNode())}.bind(this));this._icons.set(j.name,a)}.bind(this));var i;if(h.postconditions&&h.postconditions[0] instanceof Array){i=h.postconditions[0]}else{i=h.postconditions}a=new Hash();i.each(function(k){var j=FactFactory.getFactIcon(k,"embedded");a.set(k.id,j);g.appendChild(j.getNode())}.bind(this));this._icons.set("postconditions",a);var b=new Element("div",{"class":"prePostSeparator"});this._node=new Element("div",{"class":"view resource",title:h.name});this._node.appendChild(d);this._node.appendChild(b);this._node.appendChild(g);var c=new Element("div",{"class":"title"});c.update(h.label["en-gb"]);this._node.appendChild(c)},getConditionNode:function(d,c){var b=this._icons.get(c);if(b){var a=b.get(d);if(a){return a.getNode()}}return null},setReachability:function(b){var a=b.reachability;Utils.setSatisfeabilityClass(this._node,a);this._icons.get("postconditions").each(function(c){Utils.setSatisfeabilityClass(c.value.getNode(),a)});b.actions.each(function(d){var c=this._icons.get(d.name);d.preconditions.each(function(f){var g=this.get(f.id).getNode();Utils.setSatisfeabilityClass(g,f.satisfied)}.bind(c))}.bind(this))},destroy:function(){this._icons=null;this._node=null}});var OperatorView=Class.create(BuildingBlockView,{initialize:function($super,j){$super();this._preIcons=new Hash();this._postIcons=new Hash();this._node=new Element("div",{"class":"view operator",title:j.name});var f=j.actions;var a=new Array();f.each(function(i){i.preconditions.each(function(o){var n=FactFactory.getFactIcon(o,"embedded");this._preIcons.set(o.id,n);a.push(n)}.bind(this))}.bind(this));var c=new Array();if(j.postconditions&&j.postconditions[0] instanceof Array){var k=j.postconditions[0]}else{var k=j.postconditions}k.each(function(n){var i=FactFactory.getFactIcon(n,"embedded");this._postIcons.set(n.id,i);c.push(i)}.bind(this));var l=a.size();for(var g=0;g<l;g++){var b=a[g].getNode();this._node.appendChild(b);var h=this._getPosition(true,g,l,0);b.setStyle({top:Math.round(h.y)+"px",left:Math.round(h.x)+"px"})}l=c.size();for(var g=0;g<l;g++){var b=c[g].getNode();var h=this._getPosition(false,g,l,0);this._node.appendChild(b);b.setStyle({top:Math.round(h.y)+"px",left:Math.round(h.x)+"px"})}var d=new Element("div",{"class":"title"});d.update(j.label["en-gb"]);this._node.appendChild(d)},_getPosition:function(f,c,g,d){var h=74;var b=60;var a=h*(c+1)/(g+1);if((c+1)!=(g+1)/2){a+=(c<g/2)?-4:3}if(f&&d==0||!f&&d==1){if(a>h/2){var i=3*b/2-a*(b/2)/(h/2)}else{var i=a*(b/2)/(h/2)+b/2}}else{if(a>h/2){var i=a*(b/2)/(h/2)-b/2-4}else{var i=b/2-a*(b/2)/(h/2)-4}}return{x:a,y:i}},getConditionNode:function(a){return this._preIcons.get(a)?this._preIcons.get(a).getNode():this._postIcons.get(a).getNode()},setReachability:function(a){this._setViewReachability(a,this._preIcons,this._postIcons.values(),this._node)},updateOrientation:function(c){if(!c){c=0}var h=this._preIcons.values();var f=h.length;for(var d=0;d<f;d++){var b=h[d].getNode();var a=this._getPosition(true,d,f,c);b.setStyle({top:Math.round(a.y)+"px",left:Math.round(a.x)+"px"})}var g=this._postIcons.values();var f=g.length;for(var d=0;d<f;d++){var b=g[d].getNode();var a=this._getPosition(false,d,f,c);b.setStyle({top:Math.round(a.y)+"px",left:Math.round(a.x)+"px"})}},destroy:function(){this._preIcons=null;this._postIcons=null;this._node=null}});var FormView=Class.create(BuildingBlockView,{initialize:function($super,j){$super();this._actions=new Hash();this._postIcons=new Hash();this._triggerIcons=new Hash();this._node=new Element("div",{"class":"view form",title:j.name});var h=new Element("div",{"class":"title"}).update(j.label["en-gb"]);this._node.appendChild(h);var a=new Element("div",{"class":"actions"});var f=new Element("div",{"class":"title"}).update("Actions");this._node.appendChild(a);a.appendChild(f);var b=j.actions;b.each(function(l){var n=new ActionView(l);this._actions.set(l.name,n);a.appendChild(n.getNode())}.bind(this));var d=new Element("div",{"class":"postTriggerContainer"});var c=new Element("div",{"class":"title"}).update("Postconditions");d.appendChild(c);var g=new Element("div",{"class":"triggerArea"});d.appendChild(g);var k;if(j.postconditions&&j.postconditions[0] instanceof Array){k=j.postconditions[0]}else{k=j.postconditions}var i=new Element("div",{"class":"postArea"});k.each(function(n){var l=FactFactory.getFactIcon(n,"embedded");this._postIcons.set(n.id,l);i.appendChild(l.getNode())}.bind(this));d.appendChild(i);this._node.appendChild(d)},getConditionNode:function(b,a){if(a){return this._actions.get(a).getConditionNode(b)}else{return this._postIcons.get(b).getNode()}},setReachability:function(b){var a=b.reachability;Utils.setSatisfeabilityClass(this._node,a);b.actions.each(function(c){this._actions.get(c.name).setReachability(c)}.bind(this));this._postIcons.values().each(function(c){Utils.setSatisfeabilityClass(c.getNode(),a)})},destroy:function(){this._actions.each(function(a){a.value.destroy()});this._postIcons=null;this._triggerIcons.each(function(a){a.value.destroy()})}});var FormSnapshotView=Class.create(BuildingBlockView,{initialize:function($super,a){$super();this._node=new Element("div",{"class":"view form snapshot",title:a.name});var b=new Element("img",{"class":"image",src:a.icon});this._node.appendChild(b)},setReachability:function(a){}});var ActionView=Class.create({initialize:function(a){this._node=null;this._preIcons=new Hash();this._node=new Element("div",{"class":"action"});var b=new Element("div",{"class":"title"}).update(a.name);this._node.appendChild(b);var c=new Element("div",{"class":"preArea"});a.preconditions.each(function(f){var d=FactFactory.getFactIcon(f,"embedded");this._preIcons.set(f.id,d);c.appendChild(d.getNode())}.bind(this));this._node.appendChild(c)},getNode:function(){return this._node},getConditionNode:function(a){return this._preIcons.get(a).getNode()},destroy:function(){this._preIcons=null;this._node=null},setReachability:function(b){var a=b.satisfied;Utils.setSatisfeabilityClass(this._node,a);b.preconditions.each(function(c){Utils.setSatisfeabilityClass(this._preIcons.get(c.id).getNode(),c.satisfied)}.bind(this))}});var Terminal=function(h,b,a,g,f){this._conditionNode=h;this._terminalNode=new Element("div",{title:this._conditionNode.title});var d={position:"absolute",width:"1px",height:"1px","z-index":"50"};this._terminalNode.setStyle(d);this._recalculatePosition();document.body.appendChild(this._terminalNode);var c={width:2,borderwidth:2,color:"#EAEAEA",bordercolor:"#808080"};var i={};i=Object.extend(i,b);i.wireConfig=Object.extend(c,b.wireConfig);WireIt.Terminal.call(this,this._terminalNode,i);this._instance=a;this._conditionId=g;this._action=f?f:""};Object.extend(Terminal.prototype,WireIt.Terminal.prototype);Object.extend(Terminal.prototype,{getBuildingBlockUri:function(){var a;if(this._instance.constructor==PrePostInstance){a=null}else{a=this._instance.getUri()}return a},getBuildingBlockId:function(){var a;if(this._instance.constructor==PrePostInstance){a=""}else{a=this._instance.getId()}return a},getConditionId:function(){return this._conditionId},getActionId:function(){return this._action},getInstance:function(){return this._instance},destroy:function(){this.removeAllWires();this.remove();this._terminalNode.parentNode.removeChild(this._terminalNode)},updatePosition:function(){this._recalculatePosition();this.redrawAllWires()},onWireHandler:function(a){var b={};b=Object.extend(b,a);b.refTerminal=this;this.eventAddWire.subscribe(this._wireAddHandler.bind(b));this.eventRemoveWire.subscribe(this._wireRemoveHandler.bind(b))},setVisible:function(b){var a={visibility:b?"visible":"hidden"};this.el.setStyle(a)},_recalculatePosition:function(){var a=Utils.getPosition(this._conditionNode);var b={top:a.top+"px",left:a.left+"px"};this._terminalNode.setStyle(b)},_wireAddHandler:function(a,c){var b=c[0];if(b.terminal1.parentEl&&b.terminal2.parentEl){if(b.terminal1==this.refTerminal){this.onPipeCreation(b)}}else{if(b.terminal1==this.refTerminal){this.onPipeCreationStart(b,b.terminal1)}else{if(b.terminal2==this.refTerminal){this.onPipeCreationStart(b,b.terminal2)}}}},_wireRemoveHandler:function(a,c){var b=c[0];if(b.terminal1.parentEl&&b.terminal2.parentEl){if(b.terminal1==this.refTerminal){this.onPipeDeletion(b)}}else{if(b.terminal1==this.refTerminal||b.terminal2==this.refTerminal){this.onPipeCreationCancel(b)}}}});var Pipe=Class.create({initialize:function(a,b){this._wire=a;this._id=b;this._isValid=true},getWire:function(){return this._wire},getId:function(){return this._id},getSource:function(){return this._wire.terminal1},getDestination:function(){return this._wire.terminal2},getJSONforScreen:function(){return{from:{buildingblock:this.getSource().getBuildingBlockId(),condition:this.getSource().getConditionId()},to:{buildingblock:this.getDestination().getBuildingBlockId(),action:this.getDestination().getActionId(),condition:this.getDestination().getConditionId()}}},getJSONforCheck:function(){return{from:{buildingblock:this.getSource().getBuildingBlockUri(),condition:this.getSource().getConditionId()},to:{buildingblock:this.getDestination().getBuildingBlockUri(),action:this.getDestination().getActionId(),condition:this.getDestination().getConditionId()}}},setReachability:function(b){var a=this._wire.options;var c=b.satisfied;if(!b.correct){a=Object.extend(a,{color:"#EAEAEA",bordercolor:"#808080"})}else{if(c){a=Object.extend(a,{color:"#DDF7DD",bordercolor:"#008000"})}else{a=Object.extend(a,{color:"#F5D9D9",bordercolor:"#B90000"})}}this._wire.setOptions(a);this._wire.redraw();if(!b.correct){this._wire.element.setStyle({opacity:"0.5"});if(this._isValid){Utils.showMessage("The elements you have connected are not compatible. It may not work",{hide:true,error:true});this._isValid=false}}},isValid:function(){return(this.getSource().getBuildingBlockId()!=this.getDestination().getBuildingBlockId())&&this._isValid},destroy:function(){this.getSource().removeWire(this._wire);this.getDestination().removeWire(this._wire)},setVisible:function(b){if(b){this.getSource().updatePosition();this.getDestination().updatePosition()}var a={visibility:b?"visible":"hidden"};this._wire.element.setStyle(a)}});var PipeFactory=Class.create({initialize:function(){this._pipes=new Hash()},getPipe:function(){var b=null;var d;var c;var a;if(arguments.length==1){d=arguments[0];c=d.terminal1;a=d.terminal2}else{c=arguments[0];a=arguments[1];d=new WireIt.Wire(c,a,document.body,c.options.wireConfig);d.redraw()}var f=this._getPipeId(c,a);b=new Pipe(d,f);if(b.isValid()){if(!this._pipes.get(f)){this._pipes.set(f,b)}}else{b.destroy();b=null}return b},removePipe:function(a){this._pipes.unset(a.getId())},getPipeFromTerminals:function(f,g){var a=this._pipes.values();for(var c=0;c<a.size();c++){var b=a[c];var d=b.getSource()==f;d=d&&b.getDestination()==g;if(d){return b}}return null},getPipes:function(b){var a=new Array();this._pipes.values().each(function(c){var d=c.getSource().getBuildingBlockId()==b.getId();d=d||c.getDestination().getBuildingBlockId()==b.getId();if(d){a.push(c)}});return a},hidePipes:function(){this._pipes.values().each(function(a){a.setVisible(false)})},showPipes:function(){this._pipes.values().each(function(a){a.setVisible(true)})},_getPipeId:function(b,a){return b.getBuildingBlockId()+b.getConditionId()+a.getBuildingBlockId()+a.getActionId()+a.getConditionId()}});var TriggerMappingFactory=Class.create({initialize:function(){this._triggers=new Hash()},createTrigger:function(b){var a=this._createFromJSON(b);this._triggers.set(a.getId(),a);return a},removeTrigger:function(b){var a;if(b.constructor!=Trigger&&b.constructor!=ScreenTrigger){a=this._createFromJSON(b)}else{a=b}this._triggers.unset(a.getId());return a},getTriggerList:function(b){var a=new Hash();this._triggers.values().each(function(c){if(c.getDestinationId()==b.getId()){var d=a.get(c.getDestinationAction());if(!d){d=new Array()}d.push(c);a.set(c.getDestinationAction(),d)}});return a},getRelatedTriggers:function(b){var a=new Array();this._triggers.values().each(function(c){if(c.getSourceId()==b.getId()||c.getDestinationId()==b.getId()){a.push(c)}});return a},_createFromJSON:function(b){var a;if(b.from.instance==ScreenTrigger.INSTANCE_NAME){a=new ScreenTrigger(b.to)}else{a=new Trigger(b.from,b.to)}return a}});var Trigger=Class.create({initialize:function(b,a){this._from=b;this._to=a;this._id=this._createId(b,a)},getId:function(){return this._id},getDestinationId:function(){return this._to.instance.getId()},getDestinationAction:function(){return this._to.action},getTriggerName:function(){return this._from.name},getSourceId:function(){return this._from.instance.getId()},getSourceInstance:function(){return this._from.instance},toJSON:function(){return{from:{buildingblock:this.getSourceId(),name:this.getTriggerName()},to:{buildingblock:this.getDestinationId(),action:this.getDestinationAction()}}},_createId:function(b,a){return b.instance.getId()+b.name+a.instance.getId()+a.action}});var ScreenTrigger=Class.create(Trigger,{initialize:function($super,b){var a={instance:ScreenTrigger.INSTANCE_NAME,name:ScreenTrigger.ONLOAD};$super(a,b)},getSourceId:function(){return this._from.instance},getSourceInstance:function(){var a={getTitle:function(){return ScreenTrigger.INSTANCE_NAME},getId:function(){return ScreenTrigger.INSTANCE_NAME}};return a},toJSON:function(){return{from:{buildingblock:"",name:"_onload"},to:{buildingblock:this.getDestinationId(),action:this.getDestinationAction()}}},_createId:function(b,a){return b.instance+b.name+a.instance.getId()+a.action}});ScreenTrigger.INSTANCE_NAME="Screen";ScreenTrigger.ONLOAD="onload";var PersistenceEngine=Class.create();Object.extend(PersistenceEngine,{sendGet:function(c,d,b,a,f){new Ajax.Request(c,{method:"get",parameters:arguments[4],onSuccess:b.bind(d),onFailure:a.bind(d),onException:a.bind(d),requestHeaders:f})},sendPost:function(d,h,a,f,c,b,g){new Ajax.Request(d,{method:"post",parameters:h,postBody:a,onSuccess:c.bind(f),onFailure:b.bind(f),onException:b.bind(f),requestHeaders:g})},sendDelete:function(c,d,b,a,f){new Ajax.Request(c,{method:"delete",onSuccess:b.bind(d),onFailure:a.bind(d),onException:a.bind(d),requestHeaders:f})},sendUpdate:function(d,h,a,f,c,b,g){new Ajax.Request(d,{method:"put",parameters:h,postBody:a,onSuccess:c.bind(f),onFailure:b.bind(f),onException:b.bind(f),requestHeaders:g})}});var FormDialog=Class.create({initialize:function(d,b){b=Utils.variableOrDefault(b,{});this._options=Object.extend({buttonPosition:FormDialog.POSITION_BOTTOM,createMessageZone:false,minMessageLines:1,closable:true},b);var a=this._options.buttonPosition;this._dialog=new dijit.Dialog(d);if(!this._options.closable){this._dialog.closeButtonNode.style.display="none"}this._headerNode=new Element("div",{"class":"dialogHeader"});this._contentNode=new Element("div",{"class":"dialogContent"});this._messageNode=new Element("div",{"class":"dialogMessageZone hidden"});var c=new Element("div",{"class":"dialogMessageWrapper"});c.appendChild(this._messageNode);this._buttonNode=new Element("div",{"class":"dialogButtonZone"});this._formWidget=null;var f=new Element("div",{"class":a});f.appendChild(this._headerNode);switch(a){case FormDialog.POSITION_TOP:f.appendChild(this._buttonNode);if(this._options.createMessageZone){f.appendChild(c)}f.appendChild(this._contentNode);break;default:f.appendChild(this._contentNode);if(this._options.createMessageZone){f.appendChild(c)}f.appendChild(this._buttonNode);break}c.style.minHeight=((this._options.minMessageLines*18)+2)+"px";this._dialog.attr("content",f);this._initialized=false;dojo.connect(this._dialog,"hide",this._hide.bind(this))},show:function(){if(!this._initialized){this._initDialogInterface();this._initialized=true}else{this._reset()}GVS.setEnabled(false);this._dialog.show()},_initDialogInterface:function(){throw"Abstract method invocation FormDialog :: _initDialogInterface"},_hide:function(){GVS.setEnabled(true);document.documentElement.scrollTop=0},_getForm:function(){return this._formWidget.domNode},_getFormWidget:function(){return this._formWidget},_addButton:function(a,c){var b=new dijit.form.Button({label:a,onClick:c});this._buttonNode.appendChild(b.domNode);return b},_removeButtons:function(){this._buttonNode.update("")},_setHeader:function(d,a){this._headerNode.update("");var c=new Element("h2").update(d);this._headerNode.appendChild(c);if(a&&a!=""){var b=new Element("div",{"class":"line"}).update(a);this._headerNode.appendChild(b)}},_setContent:function(b,a){if(b instanceof Array){if(a){this._formWidget=new dijit.form.Form(a)}else{this._formWidget=new dijit.form.Form({method:"post"})}$A(b).each(function(c){var g;var f;switch(c.type){case"title":g=new Element("h3").update(c.value);break;case"input":if(c.regExp||c.required){var d=new dijit.form.ValidationTextBox({name:c.name,value:c.value,regExp:(c.regExp)?c.regExp:".*",required:(c.required)?c.required:false,invalidMessage:(c.message)?c.message:"This field cannot be blank"})}else{var d=new dijit.form.TextBox({name:c.name,value:c.value})}if(c.disabled){d.attr("disabled",c.disabled)}f=d.textbox;g=this._createLine(c.label,d.domNode);break;case"label":g=new Element("div",{"class":"line",style:c.style}).update(c.value);break;case"hidden":g=new Element("input",{type:"hidden",name:c.name,value:c.value});break;case"comboBox":f=new Element("select",{name:c.name});$A(c.options).each(function(h){var i=new Element("option",{value:h.value}).update(h.label);if(h.value==c.value){i.selected="selected"}f.appendChild(i)});g=this._createLine(c.label,f);break;default:throw"Unimplemented form field type"}this._formWidget.domNode.appendChild(g);if(f){this._armEvents(f,c.events)}}.bind(this));this._contentNode.update(this._formWidget.domNode)}else{this._contentNode.update(b)}dojo.parser.parse(this._contentNode)},_setMessage:function(b,a){if(arguments.length==0){this._messageNode.className="dialogMessageZone hidden";this._messageNode.update("&nbsp;");return}this._messageNode.className="dialogMessageZone";switch(a){case FormDialog.MESSAGE_WARNING:this._messageNode.addClassName("warning");break;case FormDialog.MESSAGE_ERROR:this._messageNode.addClassName("error");break;default:}this._messageNode.innerHTML=b},_createLine:function(b,c){var d=new Element("div",{"class":"line"});var a=new Element("label").update(b);d.appendChild(a);d.appendChild(c);return d},_armEvents:function(a,b){$H(b).each(function(c){Element.observe(a,c.key,c.value)})},_validate:function(){return this._getFormWidget().validate()},_reset:function(){if(this._getFormWidget()){this._getFormWidget().validate()}}});FormDialog.POSITION_LEFT="left";FormDialog.POSITION_RIGHT="right";FormDialog.POSITION_BOTTOM="bottom";FormDialog.POSITION_TOP="top";FormDialog.POSITIVE_VALIDATION="[1-9][0-9]*";FormDialog.EMAIL_VALIDATION="[a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,4}";FormDialog.URL_VALIDATION="([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*";FormDialog.INVALID_POSITIVE_MESSAGE="Invalid number";FormDialog.INVALID_EMAIL_MESSAGE="Invalid email address";FormDialog.INVALID_URL_MESSAGE="Invalid URL";FormDialog.MESSAGE_INFO="info";FormDialog.MESSAGE_WARNING="warning";FormDialog.MESSAGE_ERROR="error";var ConfirmDialog=Class.create(FormDialog,{initialize:function($super,c,b,a){$super({title:c,style:"display:none;"},a);switch(b){case ConfirmDialog.OK:this._okButton=this._addButton("Ok",this._onOk.bind(this));break;case ConfirmDialog.SAVE_DISCARD_CANCEL:if(a&&a.callback){this._addButton("Save",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.SAVE,callback:a.callback}));this._addButton("Discard changes",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.DISCARD,callback:a.callback}));this._addButton("Cancel",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.CANCEL,callback:a.callback}))}else{throw"Cannot create a confirm dialog with that configuration. ConfirmDialog::initialize"}break;case ConfirmDialog.NONE:break;case ConfirmDialog.CUSTOM:if(a&&a.callback&&a.buttons){$H(a.buttons).each(function(d){this._addButton(d.value,this._onButtonPressed.bind({mine:this,pressedButton:d.key,callback:a.callback}))}.bind(this))}else{throw"Cannot create a confirm dialog with that configuration. ConfirmDialog::initialize"}break;case ConfirmDialog.OK_CANCEL:default:this._okButton=this._addButton("Ok",this._onOk.bind(this));this._addButton("Cancel",this._onCancel.bind(this));break}},_initDialogInterface:function(){if(this._options.contents){this._setContent(this._options.contents)}},_setDisabled:function(a){this._okButton.setDisabled(a)},_onOk:function(){this._dialog.hide()},_onCancel:function(){this._dialog.hide()},_onButtonPressed:function(){this.mine._dialog.hide();this.callback(this.pressedButton)},_reset:function($super){this._setDisabled(false);$super()}});ConfirmDialog.OK="ok";ConfirmDialog.OK_CANCEL="ok_cancel";ConfirmDialog.SAVE_DISCARD_CANCEL="save_discard_cancel";ConfirmDialog.CUSTOM="custom";ConfirmDialog.NONE="none";ConfirmDialog.SAVE="save";ConfirmDialog.DISCARD="discard";ConfirmDialog.CANCEL="cancel";var PrePostDialog=Class.create(ConfirmDialog,{initialize:function($super,a,b,c){$super("Pre/Post Condition");this._label=b;this._type=c;this._onChangeCallback=a},_initDialogInterface:function(){this._setHeader("Check domain concept details","Please fulfill the required information in order to set up the Domain Concept");var a=[{type:"input",label:"Type:",name:"type",value:this._type,disabled:true},{type:"input",label:"Label:",name:"label",value:this._label,required:true},{type:"title",value:"EzWeb properties"},{type:"comboBox",label:"Binding:",name:"binding",value:"undefined",options:[]},{type:"input",label:"Variable name:",name:"variableName",value:this._label.replace(" ",""),required:true},{type:"input",label:"Friendcode:",name:"friendcode",value:this._label.replace(" ",""),required:true}];this._setContent(a);this._onTypeChange()},_onOk:function($super){this._onChangeCallback(this._getForm().serialize({hash:true}));$super()},_onTypeChange:function(){var b=new Array();switch($F(this._getForm().type)){case"pre":b.push({value:"slot",label:"Slot"});b.push({value:"pref",label:"User Preference"});b.push({value:"context",label:"Platform Context"});break;case"post":b.push({value:"event",label:"Event"});break;default:break}var a=$(this._getForm().binding);a.update("");b.each(function(d){var c=new Element("option",{value:d.value}).update(d.label);a.appendChild(c)})}});var PreferencesDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("User Preferences")},_initDialogInterface:function(){this._setHeader("User preferences");var a=GVS.getUser();var b=[{type:"input",label:"First Name:",name:"firstName",value:a.getFirstName()},{type:"input",label:"Last Name:",name:"lastName",value:a.getLastName()},{type:"input",label:"Email:",name:"email",value:a.getEmail(),regExp:FormDialog.EMAIL_VALIDATION,message:FormDialog.INVALID_EMAIL_MESSAGE,required:true},{type:"input",label:"EzWeb URL:",name:"ezWebURL",value:a.getEzWebURL(),regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE}];this._setContent(b)},_onOk:function($super){if(!this._getFormWidget().validate()){return}else{var a=GVS.getUser();a.update(this._getForm().serialize(true));$super()}},_reset:function($super){var a=GVS.getUser();this._getForm().firstName.value=a.getFirstName();this._getForm().lastName.value=a.getLastName();this._getForm().email.value=a.getEmail();this._getForm().ezWebURL.value=a.getEzWebURL();$super()}});var ExternalContentDialog=Class.create(ConfirmDialog,{initialize:function($super,a){$super(a,ConfirmDialog.NONE)},show:function($super,a){$super();this._setContent(a)},_initDialogInterface:function(){}});var BuildGadgetDialog=Class.create(ConfirmDialog,{initialize:function($super,a){$super("Build Gadget");this._onDeployCallback=a},show:function($super,a){$super();$H(a).each(function(b){this._getForm()[b.key].setValue(b.value)}.bind(this))},_initDialogInterface:function(){var a=GVS.getUser();this._setHeader("Fulfill Gadget Information","Please fulfill the required information in order to deploy a gadget.");var b=[{type:"title",value:"Gadget information"},{type:"input",label:"Gadget Name:",name:"name",value:"",required:true},{type:"input",label:"Gadget Short Name:",name:"shortname",value:""},{type:"input",label:"Owner:",name:"owner",value:"",required:true},{type:"input",label:"Version:",name:"version",value:"1.0",required:true},{type:"input",label:"Vendor:",name:"vendor",value:"Morfeo"},{type:"input",label:"Gadget Description:",name:"desc",value:""},{type:"input",label:"Image URL:",name:"imageURI",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"input",label:"Homepage:",name:"gadgetHomepage",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"input",label:"Default Height:",name:"height",value:"",regExp:FormDialog.POSITIVE_VALIDATION,message:FormDialog.INVALID_POSITIVE_MESSAGE},{type:"input",label:"Default Width:",name:"width",value:"",regExp:FormDialog.POSITIVE_VALIDATION,message:FormDialog.INVALID_POSITIVE_MESSAGE},{type:"title",value:"Author information"},{type:"input",label:"Author Name:",name:"authorName",value:a.getRealName()},{type:"input",label:"E-Mail:",name:"email",value:a.getEmail(),regExp:FormDialog.EMAIL_VALIDATION,message:FormDialog.INVALID_EMAIL_MESSAGE},{type:"input",label:"Homepage:",name:"authorHomepage",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE}];this._setContent(b)},_onOk:function($super){if(this._getFormWidget().validate()){$super();this._onDeployCallback(this._getForm().serialize({hash:true}))}},_reset:function($super){var a=GVS.getUser();this._getForm().authorName.value=a.getRealName();this._getForm().email.value=a.getEmail();$super()}});var PublishGadgetDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("Publish Gadget",ConfirmDialog.OK);this._gadgetBaseUrl=null;this._buttons=new Hash()},show:function($super,a){this._gadgetBaseUrl=a;this._initDialogInterface();$super()},_publishGadget:function(c,b,d){var a=null;if(b.mashupPlatform=="ezweb"){a=URIs.ezweb+"interfaces/gadget?template_uri="+d}else{if(b.mashupPlatform=="igoogle"){if(b.destination=="directory"){a="http://www.google.com/ig/submit?url="+d}else{if(b.destination=="personal"){a="http://www.google.com/ig/adde?moduleurl="+d}}}else{if(b.mashupPlatform=="orkut"){a="http://sandbox.orkut.com/Main#AppInfo?appUrl="+d}}}this._deploy(c,a)},_deploy:function(b,a){var c=dijit.byId(b.id);c.attr("label","Done!");c.attr("disabled",true);window.open(a);console.log(a)},_initDialogInterface:function(){var f=new Element("div");var d=new Element("h2",{"class":"detailsTitle"}).update("Publish Gadget");f.appendChild(d);var c=new Element("div",{"class":"deployment"});var b=new Element("table");c.appendChild(b);f.appendChild(c);var a=[{className:"tableHeader",fields:[{className:"left",node:"Mashup platform"},{className:"left",node:""}]}];a.push(this._createPlatformRow("ezweb",{mashupPlatform:"ezweb"},"EzWeb",this._gadgetBaseUrl+"/ezweb.xml"));a.push(this._createPlatformRow("igoogleDirectory",{mashupPlatform:"igoogle",destination:"directory"},"iGoogle Directory",this._gadgetBaseUrl+"/igoogle.xml"));a.push(this._createPlatformRow("igooglePersonal",{mashupPlatform:"igoogle",destination:"personal"},"iGoogle Personal Page",this._gadgetBaseUrl+"/igoogle.xml"));a.push(this._createPlatformRow("orkut",{mashupPlatform:"orkut"},"Orkut",this._gadgetBaseUrl+"/igoogle.xml"));this._fillTable(b,a);this._setContent(f)},_createPlatformRow:function(d,b,c,a){return{className:"",fields:[{className:"mashup",node:c+' [<a href="'+a+'" target="blank">Template</a>]'},{className:"",node:this._buttons.set(d,new dijit.form.Button({label:"Publish it!",onClick:function(f){this._publishGadget(f.element(),b,a)}.bind(this)})).domNode}]}},_fillTable:function(a,b){b.each(function(d){var c=new Element("tr",{"class":d.className});d.fields.each(function(f){var g=new Element("td",{"class":f.className}).update(f.node);c.appendChild(g)});a.appendChild(c)})}});var AddScreenDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("Add Screen")},_initDialogInterface:function(){this._setHeader("Fulfill Screen Information","Please fulfill the required information in order to add a new screen to the catalogue.");var a=[{type:"title",value:"Screen information"},{type:"input",label:"Label:",name:"label",value:"Label of the screen..."},{type:"input",label:"Description:",name:"description",value:"Short description of the screen..."},{type:"input",label:"Creator URL (*):",name:"creator",value:"Creator URL..."},{type:"input",label:"Rights URL (*):",name:"rights",value:"Rights URL..."},{type:"input",label:"Version:",name:"version",value:"1.0"},{type:"input",label:"Icon URL (*):",name:"icon",value:"icon URL..."},{type:"input",label:"Screenshot URL (*):",name:"screenshot",value:"Screenshot URL..."},{type:"input",label:"Domain Context:",name:"tags",value:'Write domain context as tags separated by ","...'},{type:"input",label:"Homepage (*):",name:"homepage",value:"Homepage URL..."},{type:"input",label:"Preconditions:",name:"preconditions",value:'If any, write preconditions separated by ","...'},{type:"input",label:"Postconditions:",name:"postconditions",value:'If any, write postconditions separated by ","...'},{type:"input",label:"Screen code URL (*):",name:"code",value:"Screencode URL..."},{type:"hidden",name:"creationDate",value:""},{type:"label",value:"(*): Required Field"}];this._setContent(a)},_onOk:function($super){$super();var j=new Date();var b=this._getForm();b.creationDate.setValue(Utils.getIsoDateNow(j));var f=b.serialize(true);f.label={"en-GB":b.label.getValue()};f.description={"en-GB":b.description.getValue()};var g=b.tags.getValue().split(",");for(var h=0;h<g.length;h++){var d=g[h].strip();if(d&&d!=""){g[h]=d}else{g[h]=null}}g=g.compact();f.tags=Utils.getCatalogueTags(g,null);var c=b.preconditions.getValue().split(",");for(var h=0;h<c.length;h++){var d=c[h].strip();if(d&&d!=""){c[h]=d}else{c[h]=null}}c=c.compact();f.preconditions=c;var a=b.postconditions.getValue().split(",");for(var h=0;h<a.length;h++){var d=a[h].strip();if(d&&d!=""){a[h]=d}else{a[h]=null}}a=a.compact();f.postconditions=a;console.log("Before json");console.log(f);console.log("After json");console.log(Object.toJSON(f));Catalogue.createScreen(Object.toJSON(f))}});var NewBuildingBlockDialog=Class.create(ConfirmDialog,{initialize:function($super,a){this._buildingblockName=a;this._searchURI=URIs[this._buildingblockName+"Search"];this._available=true;$super("New "+this._buildingblockName,ConfirmDialog.OK_CANCEL,{createMessageZone:true})},_initDialogInterface:function(){this._setHeader("Fulfill "+this._buildingblockName+" Information","Please fulfill the required information in order to create a new "+this._buildingblockName+".");var b=this._scheduleAvailabilityCheck.bind(this);var a=[{type:"input",label:this._buildingblockName+" Name:",name:"name",value:"",message:this._buildingblockName+"Name cannot be blank",required:true,events:{keypress:b,blur:function(){this._getForm().name.value=Utils.sanitize($F(this._getForm().name))}.bind(this)}},{type:"input",label:"Version:",name:"version",value:"",message:"Version cannot be blank",events:{keypress:b}},{type:"input",label:"Tags:",name:"tags",value:""}];this._setContent(a)},_updateAvailabilityStatus:function(){if(this._available){this._setMessage()}else{this._setMessage("Please, use a diferent Version or "+this._buildingblockName+" Name.",FormDialog.MESSAGE_ERROR)}this._setDisabled(!this._available)},_onAvailabilityCheckSuccess:function(b){var a=b.responseText.evalJSON();this._available=a.length==0;this._updateAvailabilityStatus()},_availabilityCheck:function(){var b=Utils.sanitize($F(this._getForm().name));var a=$F(this._getForm().version);if(b==""||a==""){this._available=b!="";this._updateAvailabilityStatus();return}var c={query:{type:"and",operands:[{type:"field",condition:"is",field:"name",value:b},{type:"field",condition:"is",field:"version",value:a}]},fields:["version"],limit:1};PersistenceEngine.sendPost(this._searchURI,null,Object.toJSON(c),this,this._onAvailabilityCheckSuccess,Utils.onAJAXError)},_scheduleAvailabilityCheck:function(a){if((a.charCode==0)&&(a.keyCode!=8&&a.keyCode!=46)){return}this._available=false;try{clearTimeout(this._timeout)}catch(a){}this._setMessage("Checking if the "+this._buildingblockName+" already exists...");this._timeout=setTimeout(this._availabilityCheck.bind(this),1000);this._setDisabled(true)},_onOk:function($super){if(this._validate()){$super();var c=Utils.sanitize($F(this._getForm().name));var b=$F(this._getForm().tags).split(/[\s,]+/).without("");var a=$F(this._getForm().version);var d=Utils.getCatalogueTags($A(b),null);this._create(c,d,a)}},_create:function(b,d,a){var c=GVS.getDocumentController();c["create"+this._buildingblockName](b,d,a)},_onCancel:function($super){try{clearTimeout(this._timeout)}catch(a){}$super()},_reset:function($super){$super();this._getForm().name.value="";this._getForm().tags.value="";this._getForm().version.value="";this._available=false;this._setDisabled(true);this._setMessage()}});var SaveAsDialog=Class.create(ConfirmDialog,{initialize:function($super,c,a,f,d){this._available=true;this._name=c;this._version=a;this._onOkHandler=f;var g=ConfirmDialog.OK_CANCEL;var b={createMessageZone:true};if(d){g=ConfirmDialog.OK;b.closable=false}$super("Choose new name/version",g,b)},_initDialogInterface:function(){var b=this._scheduleAvailabilityCheck.bind(this);var a=[{type:"input",label:"New Name:",name:"name",value:this._name,message:"Name cannot be blank",required:true,events:{keypress:b}},{type:"input",label:"Version:",name:"version",value:"",message:"Version cannot be blank",events:{keypress:b}},{type:"label",value:"(Previous version was "+this._version+")",style:"font-size: 95%; color: #555; padding-left: 130px"}];this._setContent(a);this._setDisabled(true);this._availabilityCheck()},_updateAvailabilityStatus:function(){if(this._available){this._setMessage()}else{this._setMessage("Please, use a diferent Version or Screen Name.",FormDialog.MESSAGE_ERROR)}this._setDisabled(!this._available)},_onAvailabilityCheckSuccess:function(b){var a=b.responseText.evalJSON();this._available=a.length==0;this._updateAvailabilityStatus()},_availabilityCheck:function(){var b=$F(this._getForm().name);var a=$F(this._getForm().version);if(b==""||a==""){this._available=b!="";this._updateAvailabilityStatus();return}var c={query:{type:"and",operands:[{type:"field",condition:"is",field:"name",value:b},{type:"field",condition:"is",field:"version",value:a}]},fields:["version"],limit:1};PersistenceEngine.sendPost(URIs.screenSearch,null,Object.toJSON(c),this,this._onAvailabilityCheckSuccess,Utils.onAJAXError)},_scheduleAvailabilityCheck:function(a){if((a.charCode==0)&&(a.keyCode!=8&&a.keyCode!=46)){return}this._available=false;try{clearTimeout(this._timeout)}catch(a){}this._setMessage("Checking if the screen already exists...");this._timeout=setTimeout(this._availabilityCheck.bind(this),1000);this._setDisabled(true)},_onOk:function($super){if(this._getFormWidget().validate()&&this._available){var b=$F(this._getForm().name);var a=$F(this._getForm().version);this._onOkHandler(b,a);$super()}},_onCancel:function($super){try{clearTimeout(this._timeout)}catch(a){}$super()}});var GalleryDialog=Class.create(FormDialog,{initialize:function($super,c,a){$super({title:c,style:"display:none;"},{buttonPosition:FormDialog.POSITION_TOP});var b=Utils.variableOrDefault(a,{});this._properties=new Hash();this._properties.set("showTitleRow",(b.showTitleRow||false));this._properties.set("elementsPerPage",(b.elementsPerPage||10));this._properties.set("onDblClick",(b.onDblClick||function(){}));this._properties.set("disableIfNotValid",(b.disableIfNotValid||false));this._fields=null;this._buttons=null;this._disabledButtons=new Array();this._rows=new Array();this._selectedRow=null},show:function(){},_setFields:function(a){this._fields=a},_setButtons:function(a){this._buttons=a},_addRow:function(a){this._rows.push(a)},_render:function(a){var c=Utils.variableOrDefault(a,true);var b=new Element("div",{"class":"gallery"});if(this._properties.get("showTitleRow")){}this._rows.each(function(k){var g=new Element("div",{"class":"row"});var j=k.values;for(var f=0;f<j.size();f++){if(!this._fields[f].hidden){var h=new Element("div",{"class":"field "+this._fields[f].className}).update(j[f]);g.appendChild(h)}}g.observe("click",function(l){$$(".gallery .row").each(function(n){n.removeClassName("selected")});var i=l.findElement(".row");i.addClassName("selected");if(k.isValid){this._disabledButtons.each(function(n){n.attr("disabled",false)})}else{this._disabledButtons.each(function(n){n.attr("disabled",true)})}this._selectedRow=k}.bind(this));if(this._properties.get("onDblClick")){if(!this._properties.get("disableIfNotValid")||k.isValid){g.observe("dblclick",function(){this._properties.get("onDblClick")(k.key)}.bind(this))}}b.appendChild(g)}.bind(this));if(c&&this._rows.size()>0){this._removeButtons();this._buttons.each(function(f){var g=this._addButton(f.value,function(){f.handler(this._selectedRow.key)}.bind(this));if(f.disableIfNotValid){this._disabledButtons.push(g)}}.bind(this))}if(!this._properties.get("showTitleRow")&&b.firstChild){b.firstChild.addClassName("selected")}if(this._rows.size()==0){var d=new Element("div",{"class":"info"}).update("Uppss....Nothing here");b.appendChild(d);this._removeButtons();this._addButton("Close",this._dialog.hide.bind(this._dialog))}else{this._selectedRow=this._rows[0];if(this._selectedRow.isValid){this._disabledButtons.each(function(f){f.attr("disabled",false)})}else{this._disabledButtons.each(function(f){f.attr("disabled",true)})}}this._setContent(b)},_emptyRows:function(){this._rows=new Array()},_show:function(){this._initDialogInterface();GVS.setEnabled(false);this._dialog.show()}});var ManageScreenflowsDialog=Class.create(GalleryDialog,{initialize:function($super){$super("Screenflow browser",{onDblClick:this._openScreenflow.bind(this),disableIfNotValid:true});this._screenflows=null},show:function(){PersistenceEngine.sendGet(URIs.screenflow,this,this._onLoadSuccess,Utils.onAJAXError)},_initDialogInterface:function(){this._setHeader("Browse your screenflows","These are the screenflows you have created. Here you can continue editing them and share your work with the community");this._setFields([{title:"Screenflow Name",className:"name"},{title:"Screenflow Version",className:"version"},{title:"Tags",className:"tags"},{title:"Description",className:"description"},{title:"Sharing",className:"sharing"}]);this._setButtons([{value:"Open screenflow",handler:this._openScreenflow.bind(this),disableIfNotValid:true},{value:"Clone screenflow",handler:this._cloneScreenflow.bind(this),disableIfNotValid:true},{value:"Share/Unshare screenflow",handler:this._shareScreenflow.bind(this)},{value:"Delete screenflow",handler:this._deleteScreenflow.bind(this)}]);this._createScreenflowList();this._render()},_createScreenflowList:function(){this._emptyRows();this._screenflows.each(function(b){var a=b.definition?true:false;a=a&&(b.uri)?false:true;this._addRow({key:b.id,values:[b.name,'<span class="bold">Version: </span>'+b.version,'<span class="bold">Tags: </span>'+b.tags.collect(function(c){return c.label["en-gb"]}).join(", "),'<span class="bold">Description </span><br />'+b.description["en-gb"],"<span class="+(b.uri?'"shared"':'"unshared"')+">&nbsp;</span>"],isValid:a})}.bind(this))},_onLoadSuccess:function(a){this._screenflows=JSON.parse(a.responseText);this._show()},_onReLoadSuccess:function(a){this._screenflows=JSON.parse(a.responseText);this._createScreenflowList();this._render(false)},_openScreenflow:function(b){var a=GVS.getDocumentController();a.loadScreenflow(b);this._dialog.hide()},_cloneScreenflow:function(b){var a=GVS.getDocumentController();a.cloneScreenflow(b);this._dialog.hide()},_shareScreenflow:function(c){var b=URIs.share.replace("<id>",c);var a=this._screenflows.detect(function(d){return d.id==c});if(a.uri){PersistenceEngine.sendDelete(b,this,this._reload,Utils.onAJAXError)}else{PersistenceEngine.sendPost(b,null,null,this,this._reload,Utils.onAJAXError)}},_deleteScreenflow:function(a){confirm("Are you sure you want to delete the screenflow? This action cannot be undone",this._confirmDelete.bind({mine:this,id:a}))},_confirmDelete:function(){var a=URIs.buildingblock+this.id;PersistenceEngine.sendDelete(a,this.mine,this.mine._reload,Utils.onAJAXError)},_addScreenflow:function(){this._dialog.hide()},_reload:function(){PersistenceEngine.sendGet(URIs.screenflow,this,this._onReLoadSuccess,Utils.onAJAXError)}});var ManageScreensDialog=Class.create(GalleryDialog,{initialize:function($super){$super("Screen browser",{onDblClick:this._openScreen.bind(this),disableIfNotValid:true});this._screens=null},show:function(){PersistenceEngine.sendGet(URIs.screen,this,this._onLoadSuccess,Utils.onAJAXError)},_initDialogInterface:function(){this._setHeader("Browse your screens","These are the screens you have created. Here you can continue editing them and share your work with the community");this._setFields([{title:"Icon",className:"icon"},{title:"Screen Name",className:"name"},{title:"Screen Version",className:"version"},{title:"Tags",className:"tags"},{title:"Description",className:"description"},{title:"Sharing",className:"sharing"}]);this._setButtons([{value:"Open screen",handler:this._openScreen.bind(this),disableIfNotValid:true},{value:"Clone screen",handler:this._cloneScreen.bind(this)},{value:"Share/Unshare screen",handler:this._shareScreen.bind(this)},{value:"Delete screen",handler:this._deleteScreen.bind(this)}]);this._createScreenList();this._render()},_createScreenList:function(){this._emptyRows();this._screens.each(function(a){var b=a.definition?true:false;b=b&&(a.uri)?false:true;this._addRow({key:a.id,values:[new Element("img",{src:a.icon}),a.name,'<span class="bold">Version: </span>'+a.version,'<span class="bold">Tags: </span>'+a.tags.collect(function(c){return c.label["en-gb"]}).join(", "),'<span class="bold">Description </span><br />'+a.description["en-gb"],"<span class="+(a.uri?'"shared"':'"unshared"')+">&nbsp;</span>"],isValid:b})}.bind(this))},_onLoadSuccess:function(a){this._screens=JSON.parse(a.responseText);this._show()},_onReLoadSuccess:function(a){this._screens=JSON.parse(a.responseText);this._createScreenList();this._render(false)},_openScreen:function(b){var a=GVS.getDocumentController();a.loadScreen(b);this._dialog.hide()},_cloneScreen:function(b){var a=GVS.getDocumentController();a.cloneScreen(b);this._dialog.hide()},_shareScreen:function(c){var b=URIs.share.replace("<id>",c);var a=this._screens.detect(function(d){return d.id==c});if(a.uri){PersistenceEngine.sendDelete(b,this,this._reload,Utils.onAJAXError)}else{PersistenceEngine.sendPost(b,null,null,this,this._reload,Utils.onAJAXError)}},_deleteScreen:function(a){confirm("Are you sure you want to delete the screen? This action cannot be undone",this._confirmDelete.bind({mine:this,id:a}))},_confirmDelete:function(){var a=URIs.buildingblock+this.id;PersistenceEngine.sendDelete(a,this.mine,this.mine._reload,Utils.onAJAXError)},_addScreen:function(){this._dialog.hide()},_reload:function(){PersistenceEngine.sendGet(URIs.screen,this,this._onReLoadSuccess,Utils.onAJAXError)}});var PreviewDialog=Class.create(ConfirmDialog,{initialize:function($super,b,a){$super("Preview of "+b,ConfirmDialog.OK);this._setContent(a)},_initDialogInterface:function(){}});var TriggerDialog=Class.create(ConfirmDialog,{initialize:function($super,c,b,d,a){$super("Assign triggers to "+c);this._actionName=c;this._initialTriggerList=b;this._canvasInstances=d;this._onChangeCallback=a;this._button=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});this._unselectedTriggerListNode=null;this._selectedTriggerListNode=null;this._addTriggerButton=null;this._removeTriggerButton=null},getButtonNode:function(){return new Element("div",{"class":"triggerButton"}).update(this._button.domNode)},_initDialogInterface:function(){var f=new Element("div",{"class":"triggerDialog"});var i=new Element("h2").update("Choose triggers for action: "+this._actionName);f.appendChild(i);var b=new Element("div",{"class":"subtitle"});var g=new Element("div",{style:"float:left"}).update("Selected triggers");b.appendChild(g);var h=new Element("div",{style:"float:right"}).update("Unselected triggers");b.appendChild(h);f.appendChild(b);this._selectedTriggerListNode=new Element("select",{multiple:"multiple"});this._selectedTriggerListNode.observe("change",this._onListChange.bind(this));var c=false;if(this._initialTriggerList){this._initialTriggerList.each(function(j){var k=new Element("option",{value:j.getSourceInstance().getId()+"#"+j.getTriggerName()}).update(j.getSourceInstance().getTitle()+": "+j.getTriggerName());this._selectedTriggerListNode.appendChild(k);if(j.constructor==ScreenTrigger){c=true}}.bind(this))}f.appendChild(this._selectedTriggerListNode);var a=new Element("div",{"class":"addRemoveZone"});this._addTriggerButton=new dijit.form.Button({iconClass:"plusIcon",showLabel:true,label:"<",style:"width:25px",onClick:this._onAddTrigger.bind(this)});a.appendChild(this._addTriggerButton.domNode);this._removeTriggerButton=new dijit.form.Button({iconClass:"minusIcon",showLabel:true,label:">",style:"width:25px",onClick:this._onRemoveTrigger.bind(this)});a.appendChild(this._removeTriggerButton.domNode);f.appendChild(a);this._unselectedTriggerListNode=new Element("select",{multiple:"multiple"});this._unselectedTriggerListNode.observe("change",this._onListChange.bind(this));if(!c){var d=new Element("option",{value:ScreenTrigger.INSTANCE_NAME+"#"+ScreenTrigger.ONLOAD}).update(ScreenTrigger.INSTANCE_NAME+": "+ScreenTrigger.ONLOAD);this._unselectedTriggerListNode.appendChild(d)}this._canvasInstances.each(function(j){j.getBuildingBlockDescription().triggers.each(function(k){var n=false;if(this._initialTriggerList){n=this._initialTriggerList.detect(function(o){return(j.getId()+k)==(o.getSourceId()+o.getTriggerName())})}if(!n){var l=new Element("option",{value:j.getId()+"#"+k}).update(j.getTitle()+": "+k);this._unselectedTriggerListNode.appendChild(l)}}.bind(this))}.bind(this));f.appendChild(this._unselectedTriggerListNode);this._setContent(f);this._onListChange()},_onAddTrigger:function(){var a=this._getSelectionItems(this._unselectedTriggerListNode);a.each(function(b){b.parentNode.removeChild(b);this._selectedTriggerListNode.appendChild(b)}.bind(this));this._onListChange()},_onRemoveTrigger:function(){var a=this._getSelectionItems(this._selectedTriggerListNode);a.each(function(b){b.parentNode.removeChild(b);this._unselectedTriggerListNode.appendChild(b)}.bind(this));this._onListChange()},_onOk:function($super){$super();var b=new Array();$A(this._selectedTriggerListNode.options).each(function(c){if(this._initialTriggerList){var d=this._initialTriggerList.detect(function(f){return(c.value)==(f.getSourceId()+"#"+f.getTriggerName())});if(d==null){b.push(c.value)}}else{b.push(c.value)}}.bind(this));var a=new Array();$A(this._unselectedTriggerListNode.options).each(function(c){if(this._initialTriggerList){var d=this._initialTriggerList.detect(function(f){return(c.value)==(f.getSourceId()+"#"+f.getTriggerName())});if(d){a.push(c.value)}}}.bind(this));this._onChangeCallback(this._actionName,b,a)},_onListChange:function(b){var a=null;if(b){a=b.element()}if(this._unselectedTriggerListNode==a){this._unselectAll(this._selectedTriggerListNode)}if(this._selectedTriggerListNode==a){this._unselectAll(this._unselectedTriggerListNode)}if(this._selectedTriggerListNode.selectedIndex==-1){this._removeTriggerButton.attr("disabled",true)}else{this._removeTriggerButton.attr("disabled",false)}if(this._unselectedTriggerListNode.selectedIndex==-1){this._addTriggerButton.attr("disabled",true)}else{this._addTriggerButton.attr("disabled",false)}},_getSelectionItems:function(a){var b=new Array();while(a.selectedIndex!=-1){b.push(a.options[a.selectedIndex]);a.options[a.selectedIndex].selected=false}return b},_unselectAll:function(a){while(a.selectedIndex!=-1){a.options[a.selectedIndex].selected=false}}});var ParamsDialog=Class.create(ConfirmDialog,{initialize:function($super,c,b,d,a){$super(c+" Parameters");this._buildingblockName=c;this._initialParameter=b;this._templateParameter=d;this._textarea=new dijit.form.SimpleTextarea();this._textarea.domNode.addClassName("parameterArea");this._textarea.setValue(this._initialParameter);this._tooltipButton=new Element("div",{"class":"initialParameterButton"}).update("&nbsp;");this._tooltipButton.observe("click",function(){var f=new ExternalContentDialog("Example parameter configuration");f.show(new Element("pre").update(this._templateParameter))}.bind(this));this._templateParameterTooltip=new dijit.Tooltip({connectId:[this._tooltipButton],label:"<h4> Example parameter configuration </h4><pre>"+this._templateParameter+"</pre>"});this._onChangeCallback=a},getButtonNode:function(){var a=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});return new Element("div",{"class":"triggerButton"}).update(a.domNode)},_initDialogInterface:function(){var a=new Element("div",{"class":"paramsDialog"});var b=new Element("h2").update("Edit "+this._buildingblockName+" parameters:");a.appendChild(b);a.appendChild(this._textarea.domNode);if(this._templateParameter){a.appendChild(this._tooltipButton)}this._setContent(a)},_onOk:function($super){$super();this._onChangeCallback(this._textarea.getValue())}});var PropertiesDialog=Class.create(ConfirmDialog,{initialize:function($super,a,b,c){this._title=a+" Properties";this._description=b;this._onFinishHandler=null;this._onChangeHandler=c;$super(this._title)},show:function($super,a){var b=Utils.variableOrDefault(a,null);this._onFinishHandler=b;$super()},_initDialogInterface:function(){this._setHeader(this._title);var a=[{type:"title",value:"Basic information"},{type:"input",label:"Building block name:",name:"name",value:this._description.name,required:true,events:{blur:function(){this._getForm().name.value=Utils.sanitize($F(this._getForm().name))}.bind(this)}},{type:"input",label:"Version:",name:"version",value:this._description.version},{type:"input",label:"Tags:",name:"tags",value:this._description.tags.collect(function(b){return b.label["en-gb"]}).join(", ")},{type:"title",value:"Sharing information"},{type:"input",label:"Description:",name:"description",value:this._description.description["en-gb"],required:true},{type:"input",label:"Creator:",name:"creator",value:this._description.creator,required:true,disabled:true},{type:"input",label:"Licence information:",name:"rights",value:this._description.rights,required:true},{type:"input",label:"Icon:",name:"icon",value:this._description.icon,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Screenshot:",name:"screenshot",value:this._description.screenshot,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Homepage:",name:"homepage",value:this._description.homepage,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"}];this._setContent(a)},_onOk:function($super){if(this._getFormWidget().validate()){var a=$F(this._getForm().tags).split(/[\s,]+/).without("");var c={tags:Utils.getCatalogueTags(a,null),description:{"en-gb":$F(this._getForm().description)},label:{"en-gb":Utils.sanitize($F(this._getForm().name))},name:Utils.sanitize($F(this._getForm().name))};var b=this._getForm();var d=[b.version,b.creator,b.rights,b.icon,b.screenshot,b.homepage];Object.extend(c,Form.serializeElements(d,{hash:true}));var f=false;$H(c).each(function(g){if(this._description[g.key]!=g.value){f=true}}.bind(this));this._description.addProperties(c);$super();if(f){this._onChangeHandler()}if(this._onFinishHandler&&this._onFinishHandler instanceof Function){this._onFinishHandler();this._onFinishHandler=null}}},_reset:function($super){this._handler=null;$super()}});var AlertSingleton=function(){var a=null;var b=Class.create(FormDialog,{initialize:function($super){$super({title:"Warning",style:"display:none"});this._contentNode.addClassName("systemDialog");this._addButton("Ok",function(){this._dialog.hide()}.bind(this))},show:function($super,c){this._contentNode.update(c);$super()},_initDialogInterface:function(){}});return new function(){this.getInstance=function(){if(a==null){a=new b()}return a}}}();if(document.getElementById){window.alert=function(a){AlertSingleton.getInstance().show(a);console.log(a)}}var ConfirmSingleton=function(){var b=null;var a=Class.create(ConfirmDialog,{initialize:function($super){$super("Warning");this._callback=null;this._contentNode.addClassName("systemDialog")},show:function($super,c,d){this._contentNode.update(c);$super();this._callback=d},_onOk:function($super){this._callback(true);this._callback=null;$super()},_onCancel:function($super){this._callback(false);this._callback=null;$super()},_initDialogInterface:function(){},_hide:function($super){$super();if(this._callback){this._callback(false);this._callback=null}}});return new function(){this.getInstance=function(){if(b==null){b=new a()}return b}}}();if(document.getElementById){var browserConfirm=window.confirm;window.confirm=function(b,a){if(a){ConfirmSingleton.getInstance().show(b,a)}else{browserConfirm(b)}}}var PlanPanel=Class.create(SetListener,{initialize:function(){this._node=new Element("div",{"class":"panel plans",style:"display:none"});this._plansZone=null;this._planSet=new PlanSet();this._planSet.setListener(this);this._visible=false;this._dropZone=null;this._inferenceEngine=null;this._createContent()},getNode:function(){return this._node},setDropZone:function(a){this._dropZone=a},setInferenceEngine:function(a){this._inferenceEngine=a},hide:function(){dojox.fx.wipeOut({node:this._node,duration:300,onAnimate:this._updateDropArea.bind(this),onEnd:this._showDropArea.bind(this)}).play();this._visible=false},isVisible:function(){return this._visible},showPlans:function(a){this._planSet.setPlans(a)},setChanged:function(){var a=new Array();this._planSet.getBuildingBlocks().each(function(b){a.push(new PlanComponent(b,this._dropZone,this._inferenceEngine))}.bind(this));this._plansZone.update("");a.each(function(b){this._plansZone.appendChild(b.getNode())}.bind(this));this._show()},_show:function(){dojox.fx.wipeTo({node:this._node,duration:300,height:200,onAnimate:this._updateDropArea.bind(this),onEnd:this._updateDropArea.bind(this)}).play();this._visible=true},_updateDropArea:function(){var a=(parseInt(this._node.clientHeight)+1)+"px";this._dropZone.getNode().setStyle({top:a})},_showDropArea:function(){this._dropZone.getNode().setStyle({top:"0px"})},_createContent:function(){var b=new Element("div");this._node.appendChild(b);var f=new Element("div",{"class":"dijitAccordionTitle"}).update("Available plans for the selected screen");b.appendChild(f);var d="Please drag & drop one of these sets of screens into ";d+="the screenflow area, to make the selected screen ";d+="reachable. ";var a=new Element("div",{"class":"text"}).update(d);b.appendChild(a);this._plansZone=new Element("div",{"class":"planZone"});b.appendChild(this._plansZone);var c=new Element("div",{"class":"button"});Element.observe(c,"click",function(g){g.stop();this.hide()}.bind(this));b.appendChild(c)}});var PlanSet=Class.create(BuildingBlockSet,{initialize:function($super){$super([]);this._plans=new Array();this._factory=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN)},getBuildingBlocks:function(){var a=new Array();this._plans.each(function(b){a.push(this._factory.getBuildingBlocks(b))}.bind(this));return a},setPlans:function(b){this._plans=b.splice(0,10);var a=this._plans.flatten().uniq();this._factory.cacheBuildingBlocks(a,this._cachedElements.bind(this))},_cachedElements:function(){this._listener.setChanged()}});var PlanComponent=Class.create(DragSource,{initialize:function($super,b,c,a){$super();this._dropZone=c;this._plan=b;this._inferenceEngine=a;this._view=new PlanView(this._plan);this._node=this._view.getNode();this.enableDragNDrop(null,[this._dropZone])},getNode:function(){return this._node},getHandlerNode:function(){return this._node},getDraggableObject:function(){var a=new PlanInstance(this._plan,this._inferenceEngine);var b=a.getHandlerNode();dijit.byId("main").domNode.appendChild(b);b.setStyle({top:this._getContentOffsetTop()+"px",left:this._getContentOffsetLeft()+"px",position:"absolute"});return a},_getContentOffsetTop:function(){return this._node.cumulativeOffset().top-this._node.cumulativeScrollOffset().top},_getContentOffsetLeft:function(){return this._node.cumulativeOffset().left-this._node.cumulativeScrollOffset().left}});var PlanView=Class.create(BuildingBlockView,{initialize:function($super,d){$super();this._node=new Element("div",{"class":"plan view"});var a=0;d.each(function(g){var f=new ScreenView(g);this._node.appendChild(f.getNode());a++}.bind(this));var b=102*a+6*a;var c=b+"px";this._node.setStyle({width:c})},setReachability:function(a){},destroy:function(){}});var PlanInstance=Class.create(ComponentInstance,{initialize:function($super,c,a,b){this._plan=c;$super([],a,b)},getTitle:function(){return""},getInfo:function(){return new Hash()},getUri:function(){return""},getPlanElements:function(){return this._plan},_createView:function(){return new PlanView(this._plan)}});var Builder=Class.create({initialize:function(){this._buildGadgetDialog=new BuildGadgetDialog(this._onBuildGadgetDialogCallback.bind(this));this._publishGadgetDialog=new PublishGadgetDialog();this._description=null},buildGadget:function(a){this._description=a;this._buildGadgetDialog.show({name:this._description.name,shortname:this._description.name,desc:this._description.description["en-gb"],owner:GVS.getUser().getUserName()})},_onBuildGadgetDialogCallback:function(c){var b=Object.extend(c,{description:{"en-gb":c.desc},uri:"buildingblock/"+this._description.getId(),label:{"en-gb":c.name},id:this._description.getId()});var a={gadget:Object.toJSON(b),screenflow:this._description.getId()};PersistenceEngine.sendPost(URIs.store,a,null,this,this._onBuildSuccess,this._onError)},_onBuildSuccess:function(c){var a=JSON.parse(c.responseText);var b=a.gadgetUri;this._publishGadgetDialog.show(b)},_onError:function(b,a){Logger.serverError(b,a)}});var User=Class.create({initialize:function(){this._userName=null;this._firstName=null;this._lastName=null;this._email=null;this._ezWebURL=null;this._getUser()},getUserName:function(){return this._userName},getFirstName:function(){return this._firstName},getLastName:function(){return this._lastName},getEmail:function(){return this._email},getEzWebURL:function(){return this._ezWebURL},getRealName:function(){return this._firstName+" "+this._lastName},update:function(a){this._firstName=a.firstName;this._lastName=a.lastName;this._email=a.email;this._ezWebURL=a.ezWebURL;if(this._ezWebURL[this._ezWebURL.length-1]!="/"){this._ezWebURL+="/"}URIs.ezweb=this._ezWebURL;this._updateUser()},_getUser:function(){var b=function(c){var d=JSON.parse(c.responseText);this._userName=d.user.username;this._firstName=d.user.first_name;this._lastName=d.user.last_name;this._email=d.user.email;this._ezWebURL=d.profile.ezweb_url;if(this._ezWebURL[this._ezWebURL.length-1]!="/"){this._ezWebURL+="/"}URIs.ezweb=this._ezWebURL};var a=function(c,d){Logger.serverError(c,d)};PersistenceEngine.sendGet(URIs.userPreferences,this,b,a)},_updateUser:function(){var d=function(f){};var c=function(f){Logger.serverError(f,e)};var b={first_name:this._firstName,last_name:this._lastName,email:this._email,ezweb_url:this._ezWebURL};var a={preferences:Object.toJSON(b)};PersistenceEngine.sendUpdate(URIs.userPreferences,a,null,this,d,c)}});var RecommendationManager=Class.create({initialize:function(){this._recommendations=new Hash();this._activeRecommendations=new Hash();this._currentRecommendation=1;this._step=0;this._startTimespam=0;this._timeout=null},addRecommendation:function(b,a){if(this._recommendations.get(b.key)==undefined){this._recommendations.set(b.key,{className:"recommendation"+this._currentRecommendation++,localNode:b.node,externalNodes:[],nodes:[b.node]})}var c=this._recommendations.get(b.key);c.externalNodes.push(a.node);c.nodes.push(a.node);this._dirty=true},setStartFact:function(a){this._clear();this._stopAnimation();this._startFact=a;this._dirty=true;if(this._startFact){this.startAnimation()}},startAnimation:function(){var a=this._startFact?null:3000;this._clear();this._stopAnimation();if(this._dirty){this._filterRecommendations()}this._startAnimation(a)},clear:function(){this._clear();this._stopAnimation();this._recommendations=new Hash();this._activeRecommendations=new Hash();this._currentRecommendation=1;this._dirty=false},_filterRecommendations:function(){if(this._startFact){this._activeRecommendations=new Hash();var a=this._recommendations.get(this._startFact);if(a){this._activeRecommendations.set(this._startFact,a)}}else{this._activeRecommendations=this._recommendations}this._dirty=false},_clear:function(){this._recommendations.each(function(c){var a=c.value.nodes;var b=c.value.className;a.each(function(d){d.removeClassName(b);d.getElementsByClassName("recommendationLayer")[0].style.opacity=""}.bind(this))}.bind(this))},_stopAnimation:function(){try{this._startTimestamp=0;clearTimeout(this._timeout)}catch(a){}},_startAnimation:function(b){this._activeRecommendations.each(function(f){var c;if(this._startFact){c=f.value.externalNodes}else{c=f.value.nodes}var d=f.value.className;c.each(function(g){g.getElementsByClassName("recommendationLayer")[0].style.opacity=0;g.addClassName(d)}.bind(this))}.bind(this));this._step=0;this._duration=b;var a=new Date();this._startTimestamp=a.getTime();this._timeout=setTimeout(this._timeoutCallback.bind(this),100)},_timeoutCallback:function(){var a=false;var c=Math.sin(Math.PI*this._step/10);c*=c;if(c<0.1){var b=new Date();if(this._duration&&((b.getTime()-this._startTimestamp)>this._duration)){a=true;c=0}}this._activeRecommendations.each(function(g){var d=g.value.nodes;var f=g.value.className;d.each(function(h){h.getElementsByClassName("recommendationLayer")[0].style.opacity=c}.bind(this))}.bind(this));if(!a){this._step++;this._timeout=setTimeout(this._timeoutCallback.bind(this),100)}}});var UIDGenerator=Class.create();Object.extend(UIDGenerator,{_nextIds:new Object()});Object.extend(UIDGenerator,{generate:function(a){var c=a.replace(new RegExp("\\s","g"),"").replace("_","");var b=this._nextIds[c];if(!b){b=1}this._nextIds[c]=b+1;return c+"_"+b},setStartId:function(d){var b=d.split("_");var a=b[0];var c=parseInt(b[1]);if(!this._nextIds[a]||this._nextIds[a]<=c){this._nextIds[a]=c+1}}});var BrowserUtils=Class.create();Object.extend(BrowserUtils,{getHeight:function(){var a=window.innerHeight;if(document.documentElement&&document.documentElement.clientHeight){a=document.documentElement.clientHeight}else{if(document.body&&document.body.clientHeight){a=document.body.clientHeight}}return a},getWidth:function(){var a=window.innerWidth;if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){a=document.documentElement.clientWidth}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){a=document.body.clientWidth}}return a},isLeftButton:function(a){if(a==0||(this.isIE()&&a==1)){return true}else{return false}},isIE:function(){if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){return true}else{return false}}});var Utils=Class.create();Object.extend(Utils,{getIsoDateNow:function(b){var a=b.toJSON();a=a.replace(/"/,"");if(a.endsWith('Z"')){a=a.truncate(-2,"");a=a+"+0000"}return a},ezWebDeploy:function(a,c){var b=dijit.byId(a.id);b.attr("label","Done!");b.attr("disabled",true);window.open(URIs.ezweb+"interfaces/gadget?template_uri="+c);console.log(URIs.ezweb+"interfaces/gadget?template_uri="+c)},igoogleDeploy:function(a){alert("iGoogle Deployment service being developed (<a href='"+a+"'>"+a+"</a>)")},addProperties:function(b,a){if(a){$H(a).clone().each(function(c){b[c.key]=c.value})}},setSatisfeabilityClass:function(b,a){if(a===null||a===undefined){b.removeClassName("satisfeable");b.removeClassName("unsatisfeable")}else{b.removeClassName(a?"unsatisfeable":"satisfeable");b.addClassName(a?"satisfeable":"unsatisfeable")}},extractURIfromPattern:function(b){if(b){var a=b.split(" ");return a[2]}else{return""}},onAJAXError:function(b,a){Logger.serverError(b,a)},getPosition:function(a){var c=0;var b=0;while(a.offsetParent){c+=a.offsetLeft-a.scrollLeft;b+=a.offsetTop-a.scrollTop;a=a.offsetParent}c+=a.offsetLeft;b+=a.offsetTop;return{left:c,top:b}},showMessage:function(c,b){$("messages").removeClassName("error");$("messages").removeClassName("hidden");$("messages").update(c);var a=Math.floor(($("header").clientWidth/2)-($("messages").clientWidth/2));$("messages").setStyle({opacity:"1",left:a+"px"});if(b){if(b.error){$("messages").addClassName("error")}if(b.hide){dojo.fadeOut({duration:2500,node:$("messages")}).play(b.error?2500:1500)}}},variableOrDefault:function(c,b){var a=c;if(a===undefined){a=b}return a},getCatalogueTags:function(c,b){var a=new Array();c.each(function(d){a.push({label:{"en-gb":d}})});return a},sanitize:function(b){var a=b.replace(/^\s+|\n|\s+$/g,"");a=a.replace(/\s+/g," ");return a}});var Logger=Class.create();Object.extend(Logger,{serverError:function(c,a){var b;if(a){b="JavaScript exception on file #{errorFile} (line: #{errorLine}): #{errorDesc}".interpolate({errorFile:a.fileName,errorLine:a.lineNumber,errorDesc:a})}else{if(c.responseXML){b=c.responseXML.documentElement.textContent}else{try{m=JSON.parse(c.responseText);b=m.message}catch(a){}if(!b){b="HTTP Error #{status} - #{text}".interpolate({status:c.status,text:c.statusText})}}}console.log(b)}});var KeyPressRegistry=Class.create({initialize:function(){this._handlers=new Hash();this._enabled=true;this.setEnabled(this._enabled)},addHandler:function(a,c){var b=a.toLowerCase();if(this._handlers.get(b)){shortcut.remove(b)}this._handlers.set(b,c);shortcut.add(b,this._executeHandler.bind(this),{disable_in_input:true})},isRegistered:function(a){return(this._handler.get(a)?true:false)},removeHandler:function(a){var b=a.toLowerCase();this._handlers.unset(b)},setEnabled:function(a){this._enabled=a},_executeHandler:function(b,a){if(this._enabled&&this._handlers.get(a)){this._handlers.get(a)(a)}}});var Geometry=Class.create();Object.extend(Geometry,{updateAxis:function(c,f,d){function b(h,j,i){var g=new Object();if(j>h){g.delta=h;g.offLimit=i+(j-h)}else{if(i<0){if(j+i>0){g.delta=j+i;g.offLimit=0}else{g.delta=0;g.offLimit=j+i}}else{g.delta=j;g.offLimit=i}}return g}if(f>=0){return b(c.max,f,d)}else{var a=b(-c.min,-f,-d);a.delta=-a.delta;a.offLimit=-a.offLimit;return a}},contains:function(a,b){return(b.left>=a.left)&&(b.top>=a.top)&&(b.right<=a.right)&&(b.bottom<=a.bottom)},intersects:function(a,b){return !((b.bottom<a.top)||(b.left>a.right)||(b.top>a.bottom)||(b.right<a.left))},getRectangle:function(b){var a=Utils.getPosition(b);return{top:a.top,left:a.left,bottom:a.top+b.offsetHeight,right:a.left+b.offsetWidth}},getClientRectangle:function(d){var c=document.defaultView.getComputedStyle(d,null);var f=c.getPropertyCSSValue("border-top-width").getFloatValue(CSSPrimitiveValue.CSS_PX);var b=c.getPropertyCSSValue("border-left-width").getFloatValue(CSSPrimitiveValue.CSS_PX);var a=Utils.getPosition(d);return{top:a.top+f,left:a.left+b,bottom:a.top+d.clientHeight,right:a.left+d.clientWidth}},dragRanges:function(a,b){return{x:{min:Math.min(-b.left,0),max:Math.max((a.right-a.left)-b.right,0)},y:{min:Math.min(-b.top,0),max:Math.max((a.bottom-a.top)-b.bottom,0)}}},adaptDropPosition:function(g,f){var c=this.getRectangle(f);var b=this.getClientRectangle(g);var d=c.right-c.left;var a=c.bottom-c.top;if(c.right>b.right){c.left=b.right-d}if(c.left<b.left){c.left=b.left}if(c.bottom>b.bottom){c.top=b.bottom-a}if(c.top<b.top){c.top=b.top}return{left:c.left-b.left,top:c.top-b.top}},adaptInitialPosition:function(g,f,d){var c={top:0,left:0,right:g.offsetWidth,bottom:g.offsetHeight};var b={top:d.top,left:d.left,right:d.left+f.clientWidth,bottom:d.top+f.clientHeight};var a={top:d.top,left:d.left};if(b.right>c.right){a.left=c.right-f.offsetWidth}if(b.left<c.left){a.left=c.left}if(b.bottom>c.bottom){a.top=c.bottom-f.offsetHeight}if(b.top<c.top){a.top=c.top}return a}});var Constants={BuildingBlock:{SCREEN:"screen",SCREENFLOW:"screenflow",DOMAIN_CONCEPT:"domainConcept",FORM:"form",OPERATOR:"operator",RESOURCE:"resource"},BuildingBlockNames:{screen:"Screens",domainConcept:"Domain Concepts",form:"Forms",operator:"Operators",resource:"Services & Resources"}};Constants.CatalogueRelationships={backendservices:Constants.BuildingBlock.RESOURCE,forms:Constants.BuildingBlock.FORM,operators:Constants.BuildingBlock.OPERATOR};var GVS=Class.create(ToolbarModel,{initialize:function($super){$super();this._documentController=null;this._actions=null;this._user=new User();this._dialogs=new Hash();this._menuConfig=null},init:function(){this._dialogs.set("addScreen",new AddScreenDialog());this._dialogs.set("newScreenflow",new NewBuildingBlockDialog("Screenflow"));this._dialogs.set("newScreen",new NewBuildingBlockDialog("Screen"));this._dialogs.set("browseScreenflows",new ManageScreenflowsDialog());this._dialogs.set("browseScreens",new ManageScreensDialog());this._dialogs.set("preferences",new PreferencesDialog());this._actions={newScreenflow:this._newScreenflow.bind(this),addScreen:this._addScreen.bind(this),newScreen:this._newScreen.bind(this),browseScreenflows:this._browseScreenflows.bind(this),browseScreens:this._browseScreens.bind(this),showAbout:this._showAboutDialog.bind(this),wrapperService:this._openWrapperService.bind(this)};this._documentController=new DocumentController();this._addToolbarButtons();this._setMenuItems();this._documentController.getToolbar().setModel(0,this);this._documentController.getMenu().setModel("GVS",this)},action:function(a){if(this._actions[a]){this._actions[a]()}else{alert("This function is being implemented. Stay tuned")}},getDocumentController:function(){return this._documentController},getUser:function(){return this._user},setEnabled:function(a){this._documentController.getKeyPressRegistry().setEnabled(a)},getMenuElements:function(){return this._menuConfig},_newScreenflow:function(){this._dialogs.get("newScreenflow").show()},_newScreen:function(){this._dialogs.get("newScreen").show()},_addScreen:function(){this._dialogs.get("addScreen").show()},_browseScreenflows:function(){this._dialogs.get("browseScreenflows").show()},_browseScreens:function(){this._dialogs.get("browseScreens").show()},_openWrapperService:function(){this._documentController.openWrapperService()},_addToolbarButtons:function(){this._addToolbarElement("home",new ToolbarButton("Home","home",this._documentController.showWelcomeDocument.bind(this._documentController)));var a=this._dialogs.get("preferences");this._addToolbarElement("preferences",new ToolbarButton("User Preferences","preferences",a.show.bind(a)))},_showAboutDialog:function(){PersistenceEngine.sendGet(URIs.about,this,this._onSuccessAbout,Utils.onAJAXError)},_onSuccessAbout:function(b){var a=new ExternalContentDialog("About GVS");a.show(b.responseText)},_setMenuItems:function(){this._menuConfig={file:{type:"SubMenu",label:"File",weight:1,children:{"new":{type:"SubMenu",label:"New...",weight:1,group:0,children:{newScreenflow:{type:"Action",action:new MenuAction({label:"Screenflow",weight:1,handler:function(){this.action("newScreenflow")}.bind(this),shortcut:"Shift+N"}),group:0},newScreen:{type:"Action",action:new MenuAction({label:"Screen",weight:10,handler:function(){this.action("newScreen")}.bind(this),shortcut:"Alt+N"}),group:0}}},browse:{type:"SubMenu",label:"Browse...",weight:2,group:0,children:{browseScreenflows:{type:"Action",action:new MenuAction({label:"Screenflows",weight:2,handler:function(){this.action("browseScreenflows")}.bind(this),shortcut:"Shift+O"}),group:0},browseScreens:{type:"Action",action:new MenuAction({label:"Screens",weight:10,handler:function(){this.action("browseScreens")}.bind(this),shortcut:"Alt+N"}),group:0}}}}},edit:{type:"SubMenu",weight:2,label:"Edit",children:{preferences:{type:"Action",action:new MenuAction({label:"User Preferences",weight:1,handler:function(){this._dialogs.get("preferences").show()}.bind(this)}),group:1}}},help:{type:"Submenu",weight:MenuElement.MAXIMUM_WEIGHT,label:"Help",children:{website:{type:"Action",action:new MenuAction({label:"Fast Website",weight:1,handler:function(){window.open("http://fast.morfeo-project.eu")}}),group:0},about:{type:"Action",action:new MenuAction({label:"About GVS",weight:2,handler:function(){this.action("showAbout")}.bind(this)}),group:0}}}};if(!GlobalOptions.isPublicDemo){}}});GVS=new GVS();