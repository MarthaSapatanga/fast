if(!this.JSON){this.JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());var cjson_parse=(function(){var d,b,a={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},p,n=function(q){throw {name:"SyntaxError",message:q,at:d,text:p}},h=function(q){if(q&&q!==b){n("Expected '"+q+"' instead of '"+b+"'")}b=p.charAt(d);d+=1;return b},g=function(){var r,q="";if(b==="-"){q="-";h("-")}while(b>="0"&&b<="9"){q+=b;h()}if(b==="."){q+=".";while(h()&&b>="0"&&b<="9"){q+=b}}if(b==="e"||b==="E"){q+=b;h();if(b==="-"||b==="+"){q+=b;h()}while(b>="0"&&b<="9"){q+=b;h()}}r=+q;if(isNaN(r)){n("Bad number")}else{return r}},j=function(){if(b==="/"){h();if(b==="/"){while(h()){if(b==="\n"){h();return}}}else{if(b==="*"){while(h()){if(b==="*"){while(b==="*"){h()}if(b==="/"){h();return}}}}}}n("Bad comment")},i=function(){var t,s,r="",q;if(b==='"'){while(h()){if(b==='"'){h();return r}else{if(b==="\\"){h();if(b==="u"){q=0;for(s=0;s<4;s+=1){t=parseInt(h(),16);if(!isFinite(t)){break}q=q*16+t}r+=String.fromCharCode(q)}else{if(typeof a[b]==="string"){r+=a[b]}else{break}}}else{r+=b}}}}n("Bad string")},l=function(){while(b&&(b<=" "||b==="/")){if(b==="/"){j()}else{h()}}},c=function(){switch(b){case"t":h("t");h("r");h("u");h("e");return true;case"f":h("f");h("a");h("l");h("s");h("e");return false;case"n":h("n");h("u");h("l");h("l");return null}n("Unexpected '"+b+"'")},o,k=function(){var q=[];if(b==="["){h("[");l();if(b==="]"){h("]");return q}while(b){q.push(o());l();if(b==="]"){h("]");return q}h(",");l()}}n("Bad array")},f=function(){var r,q={};if(b==="{"){h("{");l();if(b==="}"){h("}");return q}while(b){r=i();l();h(":");if(Object.hasOwnProperty.call(q,r)){n('Duplicate key "'+r+'"')}q[r]=o();l();if(b==="}"){h("}");return q}h(",");l()}}n("Bad object")};o=function(){l();switch(b){case"{":return f();case"[":return k();case'"':return i();case"-":return g();default:return b>="0"&&b<="9"?g():c()}};return function(t,r){var q;p=t;d=0;b=" ";q=o();l();if(b){n("Syntax error")}return typeof r==="function"?(function s(y,x){var w,u,z=y[x];if(z&&typeof z==="object"){for(w in z){if(Object.hasOwnProperty.call(z,w)){u=s(z,w);if(u!==undefined){z[w]=u}else{delete z[w]}}}}return r.call(y,x,z)}({"":q},"")):q}}());var CodeMirrorConfig=window.CodeMirrorConfig||{};var CodeMirror=(function(){function h(i,k){for(var j in k){if(!i.hasOwnProperty(j)){i[j]=k[j]}}}function f(l,k){for(var j=0;j<l.length;j++){k(l[j])}}function b(i){if(document.createElementNS&&document.documentElement.namespaceURI!==null){return document.createElementNS("http://www.w3.org/1999/xhtml",i)}else{return document.createElement(i)}}h(CodeMirrorConfig,{stylesheet:[],path:"",parserfile:[],basefiles:["util.js","stringstream.js","select.js","undo.js","editor.js","tokenize.js"],iframeClass:null,passDelay:200,passTime:50,lineNumberDelay:200,lineNumberTime:50,continuousScanning:false,saveFunction:null,onLoad:null,onChange:null,undoDepth:50,undoDelay:800,disableSpellcheck:true,textWrapping:true,readOnly:false,width:"",height:"300px",minHeight:100,autoMatchParens:false,parserConfig:null,tabMode:"indent",enterMode:"indent",electricChars:true,reindentOnLoad:false,activeTokens:null,onCursorActivity:null,lineNumbers:false,firstLineNumber:1,onLineNumberClick:null,indentUnit:2,domain:null,noScriptCaching:false});function c(j,k){var n=b("div"),i=b("div");n.style.position="absolute";n.style.height="100%";if(n.style.setExpression){try{n.style.setExpression("height","this.previousSibling.offsetHeight + 'px'")}catch(l){}}n.style.top="0px";n.style.left="0px";n.style.overflow="hidden";j.appendChild(n);i.className="CodeMirror-line-numbers";n.appendChild(i);i.innerHTML="<div>"+k+"</div>";return n}function g(i){if(typeof i.parserfile=="string"){i.parserfile=[i.parserfile]}if(typeof i.basefiles=="string"){i.basefiles=[i.basefiles]}if(typeof i.stylesheet=="string"){i.stylesheet=[i.stylesheet]}var j=['<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html><head>'];j.push('<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>');var k=i.noScriptCaching?"?nocache="+new Date().getTime().toString(16):"";f(i.stylesheet,function(l){j.push('<link rel="stylesheet" type="text/css" href="'+l+k+'"/>')});f(i.basefiles.concat(i.parserfile),function(l){if(!/^https?:/.test(l)){l=i.path+l}j.push('<script type="text/javascript" src="'+l+k+'"><\/script>')});j.push('</head><body style="border-width: 0;" class="editbox" spellcheck="'+(i.disableSpellcheck?"false":"true")+'"></body></html>');return j.join("")}var d=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);function a(j,k){this.options=k=k||{};h(k,CodeMirrorConfig);if(k.dumbTabs){k.tabMode="spaces"}else{if(k.normalTab){k.tabMode="default"}}if(k.cursorActivity){k.onCursorActivity=k.cursorActivity}var l=this.frame=b("iframe");if(k.iframeClass){l.className=k.iframeClass}l.frameBorder=0;l.style.border="0";l.style.width="100%";l.style.height="100%";l.style.display="block";var n=this.wrapping=b("div");n.style.position="relative";n.className="CodeMirror-wrapping";n.style.width=k.width;n.style.height=(k.height=="dynamic")?k.minHeight+"px":k.height;var i=this.textareaHack=b("textarea");n.appendChild(i);i.style.position="absolute";i.style.left="-10000px";i.style.width="10px";i.tabIndex=100000;l.CodeMirror=this;if(k.domain&&d){this.html=g(k);l.src="javascript:(function(){document.open();"+(k.domain?'document.domain="'+k.domain+'";':"")+"document.write(window.frameElement.CodeMirror.html);document.close();})()"}else{l.src="javascript:;"}if(j.appendChild){j.appendChild(n)}else{j(n)}n.appendChild(l);if(k.lineNumbers){this.lineNumbers=c(n,k.firstLineNumber)}this.win=l.contentWindow;if(!k.domain||!d){this.win.document.open();this.win.document.write(g(k));this.win.document.close()}}a.prototype={init:function(){if(this.options.initCallback){this.options.initCallback(this)}if(this.options.onLoad){this.options.onLoad(this)}if(this.options.lineNumbers){this.activateLineNumbers()}if(this.options.reindentOnLoad){this.reindent()}if(this.options.height=="dynamic"){this.setDynamicHeight()}},getCode:function(){return this.editor.getCode()},setCode:function(i){this.editor.importCode(i)},selection:function(){this.focusIfIE();return this.editor.selectedText()},reindent:function(){this.editor.reindent()},reindentSelection:function(){this.focusIfIE();this.editor.reindentSelection(null)},focusIfIE:function(){if(this.win.select.ie_selection&&document.activeElement!=this.frame){this.focus()}},focus:function(){this.win.focus();if(this.editor.selectionSnapshot){this.win.select.setBookmark(this.win.document.body,this.editor.selectionSnapshot)}},replaceSelection:function(i){this.focus();this.editor.replaceSelection(i);return true},replaceChars:function(j,k,i){this.editor.replaceChars(j,k,i)},getSearchCursor:function(j,i,k){return this.editor.getSearchCursor(j,i,k)},undo:function(){this.editor.history.undo()},redo:function(){this.editor.history.redo()},historySize:function(){return this.editor.history.historySize()},clearHistory:function(){this.editor.history.clear()},grabKeys:function(j,i){this.editor.grabKeys(j,i)},ungrabKeys:function(){this.editor.ungrabKeys()},setParser:function(i,j){this.editor.setParser(i,j)},setSpellcheck:function(i){this.win.document.body.spellcheck=i},setStylesheet:function(p){if(typeof p==="string"){p=[p]}var k={};var n={};var j=this.win.document.getElementsByTagName("link");for(var i=0,o;o=j[i];i++){if(o.rel.indexOf("stylesheet")!==-1){for(var q=0;q<p.length;q++){var l=p[q];if(o.href.substring(o.href.length-l.length)===l){k[o.href]=true;n[l]=true}}}}for(var i=0,o;o=j[i];i++){if(o.rel.indexOf("stylesheet")!==-1){o.disabled=!(o.href in k)}}for(var q=0;q<p.length;q++){var l=p[q];if(!(l in n)){var o=this.win.document.createElement("link");o.rel="stylesheet";o.type="text/css";o.href=l;this.win.document.getElementsByTagName("head")[0].appendChild(o)}}},setTextWrapping:function(i){if(i==this.options.textWrapping){return}this.win.document.body.style.whiteSpace=i?"":"nowrap";this.options.textWrapping=i;if(this.lineNumbers){this.setLineNumbers(false);this.setLineNumbers(true)}},setIndentUnit:function(i){this.win.indentUnit=i},setUndoDepth:function(i){this.editor.history.maxDepth=i},setTabMode:function(i){this.options.tabMode=i},setEnterMode:function(i){this.options.enterMode=i},setLineNumbers:function(i){if(i&&!this.lineNumbers){this.lineNumbers=c(this.wrapping,this.options.firstLineNumber);this.activateLineNumbers()}else{if(!i&&this.lineNumbers){this.wrapping.removeChild(this.lineNumbers);this.wrapping.style.paddingLeft="";this.lineNumbers=null}}},cursorPosition:function(i){this.focusIfIE();return this.editor.cursorPosition(i)},firstLine:function(){return this.editor.firstLine()},lastLine:function(){return this.editor.lastLine()},nextLine:function(i){return this.editor.nextLine(i)},prevLine:function(i){return this.editor.prevLine(i)},lineContent:function(i){return this.editor.lineContent(i)},setLineContent:function(i,j){this.editor.setLineContent(i,j)},removeLine:function(i){this.editor.removeLine(i)},insertIntoLine:function(j,i,k){this.editor.insertIntoLine(j,i,k)},selectLines:function(l,i,k,j){this.win.focus();this.editor.selectLines(l,i,k,j)},nthLine:function(j){var i=this.firstLine();for(;j>1&&i!==false;j--){i=this.nextLine(i)}return i},lineNumber:function(i){var j=0;while(i!==false){j++;i=this.prevLine(i)}return j},jumpToLine:function(i){if(typeof i=="number"){i=this.nthLine(i)}this.selectLines(i,0);this.win.focus()},currentLine:function(){return this.lineNumber(this.cursorLine())},cursorLine:function(){return this.cursorPosition().line},cursorCoords:function(i){return this.editor.cursorCoords(i)},activateLineNumbers:function(){var k=this.frame,s=k.contentWindow,u=s.document,p=u.body,v=this.lineNumbers,q=v.firstChild,w=this;var x=null;v.onclick=function(A){var z=w.options.onLineNumberClick;if(z){var B=(A||window.event).target||(A||window.event).srcElement;var y=B==v?NaN:Number(B.innerHTML);if(!isNaN(y)){z(y,B)}}};function j(){if(k.offsetWidth==0){return}for(var y=k;y.parentNode;y=y.parentNode){}if(!v.parentNode||y!=document||!s.Editor){try{o()}catch(z){}clearInterval(i);return}if(v.offsetWidth!=x){x=v.offsetWidth;k.parentNode.style.paddingLeft=x+"px"}}function l(){v.scrollTop=p.scrollTop||u.documentElement.scrollTop||0}var o=function(){};j();var i=setInterval(j,500);function t(C){var B=q.firstChild.offsetHeight;if(B==0){return}var y=50+Math.max(p.offsetHeight,Math.max(k.offsetHeight,p.scrollHeight||0)),z=Math.ceil(y/B);for(var A=q.childNodes.length;A<=z;A++){var D=b("div");D.appendChild(document.createTextNode(C?String(A+w.options.firstLineNumber):"\u00a0"));q.appendChild(D)}}function r(){function A(){t(true);l()}w.updateNumbers=A;var y=s.addEventHandler(s,"scroll",l,true),z=s.addEventHandler(s,"resize",A,true);o=function(){y();z();if(w.updateNumbers==A){w.updateNumbers=null}};A()}function n(){var C,F,E,H,K=[],L=w.options.styleNumbers;function I(N,M){if(!F){F=q.appendChild(b("div"))}if(L){L(F,M,N)}K.push(F);K.push(N);H=F.offsetHeight+F.offsetTop;F=F.nextSibling}function B(){for(var M=0;M<K.length;M+=2){K[M].innerHTML=K[M+1]}K=[]}function J(){if(!q.parentNode||q.parentNode!=w.lineNumbers){return}var M=new Date().getTime()+w.options.lineNumberTime;while(C){I(E++,C.previousSibling);for(;C&&!s.isBR(C);C=C.nextSibling){var N=C.offsetTop+C.offsetHeight;while(q.offsetHeight&&N-3>H){I("&nbsp;")}}if(C){C=C.nextSibling}if(new Date().getTime()>M){B();z=setTimeout(J,w.options.lineNumberDelay);return}}while(F){I(E++)}B();l()}function A(M){l();t(M);C=p.firstChild;F=q.firstChild;H=0;E=w.options.firstLineNumber;J()}A(true);var z=null;function D(){if(z){clearTimeout(z)}if(w.editor.allClean()){A()}else{z=setTimeout(D,200)}}w.updateNumbers=D;var G=s.addEventHandler(s,"scroll",l,true),y=s.addEventHandler(s,"resize",D,true);o=function(){if(z){clearTimeout(z)}if(w.updateNumbers==D){w.updateNumbers=null}G();y()}}(this.options.textWrapping||this.options.styleNumbers?n:r)()},setDynamicHeight:function(){var k=this,p=k.options.onCursorActivity,o=k.win,j=o.document.body,l=null,n=null,i=2*k.frame.offsetTop;j.style.overflowY="hidden";o.document.documentElement.style.overflowY="hidden";this.frame.scrolling="no";function q(){var r=0,s=j.lastChild,t;while(s&&o.isBR(s)){if(!s.hackBR){r++}s=s.previousSibling}if(s){l=s.offsetHeight;t=s.offsetTop+(1+r)*l}else{if(l){t=r*l}}if(t){k.wrapping.style.height=Math.max(i+t,k.options.minHeight)+"px"}}setTimeout(q,300);k.options.onCursorActivity=function(r){if(p){p(r)}clearTimeout(n);n=setTimeout(q,100)}}};a.InvalidLineHandle={toString:function(){return"CodeMirror.InvalidLineHandle"}};a.replace=function(i){if(typeof i=="string"){i=document.getElementById(i)}return function(j){i.parentNode.replaceChild(j,i)}};a.fromTextArea=function(l,k){if(typeof l=="string"){l=document.getElementById(l)}k=k||{};if(l.style.width&&k.width==null){k.width=l.style.width}if(l.style.height&&k.height==null){k.height=l.style.height}if(k.content==null){k.content=l.value}function j(){l.value=o.getCode()}if(l.form){if(typeof l.form.addEventListener=="function"){l.form.addEventListener("submit",j,false)}else{l.form.attachEvent("onsubmit",j)}var i=l.form.submit;function p(){j();l.form.submit=i;l.form.submit();l.form.submit=p}l.form.submit=p}function n(q){if(l.nextSibling){l.parentNode.insertBefore(q,l.nextSibling)}else{l.parentNode.appendChild(q)}}l.style.display="none";var o=new a(n,k);o.toTextArea=function(){j();l.parentNode.removeChild(o.wrapping);l.style.display="";if(l.form){l.form.submit=i;if(typeof l.form.removeEventListener=="function"){l.form.removeEventListener("submit",j,false)}else{l.form.detachEvent("onsubmit",j)}}};return o};a.isProbablySupported=function(){var i;if(window.opera){return Number(window.opera.version())>=9.52}else{if(/Apple Computer, Inc/.test(navigator.vendor)&&(i=navigator.userAgent.match(/Version\/(\d+(?:\.\d+)?)\./))){return Number(i[1])>=3}else{if(document.selection&&window.ActiveXObject&&(i=navigator.userAgent.match(/MSIE (\d+(?:\.\d*)?)\b/))){return Number(i[1])>=6}else{if(i=navigator.userAgent.match(/gecko\/(\d{8})/i)){return Number(i[1])>=20050901}else{if(i=navigator.userAgent.match(/AppleWebKit\/(\d+)/)){return Number(i[1])>=525}else{return null}}}}}};return a})();var DragHandler=Class.create({initialize:function(a){this._dragSource=a;this._draggedObject=null;this._initialDropZone=null;this._dropZonesInfo=new Array();this._boundedStartDrag=this._startDrag.bind(this);this._boundedUpdate=this._update.bind(this);this._boundedEndDrag=this._endDrag.bind(this)},enableDragNDrop:function(b,a){this._initialDropZone=b;this._initialDropZonePosition=null;a.each(function(c){this._dropZonesInfo.push({dropZone:c,position:null})}.bind(this));Event.observe(this._dragSource.getHandlerNode(),"mousedown",this._boundedStartDrag,true)},_startDrag:function(c){c=c||window.event;this._mouseXStart=0;this._mouseYStart=0;this._x=0;this._y=0;this._offLimitX=0;this._offLimitY=0;if(!BrowserUtils.isLeftButton(c.button)){return false}this._draggedObject=this._dragSource.getDraggableObject();var a=this._draggedObject.getHandlerNode();this._initialArea=a.parentNode;this._dropZonesInfo.each(function(f){var d=f.dropZone.getNode();f.position=Geometry.getClientRectangle(d)}.bind(this));if(this._initialDropZone){var b=this._initialDropZone.getNode();this._initialDropZonePosition=Geometry.getRectangle(b)}this._toggleEventHandlers(true);this._draggedObject.onStart();this._mouseXStart=parseInt(c.screenX);this._mouseYStart=parseInt(c.screenY);this._y=a.offsetTop;this._x=a.offsetLeft;if(this._isChangingZone()){a.addClassName("dragOnChangeLayer")}else{a.addClassName("dragLayer")}return false},_update:function(d){d=d||window.event;var c=parseInt(d.screenX);var b=parseInt(d.screenY);this._updateNodePosition(c,b);this._updateNodeStatus(this._isValidPosition());this._draggedObject.onUpdate(this._x,this._y);var a=this._draggedObject.getHandlerNode()},_endDrag:function(c){c=c||window.event;if(!BrowserUtils.isLeftButton(c.button)){return false}this._toggleEventHandlers(false);var a=this._draggedObject.getHandlerNode();a.removeClassName("dragLayer");a.removeClassName("dragOnChangeLayer");this._updateNodeStatus(true);var f;var b;if(this._isChangingZone()){var d=this._inWhichDropZone();if(d){b=Geometry.adaptDropPosition(d.getNode(),a);this._initialArea.removeChild(a);f=d.drop(this._draggedObject,b)}else{this._initialArea.removeChild(a);f=false}if(!f){this._draggedObject.destroy()}}else{f=true;b={top:a.offsetTop,left:a.offsetLeft}}if(f){this._draggedObject.onFinish(this._isChangingZone(),b)}this._draggedObject=null;return false},_toggleEventHandlers:function(a){if(a){document.oncontextmenu=function(){return false};document.onmousedown=function(){return false};document.onselectstart=function(){return false};Event.stopObserving(this._draggedObject.getHandlerNode(),"mousedown",this._boundedStartDrag,true);Event.observe(document,"mouseup",this._boundedEndDrag,true);Event.observe(document,"mousemove",this._boundedUpdate,true)}else{document.onmousedown=null;document.oncontextmenu=null;document.onselectstart=null;Event.observe(this._dragSource.getHandlerNode(),"mousedown",this._boundedStartDrag,true);Event.stopObserving(document,"mouseup",this._boundedEndDrag,true);Event.stopObserving(document,"mousemove",this._boundedUpdate,true)}},_isChangingZone:function(){return(this._initialDropZone==null)},_isValidPosition:function(){if(this._isChangingZone()){return(this._inWhichDropZone()!=null)}else{return true}},_inWhichDropZone:function(){for(var a=0;a<this._dropZonesInfo.length;a++){if(Geometry.intersects(this._dropZonesInfo[a].position,this._getDraggableNodeRectangle())){return this._dropZonesInfo[a].dropZone}}return null},_getDraggableNodeRectangle:function(){var a=this._draggedObject.getHandlerNode();return{top:a.offsetTop,left:a.offsetLeft,bottom:a.offsetTop+a.offsetHeight,right:a.offsetLeft+a.offsetWidth}},_updateNodePosition:function(a,i){var h=a-this._mouseXStart;var f=i-this._mouseYStart;this._mouseXStart=a;this._mouseYStart=i;var c=this._draggedObject.getHandlerNode();if(!this._isChangingZone()){var b=Geometry.dragRanges(this._initialDropZonePosition,this._getDraggableNodeRectangle());var g=Geometry.updateAxis(b.x,h,this._offLimitX);h=g.delta;this._offLimitX=g.offLimit;var d=Geometry.updateAxis(b.y,f,this._offLimitY);f=d.delta;this._offLimitY=d.offLimit}this._y=this._y+f;this._x=this._x+h;c.style.top=this._y+"px";c.style.left=this._x+"px"},_updateNodeStatus:function(a){if(a){this._draggedObject.getHandlerNode().removeClassName("disabled")}else{this._draggedObject.getHandlerNode().addClassName("disabled")}}});var DragSource=Class.create({initialize:function(){this._dragHandler=new DragHandler(this)},getHandlerNode:function(){throw"Abstract Method invocation: DragSource::_getHandlerNode"},enableDragNDrop:function(b,a){this._dragHandler.enableDragNDrop(b,a)},getDraggableObject:function(){throw"Abstract Method invocation: DragSource::getDraggableObject"},onStart:function(){},onUpdate:function(a,b){},onFinish:function(a){},isValidPosition:function(a,b){return true}});var Area=Class.create({initialize:function(d,c,f,a){var b=Utils.variableOrDefault(a,{});b=Object.extend({style:""},b);this._acceptedElements=c;this._onDropHandler=f;if(b.region!="center"){if(b.minHeight!=null){b.style+="height: "+b.minHeight+"px;"}if(b.minWidth!=null){b.style+="width: "+b.minWidth+"px;"}}this._contentPane=new dijit.layout.ContentPane(b);this._node=new Element("div",{"class":"dropArea "+d});this._contentPane.setContent(this._node)},getNode:function(){return this._node},getWidget:function(){return this._contentPane},drop:function(b,a){var c=this._onDropHandler(this,b,a);return c},accepts:function(){return this._acceptedElements},observe:function(b,a){this.getNode().observe(b,a)},stopObserving:function(a){this.getNode().stopObserving(a)},setLayout:function(){},insert:function(b,a){$("main").insert(b);a=Geometry.adaptInitialPosition(this._node,b.toElement(),Object.extend({top:33,left:33},a));b.setPosition(a);this._node.insert(b)}});var BuildingBlockFactory=Class.create({initialize:function(){},getBuildingBlockType:function(){throw"Abstract method invocation. BuildingBlockFactory::getBuildingBlockType"},getBuildingBlockName:function(){return Constants.BuildingBlockNames[this.getBuildingBlockType()]},getBuildingBlocks:function(){throw"Abstract method invocation. BuildingBlockFactory::getBuildingBlockDescriptions"},getInstance:function(b,a){throw"Abstract method invocation. BuildingBlockFactory::getInstance"}});var ScreenflowFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.SCREENFLOW},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. ScreenflowFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new ScreenflowInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.screens);this.callback()},_updateBuildingBlockDescriptions:function(b){for(var a=0;a<b.length;a++){this._buildingBlockDescriptions.set(b[a].uri,new ScreenflowDescription(b[a]))}}});var ScreenFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.SCREEN},getBuildingBlocks:function(f,d){var c=Utils.variableOrDefault(d,true);var a=new Array();var b=$A(f);if(!c){b=b.findAll(function(g){return(g.indexOf("clones")==-1)})}b.each(function(g){if(this._buildingBlockDescriptions.get(g)){a.push(this._buildingBlockDescriptions.get(g))}else{throw"Ooops. Something went wrong. ScreenFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new ScreenInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.screens);this.callback()},_updateBuildingBlockDescriptions:function(b){for(var a=0;a<b.length;a++){this._buildingBlockDescriptions.set(b[a].uri,new ScreenDescription(b[a]))}}});var DomainConceptFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super()},getBuildingBlockType:function(){return Constants.BuildingBlock.DOMAIN_CONCEPT},getBuildingBlocks:function(b,c){var a=this._createUrl(b);PersistenceEngine.sendGet(a,{callback:c},this._onSuccess,this._onError)},_createUrl:function(a){if(a.size()>0){var b=a.collect(function(c){return c.label["en-gb"]}).join("+");return URIs.catalogueTagConcepts.replace("<tags>",b)}else{return URIs.catalogueAllConcepts}},_onSuccess:function(c){var b=c.responseText.evalJSON();var a=new Array();$A(b).each(function(d){a.push(new PrePostDescription(d))});this.callback(a)},_onError:function(b,a){Logger.serverError(b,a)}});var FormFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.FORM},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new FormInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.forms);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new FormDescription(a[b]))}}});var OperatorFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.OPERATOR},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},getInstance:function(b,a){return new OperatorInstance(b,a)},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.operators);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new BuildingBlockDescription(a[b]))}}});var ResourceFactory=Class.create(BuildingBlockFactory,{initialize:function($super){$super();this._buildingBlockDescriptions=new Hash()},getBuildingBlockType:function(){return Constants.BuildingBlock.RESOURCE},getBuildingBlocks:function(b){var a=new Array();$A(b).each(function(c){if(this._buildingBlockDescriptions.get(c)){a.push(this._buildingBlockDescriptions.get(c))}else{throw"Ooops. Something went wrong. BuildingBlockFactory::getBuildingBlocks"}}.bind(this));return a},getInstance:function(b,a){return new ResourceInstance(b,a)},cacheBuildingBlocks:function(c,d){var b=new Array();$A(c).each(function(f){if(!this._buildingBlockDescriptions.get(f)){b.push(f)}}.bind(this));if(b.size()>0){var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.catalogueGetMetadata,null,a,{mine:this,callback:d},this._onSuccess,Utils.onAJAXError)}else{d()}},_onSuccess:function(b){var a=b.responseText.evalJSON();this.mine._updateBuildingBlockDescriptions(a.backendservices);this.callback()},_updateBuildingBlockDescriptions:function(a){for(var b=0;b<a.length;b++){this._buildingBlockDescriptions.set(a[b].uri,new BuildingBlockDescription(a[b]))}}});var Catalogue=Class.create();Object.extend(Catalogue,{_factories:{screen:new ScreenFactory(),screenflow:new ScreenflowFactory(),domainConcept:new DomainConceptFactory(),form:new FormFactory(),resource:new ResourceFactory(),operator:new OperatorFactory()}});Object.extend(Catalogue,{getBuildingBlockFactory:function(a){return this._factories[a]},getFacts:function(){var b=function(c){var d=c.responseText.evalJSON();FactFactory.setFacts(d)};var a=function(c,d){console.error(d)};PersistenceEngine.sendGet(URIs.catalogueGetFacts,this,b,a)},getDomainConcepts:function(){var a=function(d){var g=d.responseText.evalJSON();this.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT).updateBuildingBlockDescriptions(g.domainConcepts);var f=GVS.getDocumentController().getCurrentDocument().getPaletteController();var c=f.getPalette(Constants.BuildingBlock.DOMAIN_CONCEPT);c.paintComponents()};var b=function(c,d){console.error(d)};PersistenceEngine.sendGet(URIs.catalogueGetDomainConcepts,this,a,b)}});var BuildingBlockDescription=Class.create({initialize:function(a){Utils.addProperties(this,a)},addProperties:function(a){Utils.addProperties(this,a)},clone:function(){function c(f){var d;if((f instanceof Array)){d=[];f.each(function(g){d.push(c(g))})}else{if(f instanceof Object){d={};$H(f).each(function(g){d[g.key]=c(g.value)})}else{d=f}}return d}var a=["code","creationDate","creator","description","homepage","icon","label","parameterTemplate","postconditions","preconditions","rights","screenshot","tags","template","type","uri","version","actions","libraries","triggers"];var b={};a.each(function(d){if(this[d]!==undefined){b[d]=c(this[d])}},this);return new BuildingBlockDescription(b)},toJSON:function(){var a={};$H(this).each(function(b){if(!(b.value instanceof Function)){a[b.key]=b.value}});return a},getOrder:function(){return this.getTitle()},getTitle:function(){return this.label?this.label["en-gb"]:this.name},getId:function(){return this.id},isValid:function(){return true},getCanvasInstances:function(){return[]},getConditionInstances:function(){return[]},getPreconditionsList:function(){if(!this.actions){return this._getConditionsList("preconditions")}var a=[];$A(this.actions).each(function(b){$A(b.preconditions).each(function(c){a.push(c)})});return a},getPostconditionsList:function(){return this._getConditionsList("postconditions")},_getConditionsList:function(a){return this[a]}});var FormDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a)},getPreview:function(){var b=new Element("div",{"class":"preview"});var a=new Element("div",{"class":"error"});b.appendChild(a);var c=new Element("img",{src:this.screenshot,onerror:'this.src = "/fast/images/gui/imageNotFound.png";'});b.appendChild(c);return b}});var ScreenDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a);this._preconditions=new Hash();this._postconditions=new Hash();this._buildingBlocks=new Hash();this._pipes=new Hash();this._triggers=new Hash()},toJSON:function(){var a={preconditions:this.getPreconditions(),postconditions:this.getPostconditions(),definition:{buildingblocks:this._getScreenBuildingBlocks(),pipes:this._getScreenPipes(),triggers:this._getTriggers()}};a=Object.extend(a,{name:this.name,label:this.label,tags:this.tags,version:this.version,id:this.id,creator:this.creator,description:this.description,rights:this.rights,creationDate:this.creationDate,icon:this.icon,screenshot:this.screenshot,homepage:this.homepage,type:"screen"});return a},getPreview:function(){var b=new Element("div",{"class":"preview"});var a=new Element("div",{"class":"error"});b.appendChild(a);var c=new Element("img",{src:this.screenshot,onerror:"this.parentNode.childNodes[0].update('Image not available');this.src='"+URIs.logoFast+"';"});b.appendChild(c);return b},getInfo:function(){var a=new Hash();a.set("Title",this.label["en-gb"]);a.set("Tags",this.tags.collect(function(b){return b.label["en-gb"]}).join(", "));a.set("Version",this.version);return a},addPre:function(b,a){this._preconditions.set(b.getId(),{buildingblock:b,position:a})},addPost:function(b,a){this._postconditions.set(b.getId(),{buildingblock:b,position:a})},updatePrePost:function(b,a){var d;if(b.getType()=="pre"){d=this._preconditions}else{d=this._postconditions}var f=d.get(b.getId());var c=f.position;if(c.top!=a.top||c.left!=a.left){f.position=a;return true}else{return false}},addBuildingBlock:function(b,a,c){this._buildingBlocks.set(b.getId(),{buildingblock:b,position:a,orientation:c})},updateBuildingBlock:function(b,a,f){var c=this._buildingBlocks.get(b.getId());var d=c.position;if(d.top!=a.top||d.left!=a.left||d.orientation!=f){c.position=a;c.orientation=f;return true}return false},addPipe:function(a){this._pipes.set(a.getId(),a)},addTrigger:function(a){if(this._triggers.get(a.getId())){this._triggers.unset(a.getId())}else{this._triggers.set(a.getId(),a)}},getPipes:function(){var a=new Array();this._pipes.values().each(function(b){a.push(b.getJSONforCheck())});return a},getPreconditions:function(){var a=new Array();this._preconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreen(),{position:c.position});a.push(b)}.bind(this));return a},getPostconditions:function(){var a=new Array();this._postconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreen(),{position:c.position});a.push(b)}.bind(this));return a},getCanvasInstances:function(){var a=new Array();this._buildingBlocks.values().each(function(b){a.push(b.buildingblock)});return a},getInstance:function(a){return this._buildingBlocks.get(a).buildingblock},getInstanceByUri:function(a){return this._buildingBlocks.values().detect(function(b){return b.buildingblock.getUri()==a}).buildingblock},getInstancesByUri:function(a){var b=[];this._buildingBlocks.values().each(function(c){if(c.buildingblock.getUri()==a){b.push(c.buildingblock)}}).buildingblock;return b},contains:function(b){var a=this._buildingBlocks.values().detect(function(c){return c.buildingblock.getUri()==b});if(a){return true}else{return false}},getConditionInstances:function(){var a=new Array();this._preconditions.values().each(function(b){a.push(b.buildingblock)});this._postconditions.values().each(function(b){a.push(b.buildingblock)});return a},getPre:function(a){if(this._preconditions.get(a)){return this._preconditions.get(a).buildingblock}else{return null}},getPost:function(a){if(this._postconditions.get(a)){return this._postconditions.get(a).buildingblock}else{return null}},remove:function(a){switch(a.constructor){case PrePostInstance:if(this._preconditions.get(a.getId())){this._preconditions.unset(a.getId())}else{this._postconditions.unset(a.getId())}break;case Pipe:this._pipes.unset(a.getId());break;case Trigger:case ScreenTrigger:this._triggers.unset(a.getId());break;default:this._buildingBlocks.unset(a.getId())}},_getScreenBuildingBlocks:function(){var a=new Array();this._buildingBlocks.values().each(function(b){a.push({id:b.buildingblock.getId(),uri:b.buildingblock.getUri(),originalUri:b.buildingblock.getOriginalUri(),position:b.position,orientation:b.buildingblock.getOrientation(),parameter:b.buildingblock.getParams()})});return a},_getScreenPipes:function(){var a=new Array();this._pipes.values().each(function(b){a.push(b.getJSONforScreen())});return a},_getTriggers:function(){var a=new Array();this._triggers.values().each(function(b){a.push(b.toJSON())});return a}});var ScreenflowDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a);this._screens=new Hash();this._preconditions=new Hash();this._postconditions=new Hash()},toJSON:function(){var a={definition:{screens:this._getScreens(),preconditions:this.getPreconditions(),postconditions:this.getPostconditions()}};a=Object.extend(a,{name:this.name,label:this.label,tags:this.tags,version:this.version,id:this.id,creator:this.creator,description:this.description,rights:this.rights,creationDate:this.creationDate,icon:this.icon,screenshot:this.screenshot,homepage:this.homepage,type:"screenflow"});return a},addScreen:function(b,a){this._screens.set(b.getUri(),{buildingblock:b,position:a})},updateScreen:function(d,a){var b=this._screens.get(d);var c=b.position;if(c.top!=a.top||c.left!=a.left){b.position=a;return true}else{return false}},remove:function(a){this._screens.unset(a);this._preconditions.unset(a);this._postconditions.unset(a)},addPrePost:function(b,a){switch(b.getType()){case"pre":this._preconditions.set(b.getUri(),{buildingblock:b,position:a});break;case"post":this._postconditions.set(b.getUri(),{buildingblock:b,position:a});break;default:}},updatePrePost:function(c,a){var d=this._preconditions.get(c);if(!d){d=this._postconditions.get(c)}var b=d.position;if(b.top!=a.top||b.left!=a.left){d.position=a;return true}return false},getPre:function(a){var b=this._preconditions.get(a);if(b){return b.buildingblock}else{return null}},getPost:function(b){var a=this._postconditions.get(b);if(a){return a.buildingblock}else{return null}},getInfo:function(){var a=new Hash();a.set("Title",this.getTitle());a.set("Tags",this.tags.collect(function(b){return b.label["en-gb"]}).join(", "));a.set("Version",this.version);return a},getPreconditions:function(){var a=new Array();this._preconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreenflow(),{position:c.position});a.push(b)}.bind(this));return a},getPostconditions:function(){var a=new Array();this._postconditions.values().each(function(c){var b=Object.extend(c.buildingblock.toJSONForScreenflow(),{position:c.position});a.push(b)}.bind(this));return a},getPreconditionsCatalogue:function(){var a=new Array();this._preconditions.values().each(function(c){var b=c.buildingblock.toJSONForCatalogue();a.push(b)}.bind(this));return a},getPostconditionsCatalogue:function(){var a=new Array();this._postconditions.values().each(function(c){var b=c.buildingblock.toJSONForCatalogue();a.push(b)}.bind(this));return a},getCanvasInstances:function(){var a=new Array();var b=this._screens.values();b.each(function(c){a.push(c.buildingblock)});return a},contains:function(b){var c=this._screens.values().concat(this._preconditions.values());c=c.concat(this._postconditions.values());var a=c.detect(function(d){return d.buildingblock.getOriginalUri()==b});if(a){return true}else{return false}},getConditionInstances:function(){var a=new Array();this._preconditions.values().each(function(b){a.push(b.buildingblock)});this._postconditions.values().each(function(b){a.push(b.buildingblock)});return a},_getScreenUris:function(){return this._screens.keys()},_getScreens:function(){var a=new Array();this._screens.values().each(function(c){var d={uri:c.buildingblock.getUri(),position:c.position,title:c.buildingblock.getTitle(),originalUri:c.buildingblock.getOriginalUri()};var b=c.buildingblock.getCaption();if(b!=null&&b!=""){d.caption=b}a.push(d)});return a}});var PrePostDescription=Class.create(BuildingBlockDescription,{initialize:function($super,a){$super(a)},clone:function(){return new PrePostDescription(this.toJSON())},getOrder:function(){return FactFactory.getFactShortcut(this)},getTitle:function(){if(!this.title){this._updateTitle()}return this.title},generateUri:function(){if(this.uri==undefined){if(this.pattern){this.uri=this.pattern.split(" ")[2]}}},getUriShortcut:function(){var c;if(this.uri){c=this.uri}else{c=Utils.extractURIfromPattern(this.pattern)}if(c){var b=c.split("#");var a="";if(b.length>1){a=b[1]}else{b=c.split("/");a=b[b.length-1]}return a}else{return"Concept"}},_updateTitle:function(){if(this["http://www.w3.org/2000/01/rdf-schema#label"]){this.title=this["http://www.w3.org/2000/01/rdf-schema#label"].replace("@en","")}else{if(this["label"]){var a=$H(this["label"]).keys();if(a.size()==1){this.title=this["label"][a[0]]}else{if(this["label"]["en"]){this.title=this["label"]["en"]}else{this.title="Concept"}}}else{this.title=this._createTitle()}}},_createTitle:function(){return this._sanitizeTitle(this.getUriShortcut())},_sanitizeTitle:function(c){var a=c.replace("@en","");var b=a.match(/[A-Z][a-z0-9]+|\s+[a-z][a-z0-9]*/g);if(b){b.map(function(d){return d.strip()});a=b.join(" ")}return a}});var InferenceEngine=Class.create({initialize:function(){this._reachabilityData=new Hash();this._listeners=new Hash()},findCheck:function(c,f,b,h,g){var a=this._constructBody(c,f,b,h);var d={callback:g,mine:this};PersistenceEngine.sendPost(this._getUri("findCheck"),null,a,d,this._findCheckOnSuccess,this._onError)},check:function(c,f,b,h,g){var a=this._constructBody(c,f,b,h,"check");var d={callback:g,mine:this};PersistenceEngine.sendPost(this._getUri("check"),null,a,d,this._checkOnSuccess,this._onError)},addReachabilityListener:function(a,b){this._getListenerList(a).push(b);if(this._reachabilityData.get(a)){b.setReachability(this._reachabilityData.get(a))}},removeReachabilityListener:function(b,c){var a=this._getListenerList(b).indexOf(c);if(a>=0){this._listeners.get(b)[a]=null;this._listeners.set(b,this._listeners.get(b).compact())}},getPreconditionReachability:function(d){var b=this._reachabilityData.get(d);var a=new Hash();if(b){if(b.preconditions){var c=b.preconditions;$A(c).each(function(g){var f=Utils.extractURIfromPattern(g.pattern);a.set(f,g.satisfied)})}else{if(b.actions){$A(b.actions).each(function(f){$A(f.preconditions).each(function(h){var g=Utils.extractURIfromPattern(h.pattern);a.set(g,h.satisfied)})})}else{console.log("unknown reachability data format")}}}return a},isReachable:function(b){var a=this._reachabilityData.get(b);if(a){return a.reachability}else{return null}},_constructBody:function(b,c,a,d){throw"Abstract Method invocation: InferenceEngine::_constructBody"},_getUri:function(a){throw"Abstract Method invocation: InferenceEngine::_getUri"},_findCheckOnSuccess:function(a){throw"Abstract method invocation: InferenceEngine::_findCheckOnSuccess"},_checkOnSuccess:function(a){throw"Abstract method invocation: InferenceEngine::_CheckOnSuccess"},_onError:function(c,b){var a;if(b){a=b}else{a="Catalogue cannot load"}Utils.showMessage("Something went wrong: "+a,{error:true,hide:true});Logger.serverError(c,b)},_getListenerList:function(a){var b=this._listeners.get(a);if(!b){b=new Array();this._listeners.set(a,b)}return b},_updateReachability:function(a){a.each(function(b){if(b instanceof Object){this._reachabilityData.set(b.uri,b);this._notifyReachability(b.uri)}else{this._reachabilityData.set(b,true);this._notifyReachability(b)}}.bind(this))},_notifyReachability:function(a){this._getListenerList(a).each(function(b){b.setReachability(this._reachabilityData.get(a))}.bind(this))}});var ScreenflowInferenceEngine=Class.create(InferenceEngine,{initialize:function($super){$super()},getPlans:function(d,c,f){var b={goal:c,canvas:d};var a=Object.toJSON(b);PersistenceEngine.sendPost(URIs.cataloguePlanner,null,a,{handler:f},this._planOnSuccess,this._onError)},_planOnSuccess:function(b){var a=JSON.parse(b.responseText);this.handler(a)},_constructBody:function(c,d,b,g){var f={tags:b.collect(function(h){return h.label["en-gb"]}),user:GVS.getUser().getUserName()};var a={domainContext:f,criterion:g};a=Object.extend(a,d);a.canvas.screens=c;return Object.toJSON(a)},_getUri:function(a){switch(a){case"findCheck":return URIs.catalogueScreenflowFindCheck;break;case"check":return URIs.catalogueScreenflowCheck;break;default:return""}},_findCheckOnSuccess:function(f){var a=JSON.parse(f.responseText);if(a.palette){var c=a.palette}else{var c=[]}var d=c.clone();a.canvas.screens.each(function(g){found=d.detect(function(h){return(h.uri==g.uri)});if(!found){d.push(g)}},this);this.mine._updateReachability(d);var b=new Array();$A(c).each(function(g){b.push(g.uri)});this.callback(b,a)},_checkOnSuccess:function(c){var a=JSON.parse(c.responseText);var b=a.palette.concat(a.canvas.screens).uniq();this.mine._updateReachability(b);this.callback()}});var ScreenInferenceEngine=Class.create(InferenceEngine,{initialize:function($super){$super()},_constructBody:function(d,f,c,i,b){var h=Utils.variableOrDefault(b,"findcheck");var g={tags:c.collect(function(j){return j.label["en-gb"]}),user:GVS.getUser().getUserName()};var a={canvas:d,domainContext:g,criterion:i};if(h=="check"){a.search=false}else{a.search=true;if(GVS.getUser().getiServe()){a.iserve=true}else{a.iserve=false}}a=Object.extend(a,f);return Object.toJSON(a)},_getUri:function(a){return URIs.catalogueScreenFindCheck},_findCheckOnSuccess:function(c){var a=JSON.parse(c.responseText);if(a.canvas&&a.canvas.length>0){this.mine._updateReachability(a.canvas);if(!GVS.getUser().getCatalogueMagic()){var b=a.forms.concat(a.operators,a.backendservices);this.mine._updateReachability(b)}}this.callback(a)},_checkOnSuccess:function(c){try{var a=JSON.parse(c.responseText);this.mine._updateReachability(a.canvas);this.callback(a)}catch(b){}}});var BuildingBlockSet=Class.create({initialize:function(b,a){this._tags=b;this._factory=a;this._listener=null;this._uris=new Array()},getBuildingBlocks:function(){return this._factory.getBuildingBlocks(this._uris,false)},getBuildingBlockType:function(){return this._factory.getBuildingBlockType()},getBuildingBlockName:function(){return this._factory.getBuildingBlockName()},setListener:function(a){this._listener=a},setURIs:function(a){this._requestedUris=a;this._factory.cacheBuildingBlocks(a,this._cachedElements.bind(this))},_cachedElements:function(){if(GVS.getUser().getCatalogueMagic()){this._uris=this._requestedUris}else{this._uris=this._uris.concat(this._requestedUris).uniq()}this._listener.setChanged()}});var DomainConceptSet=Class.create(BuildingBlockSet,{initialize:function($super,b,a){$super(b,a);this._domainConcepts=new Array()},startRetrievingData:function(){this._factory.getBuildingBlocks(this._tags,this._onSuccess.bind(this))},getBuildingBlocks:function(){return this._domainConcepts},_onSuccess:function(a){this._domainConcepts=a;this._listener.setChanged()}});var SetListener=Class.create({initialize:function(){},setChanged:function(){throw"Abstract method invocation: SetListener::setChanged"}});var Table=Class.create({initialize:function(a,d,g,f){this._parentNode=a;this._title=d;this._titleNode=new Element("div",{"class":"dijitAccordionTitle "}).update(this._title);this._tableNode=new Element("table",{"class":"propertiesTable"});var c=(g=="left")?"width: 50%":"width: auto";var b=new dijit.layout.ContentPane({region:g,splitter:true,style:c,"class":"tableArea"});if(f){b.attr("minSize",f)}b.domNode.insert(this._titleNode);b.domNode.insert(this._tableNode);this._parentNode.addChild(b)},setTitle:function(a){this._title=a;this._titleNode.update(a)},getTitle:function(){return this._title},getTableNode:function(){return this._tableNode},insertFieldTitles:function(a){var b=new Element("tr",{"class":"tableHeader"});a.each(function(c){var d=new Element("td").update(c);b.insert(d)});this._tableNode.insert(b)},insertDataValues:function(a){a.each(function(b){var c=new Element("tr");b.each(function(d){var g=new Element("td");var f=new Element("div").update(d);if(typeof d==="string"){f.setAttribute("title",d)}g.insert(f);c.insert(g)});this._tableNode.insert(c)}.bind(this))},emptyTable:function(){this._tableNode.update("")}});var PropertiesPane=Class.create({initialize:function(a){this._propertiesTable=new Table(a,"Properties","left");this._propertiesTable.insertFieldTitles(["Property","Value"])},fillTable:function(a){this._clearElement();var b=a.getTitle();this._propertiesTable.insertDataValues(a.getInfo());this._propertiesTable.setTitle((b?"Properties of "+b:"Properties"))},addSection:function(b,a){this._propertiesTable.insertFieldTitles(b);this._propertiesTable.insertDataValues(a)},_clearElement:function(){this._propertiesTable.emptyTable();this._propertiesTable.setTitle("Properties");this._propertiesTable.insertFieldTitles(["Property","Value"])}});var FactPane=Class.create({initialize:function(a){this._factTable=new Table(a,"Facts","center")},fillTable:function(a,b,c){this._factTable.emptyTable();if(a.size()>0){this._factTable.insertFieldTitles(["PRE","Description","Semantics"]);this._factTable.insertDataValues(a)}if(b.size()>0){this._factTable.insertFieldTitles(["POST","Description","Semantics"]);this._factTable.insertDataValues(b)}if(c.size()>0){this._factTable.insertFieldTitles(["Fact","Description","Semantics"]);this._factTable.insertDataValues(c)}}});var Toolbar=Class.create({initialize:function(){this._toolbar=dijit.byId("toolbar");this._models=new Array();this._sections=new Array();this._sections[0]=new Array()},setModel:function(a,c){this._removeModel(a);if(c){var b=c.getToolbarElements();if(b.size()>0){this._models[a]=c;this._initSection(a);b.each(function(d){this._sections[a].push(d.getWidget())}.bind(this))}}this._refreshToolbar()},_removeModel:function(a){if(this._models[a]){this._models[a]=null;this._sections[a].clear()}},_initSection:function(a){if(!this._sections[a]){this._sections[a]=new Array()}if(a!=0&&!this._sections[a][0]){this._sections[a][0]=new dijit.ToolbarSeparator()}},_refreshToolbar:function(){this._toolbar.getDescendants().each(function(a){this._toolbar.removeChild(a)}.bind(this));this._sections.each(function(a){a.each(function(b){this._toolbar.addChild(b)}.bind(this))}.bind(this))}});var ToolbarModel=Class.create({initialize:function(){this._toolbarElements=new Hash();this._toolbarElementOrder=new Array()},getToolbarElements:function(){var a=new Array();this._toolbarElementOrder.each(function(b){a.push(this._toolbarElements.get(b))}.bind(this));return a},_addToolbarElement:function(a,b){this._toolbarElementOrder.push(a);this._toolbarElements.set(a,b)}});var ToolbarButton=Class.create({initialize:function(b,d,c,a){this._widget=new dijit.form.Button({label:b,iconClass:"toolbarIcon "+d+"Icon",onClick:c,showLabel:false,disabled:(a!==undefined)?(!a):false})},setTextVisible:function(a){this._widget.attr("showLabel",a)},getWidget:function(){return this._widget},setEnabled:function(a){this._widget.attr("disabled",!a)}});var ToolbarSeparator=Class.create({initialize:function(){this._widget=new dijit.ToolbarSeparator()},getWidget:function(){return this._widget}});var ToolbarDropDown=Class.create({initialize:function(b,c,a){this._menu=new dijit.Menu();this._widget=new dijit.form.DropDownButton({label:b,showLabel:true,iconClass:"toolbarIcon "+c+"Icon",dropDown:this._menu,disabled:(a!==undefined)?(!a):false})},addMenuItem:function(a,c,d){var b=new dijit.MenuItem({label:a,showLabel:true,onClick:c});if(d){b.attr("iconClass","dropDownIcon "+d+"Icon")}this._menu.addChild(b)},getWidget:function(){return this._widget},setEnabled:function(a){this._widget.attr("disabled",!a)}});var Menu=Class.create({initialize:function(a){this._menu=dijit.byId("menu");this._models=new Hash();this._registry=a;this._menuElements=new Array()},setModel:function(b,c){this._models.unset(b);if(c){this._models.set(b,c)}var a=this._mergeAllModels(this._models.values());this._createMenu(a)},_mergeAllModels:function(c){var b=new Hash();c.each(function(d){b=this._mergeMenuElements(b,$H(d.getMenuElements()))}.bind(this));var a=b.values().clone();a.sort(function(f,d){var h=f.get("weight")?f.get("weight"):MenuElement.MAXIMUM_WEIGHT;var g=d.get("weight")?d.get("weight"):MenuElement.MAXIMUM_WEIGHT;return h-g});return a},_mergeMenuElements:function(d,b){var a=new Hash();var c=d.keys().concat(b.keys()).uniq();c.each(function(f){if(d.get(f)&&b.get(f)){a.set(f,this._mergeMenuElement($H(d.get(f)),$H(b.get(f))))}else{if(d.get(f)){a.set(f,$H(d.get(f)))}else{if(b.get(f)){a.set(f,$H(b.get(f)))}}}}.bind(this));return a},_mergeMenuElement:function(d,b){var a=new Hash();var c=d.keys().concat(b.keys()).uniq();c.each(function(f){if(d.get(f)&&b.get(f)){if(f=="children"){a.set(f,this._mergeMenuElements($H(d.get(f)),$H(b.get(f))))}else{if(d.get(f)!=b.get(f)){throw"Conflicting menu element property "+f}a.set(f,d.get(f))}}else{if(d.get(f)){a.set(f,d.get(f))}else{if(b.get(f)){a.set(f,b.get(f))}}}}.bind(this));return a},_createMenu:function(a){this._menuElements.each(function(b){b.unregister(this._registry)}.bind(this));this._menuElements.clear();a.each(function(d){var c=d.toObject();switch(c.type.toLowerCase()){case"submenu":var b=new SubMenu(c,true);break;case"action":var b=c.action;break}this._menuElements.push(b);this._menu.addChild(b.getWidget());b.register(this._registry)}.bind(this))}});var MenuElement=Class.create({initialize:function(a){this._widget=null;this._weight=a;if(!this._weight){this._weight=MenuElement.MAXIMUM_WEIGHT}},getWidget:function(){return this._widget},getWeight:function(){return this._weight},register:function(a){throw"Abstract method invocation. MenuElement::register"},unregister:function(a){throw"Abstract method invocation. MenuElement::unregister"}});MenuElement.MAXIMUM_WEIGHT=10000;var MenuAction=Class.create(MenuElement,{initialize:function($super,b,a){$super(b.weight);if(a){this._widget=new dijit.MenuBarItem({label:b.label,onClick:b.handler,showLabel:true})}else{this._widget=new dijit.MenuItem({label:b.label,onClick:b.handler,showLabel:true})}this._handler=b.handler;this._shortcut=(b.shortcut?b.shortcut:null);if(this._shortcut){this._widget.attr("accelKey",this._shortcut)}this._enabled=null;this.setEnabled(b.enabled!==undefined?b.enabled:true);if(b.iconName){this._widget.attr("iconClass","dijitMenuItemIcon menuIcon "+b.iconName+"MenuIcon")}},setEnabled:function(a){this._enabled=a;this._widget.attr("disabled",!a)},register:function(a){if(this._shortcut){a.addHandler(this._shortcut,this._keyPressHandler.bind(this))}},unregister:function(a){if(this._shortcut){a.removeHandler(this._shortcut)}},_keyPressHandler:function(){if(this._enabled){this._handler()}}});var SubMenu=Class.create(MenuElement,{initialize:function($super,b,a){$super(b.weight);var c=new dijit.Menu({});if(a){this._widget=new dijit.PopupMenuBarItem({label:b.label,popup:c})}else{this._widget=new dijit.PopupMenuItem({label:b.label,popup:c})}this._groups=new Array();var d;$H(b.children).each(function(g){var f=$H(g.value).toObject();switch(f.type.toLowerCase()){case"action":d=f.action;break;case"submenu":d=new SubMenu(f);break}this._addChild(f.group,d)}.bind(this));this._createSubMenu(c)},register:function(a){this._groups.each(function(b){b.each(function(c){c.register(a)})})},unregister:function(a){this._groups.each(function(b){b.each(function(c){c.unregister(a)})});this._widget.destroy(false)},_addChild:function(a,b){if(!this._groups[a]){this._groups[a]=new Array()}this._groups[a].push(b);this._groups[a].sort(function(d,c){return d.getWeight()-c.getWeight()})},_createSubMenu:function(b){for(var a=0;a<this._groups.size();a++){if(this._groups[a]){this._groups[a].each(function(c){b.addChild(c.getWidget())});if(a!=this._groups.size()-1){b.addChild(new dijit.MenuSeparator())}}}b.startup()}});var AbstractDocument=Class.create(ToolbarModel,{initialize:function($super,a,c){$super();var b=Utils.variableOrDefault(c,false);this._title=a;this._tabId=UIDGenerator.generate("tab");this._tabContent=new Element("div",{"class":"document"});this._tab=null;if(!b){this._tab=new dijit.layout.ContentPane({title:this._title,id:this._tabId,closable:true,onClose:this._closeDocument.bind(this)},null);this._tab.setContent(this._tabContent)}else{this._tab=this._getWidget()}},getTabId:function(){return this._tabId},getTab:function(){return this._tab},getTitle:function(){return this._title},getNode:function(){return this._tabContent},onKeyPressed:function(a){},getMenuElements:function(){return{}},show:function(){},hide:function(){},_closeDocument:function(){GVS.getDocumentController().closeDocument(this._tabId);return true},_setTitle:function(a){this._title=a;this._tab.attr("title",this._title)}});var ExternalDocument=Class.create(AbstractDocument,{initialize:function($super,b,a){this._url=a;$super(b);this._tabContent.appendChild(new Element("iframe",{src:this._url,style:"border: 0px; width: 100%; height: 100%; margin: 0px; padding:0px;"}))},_closeDocument:function($super){this._tabContent.update("");$super()}});var PaletteDocument=Class.create(AbstractDocument,{initialize:function($super,b,c,a){$super(c.name);this._tags=c.tags;this._typeName=b;this._inferenceEngine=a;this._buildingBlockSets=this._getSets();this._paletteController=null;this._canvasCache=null;this._inspectorArea=new dijit.layout.BorderContainer({region:"bottom",design:"horizontal",style:"height: 180px; z-index:21 !important;",minSize:"100",maxSize:"220",persist:false,splitter:true});this._propertiesPane=new PropertiesPane(this._inspectorArea);this._factPane=new FactPane(this._inspectorArea);this._mainBorderContainer=null;this._isDirty=false;this._pendingOperation=null;this._designContainer=new dijit.layout.BorderContainer({region:"center",design:"sidebar",splitter:true,gutters:false});this._description=this._getDescription(c);this._areas=this._getAreas();this._areas.values().each(function(g){var f=g.getWidget();this._designContainer.addChild(f);var d=g.getNode();d.observe("click",function(){this._onClick()}.bind(this));d.observe("dblclick",function(){this._onClick()}.bind(this))}.bind(this));this._renderMainUI();this._selectedElement=null;this._propertiesDialog=new PropertiesDialog(this._typeName,this._description,this._onPropertiesChange.bind(this));if(this._description.getId()){this._canvasCache=this._getCanvasCache(c)}this._updatePanes()},getSelectedElement:function(){return this._selectedElement},getBuildingBlockDescription:function(){return this._description},modified:function(a){this._updatePanes();this._setDirty(true)},elementClicked:function(a){this._setSelectedElement(a)},elementDblClicked:function(a,b){this._setSelectedElement(a)},positionUpdated:function(b,a){this._setDirty(true)},orientationUpdated:function(b,a){this._setDirty(true)},onKeyPressed:function(a){switch(a){case"delete":this._startDeletingSelectedElement();break;case"space":this._previewSelectedElement();break;default:break}},getMenuElements:function(){return{file:{type:"SubMenu",label:"File",weight:1,children:{save:{type:"Action",action:new MenuAction({label:"Save",handler:function(){this._save()}.bind(this),weight:1,shortcut:"Alt+S"}),group:1},saveas:{type:"Action",action:new MenuAction({label:"Save as...",handler:function(){this._saveAs()}.bind(this),weight:2}),group:1}}},edit:{type:"SubMenu",weight:2,label:"Edit",children:{deleteElement:{type:"Action",action:new MenuAction({label:"Delete Element",handler:function(){this._deleteSelectedElement()}.bind(this),shortcut:"Del",weight:2}),group:1}}}}},deleteInstance:function(a){var b=a.getTitle();confirm("You are about to remove "+b+" from canvas. Are you sure?",function(c){c&&this._deleteInstance(a)}.bind(this))},rotateInstance:function(b){b.setOrientation((b.getOrientation()+1)%2);var a=b.getOrientation();b.getView().updateOrientation(a);b.onRotate(a);this.orientationUpdated(b,a)},_start:function(){this._paletteController=new PaletteController(this._buildingBlockSets,this._areas.values(),this._inferenceEngine);this._renderPaletteArea();this._configureToolbar();if(this._buildingBlockSets.size()>0){Utils.showMessage("Loading building blocks")}var b=this._getEmptyPalette();this._inferenceEngine.findCheck([],b,this._tags,"reachability",this._findCheckCallback.bind(this));var a=this._buildingBlockSets.detect(function(c){return c.constructor==DomainConceptSet});if(a){a.startRetrievingData()}if(this._description.getId()==null){this._setDirty(true)}},_setSelectedElement:function(b,a){var c=Utils.variableOrDefault(a,true);if(this._selectedElement!=null){this._selectedElement.getView().setSelected(false)}if(b!=undefined){this._selectedElement=b;this._selectedElement.getView().setSelected(true)}else{this._selectedElement=null;Utils.hideMessage()}this._updateToolbar(this._selectedElement);if(b&&c){this._refreshReachability()}else{this._updatePanes()}},_startDeletingSelectedElement:function(){if(this._selectedElement!=null){var a=null;if(this._selectedElement.getTitle()){a='the element "'+this._selectedElement.getTitle()+'"'}else{a="the selected element"}confirm("You are about to remove "+a+" from canvas. Are you sure?",function(b){if(b){this._deleteSelectedElement()}}.bind(this))}},_rotateSelectedElement:function(){var a=this._selectedElement;if(a!=null){this.rotateInstance(a)}},_renderMainUI:function(){this._mainBorderContainer=new dijit.layout.BorderContainer({design:"sidebar",liveSplitters:"false",splitter:"true"});this._mainBorderContainer.addChild(this._renderCenterContainer());this._tab.setContent(this._mainBorderContainer.domNode)},_setDirty:function(a){this._isDirty=a;this._toolbarElements.get("save").setEnabled(a);if(a){this._setTitle(this._description.name+"*")}else{this._setTitle(this._description.name)}},_renderPaletteArea:function(){this._mainBorderContainer.addChild(this._paletteController.getNode())},_deleteSelectedElement:function(){if(this._selectedElement){this._deleteInstance(this._selectedElement);this._setSelectedElement()}else{alert("Please Choose an element to delete it")}},_previewSelectedElement:function(){if(this._selectedElement){this._selectedElement.showPreviewDialog()}},_onPropertiesChange:function(){this._setTitle(this._description.name);this._setDirty(true);this._save(false)},_getCanvasUris:function(){var a=new Array();this._description.getCanvasInstances().each(function(b){a.push({uri:b.getUri()})});return a},_getAllFacts:function(){var a=new Hash();var b=this._description.getCanvasInstances().concat(this._description.getConditionInstances());b.each(function(c){if(c.constructor!=PrePostInstance){var i=this._inferenceEngine.getPreconditionReachability(c.getUri());var g=c.getPreconditionTable(i);g.each(function(j){if(!a.get(j[2])){a.set(j[2],j)}});var d=this._inferenceEngine.isReachable(c.getUri());var h=c.getPostconditionTable(d);h.each(function(j){if(!a.get(j[2])){a.set(j[2],j)}})}else{var f=c.getConditionTable();if(!a.get(f[2])){a.set(f[2],f)}}}.bind(this));return a.values()},_closeDocument:function(){if(this._isDirty){var b=new Element("div",{style:"text-align:center"}).update("The document has unsaved changes. Do you want to save?");var a=new ConfirmDialog("Warning",ConfirmDialog.SAVE_DISCARD_CANCEL,{callback:this._effectiveCloseDocument.bind(this),contents:b});a.show()}else{this._effectiveCloseDocument(ConfirmDialog.DISCARD)}return false},_effectiveCloseDocument:function(a){switch(a){case ConfirmDialog.SAVE:this._pendingOperation=this._effectiveCloseDocument.bind(this);this._save(false);break;case ConfirmDialog.CANCEL:break;case ConfirmDialog.DISCARD:default:var b=false;if(!this._description.getId()){b=true}this._description.getCanvasInstances().each(function(c){c.destroy(b,true)}.bind(this));this._description.getConditionInstances().each(function(c){c.destroy(b,true)}.bind(this));GVS.getDocumentController().closeDocument(this._tabId)}},_onClick:function(){this._setSelectedElement()},_deleteInstance:function(a){this._setSelectedElement();a.destroy(true);a.deleteInstance();this._setDirty(true);this._refreshReachability();this._save(false)},_addToArea:function(g,b,a,d){var c=b.getView();var f=c.getNode();g.getNode().appendChild(f);f.setStyle({left:a.left+"px",top:a.top+"px",position:"absolute"});if(b.constructor==OperatorInstance){c.updateOrientation(d)}},_save:function(b){var g=Utils.variableOrDefault(b,true);if(g){Utils.showMessage("Saving "+this._typeName)}var d=$H(this._description.toJSON()).merge($H(this._getExtraProperties()));var f={buildingblock:Object.toJSON(d.toObject())};f=Object.extend(f,this._getExtraParams());var a={mine:this,showMessage:g};if(this._description.getId()==null){PersistenceEngine.sendPost(this._getSaveUri(),f,null,a,this._onSaveSuccess,this._onSaveError)}else{var c=URIs.buildingblock+this._description.getId();PersistenceEngine.sendUpdate(c,f,null,a,this._onSaveSuccess,this._onSaveError)}},_saveAs:function(a){if(this._description.getId()){var b=new SaveAsDialog(this._getType(),this._description.name,this._description.version,this._onSaveAsSuccess.bind(this),a);b.show()}else{this._save()}},_onSaveAsSuccess:function(b,a){this._description.name=b;this._description.label["en-gb"]=b;this._description.version=a;this._description.id=null;this._description.creationDate=null;this._setTitle(this._description.name);this._save()},_onSaveSuccess:function(c){this.mine._setDirty(false);if(this.showMessage){Utils.showMessage("Saved",{hide:true})}this.mine._updatePanes();if(this.mine._description.getId()==null){var b=JSON.parse(c.responseText);this.mine._description.addProperties({id:b.id,version:b.version,creationDate:b.creationDate})}if(this.mine._pendingOperation){var a=this.mine._pendingOperation;this.mine._pendingOperation=null;a()}},_onSaveError:function(b){if(!this._pendingOperation){Utils.showMessage("Cannot save "+this._typeName+": A buildingblock with that name already exists",{hide:true,error:true})}else{var a=this._pendingOperation;this._pendingOperation=null;this._setDirty(false);a()}},_createInstances:function(a,c,b){c.each(function(d){var f=this._canvasCache.getIds(d.uri);f.each(function(o){var i=a.getInstance(d,this._inferenceEngine);i.setId(o);i.setParams(this._canvasCache.getParams(o));var n=this._canvasCache.getTitle(o);if(n!=null&&n!=""){i.setTitle(n)}var j=this._canvasCache.getCaption(o);if(j!=null&&j!=""){i.setCaption(j)}var h=this._canvasCache.getPosition(o);var l=this._canvasCache.getOriginalUri(o);if(l){i.setOriginalUri(l)}i.onFinish(true,h);var k=b.getNode();$("main").appendChild(i.getView().getNode());var g=Geometry.adaptInitialPosition(k,i.getView().getNode(),h);$("main").removeChild(i.getView().getNode());this._drop(b,i,g,this._canvasCache.getOrientation(o),true)}.bind(this))}.bind(this))},_getAreas:function(){throw"Abstract method invocation: PaletteDocument::_getAreas"},_getSets:function(){throw"Abstract method invocation: PaletteDocument::_getSets"},_getDescription:function(a){throw"Abstract method invocation: PaletteDocument::_getDescription"},_getCanvasCache:function(a){throw"Abstract method invocation: PaletteDocument::_getCanvasCache"},_renderCenterContainer:function(){throw"Abstract method invocation. PaletteDocument::_renderCenterContainer"},_updateToolbar:function(a){},_updatePanes:function(){},_getExtraParams:function(){return{}},_getExtraProperties:function(){return{}},_getSaveUri:function(){throw"Abstract method invocation. PaletteDocument::_getSaveUri"},_getEmptyPalette:function(){throw"Abstract method invocation. PaletteDocument::_getEmptyPalette"},_getType:function(){throw"Abstract method invocation. PaletteDocument::_getType"}});var WelcomeDocument=Class.create(AbstractDocument,{initialize:function($super){$super("Welcome!");this._populate()},_populate:function(){var k=this.getNode();k.addClassName("welcome");var d=new Element("img",{src:URIs.logoFast});k.appendChild(d);var g=new Element("div",{"class":"documentTitle"}).update("Welcome to the Gadget Visual Storyboard!");k.appendChild(g);var q=new Element("div",{id:"intro"}).update("Choose your desired action:");k.appendChild(q);var h=new dijit.form.Button({label:"Edit a new Screenflow",onClick:function(){GVS.action("newScreenflow")}});var c=new dijit.form.Button({label:"Browse Screenflows...",onClick:function(){GVS.action("browseScreenflows")}});var b=new dijit.form.Button({label:"Edit a new Screen",onClick:function(){GVS.action("newScreen")}});var f=new dijit.form.Button({label:"Browse Screens...",onClick:function(){GVS.action("browseScreens")}});var l=new dijit.form.Button({label:"Add a Building Block from sources",onClick:function(){GVS.action("newBuildingBlock")}});var p=new dijit.form.Button({label:"Browse Building Blocks...",onClick:function(){GVS.action("browseBuildingBlocks")}});var o=new dijit.form.Button({label:"Create a resource from a service",onClick:function(){GVS.action("wrapperService")}});var r=new dijit.form.Button({label:"Create operator for concepts",onClick:function(){GVS.action("mediation")}});var j=new dijit.form.Button({label:"Manage Domain Concepts",onClick:function(){GVS.action("manageConcepts")}});var i=new Element("div");i.appendChild(new Element("div").update("Screenflows"));i.appendChild(h.domNode);i.appendChild(new Element("br"));i.appendChild(c.domNode);i.appendChild(new Element("div").update("Screens"));i.appendChild(b.domNode);i.appendChild(new Element("br"));i.appendChild(f.domNode);var a=new Element("div",{style:"visibility:hidden;"});a.appendChild(l.domNode);a.appendChild(new Element("br"));a.appendChild(p.domNode);a.appendChild(new Element("br"));a.appendChild(document.createTextNode("---"));if(URIs.wrapperService!=""){a.appendChild(new Element("br"));a.appendChild(o.domNode)}if(URIs.dataMediation!=""){a.appendChild(new Element("br"));a.appendChild(r.domNode)}if(URIs.factTool!=""){a.appendChild(new Element("br"));a.appendChild(j.domNode)}var n=new Element("a",{href:"javascript:"}).update("Show advanced features...");n.observe("click",function(s){if(a.style.visibility=="hidden"){a.setStyle({visibility:"visible"});n.update("Hide advanced features...")}else{a.setStyle({visibility:"hidden"});n.update("Show advanced features...")}});i.appendChild(new Element("br"));i.appendChild(new Element("br"));i.appendChild(n);i.appendChild(new Element("br"));i.appendChild(new Element("br"));i.appendChild(a);k.appendChild(i)}});var DocumentController=Class.create({initialize:function(){this._documents=new Hash();this._currentDocument=null;this._welcomeDocument=null;this._registry=new KeyPressRegistry();this._toolbar=new Toolbar();this._menu=new Menu(this._registry);this._documentContainer=dijit.byId("documentContainer");dojo.connect(this._documentContainer,"selectChild",function(a){DocumentController.prototype._selectDocument.apply(this,arguments)}.bind(this));this.showWelcomeDocument();this._registry.addHandler("delete",this._onKeyPressed.bind(this));this._registry.addHandler("space",this._onKeyPressed.bind(this))},createScreenflow:function(c,b,a){var d=new ScreenflowDocument({name:c,tags:b,version:a});this.addDocument(d)},loadScreenflow:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this},this._onScreenflowLoadSuccess,this._onLoadError)},cloneScreenflow:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this,cloned:true},this._onScreenflowLoadSuccess,this._onLoadError)},createScreen:function(d,c,a){var b=new ScreenDocument({name:d,tags:c,version:a});this.addDocument(b)},loadScreen:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this},this._onScreenLoadSuccess,this._onLoadError)},cloneScreen:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this,cloned:true},this._onScreenLoadSuccess,this._onLoadError)},loadBuildingBlock:function(b){var a=URIs.buildingblock+b;PersistenceEngine.sendGet(a,{mine:this},function(f){var d=JSON.parse(f.responseText);var c=new BuildingBlockDocument(d);this.mine.addDocument(c);c.createTextEditors()},this._onLoadError)},createForm:function(c,b,a){this._createBuildingBlock(c,b,a,BuildingBlockDocument.FORM)},createOperator:function(c,b,a){this._createBuildingBlock(c,b,a,BuildingBlockDocument.OPERATOR)},createResource:function(c,b,a){this._createBuildingBlock(c,b,a,BuildingBlockDocument.RESOURCE)},openExternalTool:function(c,b){var a=new ExternalDocument(c,b);this.addDocument(a)},showWelcomeDocument:function(){if(this._welcomeDocument){this._documentContainer.selectChild(this._welcomeDocument.getTabId());this._selectDocument(this._welcomeDocument.getTabId())}else{this._welcomeDocument=new WelcomeDocument();this.addDocument(this._welcomeDocument)}},addDocument:function(a){this._documents.set(a.getTabId(),a);this._documentContainer.addChild(a.getTab());if(this._documents.keys().size()>1){this._documentContainer.selectChild(a.getTabId())}},getDocument:function(a){return this._documents.get(a)},getCurrentDocument:function(){return this._currentDocument},closeDocument:function(a){this._documentContainer.back();if(this._welcomeDocument&&this._welcomeDocument.getTabId()==a){this._welcomeDocument=null}this._documentContainer.removeChild(dijit.byId(a));dijit.byId(a).destroyRecursive(true);this._documents.unset(a);if($H(this._documents).keys().length==0){this.showWelcomeDocument()}},getToolbar:function(){return this._toolbar},getMenu:function(){return this._menu},getKeyPressRegistry:function(){return this._registry},_selectDocument:function(a){var b;if(a.id){b=a.id}else{b=a}if(this._currentDocument){this._currentDocument.hide()}this._currentDocument=this._documents.get(b);this._currentDocument.show();this._toolbar.setModel(1,this._currentDocument);this._menu.setModel("document",this._currentDocument);$("logout").focus();$("logout").blur()},_onKeyPressed:function(a){this._currentDocument.onKeyPressed(a)},_onScreenflowLoadSuccess:function(c){var a=JSON.parse(c.responseText);a.cloned=this.cloned;a.uri=null;var b=new ScreenflowDocument(a);this.mine.addDocument(b);b.loadInstances()},_onScreenLoadSuccess:function(c){var b=JSON.parse(c.responseText);b.cloned=this.cloned;b.uri=null;var a=new ScreenDocument(b);this.mine.addDocument(a);a.loadInstances()},_createBuildingBlock:function(d,c,b,f){var a=new BuildingBlockDocument({type:f,name:d,tags:c,version:b});this.addDocument(a);a.createTextEditors()},_onLoadError:function(){Utils.showMessage("Can not open the selected element",{error:true,hide:true})}});var ScreenflowDocument=Class.create(PaletteDocument,{initialize:function($super,a){this._planPanel=new PlanPanel();$super("Screenflow",a,new ScreenflowInferenceEngine());this._planPanel.setDropZone(this._areas.get("screen"));this._planPanel.setInferenceEngine(this._inferenceEngine);this._gadgetDialog=new GadgetDialog(this._description);this._player=new ScreenflowPlayer();this._start();this._editMenuAction=new MenuAction({label:"Edit screen",weight:1,enabled:false,handler:function(){this._cloneSelectedElement()}.bind(this)});this._unreachableShown=true},loadInstances:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN);a.cacheBuildingBlocks(this._canvasCache.getScreenURIs(),this._onScreenLoaded.bind(this))},positionUpdated:function(c,a){var b;switch(c.constructor){case ScreenInstance:b=this._description.updateScreen(c.getUri(),a);break;case PrePostInstance:b=this._description.updatePrePost(c.getUri(),a);break}if(b){this._setDirty(true)}},getMenuElements:function($super){var a=$super();a.edit.children.clone={type:"Action",action:this._editMenuAction,group:1};a.file.children.play={type:"Action",action:new MenuAction({label:"Play Gadget",handler:function(){this._playScreenflow()}.bind(this),weight:1}),group:2};a.file.children.gadget={type:"Action",action:new MenuAction({label:"Build Gadget",handler:function(){this._buildGadget()}.bind(this),weight:2}),group:2};return a},cloneElement:function(a){var b=a.getBuildingBlockDescription();if(b.definition){GVS.getDocumentController().cloneScreen(b.id)}},getPlansElement:function(){var b=this._getCanvasUris().collect(function(c){return c.uri});var a=this._getCanvasUris();this._inferenceEngine.getPlans(a,b,this._onSuccessGetPlans.bind(this))},_getAreas:function(){var b=new Area("screen",$A([Constants.BuildingBlock.SCREEN]),this._drop.bind(this),{splitter:true,region:"center"});var c=new Area("pre",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"left",minWidth:100});var a=new Area("post",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"right",minWidth:100});b.getNode().parentNode.appendChild(this._planPanel.getNode());return $H({screen:b,pre:c,post:a})},_getSets:function(){var b=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN));var a=new DomainConceptSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT));return[b,a]},_getDescription:function(a){var b;if(a.id){b=Object.clone(a)}else{b={label:{"en-gb":a.name},name:a.name,version:a.version,tags:this._tags,creator:GVS.getUser().getUserName(),description:{"en-gb":"Please fill the description..."},rights:"http://creativecommons.org/",creationDate:null,icon:"http://fast.morfeo-project.eu/icon.png",screenshot:"http://fast.morfeo-project.eu/screenshot.png",homepage:"http://fast.morfeo-project.eu/"}}return new ScreenflowDescription(b)},_getCanvasCache:function(a){return new ScreenflowCanvasCache(a)},_getSaveUri:function(){return URIs.screenflow},_getType:function(){return"screenflow"},_getEmptyPalette:function(){return{palette:[],canvas:{preconditions:[],postconditions:[]}}},_drop:function(h,b,a,d,f){var c=Utils.variableOrDefault(f,false);if(b.constructor!=PrePostInstance&&b.constructor!=PlanInstance){var g;if(c){g=b.getOriginalUri()}else{g=b.getUri()}if(this._description.contains(g)){Utils.showMessage("There is another element like this. Cannot add it",{hide:true,error:true});return false}}if(b.constructor!=PlanInstance){this._addToArea(h,b,a);b.setEventListener(this);b.enableDragNDrop(h,[h])}switch(b.constructor){case ScreenInstance:if(c){this._description.addScreen(b,a);this._inferenceEngine.addReachabilityListener(b.getUri(),b.getView())}else{b.createCatalogueCopy(function(){this._description.addScreen(b,a);this._refreshReachability();this._setSelectedElement(b);this._save(false)}.bind(this))}break;case PrePostInstance:b.setChangeHandler(this._onPrePostChange.bind({mine:this,position:a,isLoading:c}));if(h.getNode().className.include("pre")){b.setType("pre");b.getView().setReachability({satisfied:true})}else{if(h.getNode().className.include("post")){b.setType("post")}}if(!b.getId()){b.setId(UIDGenerator.generate(b.getTitle()));this._save(false)}else{UIDGenerator.setStartId(b.getId())}this._description.addPrePost(b,a);this._refreshReachability();break;case PlanInstance:this._planPanel.hide();this._addPlan(b,a);break}this._setDirty(true);return true},_setSelectedElement:function($super,a){$super(a,false)},_deleteInstance:function($super,a){this._description.remove(a.getUri());$super(a)},_findCheckCallback:function(a,c){var b=this._paletteController.getPalette(Constants.BuildingBlock.SCREEN);var d=b.getBuildingBlockSet();d.setURIs(a);if(c.canvas.postconditions){c.canvas.postconditions.each(function(g){var h=this._description.getPost(g.id);if(h){var f=h.getView();if(f){f.setReachability(g)}}}.bind(this))}this._refreshVisibility();this._updatePanes()},_configureToolbar:function(){this._addToolbarElement("save",new ToolbarButton("Save the current screenflow","save",this._save.bind(this),false));this._addToolbarElement("properties",new ToolbarButton("Edit screenflow properties","properties",this._propertiesDialog.show.bind(this._propertiesDialog),true));this._addToolbarElement("sep-1",new ToolbarSeparator());this._addToolbarElement("player",new ToolbarButton("Play Screenflow","player",this._playScreenflow.bind(this),false));this._addToolbarElement("debugger",new ToolbarButton("Debug (Test) Screenflow","debugger",this._debugScreenflow.bind(this),false));this._addToolbarElement("sep-2",new ToolbarSeparator());this._addToolbarElement("refresh",new ToolbarButton("Refresh the buildingBlocks catalog","refresh",this._refresh.bind(this),true));this._addToolbarElement("toggleVisibility",new ToolbarButton("Toggle Unreachable screens visibility","toggle",this._toggleUnreachableScreens.bind(this),true));this._addToolbarElement("planner",new ToolbarButton("Create a plan for this screen","planner",this._getPlans.bind(this),false));this._addToolbarElement("sep-3",new ToolbarSeparator());this._addToolbarElement("previewElement",new ToolbarButton("Preview selected element","preview",this._previewSelectedElement.bind(this),false));this._addToolbarElement("cloneElement",new ToolbarButton("Clone selected element","clone",this._cloneSelectedElement.bind(this),false));this._addToolbarElement("deleteElement",new ToolbarButton("Delete selected element","delete",this._startDeletingSelectedElement.bind(this),false));this._addToolbarElement("sep-4",new ToolbarSeparator());this._addToolbarElement("build",new ToolbarButton("Build Gadget","build",this._buildGadget.bind(this),false));this._toolbarElements.get("build").setTextVisible(true)},_refresh:function(){var c=this._getCanvasUris();var b=this._paletteController.getComponentUris(Constants.BuildingBlock.SCREEN);var a={palette:this._paletteController.getComponentUris(Constants.BuildingBlock.SCREEN),canvas:{preconditions:this._description.getPreconditions(),postconditions:this._description.getPostconditions()}};this._inferenceEngine.findCheck(c,a,this._tags,"reachability",this._findCheckCallback.bind(this))},_updateToolbar:function(a){this._toolbarElements.get("deleteElement").setEnabled(a!=null);this._toolbarElements.get("previewElement").setEnabled(a!=null);this._toolbarElements.get("planner").setEnabled(this._getCanvasUris().size()>0);var b=(a!=null&&a.constructor==ScreenInstance&&a.getBuildingBlockDescription().definition!=null);this._toolbarElements.get("cloneElement").setEnabled(b);this._editMenuAction.setEnabled(b)},_renderCenterContainer:function(){var a=new dijit.layout.BorderContainer({design:"headline",liveSplitters:"false",region:"center"});this._designContainer.domNode.addClassName("canvas");a.addChild(this._designContainer);a.addChild(this._inspectorArea);return a},_createInspectorArea:function(){var a=new dijit.layout.BorderContainer({region:"bottom",design:"horizontal",style:"height: 180px;",minSize:"100",maxSize:"220",persist:"false",splitter:true});return a},_refreshReachability:function(d){var c=Utils.variableOrDefault(d,true);var b=this._getCanvasUris();var a={palette:this._paletteController.getComponentUris(Constants.BuildingBlock.SCREEN),canvas:{preconditions:this._description.getPreconditionsCatalogue(),postconditions:this._description.getPostconditionsCatalogue()}};if(c){this._inferenceEngine.findCheck(b,a,this._tags,"reachability",this._findCheckCallback.bind(this))}else{this._inferenceEngine.check(b,a,this._tags,"reachability",this._updatePanes.bind(this))}this._toolbarElements.get("build").setEnabled(b.size()>0);this._toolbarElements.get("player").setEnabled(b.size()>0);this._toolbarElements.get("debugger").setEnabled(b.size()>0)},_updatePanes:function(){if(!this._selectedElement){var d=this._getAllFacts();this._propertiesPane.fillTable(this._description);this._factPane.fillTable([],[],d)}else{this._propertiesPane.fillTable(this._selectedElement);if(this._selectedElement.constructor==ScreenInstance){var g=this._inferenceEngine.getPreconditionReachability(this._selectedElement.getUri());var c=this._selectedElement.getPreconditionTable(g);var a=this._inferenceEngine.isReachable(this._selectedElement.getUri());var f=this._selectedElement.getPostconditionTable(a);this._factPane.fillTable(c,f,[])}else{if(this._selectedElement.getType()){var b=[this._selectedElement.getConditionTable()];this._factPane.fillTable([],[],b)}}}},_playScreenflow:function(){if(this._isDirty){this._pendingOperation=this._playScreenflow.bind(this);this._save(false)}else{this._player.playScreenflow(this._description)}},_debugScreenflow:function(){if(this._isDirty){this._pendingOperation=this._debugScreenflow.bind(this);this._save(false)}else{this._player.debugScreenflow(this._description)}},_buildGadget:function(){if(this._isDirty){this._pendingOperation=this._buildGadget.bind(this);this._save(false)}else{this._gadgetDialog.show()}},_onPrePostChange:function(a){this.mine._description.addPrePost(a,this.position);if(!this.isLoading){this.mine._refreshReachability();this.mine._setSelectedElement(a);this.mine._setDirty(true)}},_getPlans:function(){if(this._planPanel.isVisible()){this._planPanel.hide()}else{this.getPlansElement()}},_onSuccessGetPlans:function(a){if(a.length>0&&a[0].length>0){this._planPanel.showPlans(a)}else{alert("Sorry, but there is not any available plan for the selected screen")}},_addPlan:function(f,a){var d={left:a.left+3,top:a.top+3};var c=new Hash();f.getPlanElements().each(function(h){if(!this._description.contains(h.uri)){var g=new ScreenInstance(h,this._inferenceEngine);c.set(h.uri,g)}}.bind(this));var b=c.keys().collect(function(g){return{uri:g}});PersistenceEngine.sendPost(URIs.catalogueCopy,null,Object.toJSON(b),this,function(h){var g=JSON.parse(h.responseText);g.each(function(j){var i=c.get(j.uri);i.setCopyUri(j.clone);this._addToArea(this._areas.get("screen"),i,d);this._description.addScreen(i,d);d.left+=108;i.setEventListener(this);i.enableDragNDrop(this._areas.get("screen"),[this._areas.get("screen")]);i.onFinish(true)}.bind(this));this._setSelectedElement();this._refreshReachability()}.bind(this),Utils.onAJAXError)},_onScreenLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN);var a=b.getBuildingBlocks(this._canvasCache.getScreenURIs());this._createInstances(b,a,this._areas.get("screen"));this._loadConditions()},_createConditions:function(b,a){b.each(function(h){var g=new PrePostDescription(h);var d=new PrePostInstance(g,this._inferenceEngine);d.onFinish(true,h.position);var f=a.getNode();$("main").appendChild(d.getView().getNode());var c=Geometry.adaptInitialPosition(f,d.getView().getNode(),h.position);$("main").removeChild(d.getView().getNode());this._drop(a,d,c,true);this._description.addPrePost(d,c)}.bind(this))},_loadConditions:function(){this._createConditions(this._canvasCache.getPreconditions(),this._areas.get("pre"));this._createConditions(this._canvasCache.getPostconditions(),this._areas.get("post"));this._setDirty(false);this._refreshReachability();if(this._description.cloned){this._saveAs(true)}},_cloneSelectedElement:function(){this.cloneElement(this._selectedElement)},_toggleUnreachableScreens:function(){this._unreachableShown=!this._unreachableShown;this._refreshVisibility()},_refreshVisibility:function(){var b=this._paletteController.getPalette(Constants.BuildingBlock.SCREEN);var c=b.getContentNode();var a=this._unreachableShown?"block":"none";$A(c.childNodes).each(function(d){if(d.match(".slot")){if(d.firstChild.match(".unsatisfeable")){d.setStyle({display:a})}if(d.firstChild.match(".satisfeable")){d.setStyle({display:"block"})}}},this)}});var ScreenDocument=Class.create(PaletteDocument,{initialize:function($super,c){this._formInstance=null;this._pipeFactory=new PipeFactory();this._triggerMappingFactory=new TriggerMappingFactory();this._dojoConnections=new Array();this._recommendationManager=new RecommendationManager();this._closed=false;$super("Screen",c,new ScreenInferenceEngine());this._start();function d(h,g){var f;dojo.connect(h,"_startDrag",function(){f=dojo.connect(null,"onmousemove",g)});dojo.connect(h,"_stopDrag",function(i){dojo.disconnect(f)})}this._repaint=this._repaint.bind(this);Event.observe(window,"resize",this._repaint);var a=this._mainBorderContainer.getSplitter("left");d(a,this._repaint);var b=this._centerContainer.getSplitter("bottom");d(b,this._repaint);this._designContainer.domNode.addClassName("canvas");dojo.forEach(["left","bottom","right","top"],function(g){var f=this._designContainer.getSplitter(g);d(f,this._repaint)}.bind(this));this._prePostNodes={pre:null,post:null};this._prePostInstances={pre:null,post:null}},show:function(){this._pipeFactory.showPipes()},hide:function(){this._pipeFactory.hidePipes()},loadInstances:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM);a.cacheBuildingBlocks(this._canvasCache.getFormURI(),this._onFormLoaded.bind(this));var c=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR);c.cacheBuildingBlocks(this._canvasCache.getOperatorURIs(),this._onOperatorsLoaded.bind(this));var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE);b.cacheBuildingBlocks(this._canvasCache.getResourceURIs(),this._onResourcesLoaded.bind(this))},positionUpdated:function(d,a,c){var b;switch(d.constructor){case PrePostInstance:b=this._description.updatePrePost(d,a);break;default:b=this._description.updateBuildingBlock(d,a,c);break}if(b){this._setDirty(true)}},_getAreas:function(){var c=new Area("form",$A([Constants.BuildingBlock.FORM]),this._drop.bind(this),{splitter:true,region:"top",minHeight:150});var d=new Area("operator",$A([Constants.BuildingBlock.OPERATOR]),this._drop.bind(this),{splitter:true,region:"center",minHeight:350,minWidth:200});var b=new Area("resource",$A([Constants.BuildingBlock.RESOURCE]),this._drop.bind(this),{splitter:true,region:"bottom",minHeight:100});var f=new Area("pre",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"left",minWidth:100});var a=new Area("post",$A([Constants.BuildingBlock.DOMAIN_CONCEPT]),this._drop.bind(this),{splitter:true,region:"right",minWidth:100});this._areas=$H({form:c,operator:d,resource:b,pre:f,post:a});return this._areas},_getSets:function(){var b=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM));var c=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR));var d=new BuildingBlockSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE));var a=new DomainConceptSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT));return[b,c,d,a]},_getDescription:function(a){var b;if(a.id){b=Object.clone(a);b.definition=null;b.precondition=null;b.postconditions=null}else{b={label:{"en-gb":a.name},name:a.name,version:a.version,tags:this._tags,creator:GVS.getUser().getUserName(),description:{"en-gb":"Please fill the description..."},rights:"http://creativecommons.org/",creationDate:null,icon:"http://fast.morfeo-project.eu/icon.png",screenshot:"http://fast.morfeo-project.eu/screenshot.png",homepage:"http://fast.morfeo-project.eu/"}}return new ScreenDescription(b)},_getCanvasCache:function(a){return new ScreenCanvasCache(a)},_getSaveUri:function(){return URIs.screen},_getType:function(){return"screen"},_getEmptyPalette:function(){return{forms:[],operators:[],backendservices:[],preconditions:[],postconditions:[],pipes:[]}},_effectiveCloseDocument:function($super,a){if(!a||a==ConfirmDialog.DISCARD){this._closed=true}$super(a);if(!a||a==ConfirmDialog.DISCARD){this._dojoConnections.each(function(b){dojo.disconnect(b)}.bind(this));this._dojoConnections=null;this._repaint=null}},_drop:function(b,n,j,c,l){var k=Utils.variableOrDefault(l,false);if(n.constructor==FormInstance){if(this._formInstance){Utils.showMessage("Only one form per screen is allowed",{hide:true,error:true});return false}else{this._formInstance=n;this._description.icon=n.getBuildingBlockDescription().icon;this._description.screenshot=n.getBuildingBlockDescription().screenshot}}this._addToArea(b,n,j,c);var d={onPipeCreationStart:this._onPipeCreationStartHandler.bind(this),onPipeCreationCancel:this._onPipeCreationCancelHandler.bind(this),onPipeCreation:this._onPipeCreationHandler.bind(this),onPipeDeletion:this._onPipeDeletionHandler.bind(this)};if(n.constructor!=PrePostInstance){n.createTerminals(d);if(k){this._description.addBuildingBlock(n,j,c);this._inferenceEngine.addReachabilityListener(n.getUri(),n.getView())}else{n.createCatalogueCopy(function(){this._description.addBuildingBlock(n,j,c);this._setSelectedElement(n);this._save(false)}.bind(this))}}else{n.setConfigurable(false);if(!n.getId()){n.setId(UIDGenerator.generate(n.getTitle()))}else{UIDGenerator.setStartId(n.getId())}if(b.getNode().className.include("pre")){n.setType("pre");n.createTerminal(d);this._description.addPre(n,j);n.getView().setReachability({satisfied:true})}else{if(b.getNode().className.include("post")){n.setType("post");n.createTerminal(d);this._description.addPost(n,j)}}if(!k){this._setSelectedElement(n);this._save(false)}}if(!k){var o=null;switch(n.constructor){case FormInstance:var p=false;var g=n.getBuildingBlockDescription().actions;for(var h=0;h<g.length;h++){if(g[h].name=="init"){p=true;break}}if(p){o="init"}break;case ResourceInstance:var g=n.getBuildingBlockDescription().actions;if(g.length>0){o=g[0].name}break}if(o){var a={from:{instance:ScreenTrigger.INSTANCE_NAME,name:ScreenTrigger.ONLOAD},to:{instance:n,action:o}};var f=this._triggerMappingFactory.createTrigger(a);this._description.addTrigger(f)}}n.setEventListener(this);n.enableDragNDrop(b,[b]);n.getView().addGhost();return true},_onPipeCreationStartHandler:function(c,b){var a=b.getInstance();var d;if(a instanceof FormInstance){d="form_"+a.getId()+(b.getActionId()?"_"+b.getActionId():"")+"_"+b.getConditionId()}else{if(a instanceof PrePostInstance){d=a.getType()+"_"+a.getId()}else{if(a instanceof ResourceInstance){d="service_"+a.getId()+"_"+b.getActionId()+"_"+b.getConditionId()}else{if(a instanceof OperatorInstance){d="operator_"+a.getId()+"_"+b.getActionId()+"_"+b.getConditionId()}}}}if(a.constructor!=PrePostInstance){this._areas.get("pre").observe("mouseover",this._showDropArea.bind({startTerminal:b,area:"pre",mine:this}));this._areas.get("post").observe("mouseover",this._showDropArea.bind({startTerminal:b,area:"post",mine:this}))}if(this._selectedElement!=a){this._setSelectedElement(a)}this._recommendationManager.setStartFact(d)},_onPipeCreationCancelHandler:function(b){this._areas.get("pre").stopObserving("mouseover");this._areas.get("post").stopObserving("mouseover");var a=this._prePostNodes.pre||this._prePostNodes.post;if(a){setTimeout(function(){var c="pre";if(this._prePostNodes[c]){this._areas.get(c).getNode().removeChild(this._prePostNodes[c]);this._prePostNodes[c]=null}if(this._prePostInstances[c]){this._deleteInstance(this._prePostInstances[c]);this._prePostInstances[c]=null}c="post";if(this._prePostNodes[c]){this._areas.get(c).getNode().removeChild(this._prePostNodes[c]);this._prePostNodes[c]=null}if(this._prePostInstances[c]){this._deleteInstance(this._prePostInstances[c]);this._prePostInstances[c]=null}}.bind(this),200)}this._recommendationManager.setStartFact(null)},_onPipeDeletionHandler:function(b){if(this._closed){return}var a=this._pipeFactory.getPipe(b);if(a){this._pipeFactory.removePipe(a);this._description.remove(a);if(!this._removingInstance){this._refreshReachability()}this._setDirty(true)}},_onPipeCreationHandler:function(b){var a=this._pipeFactory.getPipe(b);if(a){this._description.addPipe(a);this._refreshReachability();this._setDirty(true);if(a.getSource().getInstance()==this._prePostInstances.pre){this._prePostInstances.pre=null}if(a.getDestination().getInstance()==this._prePostInstances.post){this._prePostInstances.post=null}}this._areas.get("pre").stopObserving("mouseover");this._areas.get("post").stopObserving("mouseover")},_showDropArea:function(){var i=this.startTerminal;var b=this.area;if(this.mine._prePostNodes[b]==null){this.mine._prePostNodes[b]=new Element("div",{style:"position:absolute; text-align: center; top: 0px;right: 0px; left: 0px; height:70px;border: 1px solid black; padding: 5px"});var j=new Element("div",{"class":"dijitAccordionTitle"}).update("Create "+b);this.mine._prePostNodes[b].appendChild(j);this.mine._areas.get(b).getNode().appendChild(this.mine._prePostNodes[b]);var k=i.getInstance().getBuildingBlockDescription();var g=i.getActionId();if(g){var f=k.actions.detect(function(l){return(l.name==g)}).preconditions}else{var f=k.postconditions}var c=f.detect(function(l){return(l.id==i.getConditionId())});var d=new PrePostDescription(c);d.generateUri();this.mine._prePostInstances[b]=new PrePostInstance(d,this.mine._inferenceEngine,false);var h={top:35,left:Geometry.getCenter(this.mine._prePostNodes[b]).left-21};var a=UIDGenerator.generate(d.id);this.mine._prePostInstances[b].setId(a);this.mine._prePostInstances[b].onFinish(h,true);this.mine._drop(this.mine._areas.get(b),this.mine._prePostInstances[b],h,true)}},_setSelectedElement:function($super,a){if(a==null){this._recommendationManager.clear()}$super(a)},_deleteInstance:function($super,a){if(a.constructor==FormInstance){this._formInstance=null}this._description.remove(a);this._removingInstance=true;this._pipeFactory.getPipes(a).each(function(b){this._pipeFactory.removePipe(b);this._description.remove(b)}.bind(this));this._triggerMappingFactory.getRelatedTriggers(a).each(function(b){this._triggerMappingFactory.removeTrigger(b);this._description.remove(b)}.bind(this));$super(a);this._removingInstance=false},_findCheckCallback:function(a){$H(a).each(function(c){var b=this._paletteController.getPalette(Constants.CatalogueRelationships[c.key]);if(b){var d=b.getBuildingBlockSet();d.setURIs(c.value)}}.bind(this))},_configureToolbar:function(){this._addToolbarElement("save",new ToolbarButton("Save the current screen","save",this._save.bind(this),false));this._addToolbarElement("properties",new ToolbarButton("Edit screen properties","properties",this._propertiesDialog.show.bind(this._propertiesDialog),true));this._addToolbarElement("sep-1",new ToolbarSeparator());this._addToolbarElement("debugger",new ToolbarButton("Debug (Test) Screen","debugger",this._debugScreen.bind(this),false));this._addToolbarElement("refresh",new ToolbarButton("Refresh the buildingBlocks catalog","refresh",this._refresh.bind(this),true));this._addToolbarElement("rotate",new ToolbarButton("Rotate selected element","rotate",this._rotateSelectedElement.bind(this),false));this._addToolbarElement("deleteElement",new ToolbarButton("Delete selected element","delete",this._startDeletingSelectedElement.bind(this),false));this._addToolbarElement("sep-1",new ToolbarSeparator());this._addToolbarElement("share",new ToolbarButton("Share Screen","share",this._share.bind(this),true));this._toolbarElements.get("share").setTextVisible(true)},_refresh:function(){var a={forms:this._paletteController.getComponentUris(Constants.BuildingBlock.FORM),operators:this._paletteController.getComponentUris(Constants.BuildingBlock.OPERATOR),backendservices:this._paletteController.getComponentUris(Constants.BuildingBlock.RESOURCE),pipes:this._description.getPipes(),preconditions:this._description.getPreconditions(),postconditions:this._description.getPostconditions()};this._inferenceEngine.findCheck([],a,this._tags,"reachability",this._findCheckCallback.bind(this))},_updateToolbar:function(a){this._toolbarElements.get("deleteElement").setEnabled(a!=null);if(a!=null){var b=a.getBuildingBlockDescription();this._toolbarElements.get("rotate").setEnabled(b.type==Constants.BuildingBlock.OPERATOR)}else{this._toolbarElements.get("rotate").setEnabled(false)}this._toolbarElements.get("debugger").setEnabled(this._formInstance!=null)},_renderCenterContainer:function(){var a=new dijit.layout.BorderContainer({design:"headline",liveSplitters:"false",region:"center"});a.addChild(this._designContainer);a.addChild(this._inspectorArea);this._centerContainer=a;return a},_repaint:function(){this._description.getCanvasInstances().each(function(a){a.onUpdate()});this._description.getConditionInstances().each(function(a){a.onUpdate()})},_refreshReachability:function(d){var c=Utils.variableOrDefault(d,true);this._recommendationManager.clear();var b=this._getCanvasUris();var a={forms:this._paletteController.getComponentUris(Constants.BuildingBlock.FORM),operators:this._paletteController.getComponentUris(Constants.BuildingBlock.OPERATOR),backendservices:this._paletteController.getComponentUris(Constants.BuildingBlock.RESOURCE),pipes:this._description.getPipes(),preconditions:this._description.getPreconditions(),postconditions:this._description.getPostconditions()};if(this._selectedElement&&this._selectedElement.getUri()){a.selectedItem=this._selectedElement.getUri()}else{if(this._selectedElement){a.selectedItem=this._selectedElement.getId()}}if(c){this._inferenceEngine.findCheck(b,a,this._tags,"reachability",this._onUpdateReachability.bind(this))}else{this._inferenceEngine.check(b,a,this._tags,"reachability",this._onUpdateReachability.bind(this))}},_parseConnectionElement:function(b,h){if(b.buildingblock==null){var d;var j;if(h){d="pre";j=this._description.getPre(b.condition)}else{d="post";j=this._description.getPost(b.condition)}return{instance:j,node:j.getView().getNode(),key:d+"_"+b.condition}}else{var g=this._description.getInstanceByUri(b.buildingblock);if(b.buildingblock.search("/forms/")!=-1){var i="form_"+g.getId()+(b.action?"_"+b.action:"")+"_"+b.condition;return{instance:g,node:g.getView().getConditionNode(b.condition,b.action),key:i}}else{if(b.buildingblock.search("/services/")!=-1){var f=g.getView();var c;if(h){c="postconditions"}else{c=f._icons.keys()[0]}var a=f.getConditionNode(b.condition,c);return{instance:g,node:a,key:"service_"+g.getId()+"_"+c+"_"+b.condition}}else{if(b.buildingblock.search("/operators/")!=-1){return{instance:g,node:g.getView().getConditionNode(b.condition,b.action),key:"operator_"+g.getId()+"_"+b.action+"_"+b.condition}}else{throw"unknowk building block at ScreenDocument::_parseConnectionElement"}}}}},_onUpdateReachability:function(a){if(a.postconditions){a.postconditions.each(function(f){var g=this._description.getPost(f.id);if(g){var d=g.getView();if(d){d.setReachability(f)}}}.bind(this))}if(a.pipes){a.pipes.each(function(g){var i,d;if(g.from.buildingblock){var f=this._description.getInstancesByUri(g.from.buildingblock);origins=f.map(function(j){return j.getTerminal(g.from.condition,"postconditions")})}else{origins=[this._description.getPre(g.from.condition).getTerminal()]}if(g.to.buildingblock){var h=this._description.getInstancesByUri(g.to.buildingblock);d=h.map(function(j){return j.getTerminal(g.to.condition,g.to.action)})}else{d=[this._description.getPost(g.to.condition).getTerminal()]}origins.each(function(j){d.each(function(l){var k=this._pipeFactory.getPipeFromTerminals(j,l);if(k){k.setReachability(g)}}.bind(this))}.bind(this))}.bind(this))}if(a.connections){a.connections.each(function(d){var j,i,g,f;try{j=this._parseConnectionElement(d.from,true);i=this._parseConnectionElement(d.to,false)}catch(h){return}if(j.instance==this._selectedElement){g=j;f=i}else{if(i.instance==this._selectedElement){g=i;f=j}else{return}}this._recommendationManager.addRecommendation(g,f)}.bind(this));this._recommendationManager.startAnimation()}if(GVS.getUser().getCatalogueMagic()){this._findCheckCallback(a)}if(a.iserve&&a.iserve.length>0){var c=new Element("span");c.update("Don't find a service in the catalogue? <br /> Some external services could fit your needs. ");var b=new Element("a",{href:"javascript:"}).update("Show them");b.observe("click",function(){this._showiServe(a.iserve)}.bind(this));c.appendChild(b);Utils.showMessage(c)}else{Utils.hideMessage()}this._updatePanes()},_updatePanes:function(){if(!this._selectedElement){this._propertiesPane.fillTable(this._description);var f=this._getAllFacts();this._factPane.fillTable([],[],f)}else{this._propertiesPane.fillTable(this._selectedElement);if(this._selectedElement.constructor!=PrePostInstance){var a=this._getInstanceActions();this._propertiesPane.addSection(["Action","Triggers"],a);var h=this._inferenceEngine.getPreconditionReachability(this._selectedElement.getUri());var d=this._selectedElement.getPreconditionTable(h);var b=this._inferenceEngine.isReachable(this._selectedElement.getUri());var g=this._selectedElement.getPostconditionTable(b);this._factPane.fillTable(d,g,[])}else{if(this._selectedElement.getType()){var c=[this._selectedElement.getConditionTable()];this._factPane.fillTable([],[],c)}}}},_getInstanceActions:function(){var b=this._triggerMappingFactory.getTriggerList(this._selectedElement);var a=new Hash();var c=this._selectedElement.getBuildingBlockDescription().actions;c.each(function(d){a.set(d.name,this._buildTriggerList(d.name,b.get(d.name)))}.bind(this));return a},_buildTriggerList:function(b,c){var a=new Element("div");var d="";if(c){c.each(function(g){d+=g.getTriggerName()+", "});d=d.slice(0,-2)}else{d=new Element("span",{"class":"triggerInfo"}).update("No triggers for this action")}a.update(d);var f=new TriggerDialog(b,c,this._description.getCanvasInstances(),this._onTriggerChange.bind(this));a.appendChild(f.getButtonNode());return a},_onTriggerChange:function(c,b,a){b.each(function(h){var i=h.split("#");var d;if(i[0]==ScreenTrigger.INSTANCE_NAME){d=i[0]}else{d=this._description.getInstance(i[0])}var g={from:{instance:d,name:i[1]},to:{instance:this._selectedElement,action:c}};var f=this._triggerMappingFactory.createTrigger(g);this._description.addTrigger(f)}.bind(this));a.each(function(h){var i=h.split("#");var d;if(i[0]==ScreenTrigger.INSTANCE_NAME){d=i[0]}else{d=this._description.getInstance(i[0])}var g={from:{instance:d,name:i[1]},to:{instance:this._selectedElement,action:c}};var f=this._triggerMappingFactory.removeTrigger(g);this._description.remove(f)}.bind(this));this._updatePanes();this._setDirty(true)},_share:function(){if(this._description.isValid()){if(this._isDirty){this._pendingOperation=this._share.bind(this);this._save(false)}else{var b=new Element("div",{style:"text-align:center; width: 30em; margin: 0 auto;"}).update("You are about to share the screen. After that, you will not be able to edit the screen anymore. You can either close the screen or create a clone (Save with another name/version)");var a=new ConfirmDialog("Warning",ConfirmDialog.CUSTOM,{callback:this._onShareDialogEvent.bind(this),contents:b,buttons:{clone:"Share and create a clone",close:"Share and close",cancel:"Cancel"},style:"width: "});a.show()}}else{this._propertiesDialog.show(this._share.bind(this))}},_onShareDialogEvent:function(a){if(a!="cancel"){var b=URIs.share.replace("<id>",this._description.getId());PersistenceEngine.sendPost(b,null,null,{mine:this,status:a},this._onShareSuccess,Utils.onAJAXError)}},_onShareSuccess:function(a){Utils.showMessage("Screen successfully shared",{hide:true});switch(this.status){case"clone":this.mine._saveAs(true);break;case"close":this.mine._effectiveCloseDocument(ConfirmDialog.DISCARD);break}},_onFormLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.FORM);var a=b.getBuildingBlocks(this._canvasCache.getFormURI());this._createInstances(b,a,this._areas.get("form"));this._canvasCache.setLoaded(Constants.BuildingBlock.FORM);this._loadConnections()},_onOperatorsLoaded:function(){var b=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.OPERATOR);var a=b.getBuildingBlocks(this._canvasCache.getOperatorURIs());this._createInstances(b,a,this._areas.get("operator"));this._canvasCache.setLoaded(Constants.BuildingBlock.OPERATOR);this._loadConnections()},_onResourcesLoaded:function(){var a=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.RESOURCE);var b=a.getBuildingBlocks(this._canvasCache.getResourceURIs());this._createInstances(a,b,this._areas.get("resource"));this._canvasCache.setLoaded(Constants.BuildingBlock.RESOURCE);this._loadConnections()},_createConditions:function(b,a){b.each(function(h){var g=new PrePostDescription(h);var d=new PrePostInstance(g,this._inferenceEngine,false);d.setId(h.id);d.onFinish(true,h.position);var f=a.getNode();$("main").appendChild(d.getView().getNode());var c=Geometry.adaptInitialPosition(f,d.getView().getNode(),h.position);$("main").removeChild(d.getView().getNode());this._drop(a,d,c,true)}.bind(this))},_createPipes:function(a){a.each(function(f){var c;var g;if(f.from.buildingblock!=""){c=this._description.getInstance(f.from.buildingblock);g=c.getTerminal(f.from.condition)}else{c=this._description.getPre(f.from.condition);if(!c){c=this._description.getPost(f.from.condition)}g=c.getTerminal()}var h;var b;if(f.to.buildingblock!=""){h=this._description.getInstance(f.to.buildingblock);b=h.getTerminal(f.to.condition,f.to.action)}else{h=this._description.getPre(f.to.condition);if(!h){h=this._description.getPost(f.to.condition)}b=h.getTerminal()}var d=this._pipeFactory.getPipe(g,b);this._description.addPipe(d)}.bind(this))},_createTriggers:function(a){a.each(function(g){var c=null;if(g.from.buildingblock!=""){c=this._description.getInstance(g.from.buildingblock)}var f=this._description.getInstance(g.to.buildingblock);var d={from:{instance:c?c:ScreenTrigger.INSTANCE_NAME,name:c?g.from.name:ScreenTrigger.ONLOAD},to:{instance:f,action:g.to.action}};var b=this._triggerMappingFactory.createTrigger(d);this._description.addTrigger(b)}.bind(this))},_loadConnections:function(){if(this._canvasCache.areInstancesLoaded()){this._createConditions(this._canvasCache.getPreconditions(),this._areas.get("pre"));this._createConditions(this._canvasCache.getPostconditions(),this._areas.get("post"));this._createPipes(this._canvasCache.getPipes());this._createTriggers(this._canvasCache.getTriggers());this._setDirty(false);this._refreshReachability();if(this._description.cloned){this._saveAs(true)}}},_debugScreen:function(){if(this._isDirty){this._pendingOperation=this._debugScreen.bind(this);this._save(false)}else{var a=URIs.storePlayScreenflow+"?screen="+this._description.getId()+"&debugLevel=debug";var b=this._description.getPreconditions();if(b.length>=1){a+="&factURI="+encodeURIComponent(b[0].uri)}GVS.getDocumentController().openExternalTool("Screen Debugger",a)}},_showiServe:function(b){var a=new a(b);iserveDialog.show()}});var BuildingBlockDocument;(function(){var p={subscribe:function u(F){var G=this._observers||(this._observers=[]);G.push(F);return this},emit:function r(){var G=this._observers||(this._observers=[]);for(var F=G.length;F--;){G[F].update.call(G[F])}return this}};function E(G,F){F||(F={});this.objects=G||[];this.model=F.model;this.primaryKey=this.model.key||"id"}Object.extend(E.prototype,p);E.prototype.find=function t(I){var F,H=this.primaryKey,J=this.objects;for(var G=J.length;G--;){F=J[G];if(F[H]===I){return F}}return null};E.prototype.insert=function b(F){var G=F[this.primaryKey];if(this.find(G)){return}this.objects.push(F);F._collection=this;return F};E.prototype.remove=function D(){var G,I=this.objects,F=[];for(var H=arguments.length;H--;){G=I.indexOf(arguments[H]);if(G>=0){F.push(I.splice(G,1))}}return F};E.prototype.create=function q(G){var F=(this.model)?new this.model(G):Object.clone(G);return this.insert(F)};E.prototype.toJSON=function c(){return this.objects};E.prototype.each=function h(G,F){return this.objects.each(G,F)};E.prototype.map=function(G,F){return this.objects.map(G,F)};E.prototype.empty=function(){return this.objects.length===0};function A(F){this.setProperties(F)}A.key="id";A.prototype.get=function(F){return this[F]};A.prototype.set=function(F,G){this[F]=G};A.prototype.getProperties=function l(){var F={};for(var G in this){F[G]=this[G]}delete F._collection;return F};A.prototype.setProperties=function v(G){for(var F in G){this[F]=G[F]}};A.prototype.remove=function D(){this._collection.remove(this)};A.prototype.toJSON=function B(){var F={};for(var G in this){F[G]=this[G]}delete F._collection;return F};function i(F){this.setProperties(F);this.preconditions=new E([],{model:A});if(F&&F.preconditions){F.preconditions.each(function(G){var H=new A(G);this.preconditions.insert(H)},this)}}i.key="name";i.prototype.getProperties=function l(){var F={};for(var G in this){F[G]=this[G]}delete F._collection;delete F.preconditions;return F};i.prototype.setProperties=function v(G){var H=this.preconditions;for(var F in G){this[F]=G[F]}this.preconditions=H};i.prototype.remove=function D(){this._collection.remove(this)};i.prototype.toJSON=function B(){var F={};for(var G in this){F[G]=this[G]}delete F._collection;return F};var g={};g.resource="serviceFunction: function(inputFacts) {\n}";g.operator="operatorFunction: function(inputFacts) {\n}";g.form='<html>\n<head>\n<script type="text/javascript">\nvar {{buildingblockId}} = Class.create(BuildingBlock, {\n\tinit: function (){}\n});\n<\/script>\n</head>\n<body>\n</body>\n</html>';BBDescription=Class.create(BuildingBlockDescription,p,{initialize:function($super,F){$super(Object.extend({label:{"en-gb":F.name},version:"0.1",tags:[],creator:GVS.getUser().getUserName(),description:{"en-gb":"Please fill the description..."},rights:"http://creativecommons.org/",icon:"http://fast.morfeo-project.eu/icon.png",screenshot:"http://fast.morfeo-project.eu/screenshot.png",homepage:"http://fast.morfeo-project.eu/",actions:[],postconditions:[]},F));var G=new E([],{model:i});this.actions.each(function(I){var J=new i(I);G.insert(J)});this.actions=G;var H=new E([],{model:A});this.postconditions.each(function(I){var J=new A(I);H.insert(J)});this.postconditions=H},toJSON:function B(){var F=this.getProperties();F.actions=this.actions;F.postconditions=this.postconditions;return F},getProperties:function(){var G=Object.clone(this);delete G._observers;delete G.actions;delete G.postconditions;for(var F in G){if(G[F] instanceof Function){delete G[F]}}return G},addProperties:function(F){this.setProperties(F)},setProperties:function(F){var G=Object.clone(F);delete G.actions;delete G.postconditions;Object.extend(this,G);this.emit()},getCode:function(){if(this.codeInline){return this.codeInline}if(!this.code){var F=g[this.type]||"";this.setProperties({codeInline:F});return F}new Ajax.Request("/proxy",{method:"post",parameters:{url:this.code,method:"get"},onSuccess:function(H){var G=H.responseText;this.setProperties({codeInline:G});this.emit()}.bind(this),onFailure:function(){Utils.showErrorMessage("Can not open code of the selected element",{hide:true})}});return g[this.type]||""}});var w=(function(){_createLine=function(F,G){var H=new Element("div",{"class":"line"});if(F){H.appendChild(new Element("label").update(F))}H.appendChild(G);return H};_buildLine=function(F,H){var L;var I;switch(F.type){case"title":L=new Element("h3").update(F.value);break;case"input":var G;if(F.regExp||F.required){G=new dijit.form.ValidationTextBox({name:F.name,value:F.value,regExp:(F.regExp)?F.regExp:".*",required:(F.required)?F.required:false,invalidMessage:(F.message)?F.message:"This field cannot be blank"})}else{G=new dijit.form.TextBox({name:F.name,value:F.value})}if(F.disabled){G.attr("disabled",F.disabled)}I=G.textbox;L=_createLine(F.label,G.domNode);break;case"checkbox":var J=new dijit.form.CheckBox({name:F.name,value:F.value});if(F.disabled){J.attr("disabled",F.disabled)}if(F.checked){J.attr("checked",F.checked)}I=J.domNode;L=_createLine(F.label,J.domNode);break;case"label":L=new Element("div",{"class":"line",style:F.style}).update(F.value);break;case"pre":L=new Element("pre",{"class":"line",style:F.style}).update(F.value);break;case"hidden":L=new Element("input",{type:"hidden",name:F.name,value:F.value});break;case"comboBox":I=new Element("select",{name:F.name});$A(F.options).each(function(M){var N=new Element("option",{value:M.value}).update(M.label);if(M.value==F.value){N.selected="selected"}I.appendChild(N)});L=_createLine(F.label,I);break;case"textarea":var K=new dijit.form.SimpleTextarea({name:F.name});K.attr("value",F.value);I=K.domNode;L=_createLine(F.label,I);break;default:throw"Unimplemented form field type"}if(I){$H(H).each(function(M){Element.observe(G,M.key,M.value)})}return L};return{build:function(G,H){var F=new dijit.form.Form(Object.extend({method:"post"},H));$A(G).each(function(I){var J=_buildLine(I);F.domNode.appendChild(J)}.bind(this));return F}}})();var d=Class.create({initialize:function(F){this.data=F;this.domNode=new Element("div").setStyle({display:"none",overflow:"auto",height:"100%",padding:"5px 20px"});this.update()},save:function(){var H=this._form.domNode;var F=Utils.sanitize($F(H.name));var G=Object.extend({name:F,tags:$F(H.tags).split(/[\s,]+/).without(""),triggers:$F(H.triggers).split(/[\s,]+/).without(""),libraries:$F(H.libraries).split(/[\s,]+/).without(""),label:{"en-gb":F},description:{"en-gb":$F(H.description)},},Form.serializeElements([H.version,H.creator,H.rights,H.icon,H.screenshot,H.homepage,H.parameterTemplate],{hash:true}));this.data.addProperties(G)},update:function(F){F=F||this.data;this._form=w.build([{type:"title",value:"Basic information"},{type:"input",label:"Building block name:",name:"name",value:F.name,required:true,events:{blur:function(){form.name.value=Utils.sanitize($F(form.name))}}},{type:"input",label:"Version:",name:"version",value:F.version},{type:"input",label:"Tags:",name:"tags",value:F.tags.collect(function(G){return G.label["en-gb"]}).join(", ")},{type:"title",value:"Sharing information"},{type:"textarea",label:"Description:",name:"description",value:F.description["en-gb"],required:true},{type:"input",label:"Creator:",name:"creator",value:F.creator,required:true,disabled:true},{type:"input",label:"Licence information:",name:"rights",value:F.rights,required:true},{type:"input",label:"Icon:",name:"icon",value:F.icon,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Screenshot:",name:"screenshot",value:F.screenshot,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Homepage:",name:"homepage",value:F.homepage,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Triggers:",name:"triggers",value:F.triggers.join(", ")},{type:"textarea",label:"Parameter Template:",name:"parameterTemplate",value:F.parameterTemplate},{type:"textarea",label:"Libraries:",name:"libraries",value:F.libraries.join(",\n")}]);this.domNode.update(this._form.domNode)},validate:function(){return this._form.validate()},show:function(){return this.domNode.show()},hide:function(){this.save();return this.domNode.hide()},visible:function(){return this.domNode.visible()},toElement:function(){return this.domNode}});var y=Class.create(DragSource,{initialize:function($super,G,F){$super();this.condition=G;this.controller=F},toElement:function(){if(!this.node){this.node=new DomainConceptView(this.condition);this.menu=new MenuOptions(this.node.toElement());this.menu.addOption("Delete Condition",function(){this.controller.remove(this.condition)}.bind(this))}return this.node.toElement()},getHandlerNode:function(){return this.node.getNode()},getDraggableObject:function(){return this},onFinish:function(G,F){this.controller.update(this.condition,{position:F})},setPosition:function(F){this.node.setPosition(F)},insertInArea:function(F){F.insert(this,this.condition.position);this.enableDragNDrop(F,[F])}});function s(F){this.actions=F}s.prototype.create=function q(H,F){var J=this.actions,G={name:F,uses:[]},I=(J.find(F)||J.create(G));if(I.preconditions.create(H)){J.emit()}};s.prototype.remove=function D(F){F.remove();this.actions.each(function(G){if(G.preconditions.empty()){G.remove()}});this.actions.emit()};s.prototype.update=function o(G,F){G.setProperties(F);this.actions.emit()};function f(G){this.actions=G;this.controller=new s(G);var F=this;this.area=new Area("pre",[Constants.BuildingBlock.DOMAIN_CONCEPT],function(K,I,H){var J=I.getBuildingBlockDescription();F.dropInstance(J,H);return true},{splitter:true,region:"left",minWidth:45});this.actions.subscribe(this)}f.prototype.update=function o(){var G=this.area,F=this.controller,H=this.actions;G.getNode().update();H.each(function(I){I.preconditions.each(function(J){view=new y(J,F);view.insertInArea(G)})})};f.prototype.init=f.prototype.update;f.prototype.dropInstance=function(H,F){var G=prompt("Action Name:","default");if(!G){return}var I=prompt("Condition Name:","default");if(!I){return}this.controller.create({id:I,label:H.label,pattern:H.pattern,position:F},G)};function a(F){this.conditions=F}a.prototype.create=function q(F){if(this.conditions.create(F)){this.conditions.emit()}};a.prototype.remove=function D(F){F.remove();this.conditions.emit()};a.prototype.update=function o(G,F){G.setProperties(F);this.conditions.emit()};function z(H){this.conditions=H;this.controller=new a(H);var G=this;this.area=new Area("post",[Constants.BuildingBlock.DOMAIN_CONCEPT],function F(L,J,I){var K=J.getBuildingBlockDescription();G.dropInstance(K,I);return true},{splitter:true,region:"right",minWidth:45});this.conditions.subscribe(this)}z.prototype.update=function o(){var G=this.area,F=this.controller,H=this.conditions;G.getNode().update();H.each(function(J){var I=new y(J,F);I.insertInArea(G)},this)};z.prototype.init=z.prototype.update;z.prototype.dropInstance=function(H,F){var G=prompt("Condition Name:","default");if(!G){return}this.controller.create({id:G,label:H.label,pattern:H.pattern,position:F})};PropertiesEditorView=Class.create({initialize:function(F){this.model=F;this.JSONEditor=new k(this.model);this.FormEditor=new d(this.model);this.area=new Area("json",[],null,{splitter:true,region:"top",minHeight:300});this.element=this.area.getNode().insert(this.JSONEditor).insert(this.FormEditor);this.showFormEditor();F.subscribe(this);F.actions.subscribe(this);F.postconditions.subscribe(this)},init:function(){this.JSONEditor.init()},toElement:function(){return this.element},save:function(){this.active.save()},update:function(){this.active.update()},changeView:function(){if(this.active===this.JSONEditor){this.showFormEditor()}else{this.showJSONEditor()}},showJSONEditor:function(){this.active=this.JSONEditor;this.FormEditor.hide();this.JSONEditor.show();this.update()},showFormEditor:function(){this.active=this.FormEditor;this.JSONEditor.hide();this.FormEditor.show();this.update()}});function k(F){this._model=F;this._onSave=true;this._onRepaint=false;this._element=new Element("div",{"class":"codeContainer"})}k.prototype={init:function(){var F=this;this._codeEditor=new CodeMirror(this._element,{readOnly:false,height:"100%",parserfile:["tokenizejavascript.js","parsejavascript.js"],parserConfig:{json:true},stylesheet:["fast/js/lib/codemirror/css/jscolors.css"],path:"fast/js/lib/codemirror/js/",lineNumbers:true,tabMode:"shift",reindentOnLoad:false,onLoad:function(){F._onRepaint=true;F.update()},onChange:this.save.bind(this)})},save:function(){if(!this._onSave){return}var F,H=this._codeEditor.getCode();try{F=JSON.parse(H)}catch(G){Utils.showErrorMessage("The properties are not well formed. It will not work")}if(F){this._onRepaint=false;n(F,this._model);this._onRepaint=true}},update:function(G){if(!this._onRepaint){return}var G=this._model,F=j(G),H=JSON.stringify(F,null,2);this._onSave=false;this._codeEditor.setCode(H);this._onSave=true},show:function(){return this._element.show()},hide:function(){return this._element.hide()},toElement:function(){return this._element}};function C(F){this._model=F;this._onSave=true;this._onRepaint=false;this._element=new Element("div",{"class":"codeContainer"});this.area=new Area("code",[],null,{splitter:true,region:"center"});this.area.getNode().insert(this._element)}C.prototype={init:function(){var F=this,H=["tokenizejavascript.js","parsejavascript.js"],G=["fast/js/lib/codemirror/css/jscolors.css"];if(this._model.type===BuildingBlockDocument.FORM){Array.prototype.push.apply(H,["parsexml.js","parsecss.js","parsehtmlmixed.js",]);Array.prototype.push.apply(G,["fast/js/lib/codemirror/css/jscolors.css","fast/js/lib/codemirror/css/xmlcolors.css",])}this._codeEditor=new CodeMirror(this._element,{height:"100%",parserfile:H,stylesheet:G,path:"fast/js/lib/codemirror/js/",lineNumbers:true,tabMode:"shift",reindentOnLoad:false,onLoad:function(){F._onRepaint=true;F.update()},onChange:this.save.bind(this)})},toElement:function(){return this._element},save:function(){if(!this._onChange){return}var F=this._codeEditor.getCode();this._onRepaint=false;this._model.setProperties({codeInline:F});this._model.emit();this._onRepaint=true},update:function(){if(!this._onRepaint){return}var F=this._model.getCode();this._onChange=false;this._codeEditor.setCode(F);this._onChange=true}};var j=(function(){function G(J){var I=J.getProperties();delete I.id;delete I.type;delete I.code;delete I.codeInline;delete I.creationDate;I.actions=F(J.actions);I.postconditions=H(J.postconditions);return I}function F(I){return I.map(function(K){var J=K.getProperties();J.preconditions=H(K.preconditions);return J})}function H(I){return I.map(function(K){var J=K.getProperties();delete J.position;return J})}return G})();var n=(function(){function F(I,J){I||(I=[]);J.each(function(N){var M,K=I.find(function(O){return O.id==N.id});if(!K){J.remove(N)}else{M=N.getProperties();K.position=M.position;for(var L in M){if(!(L in K)){delete N[L]}}N.setProperties(K)}});I.each(function(K){J.create(K)});J.emit()}function H(I,J){I||(I=[]);J.each(function(N){var M,K=I.find(function(O){return O.name==N.name});if(!K){J.remove(N)}else{M=N.getProperties();for(var L in M){if(!(L in K)){delete N[L]}}F(K.preconditions,N.preconditions);N.setProperties(K)}});I.each(function(K){J.create(K)});J.emit()}function G(J,I){H(J.actions,I.actions);F(J.postconditions,I.postconditions);props=I.getProperties();J.id=props.id;J.type=props.type;J.code=props.code;J.codeInline=props.codeInline;J.creationDate=props.creationDate;J.name=(J.name&&J.name.trim())||props.name;for(key in props){if(!(key in J)){delete I[key]}}I.setProperties(J)}return G})();BuildingBlockDocument=Class.create(PaletteDocument,{initialize:function($super,F){$super("Building Block",F,new DumbInferenceEngine());this._start()},createTextEditors:function x(){this._preView.init();this._postView.init();this._propsView.init();this._codeView.init();var F=this._description;F.subscribe(this);F.actions.subscribe(this);F.postconditions.subscribe(this)},update:function(){this._setDirty(true)},_save:function(F){this._propsView.save();this._codeView.save();var I=Utils.variableOrDefault(F,true);var H={buildingblock:JSON.stringify(this._description)};if(I){Utils.showMessage("Saving "+this._typeName)}if(this._description.getId()==null){PersistenceEngine.sendPost(this._getSaveUri(),H,null,this,this._onSaveSuccess,this._onSaveError)}else{var G=URIs.buildingblock+this._description.getId();PersistenceEngine.sendUpdate(G,H,null,this,this._onSaveSuccess,this._onSaveError)}},_getSaveUri:function(){return URIs[this._description.type]},_start:function($super){$super();if(this._description.type in ["operator","resource"]){this._toolbarElements.get("debugger").setEnabled(true)}},_getAreas:function(){var F=this._description;var G=F.actions;var H=F.postconditions;this._preView=new f(G);this._postView=new z(H);this._propsView=new PropertiesEditorView(F);this._codeView=new C(F);return $H({pre:this._preView.area,post:this._postView.area,prop:this._propsView.area,code:this._codeView.area})},_getSets:function(){var F=new DomainConceptSet(this._tags,Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.DOMAIN_CONCEPT));return[F]},_getDescription:function(F){if(!F.id){Object.extend(F,{libraries:[],triggers:[],parameterTemplate:""})}return new BBDescription(F)},_renderCenterContainer:function(){var F=new dijit.layout.BorderContainer({design:"headline",liveSplitters:"false",region:"center"});this._designContainer.domNode.addClassName("canvas");F.addChild(this._designContainer);return F},_getCanvasCache:function(F){return null},_getEmptyPalette:function(){return[]},_share:function(){if(this._isDirty){this._pendingOperation=this._share.bind(this);this._save(false)}else{var G=new Element("div",{style:"text-align:center; width: 30em; margin: 0 auto;"}).update("You are about to share the building blokc. After that, you will not be able to edit it anymore. You can either close it or create a clone (Save with another name/version)");var F=new ConfirmDialog("Warning",ConfirmDialog.CUSTOM,{callback:this._onShareDialogEvent.bind(this),contents:G,buttons:{clone:"Share and create a clone",close:"Share and close",cancel:"Cancel"}});F.show()}},_onShareDialogEvent:function(F){if(F!="cancel"){var G=URIs.share.replace("<id>",this._description.getId());PersistenceEngine.sendPost(G,null,null,{mine:this,status:F},this._onShareSuccess,Utils.onAJAXError)}},_onShareSuccess:function(F){Utils.showMessage("Building block successfully shared",{hide:true});switch(this.status){case"clone":this.mine._saveAs(true);break;case"close":this.mine._effectiveCloseDocument(ConfirmDialog.DISCARD);break}},_onSaveSuccess:function($super,G){if(this._description.getId()==null){var F=JSON.parse(G.responseText);this._description.addProperties({id:F.id,version:F.version,creationDate:F.creationDate,code:F.code});this._save(false)}else{$super(G)}},_getCodeURI:function(){return this._description.code},_configureToolbar:function(){this._addToolbarElement("save",new ToolbarButton("Save the current screenflow","save",this._save.bind(this),false));this._addToolbarElement("share",new ToolbarButton("Share the current building block with the community","share",this._share.bind(this),true));this._addToolbarElement("debugger",new ToolbarButton("Debugger the current building block code","debugger",function(){this._pendingOperation=function(){var G=URIs.bbDebugger+"?url="+encodeURIComponent(this._getCodeURI());var H="BuildingBlockTest "+this.getTitle();var F="menubar=no,toolbar=no,width=800,height=600";window.open(G,H,F)}.bind(this);this._save(true)}.bind(this),false));this._addToolbarElement("properties",new ToolbarButton("Edit Building Block properties","changeview",function(){this._propsView.changeView()}.bind(this),true))},_findCheckCallback:function(){},_refreshReachability:function(){}});BuildingBlockDocument.FORM="form";BuildingBlockDocument.OPERATOR="operator";BuildingBlockDocument.RESOURCE="resource"})();var DumbInferenceEngine=(function(){var b={initialize:function(){},findCheck:function(){},addReachabilityListener:function(){},removeReachabilityListener:function(){}};return function a(){return b}})();var ScreenCanvasCache=Class.create({initialize:function(a){this._buildingblocks=a.definition.buildingblocks;this._pipes=a.definition.pipes;this._triggers=a.definition.triggers;this._preconditions=a.preconditions||new Array();this._postconditions=a.postconditions||new Array();this._elementsLoaded=new Array()},getFormURI:function(){var a=this._buildingblocks.detect(function(b){return(b.uri.search(/forms/i)!=-1)});if(a){return[a.uri]}else{return[]}},getOperatorURIs:function(){var b=this._buildingblocks.findAll(function(c){return(c.uri.search(/operators/i)!=-1)});var a=new Array();b.each(function(c){if(a.indexOf(c.uri)==-1){a.push(c.uri)}});return a},getResourceURIs:function(){var b=this._buildingblocks.findAll(function(c){return(c.uri.search(/services/i)!=-1)});var a=new Array();b.each(function(c){if(a.indexOf(c.uri)==-1){a.push(c.uri)}});return a},getPreconditions:function(){return this._preconditions},getPostconditions:function(){return this._postconditions},getPipes:function(){return this._pipes},getTriggers:function(){return this._triggers},getIds:function(a){var b=this._buildingblocks.findAll(function(c){return c.uri==a});if(b){return b.collect(function(c){return c.id})}else{return null}},getParams:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.parameter}else{return null}},getTitle:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.title}else{return null}},getCaption:function(){return null},getPosition:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.position}else{return null}},getOriginalUri:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.originalUri}else{return null}},getOrientation:function(b){var a=this._buildingblocks.detect(function(c){return c.id==b});if(a){return a.orientation}else{return null}},setLoaded:function(a){this._elementsLoaded.push(a)},areInstancesLoaded:function(){var a=(this._elementsLoaded.indexOf(Constants.BuildingBlock.RESOURCE)!=-1);a=a&&(this._elementsLoaded.indexOf(Constants.BuildingBlock.OPERATOR)!=-1);a=a&&(this._elementsLoaded.indexOf(Constants.BuildingBlock.FORM)!=-1);return a}});var ScreenflowCanvasCache=Class.create({initialize:function(a){this._screens=a.definition.screens?a.definition.screens:new Array();this._preconditions=a.definition.preconditions||new Array();this._postconditions=a.definition.postconditions||new Array();this._elementsLoaded=new Array()},getScreenURIs:function(){var a=new Array();this._screens.each(function(b){a.push(b.uri)});return a},getPreconditions:function(){return this._preconditions},getPostconditions:function(){return this._postconditions},getIds:function(a){var b=this._screens.findAll(function(c){return c.uri==a});if(b){return b.collect(function(c){return c.uri})}else{return null}},getParams:function(a){return""},getTitle:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.title}else{return null}},getCaption:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.caption}else{return null}},getPosition:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.position}else{return null}},getOriginalUri:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.originalUri}else{return null}},getOrientation:function(b){var a=this._screens.detect(function(c){return c.uri==b});if(a){return a.orientation}else{return null}},setLoaded:function(a){this._elementsLoaded.push(a)},areInstancesLoaded:function(){return this._elementsLoaded.indexOf(Constants.BuildingBlock.SCREEN)!=-1}});var Fact=Class.create({initialize:function(c,a,b){this._uri=c;this._shortcut=a;this._description=b},getUri:function(){return this._uri},getShortcut:function(){return this._shortcut},getDescription:function(){return this._description}});var FactFactory=Class.create();Object.extend(FactFactory,{_cachedFacts:new Hash(),_cachedShortcuts:new Array()});Object.extend(FactFactory,{getFactIcon:function(b,c){var a=this._getFact(b);return new FactIcon(a,c)},getFactUri:function(a){var b;if(a.uri){b=a.uri}else{if(a.pattern){b=Utils.extractURIfromPattern(a.pattern)}else{b="http://unknown.uri#?"}}return b},getFactShortcut:function(b){var a=this._getFact(b);return a.getShortcut()},_getFact:function(a){var b=this.getFactUri(a);if(this._cachedFacts.get(b)==null){this._cachedFacts.set(b,new Fact(b,this._extractShortcut(b),this._extractDescription(a)))}return this._cachedFacts.get(b)},_extractShortcut:function(d){var c=d.split("#");var b="";if(c.length>1){b=c[1]}else{c=d.split("/");b=c[c.length-1]}b=b.substr(0,1).toUpperCase()+b.substr(1);var f=b.match(/[A-Z]/g);if(f&&f.length>1){a=f.slice(0,2).join("");if(this._cachedShortcuts.indexOf(a)==-1){this._cachedShortcuts.push(a);return a}}b[1]=b[1].toLowerCase();var a=b.slice(0,2);if(this._cachedShortcuts.indexOf(a)==-1){this._cachedShortcuts.push(a);return a}a=b.slice(0,1);return a},_extractDescription:function(b){if(b.label&&b.label["en-gb"]){return b.label["en-gb"]}var c=b["http://www.w3.org/2000/01/rdf-schema#comment"];if(c){return c.replace("@en","")}var a=b["http://www.w3.org/2000/01/rdf-schema#label"];if(a){return a.replace("@en","")}}});var FactIcon=Class.create({initialize:function(b,c){this._fact=b;this._size=c;this._node=new Element("div",{"class":this._size+"_fact fact"});var a=new Element("div",{"class":"contentLayer"});this._node.appendChild(a);a.update(this._fact.getShortcut());var d=new Element("div",{"class":"recommendationLayer"});this._node.appendChild(d)},getNode:function(){return this._node},getFact:function(){return this._fact}});var MenuOptions=Class.create({initialize:function(a){this._dijitMenu=new dijit.Menu();if(a){this.bindDomNode(a)}},bindDomNode:function(a){this._dijitMenu.bindDomNode(a)},addOption:function(b,d,a){var f={label:b,onClick:d};if(a){Object.extend(f,a)}var c=new dijit.MenuItem(f);this._dijitMenu.addChild(c)}});var ComponentInstance=Class.create(DragSource,{initialize:function($super,b,a){$super();this._buildingBlockDescription=b;this._id=null;this._orientation=0;this._title=null;this._originalUri=null;this._view=this._createView();this._menu=new MenuOptions(this._view.getNode());this._menu.addOption("Delete",function(){if(this.document&&this.document.deleteInstance){this.document.deleteInstance(this)}}.bind(this));this._params="{}";this._inferenceEngine=a;this._listener=null;this.document=null},getTitle:function(){if(!this._title){this._title=this._buildingBlockDescription.getTitle()}return this._title},getInfo:function(){var c=new Hash();c.set("Title",this.getTitle());c.set("Description",this._buildingBlockDescription.description["en-gb"]);c.set("Tags",this._buildingBlockDescription.tags.collect(function(i){return i.label["en-gb"]}).join(", "));var d=document.createElement("div");var j=this.getParams();var a=j.strip().length>0;if(a){try{var k=k=cjson_parse(j);a=false;for(var f in k){d.addClassName("json-icon-bg");a=true;break}}catch(g){d.addClassName("text-icon-bg")}}if(!a){var h=document.createElement("span");h.addClassName("triggerInfo");h.appendChild(document.createTextNode("No parameterized"));d.appendChild(h)}var b=new ParamsDialog(this.getTitle(),this.getParams(),this._buildingBlockDescription.parameterTemplate,this.setParams.bind(this));d.appendChild(b.getButtonNode());c.set("Parameters",d);return c},createCatalogueCopy:function(c){var a={uri:this._buildingBlockDescription.uri};var b={mine:this,eventHandler:c};PersistenceEngine.sendPost(URIs.catalogueCopy,null,Object.toJSON(a),b,this._onCopySuccess,Utils.onAJAXError)},setCopyUri:function(a){var b=this._buildingBlockDescription.uri;var c=this._buildingBlockDescription.clone();c.uri=a;this._buildingBlockDescription=c;this.setOriginalUri(b);this._inferenceEngine.addReachabilityListener(this.getUri(),this._view)},setEventListener:function(a){this._listener=a;this.document=a},getUri:function(){return this._buildingBlockDescription.uri},setOriginalUri:function(a){this._originalUri=a;this.setId(this.getUri())},getOriginalUri:function(){return this._originalUri},getHandlerNode:function(){return this._view.getNode()},getDraggableObject:function(){return this},getView:function(){return this._view},toElement:function(){return this._view.toElement()},getOrientation:function(){return this._orientation},setOrientation:function(a){this._orientation=a},getParams:function(){return this._params},setParams:function(a){this._params=a;if(this._listener&&this._listener.modified){this._listener.modified(this)}},setTitle:function(a){this._title=a;this._view.setTitle(a);if(this._listener&&this._listener.modified){this._listener.modified(this)}},getBuildingBlockDescription:function(){return this._buildingBlockDescription},getBuildingBlockType:function(){return this._buildingBlockType},getId:function(){return this._id},setId:function(a){this._id=a},deleteInstance:function(){if(this._originalUri){var a=this._buildDeleteUri();PersistenceEngine.sendDelete(a,this,Prototype.emptyFunction,Utils.onAJAXError)}},destroy:function(){this._inferenceEngine.removeReachabilityListener(this._buildingBlockDescription.uri,this._view);this._view.destroy();this._view=null},onUpdate:function(a,b){},onFinish:function(b,a){if(b){this._view.addEventListener(function(c){c.stop();this._onClick()}.bind(this),"mousedown");this._view.addEventListener(function(c){c.stop()},"click");this._view.addEventListener(function(c){c.stop();this._onDoubleClick(c)}.bind(this),"dblclick")}else{if(this._listener&&this._listener.positionUpdated){this._listener.positionUpdated(this,a)}}this.onUpdate()},getPreconditionTable:function(a){if(a!=null){var b=this._buildingBlockDescription.getPreconditionsList();return $A(b).map(function(c){return this._getConditionItem(c,a)}.bind(this))}else{return[]}},getPostconditionTable:function(a){if(a!=null){var b=this._buildingBlockDescription.getPostconditionsList();return $A(b).map(function(c){return this._getConditionItem(c,a)}.bind(this))}else{return[]}},setPosition:function(a){this._view.setPosition(a)},_createView:function(){throw"Abstract Method invocation: ComponentInstance::_createView"},_onClick:function(){if(this._listener&&this._listener.elementClicked){this._listener.elementClicked(this)}},_onDoubleClick:function(a){if(this._listener&&this._listener.elementDblClicked){this._listener.elementDblClicked(this,a)}},_onCopySuccess:function(b){var a=JSON.parse(b.responseText);this.mine.setCopyUri(a.clone);this.eventHandler()},_getConditionItem:function(f,b){var d=FactFactory.getFactUri(f);var a=FactFactory.getFactIcon(f,"embedded").getNode();if(b.constructor==Hash){Utils.setSatisfeabilityClass(a,b.get(d))}else{Utils.setSatisfeabilityClass(a,b)}if(f.positive===false){a.addClassName("negative")}var c=f.label["en-gb"];return[a,c,d]},_buildDeleteUri:function(){if(this.getId()){var a=this.getId().split("/");var c=[a[a.length-3],a[a.length-2],a[a.length-1]];var b=c.join("/");return URIs.catalogueDeleteCopy.replace("<id>",b)}else{return""}}});var ScreenInstance=Class.create(ComponentInstance,{initialize:function($super,b,a){$super(b,a);this._dialog=null;this._menu.addOption("Preview",function(){this.showPreviewDialog()}.bind(this));if(this.getBuildingBlockDescription().definition!=null){this._menu.addOption("Clone",function(){this.document.cloneElement(this)}.bind(this))}this._menu.addOption("Create a Plan",function(){this.document.getPlansElement(this)}.bind(this));this._caption=null},getInfo:function(){var f=new Hash();var b=new TitleDialog(this.getTitle(),this.setTitle.bind(this));var g=new Element("div");var a=new Element("span").update(this.getTitle());g.appendChild(a);g.appendChild(b.getButtonNode());f.set("Title",g);f.set("Description",this._buildingBlockDescription.description["en-gb"]);var c=new CaptionDialog(this._caption,this.setCaption.bind(this));var d=new Element("div");var i;if(this._caption!=null){i=new Element("span");var h=this._caption.stripTags().substring(0,10);if(h!=this._caption.stripTags()){h+="..."}i.update(h)}else{i=new Element("span",{"class":"triggerInfo"}).update("No caption set")}d.appendChild(i);d.appendChild(c.getButtonNode());f.set("Screen caption",d);f.set("Tags",this._buildingBlockDescription.tags.collect(function(j){return j.label["en-gb"]}).join(", "));return f},getCaption:function(){return this._caption},setCaption:function(a){this._caption=a.stripScripts();if(this._listener&&this._listener.modified){this._listener.modified(this)}},showPreviewDialog:function(){if(!this._dialog){this._dialog=new PreviewDialog(this.getTitle(),this._buildingBlockDescription.getPreview())}this._dialog.show()},_createView:function(){return new ScreenView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()}});var PrePostInstance=Class.create(ComponentInstance,{initialize:function($super,c,b,a){$super(c.clone(),b);if(!this._buildingBlockDescription.pattern){this._buildingBlockDescription.pattern="?x http://www.w3.org/1999/02/22-rdf-syntax-ns#type "+this._buildingBlockDescription.uri}if(!this._buildingBlockDescription.label){this._buildingBlockDescription.label={"en-gb":this._buildingBlockDescription.title}}if(this._buildingBlockDescription.id){this._id=this._buildingBlockDescription.id}this._dialog=null;this._changeHandler=null;this._terminal=null;this._isConfigurable=Utils.variableOrDefault(a,true)},getInfo:function(){var a=new Hash();a.set("Title",this.getTitle());a.set("Uri",this._buildingBlockDescription.uri);a.set("Type",this.getType());if(this._buildingBlockDescription.properties){a.set("EzWeb Binding",this._buildingBlockDescription.properties.ezweb.binding);a.set("Friendcode",this._buildingBlockDescription.properties.ezweb.friendcode);a.set("Variable Name",this._buildingBlockDescription.properties.ezweb.variableName)}return a},getType:function(){return this._buildingBlockDescription.type},toJSONForScreen:function(){return{label:this._buildingBlockDescription.label,pattern:this._buildingBlockDescription.pattern,positive:true,uri:this._buildingBlockDescription.uri,id:this.getId(),type:this._buildingBlockDescription.type}},toJSONForScreenflow:function(){return{conditions:[this._getCondition()],id:this.getId(),semantics:this._buildingBlockDescription.uri,binding:this._buildingBlockDescription.properties.ezweb.binding,friendcode:this._buildingBlockDescription.properties.ezweb.friendcode,variableName:this._buildingBlockDescription.properties.ezweb.variableName,label:this.getTitle(),type:this._buildingBlockDescription.type,uri:this._buildingBlockDescription.uri}},toJSONForCatalogue:function(){return this._getCondition()},getUri:function(){return this._id},setType:function(a){this._buildingBlockDescription.type=a;if(this._isConfigurable){var b={label:this.getTitle()};if(this._buildingBlockDescription.properties){b=Object.extend(b,this._buildingBlockDescription.properties.ezweb)}else{if(this._buildingBlockDescription.binding){b=Object.extend(b,{binding:this._buildingBlockDescription.binding,variableName:this._buildingBlockDescription.variableName,friendcode:this._buildingBlockDescription.friendcode})}else{b=Object.extend(b,{binding:this._buildingBlockDescription.type=="pre"?"slot":"event",variableName:this._buildingBlockDescription.getUriShortcut().replace(/\s+/gi,""),friendcode:this._buildingBlockDescription.getUriShortcut().replace(/\s+/gi,"")})}}this._onChange(b)}else{this._onClick()}},setConfigurable:function(a){this._isConfigurable=a},setChangeHandler:function(a){this._changeHandler=a},showPreviewDialog:function(){if(this._isConfigurable){if(!this._dialog){this._dialog=new PrePostDialog(this._onChange.bind(this),this._buildingBlockDescription)}this._dialog.show()}},getConditionTable:function(){var a=FactFactory.getFactIcon(this._getCondition(),"embedded").getNode();var b;if(this._reachable!=null){b=this._reachable}else{b=this._view.getReachability()}Utils.setSatisfeabilityClass(a,b);return[a,this.getTitle(),this._buildingBlockDescription.uri]},createTerminal:function(a){var b={direction:[],offsetPosition:{},wireConfig:{drawingMethod:"arrows"}};if(this._buildingBlockDescription.type=="pre"){b.alwaysSrc=true;b.direction=[1,0];b.offsetPosition={top:9,left:26};b.ddConfig={type:"output",allowedTypes:["input"]}}else{b.direction=[-1,0];b.offsetPosition={top:9,left:-8};b.ddConfig={type:"input",allowedTypes:["output"]}}this._terminal=new Terminal(this._view.getNode(),b,this,this.getId());if(this._buildingBlockDescription.type=="pre"){this._terminal.onWireHandler(a)}},getTerminal:function(){return this._terminal},destroy:function($super,a){if(this._terminal){this._terminal.destroy();this._terminal=null}$super()},onUpdate:function(a,b){if(this._terminal){this._terminal.updatePosition()}},_createView:function(){return new DomainConceptView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()},_getCondition:function(){return{label:{"en-gb":this.getTitle()},pattern:this._buildingBlockDescription.pattern,positive:true,uri:this._buildingBlockDescription.uri,id:this._id}},_onChange:function(a){this._buildingBlockDescription.title=a.label;if(a.binding){this._buildingBlockDescription.properties={ezweb:{binding:a.binding,variableName:a.variableName,friendcode:a.friendcode}}}this._onClick()}});var ScreenComponentInstance=Class.create(ComponentInstance,{destroy:function($super,a){$super();this._destroyTerminals()},createTerminals:function(a){this._destroyTerminals();this._terminals=new Hash();this._buildPreConditionsTerminals(a,this);this._buildPostConditionsTerminals(a,this)},updateTerminals:function(){if(this._terminals){this._terminals.values().each(function(a){a.values().each(function(b){b.updatePosition()})})}},getTerminal:function(d,a){var c=null;if(this._terminals){if(a){var b=this._terminals.get(a);if(b){c=b.get(d)}}else{c=this._terminals.get("postconditions").get(d)}}return c},onUpdate:function($super,a,b){$super();this.updateTerminals()},_destroyTerminals:function(){if(this._terminals){this._terminals.values().each(function(a){a.values().each(function(b){b.destroy()})});this._terminals=null}},_buildPreConditionsTerminals:function(b,a){var c={direction:[0,1],wireConfig:{drawingMethod:"arrows"},ddConfig:{type:"input",allowedTypes:["output"]}};if(this._preOffsetPosition){c.offsetPosition=this._preOffsetPosition}this._buildingBlockDescription.actions.each(function(g){var f=g.preconditions;var d=this._buildTerminals(f,a,c,b,g.name);this._terminals.set(g.name,d)}.bind(this))},_buildPostConditionsTerminals:function(b,a){var c={direction:[0,1],wireConfig:{drawingMethod:"arrows"},alwaysSrc:true,ddConfig:{type:"output",allowedTypes:["input"]}};if(this._postOffsetPosition){c.offsetPosition=this._postOffsetPosition}var d=this._buildingBlockDescription.postconditions;if(d&&d[0] instanceof Array){d=this._buildingBlockDescription.postconditions[0]}var f=this._buildTerminals(d,a,c,b);this._terminals.set("postconditions",f)},_buildTerminals:function(g,a,f,d,c){var b=new Hash();g.each(function(j){var i=this._view.getConditionNode(j.id,c);var h=new Terminal(i,f,a,j.id,c);h.onWireHandler(d);b.set(j.id,h)}.bind(this));return b}});var ResourceInstance=Class.create(ScreenComponentInstance,{_preOffsetPosition:{top:-6,left:4},_postOffsetPosition:{top:-6,left:4},_createView:function(){return new ResourceView(this._buildingBlockDescription)}});var OperatorInstance=Class.create(ScreenComponentInstance,{_preOffsetPosition:{top:6,left:0},_postOffsetPosition:{top:-10,left:2},initialize:function($super,b,a){$super(b,a);this._menu.addOption("Rotate",function(){this.document.rotateInstance(this)}.bind(this))},onRotate:function(a){this.updateTerminals()},_createView:function(){return new OperatorView(this._buildingBlockDescription,this._orientation)}});var FormInstance=Class.create(ScreenComponentInstance,{_preOffsetPosition:{top:12,left:4},_postOffsetPosition:{top:12,left:5},initialize:function($super,b,a){$super(b,a);this._menu.addOption("Preview",this.showPreviewDialog.bind(this))},showPreviewDialog:function(){if(!this._dialog){var b=this.getTitle();var a=this._buildingBlockDescription.getPreview();this._dialog=new PreviewDialog(b,a)}this._dialog.show()},_createView:function(){return new FormView(this._buildingBlockDescription)},_onDoubleClick:function(a){this.showPreviewDialog()}});var Palette=Class.create(SetListener,{initialize:function(c,a,b){this._inferenceEngine=b;this._set=c;this._dropZones=a;this._components=new Hash();this._node=null;this._contentNode=null;this._renderUI();this._set.setListener(this)},getNode:function(){return this._node},getContentNode:function(){return this._contentNode},setChanged:function(){this._updateComponents()},getBuildingBlockSet:function(){return this._set},getComponentUris:function(){if(this._set.getBuildingBlockType()==Constants.BuildingBlock.SCREEN){var a=[];this._set.getBuildingBlocks().each(function(b){a.push({uri:b.uri})});return a}else{return this._set.getBuildingBlocks().pluck("uri")}},_renderUI:function(){this._node=new dijit.layout.AccordionPane({title:this._set.getBuildingBlockName(),"class":"paletteElement"});this._contentNode=new Element("div",{"class":"paletteContent"});this._searchBox=new PaletteSearchBox();this._searchBox.addEventListener(this._filterComponents.bind(this));this._node.setContent(this._searchBox.getDOMNode());this._searchBox.getDOMNode().insert({after:this._contentNode})},_updateComponents:function(){var d=this._set.getBuildingBlockType();var f=$A(this._set.getBuildingBlocks());if(!GVS.getUser().getCatalogueMagic()||d==Constants.BuildingBlock.DOMAIN_CONCEPT){f=f.sortBy(function(h){return h.getOrder()})}if(this._components.values().size()<f.size()&&!GVS.getUser().getCatalogueMagic()){Utils.showMessage("Building blocks loaded",{hide:true})}this._components=new Hash();this._contentNode.update("");var b;var a;for(var c=0,g;g=f[c];c++){b=this._components.get(g.uri);if(!b){b=this._buildComponentFor(g);if(a){a.insert({after:b.getNode()})}else{this._contentNode.appendChild(b.getNode())}b.getNode().insert({after:new Element("div",{"class":"paletteSeparator"})})}a=b.getNode().next()}this._filterComponents()},_filterComponents:(function(){function a(b,c){if(!c){return false}return c.any(function(d){return d.textContent.toLowerCase().match(b)})}return function(b){var d=this._searchBox.getValue().toLowerCase();var f=this._contentNode.select(".slot");for(var c=0;c<f.length;c++){var g=f[c];if(d.blank()||g.select(".slotTitle").first().textContent.toLowerCase().match(d)||a(d,g.select(".contentLayer"))){g.show()}else{g.hide()}}}})(),_buildComponentFor:function(b){var a=null;switch(this._set.getBuildingBlockType()){case Constants.BuildingBlock.SCREEN:a=new ScreenComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.DOMAIN_CONCEPT:a=new DomainConceptComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.FORM:a=new FormComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.RESOURCE:a=new ResourceComponent(b,this._dropZones,this._inferenceEngine);break;case Constants.BuildingBlock.OPERATOR:a=new OperatorComponent(b,this._dropZones,this._inferenceEngine);break;default:throw"Unsupported building block type"}this._components.set(b.uri,a);return a}});var PaletteComponent=Class.create(DragSource,{initialize:function($super,c,a,b){$super();this._dropZones=a;this._buildingBlockDescription=c;this._inferenceEngine=b;this._view=this._createView();this._node=this._createSlot()},getNode:function(){return this._node},getHandlerNode:function(){return this._view.getNode()},getDraggableObject:function(){var a=this._createInstance();var b=a.getHandlerNode();document.body.appendChild(b);b.setStyle({top:this._getContentOffsetTop()+"px",left:this._getContentOffsetLeft()+"px",position:"absolute"});return a},getBuildingBlockDescription:function(){return this._buildingBlockDescription},getView:function(){return this._view},_createSlot:function(){var a=new Element("div",{"class":"slot"});this._hover=new Element("div",{"class":"hover"});this._hover.setStyle({opacity:"0"});a.appendChild(this._hover);a.appendChild(this._view.getNode());var b=new Element("div",{"class":"slotTitle"}).update(this._getTitle());a.appendChild(b);this.enableDragNDrop(null,this._dropZones);return a},_getTitle:function(){throw"Abstract Method invocation: PaletteComponent::_getTitle"},_createView:function(){throw"Abstract Method invocation: PaletteComponent::_createView"},_createInstance:function(){throw"Abstract Method invocation: PaletteComponent::_createInstance"},_getContentOffsetTop:function(){return this.getView().getNode().cumulativeOffset().top-this.getView().getNode().cumulativeScrollOffset().top},_getContentOffsetLeft:function(){return this.getView().getNode().cumulativeOffset().left-this.getView().getNode().cumulativeScrollOffset().left},_createTooltip:function(o){var a=this._buildingBlockDescription.getTitle();var h=this._buildingBlockDescription.version;var f=this._buildingBlockDescription.description["en-gb"];var b=this._buildingBlockDescription.creator;var r=this._buildingBlockDescription.screenshot;var n=this._getPreConditions();var d=this._getPostConditions();var p=document.createElement("div");var u=document.createElement("h3");p.appendChild(u);u.appendChild(document.createTextNode(a+" "));var c=document.createElement("span");c.style.color="#444";c.appendChild(document.createTextNode(h+" "));u.appendChild(c);var s=document.createElement("span");s.style.fontSize="85%";s.style.fontWeight="normal";s.appendChild(document.createTextNode("by "));u.appendChild(s);var g=document.createElement("span");g.style.fontSize="85%";g.style.fontStyle="italic";g.style.fontWeight="normal";g.style.color="#999";g.appendChild(document.createTextNode(b));u.appendChild(g);if(r){var k=document.createElement("div");k.style.textAlign="center";p.appendChild(k);var l=new Element("img",{src:r,style:"width: 250px"});k.appendChild(l)}var q=document.createElement("p");q.appendChild(document.createTextNode(f));p.appendChild(q);function t(B){var D=document.createElement("table");for(var z=0;B&&z<B.length;z++){var w=B[z];var C=w.label["en-gb"];C+=" ("+FactFactory.getFactUri(w)+")";var v=FactFactory.getFactIcon(w,"embedded");var y=document.createElement("td");y.style.border="none";y.style.width="10%";y.appendChild(v.getNode());var x=document.createElement("td");x.style.border="none";x.appendChild(document.createTextNode(C));var A=document.createElement("tr");A.appendChild(y);A.appendChild(x);D.appendChild(A)}return D}if(n&&n.length>0){var i=document.createElement("h4");i.appendChild(document.createTextNode("Input Facts:"));p.appendChild(i);p.appendChild(t(n))}if(d&&d.length>0){var i=document.createElement("h4");i.appendChild(document.createTextNode("Output Facts:"));p.appendChild(i);p.appendChild(t(d))}var j=new dijit.Tooltip({connectId:[o],label:'<div style="max-width:300px">'+p.innerHTML+"</div>"});j.startup()},_getPreConditions:function(){return this._getConditions("preconditions")},_getPostConditions:function(){return this._getConditions("postconditions")},_getConditions:function(a){return this._buildingBlockDescription[a]}});var PaletteController=Class.create({initialize:function(c,a,b){this._palettes=new Hash();this._node=new dijit.layout.AccordionContainer({"class":"palettePane",region:"left",minSize:"170",maxSize:"300",splitter:"true",livesplitters:"false",style:"width:260px;"});$A(c).each(function(g){var d=new Array();a.each(function(h){if(h.accepts().include(g.getBuildingBlockType())){d.push(h)}});var f=new Palette(g,d,b);this._palettes.set(g.getBuildingBlockType(),f);this._node.addChild(f.getNode())}.bind(this))},getPalette:function(a){return this._palettes.get(a)},getNode:function(){return this._node},getComponentUris:function(a){return this._palettes.get(a).getComponentUris()}});var PaletteSearchBox=Class.create({initialize:function(a){this.defaultValue=a||"Search...";this._listeners=[];this._textSearch="";this._inputElement=new Element("input",{type:"text","class":"defaultValue",value:this.defaultValue});this._inputElement.observe("blur",this._lostFocus.bind(this));this._inputElement.observe("focus",this._getFocus.bind(this));new Form.Element.Observer(this._inputElement,1,this._valueChange.bind(this));this._rootNode=new Element("div",{"class":"searchBox"}).insert(this._inputElement)},getValue:function(){if(this._inputElement.hasClassName("defaultValue")){return""}return String.interpret(this._inputElement.value)},setValue:function(a){this._inputElement.value=a},getDOMNode:function(){return this._rootNode},addEventListener:function(a){this._listeners.push(a)},_getFocus:function(){if(this._inputElement.hasClassName("defaultValue")){this._inputElement.value="";this._inputElement.removeClassName("defaultValue")}else{this._inputElement.select()}},_lostFocus:function(){if(!this.getValue()){this._inputElement.value=this.defaultValue;this._inputElement.addClassName("defaultValue")}},_valueChange:function(){this._textSearch=this.getValue();for(var a=0;a<this._listeners.length;a++){this._listeners[a](this,this._textSearch)}}});var ScreenComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b);this._inferenceEngine.addReachabilityListener(this._buildingBlockDescription.uri,this._view)},_createView:function(){var a=new ScreenView(this._buildingBlockDescription);this._createTooltip(a.getNode(),this._buildingBlockDescription);return a},_createInstance:function(){return new ScreenInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]}});var DomainConceptComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b)},_createView:function(){var a=new DomainConceptView(this._buildingBlockDescription);this._createTooltip(a.getNode(),this._buildingBlockDescription);return a},_createTooltip:function(c){var a=this._buildingBlockDescription.getTitle();var g=document.createElement("div");var h=document.createElement("h3");h.appendChild(document.createTextNode(a+" "));g.appendChild(h);if(this._buildingBlockDescription.description){var d=$H(this._buildingBlockDescription.description).keys();if(d.size()>0){var j=this._buildingBlockDescription.description[d[0]]}else{var j=this._buildingBlockDescription.description}var b=document.createElement("p");b.appendChild(document.createTextNode(j));g.appendChild(b)}if(this._buildingBlockDescription.subClassOf){var f=document.createElement("h4");f.appendChild(document.createTextNode("Subclass of:"));g.appendChild(f);g.appendChild(document.createTextNode(this._buildingBlockDescription.subClassOf))}if(this._buildingBlockDescription.uri){var f=document.createElement("h4");f.appendChild(document.createTextNode("URI:"));g.appendChild(f);g.appendChild(document.createTextNode(this._buildingBlockDescription.uri))}var i=new dijit.Tooltip({connectId:[c],label:'<div style="max-width:300px">'+g.innerHTML+"</div>"});i.startup()},_createInstance:function(){return new PrePostInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.getTitle()}});var ResourceComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b);this._inferenceEngine.addReachabilityListener(this._buildingBlockDescription.uri,this)},setReachability:function(a){if(a){this._hover.setStyle({opacity:"1"});dojo.fadeOut({duration:2500,node:this._hover}).play(2500)}},_createView:function(){var a=new ResourceView(this._buildingBlockDescription);this._createTooltip(a.getNode(),this._buildingBlockDescription);return a},_createInstance:function(){return new ResourceInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},_getPreConditions:function(){var a=[];var f=this._buildingBlockDescription.actions;for(var c=0;f&&c<f.length;c++){var d=f[c].preconditions;for(var b=0;d&&b<d.length;b++){a.push(d[b])}}return a}});var OperatorComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b);this._inferenceEngine.addReachabilityListener(this._buildingBlockDescription.uri,this)},setReachability:function(a){if(a){this._hover.setStyle({opacity:"1"});dojo.fadeOut({duration:2500,node:this._hover}).play(2500)}},_createView:function(){var a=new OperatorView(this._buildingBlockDescription);this._createTooltip(a.getNode(),this._buildingBlockDescription);return a},_createInstance:function(){return new OperatorInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},_getPreConditions:function(){var a=[];var f=this._buildingBlockDescription.actions;for(var c=0;f&&c<f.length;c++){var d=f[c].preconditions;for(var b=0;d&&b<d.length;b++){a.push(d[b])}}return a}});var FormComponent=Class.create(PaletteComponent,{initialize:function($super,c,a,b){$super(c,a,b);this._inferenceEngine.addReachabilityListener(this._buildingBlockDescription.uri,this)},setReachability:function(a){if(a){this._hover.setStyle({opacity:"1"});dojo.fadeOut({duration:2500,node:this._hover}).play(2500)}},_createView:function(){var a=new FormSnapshotView(this._buildingBlockDescription);this._createTooltip(a.getNode(),this._buildingBlockDescription);return a},_createInstance:function(){return new FormInstance(this._buildingBlockDescription,this._inferenceEngine)},_getTitle:function(){return this._buildingBlockDescription.label["en-gb"]},_getPreConditions:function(){var a=[];var f=this._buildingBlockDescription.actions;for(var c=0;f&&c<f.length;c++){var d=f[c].preconditions;for(var b=0;d&&b<d.length;b++){a.push(d[b])}}return a}});var BuildingBlockView=Class.create({initialize:function(){this._node=null},getNode:function(){return this._node},setTitle:function(a){},toElement:function(){return this._node},setReachability:function(a){throw"Abstract Method invocation. BuildingBlockView :: setReachability"},setSelected:function(a){if(a){this._node.addClassName("selected")}else{this._node.removeClassName("selected")}},destroy:function(){this.remove();this._node=null},remove:function(){try{this._node.remove()}catch(a){}},addEventListener:function(a,b){Element.observe(this._node,b,a)},addGhost:function(){var a=new Element("div",{"class":"ghost ghostLayer"});this._node.appendChild(a)},setPosition:function(a){var c=a.top;var b=a.left;this._node.setStyle({position:"absolute",top:c+"px",left:b+"px"});return this},_setViewReachability:function(d,c,b,f){var a=d.reachability;Utils.setSatisfeabilityClass(f,a);b.each(function(g){Utils.setSatisfeabilityClass(g.getNode(),a)});d.actions.each(function(g){g.preconditions.each(function(h){var i=c.get(h.id).getNode();Utils.setSatisfeabilityClass(i,h.satisfied)}.bind(this))}.bind(this))}});var ScreenView=Class.create(BuildingBlockView,{initialize:function($super,i){$super();this._preIcons=new Array();this._postIcons=new Array();this._tooltip=null;this._titleNode=new Element("div",{"class":"title"});this._titleNode.update(i.label["en-gb"]);var d=new Element("div",{"class":"preArea"});var g=i.preconditions;$A(g).each(function(k){var j=FactFactory.getFactIcon(k,"embedded");this._preIcons.push(j);d.appendChild(j.getNode())}.bind(this));var h=new Element("div",{"class":"postArea"});var a=i.postconditions;$A(a).each(function(j){if(j){var k=FactFactory.getFactIcon(j,"embedded");this._postIcons.push(k);if(!j.positive){k.getNode().addClassName("negative")}h.appendChild(k.getNode())}}.bind(this));var b=new Element("div",{"class":"prePostSeparator"});if(i.icon){var f=new Element("div",{"class":"image"});var c=new Element("img",{"class":"img",src:i.icon});f.appendChild(c)}this._node=new Element("div",{"class":"view screen"});this._node.appendChild(this._titleNode);this._node.appendChild(d);this._node.appendChild(b);if(i.icon){this._node.appendChild(f)}this._node.appendChild(h)},setReachability:function(d){var a=d.reachability;Utils.setSatisfeabilityClass(this.getNode(),a);this._postIcons.each(function(g){Utils.setSatisfeabilityClass(g.getNode(),a)});var c=d.preconditions;var b=c;var f=new Hash();$A(b).each(function(g){f.set(FactFactory.getFactUri(g),g.satisfied)});this._preIcons.each(function(h){var g=h.getFact().getUri();Utils.setSatisfeabilityClass(h.getNode(),f.get(g))})},destroy:function($super){this._preIcons=null;this._postIcons=null;$super()},setTitle:function(a){this._titleNode.update(a)}});var DomainConceptView=Class.create(BuildingBlockView,{initialize:function($super,a){$super();this._factIcon=FactFactory.getFactIcon(a,"standalone").getNode();this._node=new Element("div",{"class":"view domainConcept"});this._node.appendChild(this._factIcon)},setReachability:function(a){var b=(a.reachability!==undefined)?a.reachability:a.satisfied;Utils.setSatisfeabilityClass(this._factIcon,b)},getReachability:function(){return this._factIcon.hasClassName("satisfeable")}});var ResourceView=Class.create(BuildingBlockView,{initialize:function($super,h){$super();this._icons=new Hash();var d=new Element("div",{"class":"preArea"});var g=new Element("div",{"class":"postArea"});var f=h.actions;var a;f.each(function(j){a=new Hash();j.preconditions.each(function(l){var k=FactFactory.getFactIcon(l,"embedded");a.set(l.id,k);d.appendChild(k.getNode())}.bind(this));this._icons.set(j.name,a)}.bind(this));var i;if(h.postconditions&&h.postconditions[0] instanceof Array){i=h.postconditions[0]}else{i=h.postconditions}a=new Hash();i.each(function(k){var j=FactFactory.getFactIcon(k,"embedded");a.set(k.id,j);g.appendChild(j.getNode())}.bind(this));this._icons.set("postconditions",a);var b=new Element("div",{"class":"prePostSeparator"});this._node=new Element("div",{"class":"view resource",title:h.name});this._node.appendChild(d);this._node.appendChild(b);this._node.appendChild(g);var c=new Element("div",{"class":"title"});c.update(h.label["en-gb"]);this._node.appendChild(c)},getConditionNode:function(d,c){c=Utils.variableOrDefault(c,"postconditions");var b=this._icons.get(c);if(b){var a=b.get(d);if(a){return a.getNode()}}return null},setReachability:function(b){var a=b.reachability;Utils.setSatisfeabilityClass(this._node,a);this._icons.get("postconditions").each(function(c){Utils.setSatisfeabilityClass(c.value.getNode(),a)});b.actions.each(function(d){var c=this._icons.get(d.name);d.preconditions.each(function(f){var g=this.get(f.id).getNode();Utils.setSatisfeabilityClass(g,f.satisfied)}.bind(c))}.bind(this))},destroy:function($super){this._icons=null;$super()}});var OperatorView=Class.create(BuildingBlockView,{initialize:function($super,j){$super();this._preIcons=new Hash();this._postIcons=new Hash();this._node=new Element("div",{"class":"view operator",title:j.name});var f=j.actions;var a=new Array();f.each(function(i){i.preconditions.each(function(o){var n=FactFactory.getFactIcon(o,"embedded");this._preIcons.set(o.id,n);a.push(n)}.bind(this))}.bind(this));var c=new Array();if(j.postconditions&&j.postconditions[0] instanceof Array){var k=j.postconditions[0]}else{var k=j.postconditions}k.each(function(n){var i=FactFactory.getFactIcon(n,"embedded");this._postIcons.set(n.id,i);c.push(i)}.bind(this));var l=a.size();for(var g=0;g<l;g++){var b=a[g].getNode();this._node.appendChild(b);var h=this._getPosition(true,g,l,0);b.setStyle({top:Math.round(h.y)+"px",left:Math.round(h.x)+"px"})}l=c.size();for(var g=0;g<l;g++){var b=c[g].getNode();var h=this._getPosition(false,g,l,0);this._node.appendChild(b);b.setStyle({top:Math.round(h.y)+"px",left:Math.round(h.x)+"px"})}var d=new Element("div",{"class":"title"});d.update(j.label["en-gb"]);this._node.appendChild(d)},_getPosition:function(f,c,g,d){var h=74;var b=60;var a=h*(c+1)/(g+1);if((c+1)!=(g+1)/2){a+=(c<g/2)?-4:3}if(f&&d==0||!f&&d==1){if(a>h/2){var i=3*b/2-a*(b/2)/(h/2)}else{var i=a*(b/2)/(h/2)+b/2}}else{if(a>h/2){var i=a*(b/2)/(h/2)-b/2-4}else{var i=b/2-a*(b/2)/(h/2)-4}}return{x:a,y:i}},getConditionNode:function(a){return this._preIcons.get(a)?this._preIcons.get(a).getNode():this._postIcons.get(a).getNode()},setReachability:function(a){this._setViewReachability(a,this._preIcons,this._postIcons.values(),this._node)},updateOrientation:function(c){if(!c){c=0}var h=this._preIcons.values();var f=h.length;for(var d=0;d<f;d++){var b=h[d].getNode();var a=this._getPosition(true,d,f,c);b.setStyle({top:Math.round(a.y)+"px",left:Math.round(a.x)+"px"})}var g=this._postIcons.values();var f=g.length;for(var d=0;d<f;d++){var b=g[d].getNode();var a=this._getPosition(false,d,f,c);b.setStyle({top:Math.round(a.y)+"px",left:Math.round(a.x)+"px"})}},destroy:function($super){this._preIcons=null;this._postIcons=null;$super()}});var FormView=Class.create(BuildingBlockView,{initialize:function($super,j){$super();this._actions=new Hash();this._postIcons=new Hash();this._triggerIcons=new Hash();this._node=new Element("div",{"class":"view form",title:j.name});var h=new Element("div",{"class":"title"}).update(j.label["en-gb"]);this._node.appendChild(h);var a=new Element("div",{"class":"actions"});var f=new Element("div",{"class":"title"}).update("Actions");this._node.appendChild(a);a.appendChild(f);var b=j.actions;b.each(function(l){var n=new ActionView(l);this._actions.set(l.name,n);a.appendChild(n.getNode())}.bind(this));var d=new Element("div",{"class":"postTriggerContainer"});var c=new Element("div",{"class":"title"}).update("Postconditions");d.appendChild(c);var g=new Element("div",{"class":"triggerArea"});d.appendChild(g);var k;if(j.postconditions&&j.postconditions[0] instanceof Array){k=j.postconditions[0]}else{k=j.postconditions}var i=new Element("div",{"class":"postArea"});k.each(function(n){var l=FactFactory.getFactIcon(n,"embedded");this._postIcons.set(n.id,l);i.appendChild(l.getNode())}.bind(this));d.appendChild(i);this._node.appendChild(d)},getConditionNode:function(b,a){if(a){return this._actions.get(a).getConditionNode(b)}else{return this._postIcons.get(b).getNode()}},setReachability:function(b){var a=b.reachability;Utils.setSatisfeabilityClass(this._node,a);b.actions.each(function(c){this._actions.get(c.name).setReachability(c)}.bind(this));this._postIcons.values().each(function(c){Utils.setSatisfeabilityClass(c.getNode(),a)})},destroy:function($super){this._actions.each(function(a){a.value.destroy()});this._postIcons=null;this._triggerIcons.each(function(a){a.value.destroy()});$super()}});var FormSnapshotView=Class.create(BuildingBlockView,{initialize:function($super,a){$super();this._node=new Element("div",{"class":"view form snapshot",title:a.name});var b=new Element("img",{"class":"image",src:a.icon});this._node.appendChild(b)},setReachability:function(a){}});var ActionView=Class.create({initialize:function(a){this._node=null;this._preIcons=new Hash();this._node=new Element("div",{"class":"action"});var b=new Element("div",{"class":"title"}).update(a.name);this._node.appendChild(b);var c=new Element("div",{"class":"preArea"});a.preconditions.each(function(f){var d=FactFactory.getFactIcon(f,"embedded");this._preIcons.set(f.id,d);c.appendChild(d.getNode())}.bind(this));this._node.appendChild(c)},getNode:function(){return this._node},getConditionNode:function(a){return this._preIcons.get(a).getNode()},destroy:function(){this._preIcons=null;this._node.remove();this._node=null},setReachability:function(b){var a=b.satisfied;Utils.setSatisfeabilityClass(this._node,a);b.preconditions.each(function(c){Utils.setSatisfeabilityClass(this._preIcons.get(c.id).getNode(),c.satisfied)}.bind(this))}});var Terminal=function(h,b,a,g,f){this._conditionNode=h;this._terminalNode=new Element("div",{title:this._conditionNode.title});var d={position:"absolute",width:"1px",height:"1px","z-index":"50"};this._terminalNode.setStyle(d);this._recalculatePosition();document.body.appendChild(this._terminalNode);var c={width:2,borderwidth:2,color:"#EAEAEA",bordercolor:"#808080"};var i={};i=Object.extend(i,b);i.wireConfig=Object.extend(c,b.wireConfig);WireIt.Terminal.call(this,this._terminalNode,i);this._instance=a;this._conditionId=g;this._action=f?f:""};Object.extend(Terminal.prototype,WireIt.Terminal.prototype);Object.extend(Terminal.prototype,{getBuildingBlockUri:function(){var a;if(this._instance.constructor==PrePostInstance){a=null}else{a=this._instance.getUri()}return a},getBuildingBlockId:function(){var a;if(this._instance.constructor==PrePostInstance){a=""}else{a=this._instance.getId()}return a},getConditionId:function(){return this._conditionId},getActionId:function(){return this._action},getInstance:function(){return this._instance},destroy:function(){this.removeAllWires();this.remove();this._terminalNode.parentNode.removeChild(this._terminalNode)},updatePosition:function(){this._recalculatePosition();this.redrawAllWires()},onWireHandler:function(a){var b={};b=Object.extend(b,a);b.refTerminal=this;this.eventAddWire.subscribe(this._wireAddHandler.bind(b));this.eventRemoveWire.subscribe(this._wireRemoveHandler.bind(b))},setVisible:function(b){var a={visibility:b?"visible":"hidden"};this.el.setStyle(a)},_recalculatePosition:function(){var a=Utils.getPosition(this._conditionNode);var b={top:a.top+"px",left:a.left+"px"};this._terminalNode.setStyle(b)},_wireAddHandler:function(a,c){var b=c[0];if(b.terminal1.parentEl&&b.terminal2.parentEl){if(b.terminal1==this.refTerminal){this.onPipeCreation(b)}}else{if(b.terminal1==this.refTerminal){this.onPipeCreationStart(b,b.terminal1)}else{if(b.terminal2==this.refTerminal){this.onPipeCreationStart(b,b.terminal2)}}}},_wireRemoveHandler:function(a,c){var b=c[0];if(b.terminal1.parentEl&&b.terminal2.parentEl){if(b.terminal1==this.refTerminal){this.onPipeDeletion(b)}}else{if(b.terminal1==this.refTerminal||b.terminal2==this.refTerminal){this.onPipeCreationCancel(b)}}}});var Pipe=Class.create({initialize:function(a,b){this._wire=a;this._id=b;this._isValid=true},getWire:function(){return this._wire},getId:function(){return this._id},getSource:function(){return this._wire.terminal1},getDestination:function(){return this._wire.terminal2},getJSONforScreen:function(){return{from:{buildingblock:this.getSource().getBuildingBlockId(),condition:this.getSource().getConditionId()},to:{buildingblock:this.getDestination().getBuildingBlockId(),action:this.getDestination().getActionId(),condition:this.getDestination().getConditionId()}}},getJSONforCheck:function(){return{from:{buildingblock:this.getSource().getBuildingBlockUri(),condition:this.getSource().getConditionId()},to:{buildingblock:this.getDestination().getBuildingBlockUri(),action:this.getDestination().getActionId(),condition:this.getDestination().getConditionId()}}},setReachability:function(b){var a=this._wire.options;var c=b.satisfied;if(!b.correct){a=Object.extend(a,{color:"#EAEAEA",bordercolor:"#808080"})}else{if(c){a=Object.extend(a,{color:"#DDF7DD",bordercolor:"#008000"})}else{a=Object.extend(a,{color:"#F5D9D9",bordercolor:"#B90000"})}}this._wire.setOptions(a);this._wire.redraw();if(!b.correct){this._wire.element.setStyle({opacity:"0.5"});if(this._isValid){Utils.showMessage("The elements you have connected are not compatible. It may not work",{hide:true,error:true});this._isValid=false}}},isValid:function(){return(this.getSource().getBuildingBlockId()!=this.getDestination().getBuildingBlockId())&&this._isValid},destroy:function(){this.getSource().removeWire(this._wire);this.getDestination().removeWire(this._wire)},setVisible:function(b){if(b){this.getSource().updatePosition();this.getDestination().updatePosition()}var a={visibility:b?"visible":"hidden"};this._wire.element.setStyle(a)}});var PipeFactory=Class.create({initialize:function(){this._pipes=new Hash()},getPipe:function(){var b=null;var d;var c;var a;if(arguments.length==1){d=arguments[0];c=d.terminal1;a=d.terminal2}else{c=arguments[0];a=arguments[1];d=new WireIt.Wire(c,a,document.body,c.options.wireConfig);d.redraw()}var f=this._getPipeId(c,a);b=new Pipe(d,f);if(b.isValid()){if(!this._pipes.get(f)){this._pipes.set(f,b)}}else{b.destroy();b=null}return b},removePipe:function(a){this._pipes.unset(a.getId())},getPipeFromTerminals:function(f,g){var a=this._pipes.values();for(var c=0;c<a.size();c++){var b=a[c];var d=b.getSource()==f;d=d&&b.getDestination()==g;if(d){return b}}return null},getPipes:function(b){var a=new Array();this._pipes.values().each(function(c){var d=c.getSource().getBuildingBlockId()==b.getId();d=d||c.getDestination().getBuildingBlockId()==b.getId();if(d){a.push(c)}});return a},hidePipes:function(){this._pipes.values().each(function(a){a.setVisible(false)})},showPipes:function(){this._pipes.values().each(function(a){a.setVisible(true)})},_getPipeId:function(b,a){return b.getBuildingBlockId()+b.getConditionId()+a.getBuildingBlockId()+a.getActionId()+a.getConditionId()}});var TriggerMappingFactory=Class.create({initialize:function(){this._triggers=new Hash()},createTrigger:function(b){var a=this._createFromJSON(b);this._triggers.set(a.getId(),a);return a},removeTrigger:function(b){var a;if(b.constructor!=Trigger&&b.constructor!=ScreenTrigger){a=this._createFromJSON(b)}else{a=b}this._triggers.unset(a.getId());return a},getTriggerList:function(b){var a=new Hash();this._triggers.values().each(function(c){if(c.getDestinationId()==b.getId()){var d=a.get(c.getDestinationAction());if(!d){d=new Array()}d.push(c);a.set(c.getDestinationAction(),d)}});return a},getRelatedTriggers:function(b){var a=new Array();this._triggers.values().each(function(c){if(c.getSourceId()==b.getId()||c.getDestinationId()==b.getId()){a.push(c)}});return a},_createFromJSON:function(b){var a;if(b.from.instance==ScreenTrigger.INSTANCE_NAME){a=new ScreenTrigger(b.to)}else{a=new Trigger(b.from,b.to)}return a}});var Trigger=Class.create({initialize:function(b,a){this._from=b;this._to=a;this._id=this._createId(b,a)},getId:function(){return this._id},getDestinationId:function(){return this._to.instance.getId()},getDestinationAction:function(){return this._to.action},getTriggerName:function(){return this._from.name},getSourceId:function(){return this._from.instance.getId()},getSourceInstance:function(){return this._from.instance},toJSON:function(){return{from:{buildingblock:this.getSourceId(),name:this.getTriggerName()},to:{buildingblock:this.getDestinationId(),action:this.getDestinationAction()}}},_createId:function(b,a){return b.instance.getId()+b.name+a.instance.getId()+a.action}});var ScreenTrigger=Class.create(Trigger,{initialize:function($super,b){var a={instance:ScreenTrigger.INSTANCE_NAME,name:ScreenTrigger.ONLOAD};$super(a,b)},getSourceId:function(){return this._from.instance},getSourceInstance:function(){var a={getTitle:function(){return ScreenTrigger.INSTANCE_NAME},getId:function(){return ScreenTrigger.INSTANCE_NAME}};return a},toJSON:function(){return{from:{buildingblock:"",name:"_onload"},to:{buildingblock:this.getDestinationId(),action:this.getDestinationAction()}}},_createId:function(b,a){return b.instance+b.name+a.instance.getId()+a.action}});ScreenTrigger.INSTANCE_NAME="Screen";ScreenTrigger.ONLOAD="onload";var PersistenceEngine=Class.create();Object.extend(PersistenceEngine,{sendGet:function(c,d,b,a,f){new Ajax.Request(c,{method:"get",parameters:arguments[4],onSuccess:b.bind(d),onFailure:a.bind(d),onException:a.bind(d),requestHeaders:f})},sendPost:function(d,h,a,f,c,b,g){new Ajax.Request(d,{method:"post",parameters:h,postBody:a,onSuccess:c.bind(f),onFailure:b.bind(f),onException:b.bind(f),requestHeaders:g})},sendDelete:function(c,d,b,a,f){new Ajax.Request(c,{method:"delete",onSuccess:b.bind(d),onFailure:a.bind(d),onException:a.bind(d),requestHeaders:f})},sendUpdate:function(d,h,a,f,c,b,g){new Ajax.Request(d,{method:"put",parameters:h,postBody:a,onSuccess:c.bind(f),onFailure:b.bind(f),onException:b.bind(f),requestHeaders:g})}});var FormDialog=Class.create({initialize:function(d,b){b=Utils.variableOrDefault(b,{});this._options=Object.extend({buttonPosition:FormDialog.POSITION_BOTTOM,createMessageZone:false,minMessageLines:1,closable:true},b);var a=this._options.buttonPosition;this._dialog=new dijit.Dialog(d);if(!this._options.closable){this._dialog.closeButtonNode.style.display="none"}this._headerNode=new Element("div",{"class":"dialogHeader"});this._contentNode=new Element("div",{"class":"dialogContent"});this._messageNode=new Element("div",{"class":"dialogMessageZone hidden"});var c=new Element("div",{"class":"dialogMessageWrapper"});c.appendChild(this._messageNode);this._buttonNode=new Element("div",{"class":"dialogButtonZone"});this._formWidget=null;var f=new Element("div",{"class":a});f.appendChild(this._headerNode);switch(a){case FormDialog.POSITION_TOP:f.appendChild(this._buttonNode);if(this._options.createMessageZone){f.appendChild(c)}f.appendChild(this._contentNode);break;default:f.appendChild(this._contentNode);if(this._options.createMessageZone){f.appendChild(c)}f.appendChild(this._buttonNode);break}c.style.minHeight=((this._options.minMessageLines*18)+2)+"px";this._dialog.attr("content",f);this._initialized=false;dojo.connect(this._dialog,"hide",this._hide.bind(this))},show:function(){if(!this._initialized){this._initDialogInterface();this._initialized=true}else{this._reset()}GVS.setEnabled(false);this._dialog.show()},isVisible:function(){return this._dialog.attr("open")},_initDialogInterface:function(){throw"Abstract method invocation FormDialog :: _initDialogInterface"},_hide:function(){GVS.setEnabled(true);document.documentElement.scrollTop=0},_getForm:function(){return this._formWidget.domNode},_getFormWidget:function(){return this._formWidget},_addButton:function(a,c){var b=new dijit.form.Button({label:a,onClick:c});this._buttonNode.appendChild(b.domNode);return b},_removeButtons:function(){this._buttonNode.update("")},_setHeader:function(d,a){this._headerNode.update("");var c=new Element("h2").update(d);this._headerNode.appendChild(c);if(a&&a!=""){var b=new Element("div",{"class":"line"}).update(a);this._headerNode.appendChild(b)}},_setTitle:function(a){this._dialog.setAttribute("title",a)},_setContent:function(b,a){if(b instanceof Array){if(a){this._formWidget=new dijit.form.Form(a)}else{this._formWidget=new dijit.form.Form({method:"post"})}var c=this._formWidget.domNode;$A(b).each(function(n){var f;var k;switch(n.type){case"title":f=new Element("h3").update(n.value);break;case"input":if(n.regExp||n.required){var l=new dijit.form.ValidationTextBox({name:n.name,value:n.value,regExp:(n.regExp)?n.regExp:".*",required:(n.required)?n.required:false,invalidMessage:(n.message)?n.message:"This field cannot be blank"})}else{var l=new dijit.form.TextBox({name:n.name,value:n.value})}if(n.disabled){l.attr("disabled",n.disabled)}k=l.textbox;f=this._createLine(n.label,l.domNode);break;case"checkbox":var i=new dijit.form.CheckBox({name:n.name,value:n.value});if(n.disabled){i.attr("disabled",n.disabled)}if(n.checked){i.attr("checked",n.checked)}k=i.domNode;f=this._createLine(n.label,i.domNode);break;case"label":f=new Element("div",{"class":"line",style:n.style}).update(n.value);break;case"pre":f=new Element("pre",{"class":"line",style:n.style}).update(n.value);break;case"hidden":f=new Element("input",{type:"hidden",name:n.name,value:n.value});break;case"comboBox":k=new Element("select",{name:n.name});$A(n.options).each(function(o){var p=new Element("option",{value:o.value}).update(o.label);if(o.value==n.value){p.selected="selected"}k.appendChild(p)});f=this._createLine(n.label,k);break;case"textarea":var g=new dijit.form.SimpleTextarea({name:n.name});g.attr("value",n.value);k=g.domNode;f=this._createLine(n.label,k);break;case"advancedSeparator":if(c==this._formWidget.domNode){var d=new Element("div",{style:"display:none;"});var j=new Element("a",{href:"javascript:"}).update("Show advanced options...");j.observe("click",function(o){if(d.style.display=="none"){d.setStyle({display:"block"});j.update("Hide advanced options...")}else{d.setStyle({display:"none"});j.update("Show advanced options...")}});var h=this._createLine("",j);this._formWidget.domNode.appendChild(h);this._formWidget.domNode.appendChild(d);c=d}else{throw"It cannot be more than one advancedSeparator.FormDialog::_setContent"}break;default:throw"Unimplemented form field type. FormDialog::_setContent"}if(f){c.appendChild(f);f=null}if(k){this._armEvents(k,n.events)}}.bind(this));this._contentNode.update(this._formWidget.domNode)}else{this._contentNode.update(b)}dojo.parser.parse(this._contentNode)},_setMessage:function(b,a){if(arguments.length==0){this._messageNode.className="dialogMessageZone hidden";this._messageNode.update("&nbsp;");return}this._messageNode.className="dialogMessageZone";switch(a){case FormDialog.MESSAGE_WARNING:this._messageNode.addClassName("warning");break;case FormDialog.MESSAGE_ERROR:this._messageNode.addClassName("error");break;default:}this._messageNode.innerHTML=b},_createLine:function(b,c){var d=new Element("div",{"class":"line"});if(b){var a=new Element("label").update(b);d.appendChild(a)}d.appendChild(c);return d},_armEvents:function(a,b){$H(b).each(function(c){Element.observe(a,c.key,c.value)})},_validate:function(){return this._getFormWidget().validate()},_reset:function(){if(this._getFormWidget()){this._getFormWidget().validate()}}});FormDialog.POSITION_LEFT="left";FormDialog.POSITION_RIGHT="right";FormDialog.POSITION_BOTTOM="bottom";FormDialog.POSITION_TOP="top";FormDialog.POSITIVE_VALIDATION="[1-9][0-9]*";FormDialog.EMAIL_VALIDATION="[a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,4}";FormDialog.URL_VALIDATION="([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*";FormDialog.INVALID_POSITIVE_MESSAGE="Invalid number";FormDialog.INVALID_EMAIL_MESSAGE="Invalid email address";FormDialog.INVALID_URL_MESSAGE="Invalid URL";FormDialog.MESSAGE_INFO="info";FormDialog.MESSAGE_WARNING="warning";FormDialog.MESSAGE_ERROR="error";var ConfirmDialog=Class.create(FormDialog,{initialize:function($super,c,b,a){$super({title:c,style:"display:none;"},a);switch(b){case ConfirmDialog.OK:this._okButton=this._addButton("Ok",this._onOk.bind(this));break;case ConfirmDialog.SAVE_DISCARD_CANCEL:if(a&&a.callback){this._addButton("Save",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.SAVE,callback:a.callback}));this._addButton("Discard changes",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.DISCARD,callback:a.callback}));this._addButton("Cancel",this._onButtonPressed.bind({mine:this,pressedButton:ConfirmDialog.CANCEL,callback:a.callback}))}else{throw"Cannot create a confirm dialog with that configuration. ConfirmDialog::initialize"}break;case ConfirmDialog.NONE:break;case ConfirmDialog.CUSTOM:if(a&&a.callback&&a.buttons){$H(a.buttons).each(function(d){this._addButton(d.value,this._onButtonPressed.bind({mine:this,pressedButton:d.key,callback:a.callback}))}.bind(this))}else{throw"Cannot create a confirm dialog with that configuration. ConfirmDialog::initialize"}break;case ConfirmDialog.OK_CANCEL:default:this._okButton=this._addButton("Ok",this._onOk.bind(this));this._addButton("Cancel",this._onCancel.bind(this));break}},_initDialogInterface:function(){if(this._options.contents){this._setContent(this._options.contents)}},_setDisabled:function(a){this._okButton.setDisabled(a)},_onOk:function(){this._dialog.hide()},_onCancel:function(){this._dialog.hide()},_onButtonPressed:function(){this.mine._dialog.hide();this.callback(this.pressedButton)},_reset:function($super){this._setDisabled(false);$super()}});ConfirmDialog.OK="ok";ConfirmDialog.OK_CANCEL="ok_cancel";ConfirmDialog.SAVE_DISCARD_CANCEL="save_discard_cancel";ConfirmDialog.CUSTOM="custom";ConfirmDialog.NONE="none";ConfirmDialog.SAVE="save";ConfirmDialog.DISCARD="discard";ConfirmDialog.CANCEL="cancel";var PrePostDialog=Class.create(ConfirmDialog,{initialize:function($super,a,b){$super("Pre/Post Condition");this._description=b;this._onChangeCallback=a},_initDialogInterface:function(){this._setHeader("Check domain concept details","Please fulfill the required information in order to set up the Domain Concept");var a=[{type:"input",label:"Type:",name:"type",value:this._description.type.toUpperCase(),disabled:true},{type:"input",label:"Label:",name:"label",value:this._description.getTitle(),required:true},{type:"title",value:"EzWeb properties"},{type:"comboBox",label:"Binding:",name:"binding",value:"undefined",options:[]},{type:"input",label:"Variable name:",name:"variableName",value:this._description.properties.ezweb.variableName,required:true},{type:"input",label:"Friendcode:",name:"friendcode",value:this._description.properties.ezweb.friendcode,required:true}];this._setContent(a);this._onTypeChange()},_onOk:function($super){this._onChangeCallback(this._getForm().serialize({hash:true}));$super()},_onTypeChange:function(){var b=new Array();switch($F(this._getForm().type).toUpperCase()){case"PRE":b.push({value:"slot",label:"Slot"});b.push({value:"pref",label:"User Preference"});b.push({value:"context",label:"Platform Context"});break;case"POST":b.push({value:"event",label:"Event"});break;default:break}var a=$(this._getForm().binding);a.update("");b.each(function(d){var c=new Element("option",{value:d.value}).update(d.label);a.appendChild(c)})}});var PreferencesDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("User Preferences")},_initDialogInterface:function(){this._setHeader("User preferences");var a=GVS.getUser();var b=[{type:"input",label:"First Name:",name:"firstName",value:a.getFirstName()},{type:"input",label:"Last Name:",name:"lastName",value:a.getLastName()},{type:"input",label:"Email:",name:"email",value:a.getEmail(),regExp:FormDialog.EMAIL_VALIDATION,message:FormDialog.INVALID_EMAIL_MESSAGE,required:true},{type:"input",label:"EzWeb URL:",name:"ezWebURL",value:a.getEzWebURL(),regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"checkbox",label:"Magic Catalogue:",name:"catalogueMagic",checked:a.getCatalogueMagic()},{type:"checkbox",label:"Search iServe services: <br /> (It may be slow)",name:"iServe",checked:a.getiServe()}];this._setContent(b)},_onOk:function($super){if(!this._getFormWidget().validate()){return}else{var a=GVS.getUser();a.update(this._getForm().serialize(true));$super()}},_reset:function($super){var a=GVS.getUser();this._getForm().firstName.value=a.getFirstName();this._getForm().lastName.value=a.getLastName();this._getForm().email.value=a.getEmail();this._getForm().ezWebURL.value=a.getEzWebURL();this._getForm().catalogueMagic.checked=a.getCatalogueMagic()?"checked":"unchecked";this._getForm().iServe.checked=a.getiServe()?"checked":"unchecked";$super()}});var ExternalContentDialog=Class.create(ConfirmDialog,{initialize:function($super,a){$super(a,ConfirmDialog.NONE)},show:function($super,a){$super();this._setContent(a)},_initDialogInterface:function(){}});var BuildGadgetDialog=Class.create(ConfirmDialog,{initialize:function($super,a){$super("Build Gadget");this._onDeployCallback=a},show:function($super,a){$super();$H(a).each(function(b){this._getForm()[b.key].setValue(b.value)}.bind(this))},_initDialogInterface:function(){var a=GVS.getUser();this._setHeader("Fulfill Gadget Information","Please fulfill the required information in order to deploy a gadget.");var b=[{type:"title",value:"Gadget information"},{type:"input",label:"Gadget Name:",name:"name",value:"",required:true},{type:"input",label:"Gadget Short Name:",name:"shortname",value:""},{type:"input",label:"Version:",name:"version",value:"1.0",required:true},{type:"input",label:"Vendor:",name:"vendor",value:"Morfeo",required:true},{type:"input",label:"Owner:",name:"owner",value:"Morfeo",required:true},{type:"input",label:"Gadget Description:",name:"desc",value:""},{type:"input",label:"Image URL:",name:"imageURI",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"input",label:"Homepage:",name:"gadgetHomepage",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"input",label:"Default Height:",name:"height",value:"",regExp:FormDialog.POSITIVE_VALIDATION,message:FormDialog.INVALID_POSITIVE_MESSAGE},{type:"input",label:"Default Width:",name:"width",value:"",regExp:FormDialog.POSITIVE_VALIDATION,message:FormDialog.INVALID_POSITIVE_MESSAGE},{type:"checkbox",label:"Persistent Data",name:"persistent",value:"true",checked:false},{type:"title",value:"Author information"},{type:"input",label:"Author Name:",name:"authorName",value:a.getRealName()},{type:"input",label:"E-Mail:",name:"email",value:a.getEmail(),regExp:FormDialog.EMAIL_VALIDATION,message:FormDialog.INVALID_EMAIL_MESSAGE},{type:"input",label:"Homepage:",name:"authorHomepage",value:"",regExp:FormDialog.URL_VALIDATION,message:FormDialog.INVALID_URL_MESSAGE},{type:"title",value:"Destination Gadgets"},{type:"checkbox",label:"EzWeb:",name:"platforms",value:"ezweb",checked:true},{type:"checkbox",label:"Google:",name:"platforms",value:"google",checked:true}];if(GlobalOptions.isLocalStorage==false){b.push({type:"checkbox",label:"BeemBoard:",name:"platforms",value:"beemboard",checked:true})}b.push({type:"checkbox",label:"Standalone:",name:"platforms",value:"player",checked:true});this._setContent(b)},_onOk:function($super){if(this._getFormWidget().validate()){var a=this._getForm().serialize({hash:true});if(a.platforms){$super();this._onDeployCallback(a)}}},_reset:function($super){var a=GVS.getUser();this._getForm().authorName.value=a.getRealName();this._getForm().email.value=a.getEmail();$super()}});var PublishGadgetDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("Publish Gadget",ConfirmDialog.OK);this._publication=null;this._buttons=new Hash();this._standaloneDialog=null},show:function($super,a){this._publication=a;this._initDialogInterface();$super()},_publishGadget:function(c,a){var b=a.url;if(GlobalOptions.isLocalStorage){if(a.mashupPlatform=="ezweb"){b=URIs.ezweb+"interfaces/gadget?template_uri="+a.url}else{if(a.mashupPlatform=="igoogle"){if(a.destination=="directory"){b="http://www.google.com/ig/submit?url="+a.url}else{if(a.destination=="personal"){b="http://www.google.com/ig/adde?moduleurl="+a.url}}}else{if(a.mashupPlatform=="orkut"){b="http://sandbox.orkut.com/Main#MyApps?appUrl="+a.url}}}}this._deploy(c,a,b)},_deploy:function(c,b,a){var d=dijit.byId(c.id);if(b.disableAfterPublishing){d.attr("label",b.doneButtonLabel);d.attr("disabled",true)}if(b.mashupPlatform=="standalone"){if(!this._standaloneDialog){this._standaloneDialog=new StandaloneEmbeddingDialog(this._publication,a)}else{this._standaloneDialog.updateDialog(this._publication,a)}this._standaloneDialog.show()}else{window.open(a)}console.log(a)},_initDialogInterface:function(){var h=new Element("div");var g=new Element("h2",{"class":"detailsTitle"}).update("Publish Gadget");h.appendChild(g);var f=[{className:"tableHeader",fields:[{className:"left",node:"Mashup platform"},{className:"left",node:""}]}];var a=new Hash(this._publication.gadgets);var b=false;a.each(function(j){var i=PublishGadgetDialog.GADGET_DESTINATIONS.get(j.key);i.each(function(k){if(j.value){k.url=j.value;f.push(this._createPlatformRow(k));b=true}}.bind(this))}.bind(this));var d=new Element("div",{"class":"deployment"});h.appendChild(d);if(b){var c=new Element("table");d.appendChild(c);this._fillTable(c,f)}else{d.update("Upps! There are no available gadgets")}this._setContent(h)},_createPlatformRow:function(a){return{className:"",fields:[{className:"mashup",node:a.title+' [<a href="'+a.url+'" target="blank">'+a.urlLabel+"</a>]"},{className:"",node:this._buttons.set(a.id,new dijit.form.Button({label:a.buttonLabel,onClick:function(b){this._publishGadget(b.element(),a)}.bind(this)})).domNode}]}},_fillTable:function(a,b){b.each(function(d){var c=new Element("tr",{"class":d.className});d.fields.each(function(f){var g=new Element("td",{"class":f.className}).update(f.node);c.appendChild(g)});a.appendChild(c)})}});PublishGadgetDialog.GADGET_DESTINATIONS=new Hash();PublishGadgetDialog.GADGET_DESTINATIONS.set("ezweb",[{id:"ezweb",mashupPlatform:"ezweb",title:"EzWeb",urlLabel:"Template",buttonLabel:"Publish it!",disableAfterPublishing:true,doneButtonLabel:"Done"}]);PublishGadgetDialog.GADGET_DESTINATIONS.set("google",[{id:"igoogleDirectory",mashupPlatform:"igoogle",destination:"directory",title:"iGoogle Directory",urlLabel:"Template",buttonLabel:"Publish it!",disableAfterPublishing:true,doneButtonLabel:"Done"},{id:"igooglePersonal",mashupPlatform:"igoogle",destination:"personal",title:"iGoogle Personal Page",urlLabel:"Template",buttonLabel:"Publish it!",disableAfterPublishing:true,doneButtonLabel:"Done"},{id:"orkut",mashupPlatform:"orkut",title:"Orkut",urlLabel:"Template",buttonLabel:"Publish it!",disableAfterPublishing:true,doneButtonLabel:"Done"}]);PublishGadgetDialog.GADGET_DESTINATIONS.set("player",[{id:"standalone",mashupPlatform:"standalone",title:"Standalone",urlLabel:"HTML",buttonLabel:"Embed it!",disableAfterPublishing:false}]);PublishGadgetDialog.GADGET_DESTINATIONS.set("standalone",[{id:"standalone",mashupPlatform:"standalone",title:"Standalone",urlLabel:"HTML",buttonLabel:"Embed it!",disableAfterPublishing:false}]);PublishGadgetDialog.GADGET_DESTINATIONS.set("beemboard",[{id:"beemboard",mashupPlatform:"beemboard",title:"Beemboard",urlLabel:"HTML",buttonLabel:"Publish it!",disableAfterPublishing:true,doneButtonLabel:"Done"}]);var AddScreenDialog=Class.create(ConfirmDialog,{initialize:function($super){$super("Add Screen")},_initDialogInterface:function(){this._setHeader("Fulfill Screen Information","Please fulfill the required information in order to add a new screen to the catalogue.");var a=[{type:"title",value:"Screen information"},{type:"input",label:"Label:",name:"label",value:"Label of the screen..."},{type:"input",label:"Description:",name:"description",value:"Short description of the screen..."},{type:"input",label:"Creator URL (*):",name:"creator",value:"Creator URL..."},{type:"input",label:"Rights URL (*):",name:"rights",value:"Rights URL..."},{type:"input",label:"Version:",name:"version",value:"1.0"},{type:"input",label:"Icon URL (*):",name:"icon",value:"icon URL..."},{type:"input",label:"Screenshot URL (*):",name:"screenshot",value:"Screenshot URL..."},{type:"input",label:"Domain Context:",name:"tags",value:'Write domain context as tags separated by ","...'},{type:"input",label:"Homepage (*):",name:"homepage",value:"Homepage URL..."},{type:"input",label:"Preconditions:",name:"preconditions",value:'If any, write preconditions separated by ","...'},{type:"input",label:"Postconditions:",name:"postconditions",value:'If any, write postconditions separated by ","...'},{type:"input",label:"Screen code URL (*):",name:"code",value:"Screencode URL..."},{type:"hidden",name:"creationDate",value:""},{type:"label",value:"(*): Required Field"}];this._setContent(a)},_onOk:function($super){$super();var j=new Date();var b=this._getForm();b.creationDate.setValue(Utils.getIsoDateNow(j));var f=b.serialize(true);f.label={"en-GB":b.label.getValue()};f.description={"en-GB":b.description.getValue()};var g=b.tags.getValue().split(",");for(var h=0;h<g.length;h++){var d=g[h].strip();if(d&&d!=""){g[h]=d}else{g[h]=null}}g=g.compact();f.tags=Utils.getCatalogueTags(g,null);var c=b.preconditions.getValue().split(",");for(var h=0;h<c.length;h++){var d=c[h].strip();if(d&&d!=""){c[h]=d}else{c[h]=null}}c=c.compact();f.preconditions=c;var a=b.postconditions.getValue().split(",");for(var h=0;h<a.length;h++){var d=a[h].strip();if(d&&d!=""){a[h]=d}else{a[h]=null}}a=a.compact();f.postconditions=a;console.log("Before json");console.log(f);console.log("After json");console.log(Object.toJSON(f));Catalogue.createScreen(Object.toJSON(f))}});var NewBuildingBlockDialog=Class.create(ConfirmDialog,{initialize:function($super,a){this._buildingblockName=a;this._searchURI=URIs[this._buildingblockName.toLowerCase()+"Search"];this._available=true;$super("New "+this._buildingblockName,ConfirmDialog.OK_CANCEL,{createMessageZone:true})},_initDialogInterface:function(){this._setHeader("Fulfill "+this._buildingblockName+" Information","Please fulfill the required information in order to create a new "+this._buildingblockName+".");var b=this._scheduleAvailabilityCheck.bind(this);var a=[{type:"input",label:this._buildingblockName+" Name:",name:"name",value:"",message:this._buildingblockName+"Name cannot be blank",required:true,events:{keypress:b,blur:function(){this._getForm().name.value=Utils.sanitize($F(this._getForm().name))}.bind(this)}},{type:"advancedSeparator"},{type:"input",label:"Version:",name:"version",value:"",message:"Version cannot be blank",events:{keypress:b}},{type:"input",label:"Domain Concepts: <br /> (this will restrict the available set of building blocks)",name:"tags",value:""}];this._setContent(a)},_updateAvailabilityStatus:function(){if(this._available){this._setMessage()}else{this._setMessage("Please, use a diferent Version or "+this._buildingblockName+" Name.",FormDialog.MESSAGE_ERROR)}this._setDisabled(!this._available)},_onAvailabilityCheckSuccess:function(b){var a=b.responseText.evalJSON();this._available=a.length==0;this._updateAvailabilityStatus()},_availabilityCheck:function(){var b=Utils.sanitize($F(this._getForm().name));var a=$F(this._getForm().version);if(b==""||a==""){this._available=b!="";this._updateAvailabilityStatus();return}var c={query:{type:"and",operands:[{type:"field",condition:"is",field:"name",value:b},{type:"field",condition:"is",field:"version",value:a}]},fields:["version"],limit:1};PersistenceEngine.sendPost(this._searchURI,null,Object.toJSON(c),this,this._onAvailabilityCheckSuccess,Utils.onAJAXError)},_scheduleAvailabilityCheck:function(a){if((a.charCode==0)&&(a.keyCode!=8&&a.keyCode!=46&&a.keyCode!=13)){return}this._available=false;try{clearTimeout(this._timeout)}catch(a){}this._setMessage("Checking if the "+this._buildingblockName+" already exists...");this._timeout=setTimeout(this._availabilityCheck.bind(this),1000);this._setDisabled(true);if(a.keyCode==13){this._onOk();return}},_onOk:function($super){if(this._validate()){$super();var c=Utils.sanitize($F(this._getForm().name));var b=$F(this._getForm().tags).split(/[\s,]+/).without("");var a=$F(this._getForm().version);var d=Utils.getCatalogueTags($A(b),null);this._create(c,d,a)}},_create:function(b,d,a){var c=GVS.getDocumentController();c["create"+this._buildingblockName](b,d,a)},_onCancel:function($super){try{clearTimeout(this._timeout)}catch(a){}$super()},_reset:function($super){$super();this._getForm().name.value="";this._getForm().tags.value="";this._getForm().version.value="";this._available=false;this._setDisabled(true);this._setMessage()}});var NewBuildingBlockCodeDialog=Class.create(ConfirmDialog,{initialize:function($super,a){this._available=true;this._buildingblockName="Building Block";$super("New Building Block",ConfirmDialog.OK_CANCEL,{createMessageZone:true})},_initDialogInterface:function(){this._setHeader("Fulfill Building Block Information","Please fulfill the required information in order to create a new building block.");var b=this._scheduleAvailabilityCheck.bind(this);var a=[{type:"comboBox",label:"Type",name:"bBType",required:true,options:[{label:"Form",value:BuildingBlockDocument.FORM},{label:"Operator",value:BuildingBlockDocument.OPERATOR},{label:"Resource",value:BuildingBlockDocument.RESOURCE}]},{type:"input",label:"Name:",name:"name",value:"",message:this._buildingblockName+"Name cannot be blank",required:true,events:{keypress:b,blur:function(){this._getForm().name.value=Utils.sanitize($F(this._getForm().name))}.bind(this)}},{type:"advancedSeparator"},{type:"input",label:"Version:",name:"version",value:"",message:"Version cannot be blank",events:{keypress:b}},{type:"input",label:"Tags:",name:"tags",value:""}];this._setContent(a)},_updateAvailabilityStatus:function(){if(this._available){this._setMessage()}else{this._setMessage("Please, use a diferent Version or "+this._buildingblockName+" Name.",FormDialog.MESSAGE_ERROR)}this._setDisabled(!this._available)},_onAvailabilityCheckSuccess:function(b){var a=b.responseText.evalJSON();this._available=a.length==0;this._updateAvailabilityStatus()},_availabilityCheck:function(){var d=$F(this._getForm().bBType);var c=Utils.sanitize($F(this._getForm().name));var b=$F(this._getForm().version);if(d==""||c==""||b==""){this._available=c!="";this._updateAvailabilityStatus();return}var f={query:{type:"and",operands:[{type:"field",condition:"is",field:"name",value:c},{type:"field",condition:"is",field:"version",value:b}]},fields:["version"],limit:1};var a=URIs[d.toLowerCase()+"Search"];PersistenceEngine.sendPost(a,null,Object.toJSON(f),this,this._onAvailabilityCheckSuccess,Utils.onAJAXError)},_scheduleAvailabilityCheck:function(a){if((a.charCode==0)&&(a.keyCode!=8&&a.keyCode!=46&&a.keyCode!=13)){return}this._available=false;try{clearTimeout(this._timeout)}catch(a){}this._setMessage("Checking if the "+this._buildingblockName+" already exists...");this._timeout=setTimeout(this._availabilityCheck.bind(this),1000);this._setDisabled(true);if(a.keyCode==13){this._onOk();return}},_onOk:function($super){if(this._validate()){$super();var d=$F(this._getForm().bBType);var c=Utils.sanitize($F(this._getForm().name));var b=$F(this._getForm().tags).split(/[\s,]+/).without("");var a=$F(this._getForm().version);var f=Utils.getCatalogueTags($A(b),null);this._create(c,f,a,d)}},_create:function(b,f,a,c){var d=GVS.getDocumentController();var c=c.substr(0,1).toUpperCase()+c.substr(1);d["create"+c](b,f,a)},_onCancel:function($super){try{clearTimeout(this._timeout)}catch(a){}$super()},_reset:function($super){$super();this._getForm().name.value="";this._getForm().tags.value="";this._getForm().version.value="";this._available=false;this._setDisabled(true);this._setMessage()}});var SaveAsDialog=Class.create(ConfirmDialog,{initialize:function($super,h,c,a,f,d){this._type=h;this._available=true;this._name=c;this._version=a;this._onOkHandler=f;var g=ConfirmDialog.OK_CANCEL;var b={createMessageZone:true};if(d){g=ConfirmDialog.OK;b.closable=false}$super("Choose new name/version",g,b)},_initDialogInterface:function(){var b=this._scheduleAvailabilityCheck.bind(this);var a=[{type:"input",label:"New Name:",name:"name",value:this._name,message:"Name cannot be blank",required:true,events:{keypress:b}},{type:"input",label:"Version:",name:"version",value:"",message:"Version cannot be blank",events:{keypress:b}},{type:"label",value:"(Previous version was "+this._version+")",style:"font-size: 95%; color: #555; padding-left: 130px"}];this._setContent(a);this._setDisabled(true);this._availabilityCheck()},_updateAvailabilityStatus:function(){if(this._available){this._setMessage()}else{this._setMessage("Please, use a different "+this._type+" Version or Name.",FormDialog.MESSAGE_ERROR)}this._setDisabled(!this._available)},_onAvailabilityCheckSuccess:function(b){var a=b.responseText.evalJSON();this._available=a.length==0;this._updateAvailabilityStatus()},_availabilityCheck:function(){var b=$F(this._getForm().name);var a=$F(this._getForm().version);if(b==""||a==""){this._available=b!="";this._updateAvailabilityStatus();return}var c={query:{type:"and",operands:[{type:"field",condition:"is",field:"name",value:b},{type:"field",condition:"is",field:"version",value:a}]},fields:["version"],limit:1};PersistenceEngine.sendPost(URIs[this._type+"Search"],null,Object.toJSON(c),this,this._onAvailabilityCheckSuccess,Utils.onAJAXError)},_scheduleAvailabilityCheck:function(a){if((a.charCode==0)&&(a.keyCode!=8&&a.keyCode!=46)){return}this._available=false;try{clearTimeout(this._timeout)}catch(a){}this._setMessage("Checking if the name/version already exists...");this._timeout=setTimeout(this._availabilityCheck.bind(this),1000);this._setDisabled(true)},_onOk:function($super){if(this._getFormWidget().validate()&&this._available){var b=$F(this._getForm().name);var a=$F(this._getForm().version);this._onOkHandler(b,a);$super()}},_onCancel:function($super){try{clearTimeout(this._timeout)}catch(a){}$super()}});var GalleryDialog=Class.create(FormDialog,{initialize:function($super,c,a){$super({title:c,style:"display:none;"},{buttonPosition:FormDialog.POSITION_TOP});var b=Utils.variableOrDefault(a,{});this._properties=new Hash();this._properties.set("showTitleRow",(b.showTitleRow||false));this._properties.set("elementsPerPage",(b.elementsPerPage||10));this._properties.set("onDblClick",(b.onDblClick||function(){}));this._properties.set("disableIfNotValid",(b.disableIfNotValid||false));this._fields=null;this._buttons=null;this._disabledButtons=new Array();this._rows=new Array();this._selectedRow=null},show:function(){},_setFields:function(a){this._fields=a},_setButtons:function(a){this._buttons=a},_addRow:function(a){this._rows.push(a)},_render:function(c){var f=Utils.variableOrDefault(c,true);var d=new Element("div",{"class":"gallery"});if(this._properties.get("showTitleRow")){}var a=this._selectedRow&&this._selectedRow.key;this._selectedRow=null;this._rows.each(function(p){var n=new Element("div",{"class":"row"});for(var l=0,k=p.values;l<k.size();l++){if(!this._fields[l].hidden){var o=new Element("div",{"class":"field "+this._fields[l].className}).update(k[l]);n.appendChild(o)}}var j=function(){this._unselectElements();this._selectedRow=p;n.addClassName("selected");for(var q=0;q<this._disabledButtons.length;q++){this._disabledButtons[q].attr("disabled",!p.isValid)}}.bind(this);n.observe("click",j);if(this._properties.get("onDblClick")&&(!this._properties.get("disableIfNotValid")||p.isValid)){n.observe("dblclick",function(){this._properties.get("onDblClick")(p.key)}.bind(this))}if(a==p.key){j()}d.appendChild(n)}.bind(this));if(f&&this._rows.size()>0){this._removeButtons();this._buttons.each(function(i){var j=this._addButton(i.value,function(){i.handler(this._selectedRow.key)}.bind(this));if(i.disableIfNotValid){this._disabledButtons.push(j)}}.bind(this))}if(this._rows.size()==0){var g=new Element("div",{"class":"info"}).update("Uppss....Nothing here");d.appendChild(g);this._removeButtons();this._addButton("Close",this._dialog.hide.bind(this._dialog))}else{if(!this._selectedRow&&!this._properties.get("showTitleRow")&&d.firstChild){d.firstChild.addClassName("selected");var h=this._selectedRow=this._rows[0];for(var b=0;b<this._disabledButtons.length;b++){this._disabledButtons[b].attr("disabled",!h.isValid)}}}this._setContent(d);this._contentNode.appendChild(this._createSearchBar())},_unselectElements:function(){$$(".gallery .row.selected").each(function(a){a.removeClassName("selected")});this._disabledButtons.each(function(a){a.attr("disabled",true)});this._selectedRow=null},_createSearchBar:function(){var a=this._unselectElements.bind(this);var c=new Element("div",{"class":"searchBar"});c.style.marginTop="3px";var b=new PaletteSearchBox();b.addEventListener(function(h,g){var f=g.toLowerCase();var d=$$(".gallery .row .field.name");d.each(function(i){var k=i.textContent.toLowerCase();if(f.blank()||k.match(f)){i.parentNode.show()}else{var j=i.parentNode;j.hide();if(j.hasClassName("selected")){a()}}})});c.appendChild(b.getDOMNode());return c},_emptyRows:function(){this._rows=new Array()},_show:function(){this._initDialogInterface();GVS.setEnabled(false);this._dialog.show()}});var ManageScreenflowsDialog=Class.create(GalleryDialog,{initialize:function($super){$super("Screenflow browser",{onDblClick:this._openScreenflow.bind(this),disableIfNotValid:true});this._screenflows=null},show:function(){PersistenceEngine.sendGet(URIs.screenflow,this,this._onLoadSuccess,Utils.onAJAXError)},_initDialogInterface:function(){this._setHeader("Browse your screenflows","These are the screenflows you have created. Here you can continue editing them and share your work with the community");this._setFields([{title:"Screenflow Name",className:"name"},{title:"Screenflow Version",className:"version"},{title:"Tags",className:"tags"},{title:"Description",className:"description"},{title:"Sharing",className:"sharing"}]);this._setButtons([{value:"Open screenflow",handler:this._openScreenflow.bind(this),disableIfNotValid:true},{value:"Clone screenflow",handler:this._cloneScreenflow.bind(this),disableIfNotValid:true},{value:"Share/Unshare screenflow",handler:this._shareScreenflow.bind(this)},{value:"Delete screenflow",handler:this._deleteScreenflow.bind(this)}]);this._createScreenflowList();this._render()},_createScreenflowList:function(){this._emptyRows();this._screenflows.each(function(b){var a=b.definition?true:false;a=a&&(b.uri)?false:true;this._addRow({key:b.id,values:[b.name,'<span class="bold">Version: </span>'+b.version,'<span class="bold">Tags: </span>'+b.tags.collect(function(c){return c.label["en-gb"]}).join(", "),'<span class="bold">Description </span><br />'+b.description["en-gb"],"<span class="+(b.uri?'"shared"':'"unshared"')+">&nbsp;</span>"],isValid:a})}.bind(this))},_onLoadSuccess:function(a){this._screenflows=JSON.parse(a.responseText);this._show()},_onReLoadSuccess:function(a){this._screenflows=JSON.parse(a.responseText);this._createScreenflowList();this._render(false)},_openScreenflow:function(b){var a=GVS.getDocumentController();a.loadScreenflow(b);this._dialog.hide()},_cloneScreenflow:function(b){var a=GVS.getDocumentController();a.cloneScreenflow(b);this._dialog.hide()},_shareScreenflow:function(c){var b=URIs.share.replace("<id>",c);var a=this._screenflows.detect(function(d){return d.id==c});if(a.uri){PersistenceEngine.sendDelete(b,this,this._reload,Utils.onAJAXError)}else{PersistenceEngine.sendPost(b,null,null,this,this._reload,Utils.onAJAXError)}},_deleteScreenflow:function(a){confirm("Are you sure you want to delete the screenflow? This action cannot be undone. <br />All the generated gadgets will be destroyed (unless you have deployed them before).",this._confirmDelete.bind({mine:this,id:a}))},_confirmDelete:function(){var a=URIs.buildingblock+this.id;PersistenceEngine.sendDelete(a,this.mine,this.mine._reload,Utils.onAJAXError)},_addScreenflow:function(){this._dialog.hide()},_reload:function(){PersistenceEngine.sendGet(URIs.screenflow,this,this._onReLoadSuccess,Utils.onAJAXError)}});var ManageScreensDialog=Class.create(GalleryDialog,{initialize:function($super){$super("Screen browser",{onDblClick:this._openScreen.bind(this),disableIfNotValid:true});this._screens=null},show:function(){PersistenceEngine.sendGet(URIs.screen,this,this._onLoadSuccess,Utils.onAJAXError)},_initDialogInterface:function(){this._setHeader("Browse your screens","These are the screens you have created. Here you can continue editing them and share your work with the community");this._setFields([{title:"Icon",className:"icon"},{title:"Screen Name",className:"name"},{title:"Screen Version",className:"version"},{title:"Tags",className:"tags"},{title:"Description",className:"description"},{title:"Sharing",className:"sharing"}]);this._setButtons([{value:"Open screen",handler:this._openScreen.bind(this),disableIfNotValid:true},{value:"Clone screen",handler:this._cloneScreen.bind(this)},{value:"Share/Unshare screen",handler:this._shareScreen.bind(this)},{value:"Delete screen",handler:this._deleteScreen.bind(this)}]);this._createScreenList();this._render()},_createScreenList:function(){this._emptyRows();this._screens.each(function(a){var b=a.definition&&!a.uri;this._addRow({key:a.id,values:[new Element("img",{src:a.icon}),a.name,'<span class="bold">Version: </span>'+a.version,'<span class="bold">Tags: </span>'+a.tags.collect(function(c){return c.label["en-gb"]}).join(", "),'<span class="bold">Description </span><br />'+a.description["en-gb"],"<span class="+(a.uri?'"shared"':'"unshared"')+">&nbsp;</span>"],isValid:b})}.bind(this))},_onLoadSuccess:function(a){this._screens=JSON.parse(a.responseText);this._show()},_onReLoadSuccess:function(a){this._screens=JSON.parse(a.responseText);this._createScreenList();this._render(false)},_openScreen:function(b){var a=GVS.getDocumentController();a.loadScreen(b);this._dialog.hide()},_cloneScreen:function(b){var a=GVS.getDocumentController();a.cloneScreen(b);this._dialog.hide()},_shareScreen:function(c){var b=URIs.share.replace("<id>",c);var a=this._screens.detect(function(d){return d.id==c});if(a.uri){PersistenceEngine.sendDelete(b,this,this._reload,Utils.onAJAXError)}else{PersistenceEngine.sendPost(b,null,null,this,this._reload,Utils.onAJAXError)}},_deleteScreen:function(a){confirm("Are you sure you want to delete the screen? This action cannot be undone",this._confirmDelete.bind({mine:this,id:a}))},_confirmDelete:function(b){var a=URIs.buildingblock+this.id;if(b){PersistenceEngine.sendDelete(a,this.mine,this.mine._reload,Utils.onAJAXError)}},_addScreen:function(){this._dialog.hide()},_reload:function(){PersistenceEngine.sendGet(URIs.screen,this,this._onReLoadSuccess,Utils.onAJAXError)}});var PreviewDialog=Class.create(ConfirmDialog,{initialize:function($super,b,a){$super("Preview of "+b,ConfirmDialog.OK);this._setContent(a)},setContent:function(b,a){this._setContent(b,a)}});var TriggerDialog=Class.create(ConfirmDialog,{initialize:function($super,c,b,d,a){$super("Assign triggers to "+c);this._actionName=c;this._initialTriggerList=b;this._canvasInstances=d;this._onChangeCallback=a;this._button=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});this._unselectedTriggerListNode=null;this._selectedTriggerListNode=null;this._addTriggerButton=null;this._removeTriggerButton=null},getButtonNode:function(){return new Element("div",{"class":"triggerButton"}).update(this._button.domNode)},_initDialogInterface:function(){var f=new Element("div",{"class":"triggerDialog"});var i=new Element("h2").update("Choose triggers for action: "+this._actionName);f.appendChild(i);var b=new Element("div",{"class":"subtitle"});var g=new Element("div",{style:"float:left"}).update("Selected triggers");b.appendChild(g);var h=new Element("div",{style:"float:right"}).update("Unselected triggers");b.appendChild(h);f.appendChild(b);this._selectedTriggerListNode=new Element("select",{multiple:"multiple"});this._selectedTriggerListNode.observe("change",this._onListChange.bind(this));var c=false;if(this._initialTriggerList){this._initialTriggerList.each(function(j){var k=new Element("option",{value:j.getSourceInstance().getId()+"#"+j.getTriggerName()}).update(j.getSourceInstance().getTitle()+": "+j.getTriggerName());this._selectedTriggerListNode.appendChild(k);if(j.constructor==ScreenTrigger){c=true}}.bind(this))}f.appendChild(this._selectedTriggerListNode);var a=new Element("div",{"class":"addRemoveZone"});this._addTriggerButton=new dijit.form.Button({iconClass:"plusIcon",showLabel:true,label:"<",style:"width:25px",onClick:this._onAddTrigger.bind(this)});a.appendChild(this._addTriggerButton.domNode);this._removeTriggerButton=new dijit.form.Button({iconClass:"minusIcon",showLabel:true,label:">",style:"width:25px",onClick:this._onRemoveTrigger.bind(this)});a.appendChild(this._removeTriggerButton.domNode);f.appendChild(a);this._unselectedTriggerListNode=new Element("select",{multiple:"multiple"});this._unselectedTriggerListNode.observe("change",this._onListChange.bind(this));if(!c){var d=new Element("option",{value:ScreenTrigger.INSTANCE_NAME+"#"+ScreenTrigger.ONLOAD}).update(ScreenTrigger.INSTANCE_NAME+": "+ScreenTrigger.ONLOAD);this._unselectedTriggerListNode.appendChild(d)}this._canvasInstances.each(function(j){j.getBuildingBlockDescription().triggers.each(function(k){var n=false;if(this._initialTriggerList){n=this._initialTriggerList.detect(function(o){return(j.getId()+k)==(o.getSourceId()+o.getTriggerName())})}if(!n){var l=new Element("option",{value:j.getId()+"#"+k}).update(j.getTitle()+": "+k);this._unselectedTriggerListNode.appendChild(l)}}.bind(this))}.bind(this));f.appendChild(this._unselectedTriggerListNode);this._setContent(f);this._onListChange()},_onAddTrigger:function(){var a=this._getSelectionItems(this._unselectedTriggerListNode);a.each(function(b){b.parentNode.removeChild(b);this._selectedTriggerListNode.appendChild(b)}.bind(this));this._onListChange()},_onRemoveTrigger:function(){var a=this._getSelectionItems(this._selectedTriggerListNode);a.each(function(b){b.parentNode.removeChild(b);this._unselectedTriggerListNode.appendChild(b)}.bind(this));this._onListChange()},_onOk:function($super){$super();var b=new Array();$A(this._selectedTriggerListNode.options).each(function(c){if(this._initialTriggerList){var d=this._initialTriggerList.detect(function(f){return(c.value)==(f.getSourceId()+"#"+f.getTriggerName())});if(d==null){b.push(c.value)}}else{b.push(c.value)}}.bind(this));var a=new Array();$A(this._unselectedTriggerListNode.options).each(function(c){if(this._initialTriggerList){var d=this._initialTriggerList.detect(function(f){return(c.value)==(f.getSourceId()+"#"+f.getTriggerName())});if(d){a.push(c.value)}}}.bind(this));this._onChangeCallback(this._actionName,b,a)},_onListChange:function(b){var a=null;if(b){a=b.element()}if(this._unselectedTriggerListNode==a){this._unselectAll(this._selectedTriggerListNode)}if(this._selectedTriggerListNode==a){this._unselectAll(this._unselectedTriggerListNode)}if(this._selectedTriggerListNode.selectedIndex==-1){this._removeTriggerButton.attr("disabled",true)}else{this._removeTriggerButton.attr("disabled",false)}if(this._unselectedTriggerListNode.selectedIndex==-1){this._addTriggerButton.attr("disabled",true)}else{this._addTriggerButton.attr("disabled",false)}},_getSelectionItems:function(a){var b=new Array();while(a.selectedIndex!=-1){b.push(a.options[a.selectedIndex]);a.options[a.selectedIndex].selected=false}return b},_unselectAll:function(a){while(a.selectedIndex!=-1){a.options[a.selectedIndex].selected=false}}});var ParamsDialog=Class.create(ConfirmDialog,{initialize:function($super,c,b,d,a){$super(c+" Parameters");this._buildingblockName=c;this._initialParameter=b;this._templateParameter=d;this._textarea=new dijit.form.SimpleTextarea();this._textarea.domNode.addClassName("parameterArea");this._textarea.setValue(this._initialParameter);this._tooltipButton=new Element("div",{"class":"initialParameterButton"}).update("&nbsp;");this._tooltipButton.observe("click",function(){var f=new ExternalContentDialog("Example parameter configuration");f.show(new Element("pre").update(this._templateParameter))}.bind(this));this._templateParameterTooltip=new dijit.Tooltip({connectId:[this._tooltipButton],label:"<h4> Example parameter configuration </h4><pre>"+this._templateParameter+"</pre>"});this._onChangeCallback=a},getButtonNode:function(){var a=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});return new Element("div",{"class":"triggerButton"}).update(a.domNode)},_initDialogInterface:function(){var a=new Element("div",{"class":"paramsDialog"});var b=new Element("h2").update("Edit "+this._buildingblockName+" parameters:");a.appendChild(b);a.appendChild(this._textarea.domNode);if(this._templateParameter){a.appendChild(this._tooltipButton)}this._setContent(a)},_onOk:function($super){$super();this._onChangeCallback(this._textarea.getValue())}});var TitleDialog=Class.create(ConfirmDialog,{initialize:function($super,b,a){$super("Change Screen title");this._title=b;this._onChangeCallback=a},getButtonNode:function(){var a=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});return new Element("div",{"class":"triggerButton"}).update(a.domNode)},_initDialogInterface:function(){this._setHeader("Change Screen title","This title will be shown when executing the gadget");var a=[{type:"input",label:"Screen Title:",name:"title",value:this._title,message:"Title cannot be blank",required:true}];this._setContent(a)},_onOk:function($super){$super();this._onChangeCallback(this._getForm().title.value)}});var CaptionDialog=Class.create(ConfirmDialog,{initialize:function($super,b,a){$super("Add Screen caption");this._caption=b;this._onChangeCallback=a},getButtonNode:function(){var a=new dijit.form.Button({label:"...",onClick:this.show.bind(this)});return new Element("div",{"class":"triggerButton"}).update(a.domNode)},_initDialogInterface:function(){this._setHeader("Add Screen caption","The caption will be shown in screen bottom when executing the gadget.<br />You can use HTML tags to add formatting");var a=[{type:"textarea",label:"Screen Caption:",name:"caption",value:this._caption}];this._setContent(a)},_onOk:function($super){$super();this._onChangeCallback(this._getForm().caption.value)}});var PropertiesDialog=Class.create(ConfirmDialog,{initialize:function($super,a,b,c){this._title=a+" Properties";this._description=b;this._onFinishHandler=null;this._onChangeHandler=c;$super(this._title)},show:function($super,a){var b=Utils.variableOrDefault(a,null);this._onFinishHandler=b;$super()},_initDialogInterface:function(){this._setHeader(this._title);var a=[{type:"title",value:"Basic information"},{type:"input",label:"Building block name:",name:"name",value:this._description.name,required:true,events:{blur:function(){this._getForm().name.value=Utils.sanitize($F(this._getForm().name))}.bind(this)}},{type:"input",label:"Version:",name:"version",value:this._description.version},{type:"input",label:"Tags:",name:"tags",value:this._description.tags.collect(function(b){return b.label["en-gb"]}).join(", ")},{type:"title",value:"Sharing information"},{type:"textarea",label:"Description:",name:"description",value:this._description.description["en-gb"],required:true},{type:"input",label:"Creator:",name:"creator",value:this._description.creator,required:true,disabled:true},{type:"input",label:"Licence information:",name:"rights",value:this._description.rights,required:true},{type:"input",label:"Icon:",name:"icon",value:this._description.icon,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Screenshot:",name:"screenshot",value:this._description.screenshot,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"},{type:"input",label:"Homepage:",name:"homepage",value:this._description.homepage,regExp:"([hH][tT][tT][pP][sS]?)://[A-Za-z0-9-_]+(.[A-Za-z0-9-_]+)*(:\d+)?(/[a-zA-Z0-9.?=/#%&+-]*)*",message:"Invalid URL"}];this._setContent(a)},_onOk:function($super){if(this._getFormWidget().validate()){var a=$F(this._getForm().tags).split(/[\s,]+/).without("");var c={tags:Utils.getCatalogueTags(a,null),description:{"en-gb":$F(this._getForm().description)},label:{"en-gb":Utils.sanitize($F(this._getForm().name))},name:Utils.sanitize($F(this._getForm().name))};var b=this._getForm();var d=[b.version,b.creator,b.rights,b.icon,b.screenshot,b.homepage];Object.extend(c,Form.serializeElements(d,{hash:true}));var f=false;$H(c).each(function(g){if(this._description[g.key]!=g.value){f=true}}.bind(this));this._description.addProperties(c);$super();if(f){this._onChangeHandler()}if(this._onFinishHandler&&this._onFinishHandler instanceof Function){this._onFinishHandler();this._onFinishHandler=null}}},_reset:function($super){this._handler=null;this._initDialogInterface();$super()}});var AlertSingleton=function(){var a=null;var b=Class.create(FormDialog,{initialize:function($super){$super({title:"Warning",style:"display:none"});this._contentNode.addClassName("systemDialog");this._addButton("Ok",function(){this._dialog.hide()}.bind(this))},show:function($super,c){this._contentNode.update(c);$super()},_initDialogInterface:function(){}});return new function(){this.getInstance=function(){if(a==null){a=new b()}return a}}}();if(document.getElementById){window.alert=function(a){AlertSingleton.getInstance().show(a);console.log(a)}}var ConfirmSingleton=function(){var b=null;var a=Class.create(ConfirmDialog,{initialize:function($super){$super("Warning");this._callback=null;this._contentNode.addClassName("systemDialog")},show:function($super,c,d){this._contentNode.update(c);$super();this._callback=d},_onOk:function($super){this._callback(true);this._callback=null;$super()},_onCancel:function($super){this._callback(false);this._callback=null;$super()},_initDialogInterface:function(){},_hide:function($super){$super();if(this._callback){this._callback(false);this._callback=null}}});return new function(){this.getInstance=function(){if(b==null){b=new a()}return b}}}();if(document.getElementById){var browserConfirm=window.confirm;window.confirm=function(b,a){if(a){ConfirmSingleton.getInstance().show(b,a)}else{browserConfirm(b)}}}var StandaloneEmbeddingDialog=Class.create(ConfirmDialog,{initialize:function($super,a,b){this._url=b;this._publication=a;$super(this._getDialogTitle(this._publication.name),ConfirmDialog.OK);this._setContent(content)},updateDialog:function(a,b){this._url=b;this._publication=a;this._initDialogInterface();this._setTitle(this._getDialogTitle(this._publication.name),null)},_initDialogInterface:function(){var a=[{type:"title",value:"Please, embed this HTML code into your web page:"},{type:"pre",value:this._getEmbedding()}];this._setContent(a)},_getEmbedding:function(){var a=this._publication.height;if(!a||a==""){a="600"}var b=this._publication.width;if(!b||b==""){b="400"}return('<object data="'+this._url+'" height="'+a+'" width="'+b+'" class="embed"></object>').escapeHTML()},_getDialogTitle:function(a){return"Embedding of "+a+" Standalone Gadget"}});var ButtonArrayDialog=Class.create(FormDialog,{initialize:function($super,b,a){$super({title:"Choose Building Block",style:"display:none;"},a);this._handlers=b},_initDialogInterface:function(){var a=new Element("div",{"class":"buttonArray"});this._handlers.each(function(c){var b=new dijit.form.Button({label:c.label,onClick:function(){this._dialog.hide();c.handler()}.bind(this)});a.appendChild(b.domNode);a.appendChild(new Element("br"))}.bind(this));this._setContent(a)}});var ManageBuildingBlocksDialog=Class.create(GalleryDialog,{initialize:function($super){$super("Building blocks browser",{onDblClick:this._openBuildingBlock.bind(this),disableIfNotValid:true});this._buildingBlocks=null;this._showForms=true;this._showOperators=true;this._showResources=true},show:function(){this._loadBuildinBlocks(this._show.bind(this))},_createSearchBar:function($super){var d=$super();var c=document.createElement("div");c.style.textAlign="right";d.appendChild(c);var b=new dijit.form.CheckBox({name:"Forms",checked:this._showForms,onChange:function(f){this._showForms=!(this._showForms&&(this._showOperators||this._showResources));this._reload()}.bind(this)});c.appendChild(b.domNode);var a=document.createElement("span");a.innerHTML="Forms ";c.appendChild(a);var b=new dijit.form.CheckBox({name:"Operators",checked:this._showOperators,onChange:function(f){this._showOperators=!(this._showOperators&&(this._showForms||this._showResources));this._reload()}.bind(this)});c.appendChild(b.domNode);var a=document.createElement("span");a.innerHTML="Operators ";c.appendChild(a);var b=new dijit.form.CheckBox({name:"Resources",checked:this._showResources,onChange:function(f){this._showResources=!(this._showResources&&(this._showForms||this._showOperators));this._reload()}.bind(this)});c.appendChild(b.domNode);var a=document.createElement("span");a.innerHTML="Resources";c.appendChild(a);return d},_initDialogInterface:function(){this._setHeader("Browse your building blocks","These are the building blocks you have created. Here you can continue editing them and share your work with the community");this._setFields([{title:"Icon",className:"icon"},{title:"Screen Name",className:"name"},{title:"Screen Version",className:"version"},{title:"Tags",className:"tags"},{title:"Description",className:"description"},{title:"Sharing",className:"sharing"}]);this._setButtons([{value:"Open building block",handler:this._openBuildingBlock.bind(this),disableIfNotValid:true},{value:"Share/Unshare building block",handler:this._shareBuildingBlock.bind(this)},{value:"Delete building block",handler:this._deleteBuildingBlock.bind(this)}]);this._createBuildingBlockList();this._render()},_createBuildingBlockList:function(){this._emptyRows();this._buildingBlocks.each(function(a){var b=!a.uri;this._addRow({key:a.id,values:[new Element("img",{src:a.icon}),a.name,'<span class="bold">Version: </span>'+a.version,'<span class="bold">Tags: </span>'+a.tags.collect(function(c){return c.label["en-gb"]}).join(", "),'<span class="bold">Description </span><br />'+a.description["en-gb"],"<span class="+(a.uri?'"shared"':'"unshared"')+">&nbsp;</span>"],isValid:b})}.bind(this))},_openBuildingBlock:function(b){var a=GVS.getDocumentController();a.loadBuildingBlock(b);this._dialog.hide()},_shareBuildingBlock:function(c){var b=URIs.share.replace("<id>",c);var a=this._buildingBlocks.detect(function(d){return d.id==c});if(a.uri){PersistenceEngine.sendDelete(b,this,this._reload,Utils.onAJAXError)}else{PersistenceEngine.sendPost(b,null,null,this,this._reload,Utils.onAJAXError)}},_deleteBuildingBlock:function(a){confirm("Are you sure you want to delete the building block? This action cannot be undone",this._confirmDelete.bind({mine:this,id:a}))},_confirmDelete:function(b){var a=URIs.buildingblock+this.id;if(b){PersistenceEngine.sendDelete(a,this.mine,this.mine._reload,Utils.onAJAXError)}},_reload:function(){this._loadBuildinBlocks(function(){this._createBuildingBlockList();this._render(false)}.bind(this))},_loadBuildinBlocks:function(b){var a=[];this._buildingBlocks=[];if(this._showForms){a.push("form")}if(this._showOperators){a.push("operator")}if(this._showResources){a.push("resource")}this._getBuildingBlocks(a,this,b)},_getBuildingBlocks:function(b,a,d){var c=b.pop();if(!c&&d instanceof Function){d.call(a)}else{PersistenceEngine.sendGet(URIs[c],a,function(f){this._buildingBlocks=this._buildingBlocks.concat(JSON.parse(f.responseText));this._getBuildingBlocks(b,a,d)},Utils.onAJAXError)}}});var iServeDialog=Class.create(ConfirmDialog,{initialize:function($super,a){$super("iServe External Services",ConfirmDialog.OK);this._iServeList=a},_initDialogInterface:function(){var f=new Element("div");var c=new Element("h2").update("About this services");f.appendChild(c);var h=new Element("p").update('This services are extracted from <a href="http://iserve.kmi.open.ac.uk/">iServe</a>, which is a platform to discover services through its semantic information. All of them are related to the building block you are creating, so hopefully some of them will be useful for you.');f.appendChild(h);var g=new Element("p").update("The proposed services are not GVS-compliant, so you will have to wrap them. You can use the GVS to do so. ");f.appendChild(g);var i=new Element("table");var j=new Element("tr");i.appendChild(j);var d=new Element("th").update("Service Name");j.appendChild(d);var a=new Element("th").update("Service URL");j.appendChild(a);var b=new Element("th").update("Get more info");j.appendChild(b);this._iServeList.each(function(k){var p=new Element("tr");i.appendChild(p);var n=k.label||"-";var k=new Element("td").update(n);p.appendChild(k);var l=new Element("td").update(k.address);p.appendChild(l);var o=new Element("td").update('<a href="'+k.doc+'">+</a>');p.appendChild(o)});this._setContent(f)}});var PlanPanel=Class.create(SetListener,{initialize:function(){this._node=new Element("div",{"class":"panel plans",style:"display:none"});this._plansZone=null;this._planSet=new PlanSet();this._planSet.setListener(this);this._visible=false;this._dropZone=null;this._inferenceEngine=null;this._createContent()},getNode:function(){return this._node},setDropZone:function(a){this._dropZone=a},setInferenceEngine:function(a){this._inferenceEngine=a},hide:function(){dojox.fx.wipeOut({node:this._node,duration:300,onAnimate:this._updateDropArea.bind(this),onEnd:this._showDropArea.bind(this)}).play();this._visible=false},isVisible:function(){return this._visible},showPlans:function(a){this._planSet.setPlans(a)},setChanged:function(){var a=new Array();this._planSet.getBuildingBlocks().each(function(b){a.push(new PlanComponent(b,this._dropZone,this._inferenceEngine))}.bind(this));this._plansZone.update("");a.each(function(b){this._plansZone.appendChild(b.getNode())}.bind(this));this._show()},_show:function(){dojox.fx.wipeTo({node:this._node,duration:300,height:200,onAnimate:this._updateDropArea.bind(this),onEnd:this._updateDropArea.bind(this)}).play();this._visible=true},_updateDropArea:function(){var a=(parseInt(this._node.clientHeight)+1)+"px";this._dropZone.getNode().setStyle({top:a})},_showDropArea:function(){this._dropZone.getNode().setStyle({top:"0px"})},_createContent:function(){var b=new Element("div");this._node.appendChild(b);var f=new Element("div",{"class":"dijitAccordionTitle"}).update("Available plans for the selected screen");b.appendChild(f);var d="Please drag & drop one of these sets of screens into ";d+="the screenflow area, to make the selected screen ";d+="reachable. ";var a=new Element("div",{"class":"text"}).update(d);b.appendChild(a);this._plansZone=new Element("div",{"class":"planZone"});b.appendChild(this._plansZone);var c=new Element("div",{"class":"button"});Element.observe(c,"click",function(g){g.stop();this.hide()}.bind(this));b.appendChild(c)}});var PlanSet=Class.create(BuildingBlockSet,{initialize:function($super){$super([]);this._plans=new Array();this._factory=Catalogue.getBuildingBlockFactory(Constants.BuildingBlock.SCREEN)},getBuildingBlocks:function(){var a=new Array();this._plans.each(function(b){a.push(this._factory.getBuildingBlocks(b))}.bind(this));return a},setPlans:function(b){this._plans=b.splice(0,10);var a=this._plans.flatten().uniq();this._factory.cacheBuildingBlocks(a,this._cachedElements.bind(this))},_cachedElements:function(){this._listener.setChanged()}});var PlanComponent=Class.create(DragSource,{initialize:function($super,b,c,a){$super();this._dropZone=c;this._plan=b;this._inferenceEngine=a;this._view=new PlanView(this._plan);this._node=this._view.getNode();this.enableDragNDrop(null,[this._dropZone])},getNode:function(){return this._node},getHandlerNode:function(){return this._node},getDraggableObject:function(){var a=new PlanInstance(this._plan,this._inferenceEngine);var b=a.getHandlerNode();dijit.byId("main").domNode.appendChild(b);b.setStyle({top:this._getContentOffsetTop()+"px",left:this._getContentOffsetLeft()+"px",position:"absolute"});return a},_getContentOffsetTop:function(){return this._node.cumulativeOffset().top-this._node.cumulativeScrollOffset().top},_getContentOffsetLeft:function(){return this._node.cumulativeOffset().left-this._node.cumulativeScrollOffset().left}});var PlanView=Class.create(BuildingBlockView,{initialize:function($super,d){$super();this._node=new Element("div",{"class":"plan view"});var a=0;d.each(function(g){var f=new ScreenView(g);this._node.appendChild(f.getNode());a++}.bind(this));var b=102*a+6*a;var c=b+"px";this._node.setStyle({width:c})},setReachability:function(a){},destroy:function(){}});var PlanInstance=Class.create(ComponentInstance,{initialize:function($super,c,a,b){this._plan=c;$super([],a,b)},getTitle:function(){return""},getInfo:function(){return new Hash()},getUri:function(){return""},getPlanElements:function(){return this._plan},_createView:function(){return new PlanView(this._plan)}});var GadgetDialog=Class.create(GalleryDialog,{initialize:function($super,a){$super("Available gadgets for the screenflow",{onDblClick:this._showDeploymentInfo.bind(this)});this._buildGadgetDialog=new BuildGadgetDialog(this._onBuildGadgetDialogCallback.bind(this));this._publishGadgetDialog=new PublishGadgetDialog();this._description=a;this._storedGadgets=new Hash()},show:function(){var a=URIs.getStore.replace("<screenflow_id>",this._description.id);PersistenceEngine.sendGet(a,this,this._onLoadSuccess,Utils.onAJAXError)},_onLoadSuccess:function(b){var a=JSON.parse(b.responseText);a.each(function(c){this._storedGadgets.set(c.id,c)},this);if(this._storedGadgets.values().size()>0){this._show()}else{this._buildGadget()}},_initDialogInterface:function(){this._setHeader("Stored Gadgets for this screenflow","These are the gadgets you have created for the current screenflow.Here you can deploy them to several mashup platforms or create new ones");this._setFields([{title:"Gadget Name",className:"name"},{title:"Gadget Vendor",className:"vendor"},{title:"Gadget Version",className:"version"},{title:"Mashup Platforms",className:"platforms"},{title:"Description",className:"description"}]);this._setButtons([{value:"Create new gadget",handler:this._buildGadget.bind(this),disableIfNotValid:false},{value:"Show Available platforms",handler:this._showDeploymentInfo.bind(this),disableIfNotValid:true},{value:"Delete Gadget",handler:this._confirmDeleteGadget.bind(this),disableIfNotValid:true}]);this._createGadgetList();this._render()},_createGadgetList:function(){this._emptyRows();this._storedGadgets.values().each(function(a){this._addRow({key:a.id,values:[a.name,'<span class="bold">Vendor: </span>'+a.vendor,'<span class="bold">Version: </span>'+a.version,'<span class="bold">Mashup platforms: </span>'+a.platforms,'<span class="bold">Description </span><br />'+a.description],isValid:true})}.bind(this))},_buildGadget:function(){this._hide();this._buildGadgetDialog.show({name:this._description.name,shortname:this._description.name,desc:this._description.description["en-gb"]})},_onBuildGadgetDialogCallback:function(c){var b=Object.extend(c,{description:{"en-gb":c.desc},uri:"buildingblock/"+this._description.getId(),label:{"en-gb":c.name},id:this._description.getId()});var a={gadget:Object.toJSON(b),screenflow:this._description.getId()};PersistenceEngine.sendPost(URIs.store,a,null,this,this._onBuildSuccess,this._onError);Utils.showMessage("Creating and storing the gadget...")},_onBuildSuccess:function(b){var a=JSON.parse(b.responseText);this._storedGadgets.set(a.id,a);this._createGadgetList();if(this.isVisible()){this._render()}Utils.showMessage("Creating and storing the gadget...Done",{hide:true});this._showDeploymentInfo(a.id)},_showDeploymentInfo:function(b){var a=this._storedGadgets.get(b);this._publishGadgetDialog.show(a)},_confirmDeleteGadget:function(a){confirm("Are you sure you want to delete the gadget? This action cannot be undone",function(b){if(b){this._deleteGadget(a)}}.bind(this))},_deleteGadget:function(b){var a=URIs.store+b;PersistenceEngine.sendDelete(a,this,function(){this._storedGadgets.unset(b);this._createGadgetList();if(this.isVisible()){this._render()}},this._onError)},_onDelete:function(){},_onError:function(c,b){var a;if(b){a=b}else{a=c.responseText}Utils.showMessage("Cannot store the gadget: "+a,{error:true,hide:true})}});var ScreenflowPlayer=Class.create({initialize:function(){this._description=null;this._dialog=null;this._logEnabled=false;this._object=null},playScreenflow:function(a){this._description=a;if(!this._dialog){var b=this._description.name;this._dialog=new PreviewDialog(b,this._getPreview())}else{this._dialog.setContent(this._getPreview())}this._dialog.show()},debugScreenflow:function(a){this._description=a;GVS.getDocumentController().openExternalTool("Screenflow Debugger",this._getScreenflowURL("debug"))},_getPreview:function(){var f=new Element("div",{"class":"player"});var b=new Element("div",{"class":"error"});f.appendChild(b);this._object=new Element("object",{data:this._getScreenflowURL(),"class":"embed"});f.appendChild(this._object);var g=new Element("div");var a=new Element("a",{href:this._getScreenflowURL("debug"),target:"_blank"}).update("[Debug in new window]");g.appendChild(a);g.appendChild(new Element("br"));var d=new dijit.form.CheckBox({checked:this._logEnabled});g.appendChild(d.domNode);d.domNode.observe("change",this._toggleLogging.bind(this));var c=new Element("span").update("Logging enabled (better if you have Firebug)");g.appendChild(c);f.appendChild(g);return f},_toggleLogging:function(b){var a=Event.element(b);this._logEnabled=!this._logEnabled;a.checked=this._logEnabled;this._object.contentDocument.location.href=this._getScreenflowURL()},_getScreenflowURL:function(b){var a=b||(this._logEnabled?"logging":"");return URIs.storePlayScreenflow+"?screenflow="+this._description.getId()+"&debugLevel="+a}});var User=Class.create({initialize:function(){this._userName=null;this._firstName=null;this._lastName=null;this._email=null;this._ezWebURL=null;this._catalogueMagic=false;this._iServe=false;this._getUser()},getUserName:function(){return this._userName},getFirstName:function(){return this._firstName},getLastName:function(){return this._lastName},getEmail:function(){return this._email},getEzWebURL:function(){return this._ezWebURL},getRealName:function(){return this._firstName+" "+this._lastName},getCatalogueMagic:function(){return this._catalogueMagic},setCatalogueMagic:function(a){this._catalogueMagic=a},getiServe:function(){return this._iServe},setiServe:function(a){this._iServe=a},update:function(a){this._firstName=a.firstName;this._lastName=a.lastName;this._email=a.email;this._catalogueMagic=(a.catalogueMagic!==undefined);this._iServe=(a.iServe!==undefined);this._ezWebURL=a.ezWebURL;if(this._ezWebURL!=""&&this._ezWebURL[this._ezWebURL.length-1]!="/"){this._ezWebURL+="/"}URIs.ezweb=this._ezWebURL;this._updateUser()},_getUser:function(){var b=function(c){var d=JSON.parse(c.responseText);this._userName=d.user.username;this._firstName=d.user.first_name;this._lastName=d.user.last_name;this._email=d.user.email;this._ezWebURL=d.profile.ezweb_url;if(this._ezWebURL!=""&&this._ezWebURL[this._ezWebURL.length-1]!="/"){this._ezWebURL+="/"}URIs.ezweb=this._ezWebURL};var a=function(c,d){Logger.serverError(c,d)};PersistenceEngine.sendGet(URIs.userPreferences,this,b,a)},_updateUser:function(){var d=function(f){};var c=function(f){Logger.serverError(f,e)};var b={first_name:this._firstName,last_name:this._lastName,email:this._email,ezweb_url:this._ezWebURL};var a={preferences:Object.toJSON(b)};PersistenceEngine.sendUpdate(URIs.userPreferences,a,null,this,d,c)}});var RecommendationManager=Class.create({initialize:function(){this._recommendations=new Hash();this._activeRecommendations=new Hash();this._currentRecommendation=1;this._step=0;this._startTimespam=0;this._timeout=null},addRecommendation:function(b,a){if(this._recommendations.get(b.key)==undefined){this._recommendations.set(b.key,{className:"recommendation"+this._currentRecommendation++,localNode:b.node,externalNodes:[],nodes:[b.node]})}var c=this._recommendations.get(b.key);c.externalNodes.push(a.node);c.nodes.push(a.node);this._dirty=true},setStartFact:function(a){this._clear();this._stopAnimation();this._startFact=a;this._dirty=true;if(this._startFact){this.startAnimation()}},startAnimation:function(){var a=this._startFact?null:3000;this._clear();this._stopAnimation();if(this._dirty){this._filterRecommendations()}this._startAnimation(a)},clear:function(){this._clear();this._stopAnimation();this._recommendations=new Hash();this._activeRecommendations=new Hash();this._currentRecommendation=1;this._dirty=false},_filterRecommendations:function(){if(this._startFact){this._activeRecommendations=new Hash();var a=this._recommendations.get(this._startFact);if(a){this._activeRecommendations.set(this._startFact,a)}}else{this._activeRecommendations=this._recommendations}this._dirty=false},_clear:function(){this._recommendations.each(function(c){var a=c.value.nodes;var b=c.value.className;a.each(function(d){d.removeClassName(b);d.getElementsByClassName("recommendationLayer")[0].style.opacity=""}.bind(this))}.bind(this))},_stopAnimation:function(){try{this._startTimestamp=0;clearTimeout(this._timeout)}catch(a){}},_startAnimation:function(b){this._activeRecommendations.each(function(f){var c;if(this._startFact){c=f.value.externalNodes}else{c=f.value.nodes}var d=f.value.className;c.each(function(g){g.getElementsByClassName("recommendationLayer")[0].style.opacity=0;g.addClassName(d)}.bind(this))}.bind(this));this._step=0;this._duration=b;var a=new Date();this._startTimestamp=a.getTime();this._timeout=setTimeout(this._timeoutCallback.bind(this),100)},_timeoutCallback:function(){var a=false;var c=Math.sin(Math.PI*this._step/10);c*=c;if(c<0.1){var b=new Date();if(this._duration&&((b.getTime()-this._startTimestamp)>this._duration)){a=true;c=0}}this._activeRecommendations.each(function(g){var d=g.value.nodes;var f=g.value.className;d.each(function(h){h.getElementsByClassName("recommendationLayer")[0].style.opacity=c}.bind(this))}.bind(this));if(!a){this._step++;this._timeout=setTimeout(this._timeoutCallback.bind(this),100)}}});var UIDGenerator=Class.create();Object.extend(UIDGenerator,{_nextIds:new Object()});Object.extend(UIDGenerator,{generate:function(a){var c=a.replace(new RegExp("\\s","g"),"").replace("_","");var b=this._nextIds[c];if(!b){b=1}this._nextIds[c]=b+1;return c+"_"+b},setStartId:function(d){var b=d.split("_");var a=b[0];var c=parseInt(b[1]);if(!this._nextIds[a]||this._nextIds[a]<=c){this._nextIds[a]=c+1}}});var BrowserUtils=Class.create();Object.extend(BrowserUtils,{getHeight:function(){var a=window.innerHeight;if(document.documentElement&&document.documentElement.clientHeight){a=document.documentElement.clientHeight}else{if(document.body&&document.body.clientHeight){a=document.body.clientHeight}}return a},getWidth:function(){var a=window.innerWidth;if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){a=document.documentElement.clientWidth}else{if(document.body&&(document.body.clientWidth||document.body.clientHeight)){a=document.body.clientWidth}}return a},isLeftButton:function(a){if(a==0||(this.isIE()&&a==1)){return true}else{return false}},isIE:function(){if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){return true}else{return false}}});var Utils=Class.create();Object.extend(Utils,{getIsoDateNow:function(b){var a=b.toJSON();a=a.replace(/"/,"");if(a.endsWith('Z"')){a=a.truncate(-2,"");a=a+"+0000"}return a},addProperties:function(b,a){if(a){$H(a).clone().each(function(c){b[c.key]=c.value})}},setSatisfeabilityClass:function(b,a){if(a===null||a===undefined){b.removeClassName("satisfeable");b.removeClassName("unsatisfeable")}else{b.removeClassName(a?"unsatisfeable":"satisfeable");b.addClassName(a?"satisfeable":"unsatisfeable")}},extractURIfromPattern:function(b){if(b){var a=b.split(" ");return a[2]}else{return""}},onAJAXError:function(c,b){Logger.serverError(c,b);var a="Try Reloading";if(b){a=b}Utils.showMessage("Ooops. Something unexpected happened: "+a,{error:true,hide:true})},getPosition:function(a){var c=0;var b=0;while(a.offsetParent){c+=a.offsetLeft-a.scrollLeft;b+=a.offsetTop-a.scrollTop;a=a.offsetParent}c+=a.offsetLeft;b+=a.offsetTop;return{left:c,top:b}},showMessage:function(c,b){$("messages").removeClassName("error");$("messages").removeClassName("hidden");$("messages").update(c);var a=Math.floor(($("header").clientWidth/2)-($("messages").clientWidth/2));$("messages").setStyle({opacity:"1",left:a+"px"});if(b){if(b.error){$("messages").addClassName("error")}if(b.hide){dojo.fadeOut({duration:2500,node:$("messages")}).play(b.error?2500:1500)}}},hideMessage:function(){$("messages").setStyle({opacity:"0"})},showErrorMessage:function(b,a){this.showMessage(b,Object.extend(a||{},{error:true}))},variableOrDefault:function(c,b){var a=c;if(a===undefined){a=b}return a},getCatalogueTags:function(c,b){var a=new Array();c.each(function(d){a.push({label:{"en-gb":d}})});return a},sanitize:function(b){var a=b.replace(/^\s+|\n|\s+$/g,"");a=a.replace(/\s+/g," ");return a}});var Logger=Class.create();Object.extend(Logger,{serverError:function(c,a){var b;if(a){b="JavaScript exception on file #{errorFile} (line: #{errorLine}): #{errorDesc}".interpolate({errorFile:a.fileName,errorLine:a.lineNumber,errorDesc:a})}else{if(c.responseXML){b=c.responseXML.documentElement.textContent}else{try{m=JSON.parse(c.responseText);b=m.message}catch(a){}if(!b){b="HTTP Error #{status} - #{text}".interpolate({status:c.status,text:c.statusText})}}}console.log(b)}});var KeyPressRegistry=Class.create({initialize:function(){this._handlers=new Hash();this._enabled=true;this.setEnabled(this._enabled)},addHandler:function(a,c){var b=a.toLowerCase();if(this._handlers.get(b)){shortcut.remove(b)}this._handlers.set(b,c);shortcut.add(b,this._executeHandler.bind(this),{disable_in_input:true})},isRegistered:function(a){return(this._handler.get(a)?true:false)},removeHandler:function(a){var b=a.toLowerCase();this._handlers.unset(b)},setEnabled:function(a){this._enabled=a},_executeHandler:function(b,a){if(this._enabled&&this._handlers.get(a)){this._handlers.get(a)(a)}}});var Geometry=Class.create();Object.extend(Geometry,{updateAxis:function(c,f,d){function b(h,j,i){var g=new Object();if(j>h){g.delta=h;g.offLimit=i+(j-h)}else{if(i<0){if(j+i>0){g.delta=j+i;g.offLimit=0}else{g.delta=0;g.offLimit=j+i}}else{g.delta=j;g.offLimit=i}}return g}if(f>=0){return b(c.max,f,d)}else{var a=b(-c.min,-f,-d);a.delta=-a.delta;a.offLimit=-a.offLimit;return a}},contains:function(a,b){return(b.left>=a.left)&&(b.top>=a.top)&&(b.right<=a.right)&&(b.bottom<=a.bottom)},intersects:function(a,b){return !((b.bottom<a.top)||(b.left>a.right)||(b.top>a.bottom)||(b.right<a.left))},getRectangle:function(b){var a=Utils.getPosition(b);return{top:a.top,left:a.left,bottom:a.top+b.offsetHeight,right:a.left+b.offsetWidth}},getClientRectangle:function(d){var c=document.defaultView.getComputedStyle(d,null);var f=c.getPropertyCSSValue("border-top-width").getFloatValue(CSSPrimitiveValue.CSS_PX);var b=c.getPropertyCSSValue("border-left-width").getFloatValue(CSSPrimitiveValue.CSS_PX);var a=Utils.getPosition(d);return{top:a.top+f,left:a.left+b,bottom:a.top+d.clientHeight,right:a.left+d.clientWidth}},getCenter:function(a){return{top:(a.clientHeight-a.clientTop)/2,left:(a.clientWidth-a.clientLeft)/2}},dragRanges:function(a,b){return{x:{min:Math.min(-b.left,0),max:Math.max((a.right-a.left)-b.right,0)},y:{min:Math.min(-b.top,0),max:Math.max((a.bottom-a.top)-b.bottom,0)}}},adaptDropPosition:function(g,f){var c=this.getRectangle(f);var b=this.getClientRectangle(g);var d=c.right-c.left;var a=c.bottom-c.top;if(c.right>b.right){c.left=b.right-d}if(c.left<b.left){c.left=b.left}if(c.bottom>b.bottom){c.top=b.bottom-a}if(c.top<b.top){c.top=b.top}return{left:c.left-b.left,top:c.top-b.top}},adaptInitialPosition:function(g,f,d){var c={top:0,left:0,right:g.offsetWidth,bottom:g.offsetHeight};var b={top:d.top,left:d.left,right:d.left+f.clientWidth,bottom:d.top+f.clientHeight};var a={top:d.top,left:d.left};if(b.right>c.right){a.left=c.right-f.offsetWidth}if(b.left<c.left){a.left=c.left}if(b.bottom>c.bottom){a.top=c.bottom-f.offsetHeight}if(b.top<c.top){a.top=c.top}return a}});var Constants={BuildingBlock:{SCREEN:"screen",SCREENFLOW:"screenflow",DOMAIN_CONCEPT:"domainConcept",FORM:"form",OPERATOR:"operator",RESOURCE:"resource"},BuildingBlockNames:{screen:"Screens",domainConcept:"Domain Concepts",form:"Forms",operator:"Operators",resource:"Services & Resources"},CatalogueCopies:{screen:"screens",form:"forms",operator:"operators",resource:"backendservices"}};Constants.CatalogueRelationships={backendservices:Constants.BuildingBlock.RESOURCE,forms:Constants.BuildingBlock.FORM,operators:Constants.BuildingBlock.OPERATOR};var GVS=Class.create(ToolbarModel,{initialize:function($super){$super();this._documentController=null;this._actions=null;this._user=new User();this._dialogs=new Hash();this._menuConfig=null},init:function(){this._actions={newBuildingBlock:this._newBuildingBlock.bind(this),newScreenflow:this._newScreenflow.bind(this),addScreen:this._addScreen.bind(this),newScreen:this._newScreen.bind(this),browseScreenflows:this._browseScreenflows.bind(this),browseScreens:this._browseScreens.bind(this),browseBuildingBlocks:this._browseBuildingBlocks.bind(this),showAbout:this._showAboutDialog.bind(this),wrapperService:this._openWrapperService.bind(this),mediation:this._openMediationTool.bind(this),manageConcepts:this._openFactTool.bind(this)};this._dialogs.set("addScreen",new AddScreenDialog());this._dialogs.set("newScreenflow",new NewBuildingBlockDialog("Screenflow"));this._dialogs.set("newScreen",new NewBuildingBlockDialog("Screen"));this._dialogs.set("newForm",new NewBuildingBlockDialog("Form"));this._dialogs.set("newOperator",new NewBuildingBlockDialog("Operator"));this._dialogs.set("newResource",new NewBuildingBlockDialog("Resource"));this._dialogs.set("browseScreenflows",new ManageScreenflowsDialog());this._dialogs.set("browseScreens",new ManageScreensDialog());this._dialogs.set("browseBuildingBlocks",new ManageBuildingBlocksDialog());this._dialogs.set("preferences",new PreferencesDialog());this._dialogs.set("newBuildingBlock",new NewBuildingBlockCodeDialog());this._documentController=new DocumentController();this._addToolbarButtons();this._setMenuItems();this._documentController.getToolbar().setModel(0,this);this._documentController.getMenu().setModel("GVS",this)},action:function(a){if(this._actions[a]){this._actions[a]()}else{alert("This function is being implemented. Stay tuned")}},getDocumentController:function(){return this._documentController},getUser:function(){return this._user},setEnabled:function(a){this._documentController.getKeyPressRegistry().setEnabled(a)},getMenuElements:function(){return this._menuConfig},_newScreenflow:function(){this._dialogs.get("newScreenflow").show()},_newScreen:function(){this._dialogs.get("newScreen").show()},_addScreen:function(){this._dialogs.get("addScreen").show()},_browseScreenflows:function(){this._dialogs.get("browseScreenflows").show()},_browseScreens:function(){this._dialogs.get("browseScreens").show()},_browseBuildingBlocks:function(){this._dialogs.get("browseBuildingBlocks").show()},_openWrapperService:function(){this._documentController.openExternalTool("Wrap a service",URIs.wrapperService)},_openMediationTool:function(){this._documentController.openExternalTool("Mediation between concepts",URIs.dataMediation)},_openFactTool:function(){this._documentController.openExternalTool("Manage concepts",URIs.factTool)},_newBuildingBlock:function(){this._dialogs.get("newBuildingBlock").show()},_addToolbarButtons:function(){this._addToolbarElement("home",new ToolbarButton("Home","home",this._documentController.showWelcomeDocument.bind(this._documentController)));var a=this._dialogs.get("preferences");this._addToolbarElement("preferences",new ToolbarButton("User Preferences","preferences",a.show.bind(a)))},_showAboutDialog:function(){PersistenceEngine.sendGet(URIs.about,this,this._onSuccessAbout,Utils.onAJAXError)},_onSuccessAbout:function(b){var a=new ExternalContentDialog("About GVS");a.show(b.responseText)},_setMenuItems:function(){this._menuConfig={file:{type:"SubMenu",label:"File",weight:1,children:{"new":{type:"SubMenu",label:"New...",weight:1,group:0,children:{newScreenflow:{type:"Action",action:new MenuAction({label:"Screenflow",weight:1,handler:function(){this.action("newScreenflow")}.bind(this),shortcut:"Shift+N"}),group:0},newScreen:{type:"Action",action:new MenuAction({label:"Screen",weight:10,handler:function(){this.action("newScreen")}.bind(this),shortcut:"Alt+N"}),group:0},newOperator:{type:"Action",action:new MenuAction({label:"Operator",weight:2,handler:function(){this.action("newOperator")}.bind(this)}),group:1},newForm:{type:"Action",action:new MenuAction({label:"Form",weight:1,handler:function(){this.action("newForm")}.bind(this)}),group:1},newResource:{type:"Action",action:new MenuAction({label:"Resource",weight:3,handler:function(){this.action("newResource")}.bind(this)}),group:1}}},browse:{type:"SubMenu",label:"Browse...",weight:2,group:0,children:{browseScreenflows:{type:"Action",action:new MenuAction({label:"Screenflows",weight:2,handler:function(){this.action("browseScreenflows")}.bind(this),shortcut:"Shift+O"}),group:0},browseScreens:{type:"Action",action:new MenuAction({label:"Screens",weight:10,handler:function(){this.action("browseScreens")}.bind(this),shortcut:"Alt+N"}),group:0}}}}},edit:{type:"SubMenu",weight:2,label:"Edit",children:{preferences:{type:"Action",action:new MenuAction({label:"User Preferences",weight:1,handler:function(){this._dialogs.get("preferences").show()}.bind(this)}),group:1}}},help:{type:"Submenu",weight:MenuElement.MAXIMUM_WEIGHT,label:"Help",children:{website:{type:"Action",action:new MenuAction({label:"Fast Website",weight:1,handler:function(){window.open("http://fast.morfeo-project.eu")}}),group:0},about:{type:"Action",action:new MenuAction({label:"About GVS",weight:2,handler:function(){this.action("showAbout")}.bind(this)}),group:0},feedback:{type:"Action",action:new MenuAction({label:"Send us feedback",weight:3,handler:function(){UserVoice.Popin.show(uservoiceOptions)}.bind(this)}),group:0}}}};if(!GlobalOptions.isPublicDemo){}}});GVS=new GVS();
